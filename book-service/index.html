<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wrong Fuel Rescue Booking - Emergency Fuel Extraction | Eek Mechanical</title>
  <meta name="description" content="Book emergency wrong fuel extraction service with Eek Mechanical. Professional fuel removal, system flush, NZIFDA certified. Don't start your engine - call now!" />
  <meta name="keywords" content="wrong fuel rescue, fuel extraction booking, misfuel service, petrol in diesel, diesel in petrol, emergency fuel removal" />

  <!-- Security Headers -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com https://js.stripe.com;
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    frame-src https://js.stripe.com https://hooks.stripe.com https://www.googletagmanager.com;
    connect-src 'self' https://www.google-analytics.com https://www.googletagmanager.com https://api.stripe.com https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com;">

  <!-- Google Analytics (GA4 only - no ads tracking) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQNKF1YLWR"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-DQNKF1YLWR');
  </script>
  
  <!-- Centralized Phone Number Management -->
  <script src="/phone-manager.js?v={{ site.version }}"></script>
  
  <!-- Unified Tracking System (replaces tracking-manager.js) -->
  <script src="/unified-tracking.js?v={{ site.version }}"></script>
  
  <!-- Centralized Footer Management -->
  <script src="/footer-new.js?v={{ site.version }}"></script>

  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <style>
    :root{
      --brand:#ff5500; --brand2:#ff7733; --ok:#28a745; --warn:#ff9500; --muted:#6c757d; --purple:#6f42c1;
    }
    body{font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif;background:#f5f5f5;margin:0;padding:0 0 80px 0;color:#333;text-align:center}
    header{background:#fff;padding:20px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .business-name{font-size:2.2em;font-weight:700;color:var(--brand);margin:.3em 0;text-shadow:1px 1px 2px rgba(0,0,0,.08)}
    header img{max-width:250px;height:auto;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.1)}
    h1{font-size:1.8em;margin:.5em 0 .2em}
    .breadcrumb{background:#e8f4f8;padding:10px 20px;margin:0;text-align:left;font-size:.9em}
    .breadcrumb a{color:var(--brand);text-decoration:none}
    .breadcrumb a:hover{text-decoration:underline}

    .booking-container{max-width:900px;margin:20px auto;background:#fff;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.1);overflow:hidden}
    .booking-header{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:40px 30px;text-align:center;position:relative;overflow:hidden}
    .booking-header::before{content:'';position:absolute;top:-50%;right:-50%;width:200%;height:200%;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;animation:float 20s infinite linear}
    .booking-header.winz{background:linear-gradient(135deg,var(--purple),#5a32a3)}
    .booking-header h2{margin:0 0 10px 0;font-size:2.2em;text-shadow:2px 2px 4px rgba(0,0,0,0.3)}
    .booking-header p{margin:0;font-size:1.2em;opacity:.95;font-weight:500}
    @keyframes float{0%{transform:translateX(0) translateY(0)}100%{transform:translateX(-100px) translateY(-100px)}}
    .service-stats{background:rgba(255,255,255,.15);padding:15px;border-radius:8px;margin-top:15px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;text-align:center}
    .stat-item{font-size:.9em}.stat-number{font-size:1.8em;font-weight:700;display:block}

    .progress-bar{display:flex;justify-content:space-between;margin:20px 0;padding:0 20px}
    .progress-step{flex:1;text-align:center;position:relative}
    .progress-step::before{content:'';width:30px;height:30px;border-radius:50%;background:#ddd;display:block;margin:0 auto 8px}
    .progress-step.active::before{background:var(--brand)}
    .progress-step.completed::before{background:var(--ok)}
    .progress-step span{font-size:.9em;color:#666}
    .progress-step.active span{color:var(--brand);font-weight:700}

    .booking-steps{padding:30px}
    .step{display:none;text-align:left}
    .step.active{display:block}
    .step h3{color:var(--brand);margin-bottom:20px;font-size:1.4em}
    
    .step.winz-step h3{background:#f0f0f0;padding:15px;border-radius:8px;color:#333;font-weight:600}

    .emergency-selector{margin:20px 0}
    .emergency-selector label{font-weight:700;font-size:1.05em;display:block;margin-bottom:15px;color:#333}
    .emergency-selector label .required{color:#ff0000}
    .emergency-option{display:flex;align-items:center;padding:15px;border:2px solid #e0e0e0;border-radius:8px;margin-bottom:10px;cursor:pointer;transition:all .2s;background:#fff}
    .emergency-option:hover{border-color:var(--purple);background:#f9f5ff}
    .emergency-option input[type="radio"]{width:20px;height:20px;margin-right:15px;cursor:pointer}
    .emergency-option.selected{border-color:var(--purple);background:#f9f5ff;border-width:3px}
    .emergency-label{font-size:1.05em;color:#333}

    .location-input,.details-input{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:1.05em;margin-bottom:20px;box-sizing:border-box}
    .location-input:focus,.details-input:focus{border-color:var(--brand);outline:none}
    .details-input{height:120px;resize:vertical}

    .timing-notice{background:#fff3cd;border:2px solid #ffeaa7;border-radius:12px;padding:20px;margin:20px 0;text-align:left}
    .timing-notice h4{margin:0 0 10px 0;color:#856404}
    .timing-notice p{margin:8px 0;color:#856404;line-height:1.5}

    .urgency-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin:20px 0}
    .urgency-option{border:2px solid #ddd;border-radius:12px;padding:20px;cursor:pointer;text-align:center;transition:all .3s;background:#fff}
    .urgency-option:hover{border-color:var(--brand);transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,85,0,.15)}
    .urgency-option.selected{border-color:var(--brand);background:linear-gradient(135deg,#fff5f0,#ffe5d9);border-width:3px}
    .urgency-title{font-weight:700;margin-bottom:8px;font-size:1.1em}
    .urgency-time{color:var(--brand);font-size:.95em;margin-bottom:8px;font-weight:600}
    .urgency-description{font-size:.9em;color:#666;margin-bottom:12px}
    .urgency-price{font-size:1.25em;font-weight:800;color:var(--brand)}
    .urgency-price.calculating{color:var(--muted);font-size:1em}

    .voltage-wrap{background:#f8f9fa;border:2px solid #e9ecef;border-radius:12px;padding:16px;margin:16px 0}
    .voltage-title{font-weight:800;margin-bottom:10px}
    .voltage-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
    .voltage-card{border:2px solid #ddd;border-radius:12px;padding:14px;cursor:pointer;background:#fff;transition:all .2s}
    .voltage-card:hover{border-color:var(--brand);transform:translateY(-1px)}
    .voltage-card.selected{border-color:var(--brand);background:linear-gradient(135deg,#fff5f0,#ffe5d9)}
    .voltage-label{font-weight:700}
    .voltage-price{color:var(--brand);font-weight:800;margin-top:6px}

    .reservation-summary{background:#e8f4f8;border-radius:8px;padding:20px;margin:20px 0}
    .reservation-summary h4{margin:0 0 15px 0}
    .summary-item{display:flex;justify-content:space-between;margin:8px 0;align-items:center}
    .summary-item strong{color:var(--brand)}

    .button{background:var(--brand);color:#fff;padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-size:1.05em;text-decoration:none;display:inline-block;transition:all .2s;margin:10px 5px}
    .button:hover{background:#e04400;transform:translateY(-1px)}
    .button.secondary{background:var(--muted)}
    .button.secondary:hover{background:#545b62}
    .button.winz{background:var(--purple)}
    .button.winz:hover{background:#5a32a3}
    .button:disabled{background:#ccc;cursor:not-allowed;transform:none}
    .button.processing{background:var(--muted);position:relative}
    .button.processing::after{content:'...';animation:dots 1.5s steps(3,end) infinite}
    @keyframes dots{0%,20%{content:'.'}40%{content:'..'}60%,100%{content:'...'}}

    .terms-section{background:#f8f9fa;border-radius:8px;padding:20px;margin:20px 0;text-align:left}
    .terms-checkbox{display:flex;align-items:flex-start;gap:10px;margin:15px 0}
    .terms-checkbox input{margin-top:4px;transform:scale(1.2)}
    .terms-text{font-size:.95em;line-height:1.5}
    .terms-text a{color:var(--brand);text-decoration:none}
    .terms-text a:hover{text-decoration:underline}

    .info-box{background:#fff3cd;border:1px solid #ffeaa7;border-radius:8px;padding:15px;margin:15px 0;text-align:left}
    .info-box h4{margin:0 0 10px 0;color:#856404}
    .info-box ul{margin:0;padding-left:20px;color:#856404}

    .contact-info{margin:15px 0}
    .contact-info label{display:block;margin-bottom:8px;font-weight:700}
    .contact-info input{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:1em;margin-bottom:15px;box-sizing:border-box}
    .contact-info input:focus{border-color:var(--brand);outline:none}

    @media (max-width: 768px) {
      .booking-steps{padding:20px}
      .urgency-options{grid-template-columns:1fr}
      .voltage-grid{grid-template-columns:1fr}
      .business-name{font-size:1.8em}
      .stats-grid{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
<header>
  <img id="headerImage" src="/brand-image.png" alt="Eek Mechanical - Emergency Roadside Services"/>
  <div class="business-name">Eek Mechanical</div>
  <h1 id="headerTitle">Wrong Fuel Rescue Service</h1>
  <p id="headerSubtitle" style="font-size:1.1em;color:#666;margin:10px 0;"></p>
</header>

<div class="breadcrumb">
  <a href="/" class="tracking-link">Home</a> > <span id="breadcrumbText">Wrong Fuel Rescue</span>
</div>

<div class="booking-container">
  <div class="booking-header" id="bookingHeader">
    <h2 id="bookingTitle">Book Wrong Fuel Rescue Service</h2>
    <p id="bookingDescription">Emergency fuel extraction service ‚Ä¢ Don't start your engine!</p>
    <div class="service-stats">
      <div class="stats-grid" id="statsContent"></div>
    </div>
  </div>

  <div class="progress-bar">
    <div class="progress-step active" id="step1-progress"><span>Details</span></div>
    <div class="progress-step" id="step2-progress"><span id="step2Label">Scheduling</span></div>
    <div class="progress-step" id="step3-progress"><span>Confirm</span></div>
  </div>

  <div class="booking-steps">
    <!-- Step 1: Service Details -->
    <div class="step active" id="step1">
      <h3 id="step1Title">Step 1: Service Details</h3>

      <div id="emergencySelector" class="emergency-selector" style="display:none;">
        <label>1. What is your emergency? <span class="required">*</span></label>
        <div id="emergencyOptions"></div>
      </div>

      <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
        <h4 style="margin:0 0 15px 0;color:#333;">Your Information</h4>
        <div class="contact-info">
          <label for="nameInput">Full Name (required)</label>
          <input type="text" id="nameInput" placeholder="John Smith" required autocomplete="name"/>
          <label for="phoneInput">Phone Number (required)</label>
          <input type="tel" id="phoneInput" placeholder="021 234 5678" required inputmode="tel" autocomplete="tel"/>
          <label for="emailInput">Email Address (required)</label>
          <input type="email" id="emailInput" placeholder="your.email@example.com" required autocomplete="email"/>
        </div>
      </div>

      <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
        <h4 style="margin:0 0 15px 0;color:#333;">Vehicle Information</h4>
        <div class="contact-info">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
            <div>
              <label for="regoInput">Registration Number (required)</label>
              <input type="text" id="regoInput" placeholder="ABC123" style="text-transform:uppercase;" required autocapitalize="characters" spellcheck="false"/>
            </div>
            <div>
              <label for="yearInput">Year (required)</label>
              <input type="text" id="yearInput" placeholder="2018" maxlength="4" required pattern="\\d{4}" inputmode="numeric"/>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
            <div>
              <label for="makeInput">Make (required)</label>
              <input type="text" id="makeInput" placeholder="Toyota" required/>
            </div>
            <div>
              <label for="modelInput">Model (required)</label>
              <input type="text" id="modelInput" placeholder="Corolla" required/>
            </div>
          </div>
        </div>
      </div>

      <div id="voltageSelector" class="voltage-wrap" style="display:none;">
        <div class="voltage-title">Select battery voltage (required for jump starts)</div>
        <div class="voltage-grid" id="voltageGrid"></div>
      </div>

      <label for="locationInput" style="display:block;margin-bottom:8px;font-weight:700;">Where do you need service?</label>
      <input type="text" class="location-input" id="locationInput" placeholder="Enter your address, suburb, or region" required autocomplete="street-address"/>

      <label for="detailsInput" style="display:block;margin-bottom:8px;margin-top:15px;font-weight:700;" id="detailsLabel">Tell us more about your situation:</label>
      <textarea class="details-input" id="detailsInput" placeholder="Describe the issue or what you need help with..."></textarea>

      <div class="info-box" id="serviceInfoBox"></div>

      <div style="text-align:center;margin:20px 0;">
        <button class="button" id="nextBtn" onclick="goToStep2()">Next: Select Time</button>
      </div>
    </div>

    <!-- Step 2: Scheduling (or Quote for WINZ) -->
    <div class="step" id="step2">
      <h3 id="step2Title">Step 2: When do you need service?</h3>

      <div class="timing-notice" id="timingNotice">
        <h4>‚è∞ Important Timing Information</h4>
        <p><strong>Time windows are approximate arrival times.</strong> As a mobile service, a previous job may run long. We'll text you when your tech is on the way.</p>
      </div>

      <div class="urgency-options" id="urgencyOptions"></div>

      <div style="margin:20px 0;">
        <button class="button secondary" onclick="goToStep1()">Back</button>
        <button class="button" id="confirmTimeBtn" onclick="goToStep3()" disabled>Continue</button>
      </div>
    </div>

    <!-- Step 3: Confirmation -->
    <div class="step" id="step3">
      <h3 id="step3Title">Step 3: Review and confirm</h3>

      <div class="reservation-summary">
        <h4>Your Service Request</h4>
        <div class="summary-item"><span>Service:</span><strong id="summaryService"></strong></div>
        <div class="summary-item" id="summaryEmergencyRow" style="display:none;"><span>Emergency Type:</span><strong id="summaryEmergency"></strong></div>
        <div class="summary-item"><span>Location:</span><strong id="summaryLocation"></strong></div>
        <div class="summary-item"><span>Phone:</span><strong id="summaryPhone"></strong></div>
        <div class="summary-item" id="summaryVoltageRow" style="display:none;"><span>Battery Voltage:</span><strong id="summaryVoltage"></strong></div>
        <div class="summary-item" id="summaryUrgencyRow"><span>Response Time:</span><strong id="summaryUrgency"></strong></div>
        <div class="summary-item" id="summaryPriceRow"><span>Service Fee:</span><strong id="summaryPrice"></strong></div>
      </div>

      <div class="timing-notice" id="nextStepsBox" style="background:#e8f8ff;border-color:#bee5eb;">
        <h4>üì± What happens next?</h4>
        <p>1. Click "Generate Payment Link" to create your secure payment link</p>
        <p>2. Complete payment through Stripe's secure checkout</p>
        <p>3. Receive SMS confirmation with your booking details</p>
        <p>4. Get a notification when your technician is on the way</p>
      </div>

      <div class="terms-section">
        <h4>Terms and Conditions</h4>
        <div class="terms-checkbox">
          <input type="checkbox" id="termsAgree" onchange="toggleBookingButton()" />
          <div class="terms-text">
            I agree to the <a href="https://eek.nz/terms-of-service.html" target="_blank">Eek Mechanical Terms of Service</a> and understand that:
            <ul style="margin:10px 0;padding-left:20px;" id="termsList"></ul>
          </div>
        </div>
      </div>

      <div style="text-align:center;margin:20px 0;">
        <div style="display:flex;justify-content:center;gap:15px;flex-wrap:wrap;">
          <button class="button secondary" onclick="goToStep2()">Back to Selection</button>
          <button class="button" id="generatePaymentBtn" onclick="generatePaymentLink()" disabled>Generate Payment Link</button>
        </div>
        <p style="margin:15px 0;color:#666;font-size:.9em;" id="paymentNote">Secure payment processing powered by Stripe</p>
      </div>
    </div>
  </div>
</div>

<script>
// CENTRALIZED GCLID EXTRACTION UTILITY (supports gclid, gbraid, wbraid)
function extractGCLID(urlParams) {
  return urlParams.get('gclid') || urlParams.get('gbraid') || urlParams.get('wbraid') || null;
}

// === TRACKING INITIALIZATION ===
let sessionId = null;
let gclid = null;
let utmData = {};

function initializeTracking() {
  console.log('üìä Initializing tracking system...');
  
  sessionId = getOrCreateSessionId();
  gclid = getGCLID();
  utmData = getUTMData();
  
  console.log('‚úÖ Tracking system initialized');
  console.log('üìä Session ID:', sessionId);
  console.log('üìä GCLID/GBRAID/WBRAID:', gclid || 'None');
  console.log('üìä UTM Data:', utmData);
}

function getOrCreateSessionId() {
  let sid = localStorage.getItem("eek_session_id");
  
  if (!sid) {
    const urlParams = new URLSearchParams(window.location.search);
    sid = urlParams.get('session_id');
    
    if (sid) {
      localStorage.setItem("eek_session_id", sid);
      console.log('üîÑ Session ID restored from URL');
    } else {
      sid = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      localStorage.setItem("eek_session_id", sid);
      console.log('üÜï New session ID created');
    }
  } else {
    console.log('‚úÖ Existing session ID found');
  }
  
  return sid;
}

function getGCLID() {
  const urlParams = new URLSearchParams(window.location.search);
  let gclidValue = extractGCLID(urlParams);
  
  if (gclidValue) {
    localStorage.setItem("eek_gclid", gclidValue);
    localStorage.setItem("eek_gclid_timestamp", new Date().toISOString());
    console.log('‚úÖ GCLID/GBRAID/WBRAID captured from URL:', gclidValue);
    return gclidValue;
  }
  
  const storedGclid = localStorage.getItem("eek_gclid");
  const storedTimestamp = localStorage.getItem("eek_gclid_timestamp");
  
  if (storedGclid && storedTimestamp) {
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    
    if (new Date(storedTimestamp) > thirtyDaysAgo) {
      console.log('üìã Using stored GCLID/GBRAID/WBRAID:', storedGclid);
      return storedGclid;
    } else {
      localStorage.removeItem("eek_gclid");
      localStorage.removeItem("eek_gclid_timestamp");
      console.log('‚ö†Ô∏è GCLID/GBRAID/WBRAID expired and removed');
    }
  }
  
  return null;
}

function getUTMData() {
  const urlParams = new URLSearchParams(window.location.search);
  const utm = {};
  const utmParams = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'];
  
  utmParams.forEach(param => {
    const value = urlParams.get(param);
    if (value) {
      utm[param] = value;
      localStorage.setItem(`eek_${param}`, value);
    }
  });
  
  utmParams.forEach(param => {
    if (!utm[param]) {
      const stored = localStorage.getItem(`eek_${param}`);
      if (stored) {
        utm[param] = stored;
      }
    }
  });
  
  return utm;
}

function appendTrackingParams(url) {
  if (url.startsWith('tel:') || url.startsWith('mailto:') || url.startsWith('http')) {
    return url;
  }
  
  const params = new URLSearchParams();
  
  if (sessionId) params.set('session_id', sessionId);
  if (gclid) params.set('gclid', gclid);
  
  ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'].forEach(param => {
    const value = utmData[param];
    if (value) params.set(param, value);
  });
  
  const paramString = params.toString();
  if (!paramString) return url;
  
  const separator = url.includes('?') ? '&' : '?';
  return url + separator + paramString;
}

function updateAllTrackingLinks() {
  console.log('üîó Updating all navigation links with tracking parameters...');
  
  document.querySelectorAll('.tracking-link').forEach(link => {
    const originalHref = link.getAttribute('href');
    if (originalHref && !originalHref.startsWith('tel:') && !originalHref.startsWith('mailto:')) {
      const updatedHref = appendTrackingParams(originalHref);
      link.setAttribute('href', updatedHref);
      console.log(`üîó Updated link: ${originalHref} ‚Üí ${updatedHref}`);
    }
  });
  
  console.log('‚úÖ All tracking links updated');
}

// --- NZ timezone helpers ---
const NZ_TZ = 'Pacific/Auckland';
function nowNZ(){
  const parts = new Intl.DateTimeFormat('en-NZ',{
    timeZone:NZ_TZ,hour12:false,year:'numeric',month:'2-digit',day:'2-digit',
    hour:'2-digit',minute:'2-digit',second:'2-digit'
  }).formatToParts(new Date());
  const get=t=>parts.find(p=>p.type===t).value;
  return new Date(`${get('year')}-${get('month')}-${get('day')}T${get('hour')}:${get('minute')}:${get('second')}`);
}
function fmtDateNZ(d){
  return d.toLocaleDateString('en-NZ',{timeZone:NZ_TZ,weekday:'long',year:'numeric',month:'long',day:'numeric'});
}

// === BOOKING STATUS CONSTANTS ===
const BOOKING_STATUS = {
  INITIAL: 'booking_started',
  DETAILS_COMPLETE: 'details_complete',
  TIME_SELECTED: 'time_selected',
  TERMS_ACCEPTED: 'terms_accepted',
  PAYMENT_PENDING: 'payment_pending',
  WINZ_QUOTE_SENT: 'winz_quote_sent'
};

const STATUS_COLORS = {
  'booking_started': '#007bff',
  'details_complete': '#28a745',
  'time_selected': '#fd7e14',
  'terms_accepted': '#6f42c1',
  'payment_pending': '#dc3545',
  'winz_quote_sent': '#20c997'
};

const STATUS_DESCRIPTIONS = {
  'booking_started': 'Customer started booking form',
  'details_complete': 'Customer completed contact and vehicle details',
  'time_selected': 'Customer selected service timing',
  'terms_accepted': 'Customer accepted terms and conditions',
  'payment_pending': 'Payment link generated, awaiting customer payment',
  'winz_quote_sent': 'WINZ quote generated and sent to customer'
};

// Service Configurations
const serviceConfigs = {
  'fuel-extraction': {
    title:'Wrong Fuel Extraction Service',
    subtitle:"Put wrong fuel in? We'll extract it safely!",
    breadcrumb:'Fuel Extraction',
    bookingTitle:'Emergency Fuel Extraction Service',
    bookingDescription:"Professional fuel extraction ‚Ä¢ Don't start the engine!",
    step1Title:'Step 1: Tell us about the fuel situation',
    detailsLabel:'Critical details about what happened:',
    detailsPlaceholder:'e.g., How much wrong fuel, have you started engine, petrol in diesel or vice versa, etc.',
    serviceCode:'FUEL',
    basePrice:399,
    stats:[
      {number:'30‚Äì90',text:'min arrival'},
      {number:'Mobile',text:'extraction first'},
      {number:'100%',text:'insured service'},
      {number:'Complete',text:'system flush'}
    ],
    urgencyOptions:[
      {id:'mobile',title:'Mobile Extraction Service',time:'30‚Äì90 minutes arrival',description:'On-site fuel extraction and system flush',price:399},
      {id:'workshop',title:'Workshop Service',time:'Vehicle collection + workshop completion',description:'Complete workshop extraction with comprehensive system service',price:849}
    ],
    infoContent:`
      <h4>CRITICAL: DO NOT START THE ENGINE</h4>
      <ul>
        <li><strong>Professional extraction</strong> of contaminated fuel</li>
        <li><strong>Complete system flush</strong> to remove all traces</li>
        <li><strong>Fresh fuel replacement</strong> with correct fuel type</li>
        <li><strong>System testing</strong> to ensure safe operation</li>
        <li><strong>Fully insured service</strong> for your protection</li>
        <li><strong>Professional assessment</strong> will determine the best approach for your situation</li>
      </ul>`,
    terms:{
      mobile:[
        'In some cases, transfer to workshop may be necessary. Towing costs not included in service price. Additional fees may apply.'
      ],
      workshop:[
        'Towing costs not included in service price',
        'Additional fees may apply for complex extraction requirements'
      ]
    }
  },
};

// Globals
// TRACKING_API_URL removed - all tracking now goes through unified-tracking.js
const PAYMENT_API_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/dbc93a177083499caf5a06eeac87683c/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=vXidGdo8qErY4QVv03JeNaGbA79eWEoiOxuDocljL6Q';
const WINZ_API_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/95fc801df59b4250a48919ace91c0276/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=mFpTX4gPrz1u1DbdfF3YqHBnAsW3pnAAj-GWXWvBYYc';

let selectedUrgency = null;
let selectedUrgencyDetails = {};
let selectedVoltageId = null;
let selectedVoltagePrice = null;
let selectedEmergencyType = null;
let calculatedPrice = null;
let winzQuoteGenerated = false;

// === STEP COMPLETION TRACKING (Security Safeguard) ===
let stepCompletionState = {
  step1Completed: false,
  step2Completed: false,
  step3Active: false,
  step1Timestamp: null,
  step2Timestamp: null,
  step3Timestamp: null,
  validationToken: null
};

// Persist step completion state to localStorage (allows customers to resume)
function saveStepCompletionState() {
  try {
    localStorage.setItem('eek_booking_step_state', JSON.stringify(stepCompletionState));
    console.log('üíæ Step completion state saved to localStorage');
  } catch (e) {
    console.warn('‚ö†Ô∏è Could not save step state to localStorage:', e);
  }
}

// Restore step completion state from localStorage (for returning customers)
function restoreStepCompletionState() {
  try {
    const saved = localStorage.getItem('eek_booking_step_state');
    if (saved) {
      const parsed = JSON.parse(saved);
      // Only restore if it's recent (within 24 hours) to prevent stale state
      const maxAge = 24 * 60 * 60 * 1000; // 24 hours
      
      // Collect valid timestamps (ignore null/undefined - don't default to Date.now())
      const timestamps = [
        parsed.step1Timestamp ? new Date(parsed.step1Timestamp).getTime() : null,
        parsed.step2Timestamp ? new Date(parsed.step2Timestamp).getTime() : null,
        parsed.step3Timestamp ? new Date(parsed.step3Timestamp).getTime() : null
      ].filter(t => t !== null && !isNaN(t));
      
      // If no valid timestamps exist, treat as invalid/stale session
      if (timestamps.length === 0) {
        console.log('‚ö†Ô∏è No valid timestamps in saved state, clearing');
        localStorage.removeItem('eek_booking_step_state');
        return false;
      }
      
      const oldestTimestamp = Math.min(...timestamps);
      
      if (Date.now() - oldestTimestamp < maxAge) {
        stepCompletionState = { ...stepCompletionState, ...parsed };
        console.log('‚úÖ Step completion state restored from localStorage');
        return true;
      } else {
        console.log('‚ö†Ô∏è Saved step state expired, clearing');
        localStorage.removeItem('eek_booking_step_state');
      }
    }
  } catch (e) {
    console.warn('‚ö†Ô∏è Could not restore step state from localStorage:', e);
  }
  return false;
}

// Clear step completion state (when booking is completed or abandoned)
function clearStepCompletionState() {
  stepCompletionState = {
    step1Completed: false,
    step2Completed: false,
    step3Active: false,
    step1Timestamp: null,
    step2Timestamp: null,
    step3Timestamp: null,
    validationToken: null
  };
  localStorage.removeItem('eek_booking_step_state');
  console.log('üóëÔ∏è Step completion state cleared');
}

// Generate a validation token when step 3 is reached
function generateValidationToken() {
  const timestamp = Date.now();
  const random = Math.random().toString(36).substr(2, 9);
  const data = `${timestamp}-${random}-${sessionId || 'unknown'}`;
  // Simple hash for token (not cryptographically secure, but prevents casual bypass)
  let hash = 0;
  for (let i = 0; i < data.length; i++) {
    const char = data.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32bit integer
  }
  return `token_${Math.abs(hash).toString(36)}_${timestamp}`;
}

// Validate that all required steps have been completed
// This is more flexible - allows customers who started the process to continue
function validateStepCompletion() {
  const errors = [];
  
  // Check if we have valid form data (this is the real validation)
  // If form is complete, we allow payment even if step state was lost
  const hasValidFormData = validateRequiredFields().valid;
  
  // If form data is valid, we're more lenient about step state
  // This allows customers to resume their booking
  if (hasValidFormData) {
    // Still check that urgency was selected (critical for pricing)
    if (!selectedUrgency) {
      errors.push('Service time/urgency must be selected');
    }
    
    // If Step 3 is visible and active, that's good enough
    const step3Element = document.getElementById('step3');
    if (step3Element && step3Element.classList.contains('active')) {
      // If we're on step 3 with valid data, check step completion state
      // Use OR logic: if EITHER step is incomplete, log warning
      if (!stepCompletionState.step1Completed || !stepCompletionState.step2Completed) {
        // Some step state is missing - could be bypass attempt or returning customer
        // Log for monitoring but allow if form data is complete (likely legitimate)
        console.log('‚ö†Ô∏è Step state incomplete (step1:', stepCompletionState.step1Completed, 
                    ', step2:', stepCompletionState.step2Completed, ') - form data valid, allowing with caution');
      }
    } else {
      errors.push('Please complete all booking steps before generating payment');
    }
  } else {
    // If form data is incomplete, be strict about step completion
    if (!stepCompletionState.step1Completed) {
      errors.push('Step 1 (Service Details) has not been completed');
    }
    
    if (!stepCompletionState.step2Completed) {
      errors.push('Step 2 (Scheduling) has not been completed');
    }
    
    if (!stepCompletionState.step3Active) {
      errors.push('Step 3 (Confirmation) is not active');
    }
  }
  
  return {
    valid: errors.length === 0,
    errors: errors
  };
}

// Validate all required form fields are filled
function validateRequiredFields() {
  const errors = [];
  
  const name = document.getElementById('nameInput')?.value?.trim();
  const phone = document.getElementById('phoneInput')?.value?.trim();
  const email = document.getElementById('emailInput')?.value?.trim();
  const location = document.getElementById('locationInput')?.value?.trim();
  const rego = sanitizeRego(document.getElementById('regoInput')?.value || '');
  const year = document.getElementById('yearInput')?.value?.trim();
  const make = document.getElementById('makeInput')?.value?.trim();
  const model = document.getElementById('modelInput')?.value?.trim();
  
  if (!name) errors.push('Full name is required');
  if (!phone || phone.replace(/\D/g,'').length < 9) errors.push('Valid phone number is required (at least 9 digits)');
  if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) errors.push('Valid email address is required');
  if (!location) errors.push('Service location is required');
  if (!rego) errors.push('Vehicle registration is required');
  if (!year || year.replace(/\D/g,'').length !== 4) errors.push('Valid 4-digit vehicle year is required');
  if (!make) errors.push('Vehicle make is required');
  if (!model) errors.push('Vehicle model is required');
  
  // Check urgency/time selection
  if (!selectedUrgency) {
    errors.push('Service time/urgency must be selected');
  }
  
  // WINZ-specific validation
  if (window.currentConfig?.isWinz && !selectedEmergencyType) {
    errors.push('Emergency type must be selected');
  }
  
  return {
    valid: errors.length === 0,
    errors: errors
  };
}

function sanitizePhone(val){ return (val || '').replace(/\D/g,''); }
function sanitizeRego(val){ return (val || '').toUpperCase().replace(/[^A-Z0-9]/g,''); }
function sanitizeText(val){ return (val || '').trim().replace(/\s+/g,' '); }

// === CONSISTENT DATA BUILDER ===
function buildBookingData(status) {
  const geo = window.CF_GEO || {};
  const locationInputValue = sanitizeText(document.getElementById('locationInput')?.value || '');
  
  const baseData = {
    sessionId: sessionId,
    gclid: gclid,
    bookingStatus: status,
    statusColor: STATUS_COLORS[status] || '#6c757d',
    statusDescription: STATUS_DESCRIPTIONS[status] || 'Unknown status',
    timestamp: new Date().toISOString(),
    
    name: sanitizeText(document.getElementById('nameInput')?.value || ''),
    phone: sanitizePhone(document.getElementById('phoneInput')?.value || ''),
    email: document.getElementById('emailInput')?.value?.trim() || '',
    // Root-level location object for email template compatibility (MUST be object, not string)
    location: {
      city: locationInputValue || 'Unknown',
      region: geo?.region || 'Unknown',
      country: geo?.country || 'New Zealand',
      address: locationInputValue || '',
      coordinates: {
        latitude: geo?.latitude || null,
        longitude: geo?.longitude || null,
        accuracy: geo?.latitude && geo?.longitude ? 'IP-based' : null
      }
    },
    details: document.getElementById('detailsInput').value || '',
    
    rego: sanitizeRego(document.getElementById('regoInput').value),
    vehicleRego: sanitizeRego(document.getElementById('regoInput').value),
    year: document.getElementById('yearInput').value.trim(),
    vehicleYear: document.getElementById('yearInput').value.trim(),
    make: sanitizeText(document.getElementById('makeInput').value),
    vehicleMake: sanitizeText(document.getElementById('makeInput').value),
    model: sanitizeText(document.getElementById('modelInput').value),
    vehicleModel: sanitizeText(document.getElementById('modelInput').value),
    vehicleType: selectedVoltageId === '24v' ? 'truck' : 'car',
    
    service: window.currentService,
    serviceCode: window.currentConfig.serviceCode,
    serviceTitle: window.currentConfig.title,
    
    utm: {
      source: utmData.utm_source || null,
      medium: utmData.utm_medium || null,
      campaign: utmData.utm_campaign || null,
      term: utmData.utm_term || null,
      content: utmData.utm_content || null,
      gclid: gclid
    },
    
    source: 'booking_form',
    formVersion: '2.1',
    
    // Add visitorData for Power Automate compatibility
    visitorData: {
      name: sanitizeText(document.getElementById('nameInput')?.value || ''),
      phone: sanitizePhone(document.getElementById('phoneInput')?.value || ''),
      email: document.getElementById('emailInput')?.value?.trim() || '',
      // visitorData.location can be string (for backward compatibility) but root-level location must be object
      location: locationInputValue,
      vehicleRego: sanitizeRego(document.getElementById('regoInput').value),
      vehicleYear: document.getElementById('yearInput').value.trim(),
      vehicleMake: sanitizeText(document.getElementById('makeInput').value),
      vehicleModel: sanitizeText(document.getElementById('modelInput').value),
      service: window.currentService,
      serviceCode: window.currentConfig.serviceCode,
      serviceTitle: window.currentConfig.title
    }
  };

  if (status === BOOKING_STATUS.TIME_SELECTED || status === BOOKING_STATUS.TERMS_ACCEPTED || status === BOOKING_STATUS.PAYMENT_PENDING) {
    baseData.selectedTime = selectedUrgencyDetails.time || '';
    baseData.selectedUrgency = selectedUrgency;
    baseData.urgencyTitle = selectedUrgencyDetails.title || '';
    baseData.calculatedPrice = calculatedPrice || window.currentConfig.basePrice;
    baseData.finalPrice = getTotalPrice();
    
    if (window.currentService === 'fuel-extraction' && window.currentConfig.terms && !Array.isArray(window.currentConfig.terms)) {
      const acceptedTerms = window.currentConfig.terms[selectedUrgency] || [];
      baseData.acceptedTerms = acceptedTerms;
      baseData.serviceLevel = selectedUrgency;
    }
  }

  if (false) { // Removed jumpstart voltage selection
    baseData.selectedVoltage = selectedVoltageId;
    baseData.batteryVoltage = selectedVoltageId === '12v' ? '12V' : '24V';
  }

  if (window.currentConfig.isWinz && selectedEmergencyType) {
    baseData.emergencyType = selectedEmergencyType;
    
    if (status === BOOKING_STATUS.TIME_SELECTED || status === BOOKING_STATUS.TERMS_ACCEPTED || status === BOOKING_STATUS.WINZ_QUOTE_SENT) {
      baseData.quoteAmount = calculatedPrice || getTotalPrice();
      baseData.calculatedPrice = calculatedPrice || getTotalPrice();
      baseData.finalPrice = calculatedPrice || getTotalPrice();
      baseData.price = calculatedPrice || getTotalPrice();
      
      if (!window.winzQuoteReference) {
        window.winzQuoteReference = `WINZ-${Date.now()}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
      }
      baseData.quoteReference = window.winzQuoteReference;
      
      const emergencyConfig = window.currentConfig.emergencyTypes.find(e => e.id === selectedEmergencyType);
      if (emergencyConfig) {
        baseData.emergencyLabel = emergencyConfig.label;
        baseData.emergencyDescription = emergencyConfig.description;
      }
    }
  }

  return baseData;
}

async function sendBookingUpdate(status) {
  const data = buildBookingData(status);
  
  console.log(`%cüì° BOOKING STATUS UPDATE: ${status.toUpperCase()}`, `color: ${STATUS_COLORS[status]}; font-weight: bold; font-size: 14px;`);
  console.log(`%c${STATUS_DESCRIPTIONS[status]}`, `color: ${STATUS_COLORS[status]}; font-style: italic;`);
  console.log('üìä Complete booking data:', data);
  
  // Use unified-tracking.js - this is the ONLY way to send tracking data
  try {
    if (window.unifiedTracking && typeof window.unifiedTracking.sendTrackingData === 'function') {
      await window.unifiedTracking.sendTrackingData(status, {
        ...data,
        eventType: status,
        service: data.service,
        serviceCode: data.serviceCode,
        serviceTitle: data.serviceTitle,
        price: data.price,
        basePrice: data.basePrice,
        selectedTime: data.selectedTime,
        selectedUrgency: data.selectedUrgency
      });
      console.log(`%c‚úÖ Tracking data sent via unified-tracking.js: ${status}`, `color: ${STATUS_COLORS[status]}`);
    } else {
      console.warn('‚ö†Ô∏è unified-tracking.js not available, skipping tracking');
    }
  } catch (err) {
    console.error(`%c‚ùå Error sending ${status} update:`, `color: #dc3545`, err);
  }
}

async function generateWinzQuote() {
  const data = buildBookingData(BOOKING_STATUS.WINZ_QUOTE_SENT);
  
  console.log('üìã === WINZ QUOTE GENERATION === üìã');
  console.log('üí∞ Quote data:', data);
  
  // Mirror to unified tracking
  try {
    if (window.unifiedTracking && typeof window.unifiedTracking.sendTrackingData === 'function') {
      window.unifiedTracking.sendTrackingData('winz_quote_sent', {
        ...data,
        eventType: 'winz_quote_sent'
      });
    }
  } catch (e) {}
  
  try {
    const response = await fetch(WINZ_API_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    console.log(`‚úÖ WINZ Quote API Response: ${response.status}`);
    return response;
  } catch (err) {
    console.error('‚ùå Error generating WINZ quote:', err);
    throw err;
  }
}

// Enhanced visitor data persistence
function storeVisitorData(data) {
  const visitorData = JSON.parse(localStorage.getItem('eek_visitor_data') || '{}');
  
  // Merge new data with existing data
  Object.assign(visitorData, data);
  
  // Add timestamp for data freshness
  visitorData.lastUpdated = new Date().toISOString();
  
  localStorage.setItem('eek_visitor_data', JSON.stringify(visitorData));
  
  console.log('‚úÖ Visitor data stored:', data);
  return visitorData;
}

function getVisitorData() {
  return JSON.parse(localStorage.getItem('eek_visitor_data') || '{}');
}

function clearVisitorData() {
  localStorage.removeItem('eek_visitor_data');
  console.log('üóëÔ∏è Visitor data cleared');
}

// Check for return visit from booking link
function checkReturnVisit() {
  const urlParams = new URLSearchParams(window.location.search);
  const callAttemptId = urlParams.get('call_attempt_id');
  const callTimestamp = urlParams.get('call_timestamp');
  const sessionId = urlParams.get('session_id');
  
  if (callAttemptId && callTimestamp) {
    // This is a return visit from a booking link
    const returnVisitData = {
      callAttemptId: callAttemptId,
      callTimestamp: callTimestamp,
      returnTimestamp: new Date().toISOString(),
      timeBetweenCallAndReturn: new Date() - new Date(callTimestamp),
      source: 'booking_link_return',
      page: 'book_service'
    };
    
    // Send tracking event for return visit
    sendBookingUpdate('return_visit_from_call', returnVisitData);
    
    console.log('‚úÖ Return visit detected from booking link:', returnVisitData);
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', function(){
  console.log('üöÄ === BOOKING FORM INITIALIZED === üöÄ');
  
  initializeTracking();
  updateAllTrackingLinks();
  
  // Check for return visit from booking link
  checkReturnVisit();
  
  const urlParams = new URLSearchParams(window.location.search);
  const service = urlParams.get('service') || 'fuel-extraction';
  
  // Only allow fuel-extraction service
  if (service !== 'fuel-extraction') {
    console.log('üîÑ Redirecting to fuel-extraction service');
    const redirectParams = new URLSearchParams();
    redirectParams.append('service', 'fuel-extraction');
    if (gclid) redirectParams.append('gclid', gclid);
    if (sessionId) redirectParams.append('session_id', sessionId);
    
    ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'].forEach(param => {
      const value = urlParams.get(param);
      if (value) redirectParams.append(param, value);
    });
    
    window.location.href = '/book-service/?' + redirectParams.toString();
    return;
  }
  
  loadServiceConfig(service);
  
  // Restore booking state for returning customers
  restoreBookingState();
  
  sendBookingUpdate(BOOKING_STATUS.INITIAL);
});

// Restore booking state and form data for returning customers
function restoreBookingState() {
  console.log('üîÑ Checking for saved booking state...');
  
  // Restore step completion state
  const stateRestored = restoreStepCompletionState();
  
  // Restore form field values from visitor data
  const visitorData = getVisitorData();
  if (visitorData && Object.keys(visitorData).length > 0) {
    console.log('üìã Restoring form data from previous session...');
    
    if (visitorData.name && document.getElementById('nameInput')) {
      document.getElementById('nameInput').value = visitorData.name;
    }
    if (visitorData.phone && document.getElementById('phoneInput')) {
      document.getElementById('phoneInput').value = visitorData.phone;
    }
    if (visitorData.email && document.getElementById('emailInput')) {
      document.getElementById('emailInput').value = visitorData.email;
    }
    
    console.log('‚úÖ Form data restored (partial)');
  }
  
  // If customer was on Step 3, restore their progress
  if (stateRestored && stepCompletionState.step3Active) {
    console.log('üîÑ Customer was on Step 3 - attempting to restore...');
    
    // Restore urgency selection if we can determine it
    // Note: We can't fully restore Step 2 state without more data,
    // but we can at least allow them to continue if form is complete
    
    // Check if form has enough data to proceed
    const name = document.getElementById('nameInput')?.value?.trim();
    const phone = document.getElementById('phoneInput')?.value?.trim();
    const email = document.getElementById('emailInput')?.value?.trim();
    const location = document.getElementById('locationInput')?.value?.trim();
    
    if (name && phone && email && location) {
      console.log('‚úÖ Form appears complete - customer can continue from Step 3');
      // Don't auto-advance, but allow them to proceed if they click through
    } else {
      console.log('‚ö†Ô∏è Form incomplete - customer will need to complete steps');
      // Reset state if form is too incomplete
      stepCompletionState.step3Active = false;
      stepCompletionState.validationToken = null;
    }
  }
}

function loadServiceConfig(serviceType){
  const config = serviceConfigs[serviceType] || serviceConfigs['fuel-extraction'];
  
  console.log('‚öôÔ∏è === SERVICE CONFIGURATION LOADED === ‚öôÔ∏è');
  console.log('üì¶ Service:', config.title);

  document.title = `${config.title} - Eek Mechanical`;
  document.getElementById('headerTitle').textContent = config.title;
  document.getElementById('headerSubtitle').textContent = config.subtitle;
  document.getElementById('breadcrumbText').textContent = config.breadcrumb;
  document.getElementById('bookingTitle').textContent = config.bookingTitle;
  document.getElementById('bookingDescription').textContent = config.bookingDescription;
  document.getElementById('step1Title').textContent = config.step1Title;
  document.getElementById('detailsLabel').textContent = config.detailsLabel;
  document.getElementById('detailsInput').placeholder = config.detailsPlaceholder;
  document.getElementById('serviceInfoBox').innerHTML = config.infoContent;

  const bookingHeader = document.getElementById('bookingHeader');
  if (config.isWinz) {
    bookingHeader.classList.add('winz');
    document.getElementById('step1').classList.add('winz-step');
  } else {
    bookingHeader.classList.remove('winz');
    document.getElementById('step1').classList.remove('winz-step');
  }

  const statsContainer = document.getElementById('statsContent');
  statsContainer.innerHTML = config.stats.map(stat =>
    `<div class="stat-item"><span class="stat-number">${stat.number}</span>${stat.text}</div>`
  ).join('');

  const termsList = document.getElementById('termsList');
  if (config.terms) {
    if (Array.isArray(config.terms)) {
      termsList.innerHTML = config.terms.map(term => `<li>${term}</li>`).join('');
    } else {
      termsList.innerHTML = '';
    }
  }

  const emergencySelector = document.getElementById('emergencySelector');
  const emergencyOptions = document.getElementById('emergencyOptions');
  if (config.isWinz && config.emergencyTypes) {
    emergencySelector.style.display = 'block';
    emergencyOptions.innerHTML = config.emergencyTypes.map(e => `
      <div class="emergency-option" onclick="selectEmergencyType('${e.id}', this)">
        <input type="radio" name="emergencyType" value="${e.id}" id="emergency_${e.id}">
        <label for="emergency_${e.id}" class="emergency-label">${e.label}</label>
      </div>
    `).join('');
  } else {
    emergencySelector.style.display = 'none';
  }

  const vWrap = document.getElementById('voltageSelector');
  const vGrid = document.getElementById('voltageGrid');
  if (config.voltages && !config.isWinz){
    vWrap.style.display = 'block';
    vGrid.innerHTML = config.voltages.map(v => `
      <div class="voltage-card" data-id="${v.id}" onclick="selectVoltage('${v.id}', ${v.price}, this)">
        <div class="voltage-label">${v.label}</div>
        <div class="voltage-price">Calculating...</div>
      </div>
    `).join('');
  } else {
    vWrap.style.display = 'none';
    vGrid.innerHTML = '';
  }

  if (config.isWinz) {
    document.getElementById('nextBtn').textContent = 'Get Quote';
    document.getElementById('nextBtn').classList.add('winz');
    document.getElementById('step2Label').textContent = 'Quote';
  } else {
    document.getElementById('nextBtn').textContent = 'Next: Select Time';
    document.getElementById('nextBtn').classList.remove('winz');
    document.getElementById('step2Label').textContent = 'Scheduling';
  }

  selectedVoltageId = null;
  selectedVoltagePrice = null;
  selectedEmergencyType = null;
  selectedUrgency = null;
  selectedUrgencyDetails = {};
  calculatedPrice = null;
  winzQuoteGenerated = false;
  document.querySelectorAll('.progress-step').forEach(el => el.classList.remove('active','completed'));
  document.getElementById('step1-progress').classList.add('active');
  document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
  document.getElementById('step1').classList.add('active');

  window.currentService = serviceType;
  window.currentConfig = config;
}

function selectEmergencyType(id, el){
  document.querySelectorAll('.emergency-option').forEach(x=>x.classList.remove('selected'));
  el.classList.add('selected');
  el.querySelector('input[type="radio"]').checked = true;
  selectedEmergencyType = id;
}

function selectVoltage(id, price, el){
  document.querySelectorAll('.voltage-card.selected').forEach(x=>x.classList.remove('selected'));
  el.classList.add('selected');
  selectedVoltageId = id;
  selectedVoltagePrice = price;
}

function goToStep1(){
  document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
  document.getElementById('step1').classList.add('active');
  document.querySelectorAll('.progress-step').forEach(el => el.classList.remove('active','completed'));
  document.getElementById('step1-progress').classList.add('active');
  
  // Reset ALL step completion state when going back to Step 1
  // This ensures customers must go through the full flow again
  // (prevents bypassing steps by going back then forward)
  if (stepCompletionState.step1Completed || stepCompletionState.step2Completed || stepCompletionState.step3Active) {
    stepCompletionState.step1Completed = false;
    stepCompletionState.step2Completed = false;
    stepCompletionState.step3Active = false;
    stepCompletionState.step1Timestamp = null;
    stepCompletionState.step2Timestamp = null;
    stepCompletionState.step3Timestamp = null;
    stepCompletionState.validationToken = null;
    saveStepCompletionState(); // Persist updated state
    console.log('üîÑ All step completion state reset - customer must complete flow again');
  }
}

async function goToStep2(){
  console.log('üìù === STEP 1 ‚Üí STEP 2 TRANSITION === üìù');
  
  const name = document.getElementById('nameInput').value.trim();
  const phone = document.getElementById('phoneInput').value.trim();
  const email = document.getElementById('emailInput').value.trim();
  const location = document.getElementById('locationInput').value.trim();
  const details = document.getElementById('detailsInput').value.trim();

  const regoRaw = document.getElementById('regoInput').value;
  const yearRaw = document.getElementById('yearInput').value;
  const makeRaw = document.getElementById('makeInput').value;
  const modelRaw = document.getElementById('modelInput').value;

  const phoneRegex = /^[\d\s\-\+\(\)]+$/;
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const yearDigits = yearRaw.replace(/\D/g,'');
  const regoSan = sanitizeRego(regoRaw);

  if (!name){ alert('Please enter your full name'); document.getElementById('nameInput').focus(); return; }
  if (!phone){ alert('Please enter your phone number'); document.getElementById('phoneInput').focus(); return; }
  if (!phoneRegex.test(phone) || phone.replace(/\D/g,'').length < 9){
    alert('Please enter a valid phone number (at least 9 digits)');
    document.getElementById('phoneInput').focus();
    return;
  }
  if (!email){ alert('Please enter your email address'); document.getElementById('emailInput').focus(); return; }
  if (!emailRegex.test(email)){
    alert('Please enter a valid email address');
    document.getElementById('emailInput').focus();
    return;
  }
  if (!location){ alert('Please enter the service location'); document.getElementById('locationInput').focus(); return; }
  if (!regoSan){ alert('Please enter the vehicle registration (rego)'); document.getElementById('regoInput').focus(); return; }
  if (yearDigits.length !== 4){ alert('Please enter a 4-digit vehicle year'); document.getElementById('yearInput').focus(); return; }
  if (!makeRaw.trim()){ alert('Please enter the vehicle make'); document.getElementById('makeInput').focus(); return; }
  if (!modelRaw.trim()){ alert('Please enter the vehicle model'); document.getElementById('modelInput').focus(); return; }

  if (window.currentConfig.isWinz) {
    if (!selectedEmergencyType) {
      alert('Please select an emergency type');
      return;
    }
    if (!details) {
      alert('Please describe the problem in detail');
      document.getElementById('detailsInput').focus();
      return;
    }
  }

  if (!window.currentConfig.isWinz) {
    const btn = document.getElementById('nextBtn');
    btn.disabled = true;
    btn.textContent = 'Calculating price...';
    
    try {
      const response = await sendBookingUpdate(BOOKING_STATUS.DETAILS_COMPLETE);
      
      if (response && response.ok) {
        const responseText = await response.text();
        
        if (responseText) {
          try {
            const result = JSON.parse(responseText);
            calculatedPrice = result.price || window.currentConfig.basePrice;
          } catch (parseError) {
            calculatedPrice = window.currentConfig.basePrice;
          }
        } else {
          calculatedPrice = window.currentConfig.basePrice;
        }
        
        // Voltage selection removed - fuel extraction only
      }
    } catch (err) {
      console.error('Pricing API error:', err);
      calculatedPrice = window.currentConfig.basePrice;
    } finally {
      btn.disabled = false;
      btn.textContent = 'Next: Select Time';
    }
  }

  document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
  document.getElementById('step2').classList.add('active');
  document.getElementById('step1-progress').classList.add('completed');
  document.getElementById('step1-progress').classList.remove('active');
  document.getElementById('step2-progress').classList.add('active');
  
  // Mark Step 1 as completed
  stepCompletionState.step1Completed = true;
  stepCompletionState.step1Timestamp = new Date().toISOString();
  saveStepCompletionState(); // Persist to localStorage
  console.log('‚úÖ Step 1 marked as completed');

  // Scroll to step 2 with proper alignment
  setTimeout(() => {
    const step2Element = document.getElementById('step2');
    if (step2Element) {
      step2Element.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start',
        inline: 'nearest'
      });
      // Additional offset to account for fixed header if needed
      window.scrollBy(0, -20);
    }
  }, 100);

  if (window.currentConfig.isWinz) {
    document.getElementById('step2Title').textContent = window.currentConfig.step2Title || 'Step 2: Generate Your WINZ Quote';
    document.getElementById('timingNotice').style.display = 'none';
    document.getElementById('confirmTimeBtn').textContent = 'Generate Quote';
    document.getElementById('confirmTimeBtn').classList.add('winz');
  } else {
    document.getElementById('step2Title').textContent = 'Step 2: When do you need service?';
    document.getElementById('timingNotice').style.display = 'block';
    document.getElementById('confirmTimeBtn').textContent = 'Continue';
    document.getElementById('confirmTimeBtn').classList.remove('winz');
  }

  const urgencyContainer = document.getElementById('urgencyOptions');
  urgencyContainer.innerHTML = window.currentConfig.urgencyOptions.map(o => {
    let displayPrice, priceHtml;
    
    if (window.currentService === 'fuel-extraction') {
      displayPrice = o.price;
      priceHtml = `<div class="urgency-price" style="display:none;">$${displayPrice}</div>`;
      const titleWithPrice = `${o.title} - $${displayPrice}`;
      
      return `
        <div class="urgency-option" onclick="selectUrgency('${o.id}','${o.title}','${o.time}',${o.price || displayPrice},this)">
          <div class="urgency-title">${titleWithPrice}</div>
          <div class="urgency-time">${o.time}</div>
          <div class="urgency-description">${o.description}</div>
          ${priceHtml}
        </div>`;
    } else {
      displayPrice = calculatedPrice || window.currentConfig.basePrice;
      priceHtml = (o.hidePrice || window.currentConfig.hidePrice) 
        ? '<div class="urgency-price calculating">Price in quote</div>'
        : `<div class="urgency-price">$${displayPrice}</div>`;
      
      return `
        <div class="urgency-option" onclick="selectUrgency('${o.id}','${o.title}','${o.time}',${o.price || displayPrice},this)">
          <div class="urgency-title">${o.title}</div>
          <div class="urgency-time">${o.time}</div>
          <div class="urgency-description">${o.description}</div>
          ${priceHtml}
        </div>`;
    }
  }).join('');

  if (window.currentConfig.urgencyOptions.length === 1) {
    const firstOption = window.currentConfig.urgencyOptions[0];
    selectUrgency(firstOption.id, firstOption.title, firstOption.time, calculatedPrice || 0, urgencyContainer.querySelector('.urgency-option'));
  }
}

function selectUrgency(id, title, time, price, el){
  document.querySelectorAll('.urgency-option.selected').forEach(x => x.classList.remove('selected'));
  el.classList.add('selected');
  selectedUrgency = id;
  selectedUrgencyDetails = {
    title,
    time,
    price: calculatedPrice || price
  };
  
  if (window.currentService === 'fuel-extraction' && window.currentConfig.terms && !Array.isArray(window.currentConfig.terms)) {
    const termsList = document.getElementById('termsList');
    const termsForSelection = window.currentConfig.terms[id] || [];
    termsList.innerHTML = termsForSelection.map(term => `<li>${term}</li>`).join('');
  }
  
  document.getElementById('confirmTimeBtn').disabled = false;
}

async function goToStep3(){
  console.log('‚è∞ === STEP 2 ‚Üí STEP 3 TRANSITION === ‚è∞');
  
  if (!selectedUrgency){
    alert('Please select a service time');
    return;
  }

  await sendBookingUpdate(BOOKING_STATUS.TIME_SELECTED);

  if (window.currentConfig.isWinz) {
    let quotePrice = 299;
    if (selectedEmergencyType === 'battery') {
      quotePrice = 149;
    } else if (selectedEmergencyType === 'mechanical') {
      quotePrice = 249;
    } else if (selectedEmergencyType === 'misfuel') {
      quotePrice = 849;
    }

    calculatedPrice = quotePrice;
  }

  document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
  document.getElementById('step3').classList.add('active');
  document.getElementById('step2-progress').classList.add('completed');
  document.getElementById('step2-progress').classList.remove('active');
  document.getElementById('step3-progress').classList.add('active');

  // Mark Step 2 as completed and Step 3 as active
  stepCompletionState.step2Completed = true;
  stepCompletionState.step2Timestamp = new Date().toISOString();
  stepCompletionState.step3Active = true;
  stepCompletionState.step3Timestamp = new Date().toISOString();
  stepCompletionState.validationToken = generateValidationToken();
  saveStepCompletionState(); // Persist to localStorage
  console.log('‚úÖ Step 2 marked as completed, Step 3 activated with validation token');

  updateSummary();
}

function getTotalPrice(){
  if (window.currentConfig.isWinz) {
    return calculatedPrice || 0;
  }
  // Voltage pricing removed - fuel extraction only
  if (window.currentService === 'fuel-extraction' && selectedUrgency) {
    const selectedOption = window.currentConfig.urgencyOptions.find(opt => opt.id === selectedUrgency);
    return selectedOption ? selectedOption.price : window.currentConfig.basePrice;
  }
  return calculatedPrice || selectedUrgencyDetails.price || window.currentConfig.basePrice;
}

function updateSummary(){
  const phone = document.getElementById('phoneInput').value;
  const location = document.getElementById('locationInput').value;

  document.getElementById('summaryService').textContent = window.currentConfig.title;
  document.getElementById('summaryLocation').textContent = location;
  document.getElementById('summaryPhone').textContent = sanitizePhone(phone);
  
  const emergencyRow = document.getElementById('summaryEmergencyRow');
  if (window.currentConfig.isWinz && selectedEmergencyType) {
    emergencyRow.style.display = '';
    const emergencyLabel = window.currentConfig.emergencyTypes.find(e => e.id === selectedEmergencyType)?.label || '';
    document.getElementById('summaryEmergency').textContent = emergencyLabel;
  } else {
    emergencyRow.style.display = 'none';
  }

  const voltageRow = document.getElementById('summaryVoltageRow');
  voltageRow.style.display = 'none'; // Voltage selection not applicable for fuel extraction

  if (window.currentConfig.isWinz) {
    document.getElementById('summaryUrgencyRow').style.display = 'none';
    document.getElementById('summaryPrice').textContent = `$${getTotalPrice()} (quote for WINZ)`;
    
    document.getElementById('nextStepsBox').innerHTML = `
      <h4>üìã Your WINZ Quote is Ready!</h4>
      <p><strong>Quote Amount: $${getTotalPrice()}</strong></p>
      ${window.winzQuoteReference ? `<p>Quote Reference: ${window.winzQuoteReference}</p>` : ''}
      <p>1. Download or print your quote</p>
      <p>2. Take it to your local WINZ office or upload to MyMSD</p>
      <p>3. WINZ will process within 1-2 business days</p>
      <p>4. Once approved, we'll contact you to arrange service</p>
    `;
    
    document.getElementById('generatePaymentBtn').textContent = 'Download WINZ Quote';
    document.getElementById('generatePaymentBtn').classList.add('winz');
    document.getElementById('paymentNote').textContent = 'Quote will be emailed and available for download';
  } else {
    document.getElementById('summaryUrgencyRow').style.display = '';
    document.getElementById('summaryUrgency').textContent = selectedUrgencyDetails.time || '';
    document.getElementById('summaryPrice').textContent = `$${getTotalPrice()}`;
  }
}

function toggleBookingButton(){
  document.getElementById('generatePaymentBtn').disabled = !document.getElementById('termsAgree').checked;
}

function buildRedirectUrl(){
  const baseUrl = 'https://www.eek.nz/thanks';
  const params = new URLSearchParams();

  const name = sanitizeText(document.getElementById('nameInput').value);
  const phone = sanitizePhone(document.getElementById('phoneInput').value);
  const email = document.getElementById('emailInput').value.trim();
  const location = sanitizeText(document.getElementById('locationInput').value);
  const rego = sanitizeRego(document.getElementById('regoInput').value);
  const year = document.getElementById('yearInput').value.trim();
  const make = sanitizeText(document.getElementById('makeInput').value);
  const model = sanitizeText(document.getElementById('modelInput').value);

  params.append('name', name);
  params.append('phone', phone);
  params.append('email', email);
  params.append('location', location);
  params.append('rego', rego);
  params.append('year', year);
  params.append('make', make);
  params.append('model', model);
  params.append('service', window.currentService);
  params.append('serviceCode', window.currentConfig.serviceCode);
  params.append('serviceTitle', window.currentConfig.title);
  params.append('price', getTotalPrice());
  params.append('details', document.getElementById('detailsInput').value || '');
  params.append('scheduledDate', fmtDateNZ(nowNZ()));
  params.append('scheduledDateNZ', nowNZ().toLocaleString('sv-SE',{ timeZone:NZ_TZ, hour12:false }));
  params.append('timeWindow', selectedUrgencyDetails.time || '');
  params.append('urgencyLevel', selectedUrgency || '');
  params.append('bookingTime', new Date().toISOString());
  
  if (gclid) params.append('gclid', gclid);
  if (sessionId) params.append('session_id', sessionId);
  
  if (window.currentConfig.isWinz) {
    params.append('emergencyType', selectedEmergencyType || '');
    if (window.winzQuoteReference) {
      params.append('quoteReference', window.winzQuoteReference);
    }
  }
  
  // Battery voltage removed - fuel extraction only

  return `${baseUrl}?${params.toString()}`;
}

async function generatePaymentLink(){
  const btn = document.getElementById('generatePaymentBtn');
  
  // === COMPREHENSIVE VALIDATION SAFEGUARDS ===
  console.log('üîí Payment generation validation starting...');
  
  // 0. Verify button exists and is enabled (prevents direct console calls)
  if (!btn) {
    console.error('‚ùå Payment button not found');
    alert('Payment button not available. Please use the booking form.');
    return;
  }
  
  if (btn.disabled && !btn.classList.contains('processing')) {
    console.error('‚ùå Payment button is disabled');
    alert('Please complete all required steps and accept terms before generating payment link.');
    return;
  }
  
  // 1. Check terms acceptance
  const termsCheckbox = document.getElementById('termsAgree');
  if (!termsCheckbox || !termsCheckbox.checked){
    alert('Please accept the terms and conditions');
    console.warn('‚ùå Validation failed: Terms not accepted');
    return;
  }
  
  // 2. Validate step completion (flexible for returning customers)
  const stepValidation = validateStepCompletion();
  if (!stepValidation.valid) {
    console.error('‚ùå Step completion validation failed:', stepValidation.errors);
    // More helpful message for returning customers
    const errorMsg = stepValidation.errors.length > 0 
      ? 'Please complete the following:\n\n' + stepValidation.errors.join('\n')
      : 'Please complete all booking steps before generating payment link.';
    alert(errorMsg);
    return;
  }
  
  // 3. Validate all required fields
  const fieldValidation = validateRequiredFields();
  if (!fieldValidation.valid) {
    console.error('‚ùå Field validation failed:', fieldValidation.errors);
    alert('Please complete all required fields:\n\n' + fieldValidation.errors.join('\n'));
    return;
  }
  
  // 4. Verify Step 3 is actually visible and active (or allow if form is complete)
  const step3Element = document.getElementById('step3');
  const isStep3Active = step3Element && step3Element.classList.contains('active');
  
  if (!isStep3Active) {
    // If Step 3 is not active but form is complete, allow them to proceed
    // This helps returning customers who may have lost UI state
    if (fieldValidation.valid && selectedUrgency) {
      console.log('‚ö†Ô∏è Step 3 not active, but form is complete - allowing payment generation');
      // Auto-advance to Step 3 for them (await the async function)
      await goToStep3();
      // Additional delay to ensure UI and state are fully updated
      await new Promise(resolve => setTimeout(resolve, 200));
    } else {
      console.error('‚ùå Step 3 not active and form incomplete');
      alert('Please complete all booking steps before generating payment link.');
      return;
    }
  }
  
  // 5. Verify urgency/time was selected
  if (!selectedUrgency) {
    console.error('‚ùå No urgency/time selected');
    alert('Please select a service time before generating payment link.');
    return;
  }
  
  // 6. Verify price is valid
  const totalPrice = getTotalPrice();
  if (!totalPrice || totalPrice <= 0) {
    console.error('‚ùå Invalid price:', totalPrice);
    alert('Invalid service price. Please refresh and try again.');
    return;
  }
  
  console.log('‚úÖ All validation checks passed');
  console.log('üîí Validation token:', stepCompletionState.validationToken);
  console.log('üìä Step completion state:', stepCompletionState);

  btn.disabled = true;
  btn.classList.add('processing');
  
  await sendBookingUpdate(BOOKING_STATUS.TERMS_ACCEPTED);
  try {
    if (window.unifiedTracking && typeof window.unifiedTracking.sendTrackingData === 'function') {
      const mirror = buildBookingData(BOOKING_STATUS.TERMS_ACCEPTED);
      window.unifiedTracking.sendTrackingData('terms_accepted', { ...mirror, eventType: 'terms_accepted' });
    }
  } catch (e) {}
  
  if (window.currentConfig.isWinz) {
    btn.textContent = 'Generating Quote';
    
    try {
      await sendBookingUpdate(BOOKING_STATUS.WINZ_QUOTE_SENT);
      await generateWinzQuote();
    } catch (err) {
      console.error('WINZ quote process error:', err);
    }
    
    btn.textContent = 'Preparing Quote';
    
    const redirectUrl = buildRedirectUrl();
    
    setTimeout(() => {
      window.location.href = redirectUrl;
    }, 1500);
    return;
  }
  
  await sendBookingUpdate(BOOKING_STATUS.PAYMENT_PENDING);
  try {
    if (window.unifiedTracking && typeof window.unifiedTracking.sendTrackingData === 'function') {
      const mirror2 = buildBookingData(BOOKING_STATUS.PAYMENT_PENDING);
      window.unifiedTracking.sendTrackingData('payment_pending', { ...mirror2, eventType: 'payment_pending' });
    }
  } catch (e) {}
  
  btn.textContent = 'Generating Link';

  const customerName = sanitizeText(document.getElementById('nameInput').value);
  const phone = sanitizePhone(document.getElementById('phoneInput').value);
  
  // Store visitor data for persistence (so customers can resume)
  storeVisitorData({
    name: customerName,
    phone: phone,
    email: document.getElementById('emailInput')?.value || '',
    location: sanitizeText(document.getElementById('locationInput')?.value || ''),
    rego: sanitizeRego(document.getElementById('regoInput')?.value || ''),
    year: document.getElementById('yearInput')?.value?.trim() || '',
    make: sanitizeText(document.getElementById('makeInput')?.value || ''),
    model: sanitizeText(document.getElementById('modelInput')?.value || ''),
    service: window.currentConfig?.service || 'unknown',
    serviceCode: window.currentConfig?.serviceCode || 'unknown',
    selectedUrgency: selectedUrgency || '',
    lastUpdated: new Date().toISOString()
  });
  const email = document.getElementById('emailInput').value.trim();
  const location = sanitizeText(document.getElementById('locationInput').value);
  const rego = sanitizeRego(document.getElementById('regoInput').value);
  const year = document.getElementById('yearInput').value.trim();
  const make = sanitizeText(document.getElementById('makeInput').value);
  const model = sanitizeText(document.getElementById('modelInput').value);
  const vehicleDescription = [rego,year,make,model].filter(Boolean).join(' ') || 'Vehicle details not provided';

  const total = getTotalPrice();

  // Get comprehensive tracking data
  const trackingData = window.enhancedTracking ? window.enhancedTracking.getTrackingData() : {};
  const geo = window.CF_GEO || {};
  
  const bookingData = {
    rego: rego || 'Not provided',
    amount: total * 100,
    currency: 'NZD',
    description: `${window.currentConfig.title} - ${vehicleDescription} - ${location}`,
    redirectUrl: buildRedirectUrl(),
    
    // Security validation data
    validationToken: stepCompletionState.validationToken,
    stepCompletionState: {
      step1Completed: stepCompletionState.step1Completed,
      step2Completed: stepCompletionState.step2Completed,
      step3Active: stepCompletionState.step3Active,
      step1Timestamp: stepCompletionState.step1Timestamp,
      step2Timestamp: stepCompletionState.step2Timestamp,
      step3Timestamp: stepCompletionState.step3Timestamp
    },
    
    // Root-level fields for thanks page compatibility
    name: customerName,
    phone: phone,
    email: email,
    // Root-level location object for email template compatibility (MUST be object, not string)
    location: (() => {
      const locationStr = location || '';
      return {
        city: locationStr || 'Unknown',
        region: geo?.region || 'Unknown',
        country: geo?.country || 'New Zealand',
        address: locationStr || '',
        coordinates: {
          latitude: geo?.latitude || null,
          longitude: geo?.longitude || null,
          accuracy: geo?.latitude && geo?.longitude ? 'IP-based' : null
        }
      };
    })(),
    price: total,
    finalPrice: total,
    calculatedPrice: total,
    service: window.currentService,
    serviceCode: window.currentConfig.serviceCode,
    serviceTitle: window.currentConfig.title,
    year: year,
    make: make,
    model: model,
    vehicleType: selectedVoltageId === '24v' ? 'truck' : 'car',
    vehicleAddon: 0,
    details: document.getElementById('detailsInput').value || 'No additional details provided',
    bookingTime: nowNZ().toISOString(),
    sessionId: sessionId,
    urgencyLevel: selectedUrgency || 'emergency',
    emergencyType: selectedEmergencyType || '',
    quoteReference: window.winzQuoteReference || '',
    isWinzService: window.currentConfig.isWinz || false,
    batteryVoltage: '', // Not applicable for fuel extraction
    
    customerData: {
      name: customerName, 
      phone, 
      email, 
      location,
      vehicleRego: rego, 
      vehicleYear: year, 
      vehicleMake: make, 
      vehicleModel: model, 
      vehicleDescription,
      service: window.currentService,
      serviceCode: window.currentConfig.serviceCode,
      serviceTitle: window.currentConfig.title,
      details: document.getElementById('detailsInput').value || 'No additional details provided',
      price: `${total}`,
      basePrice: window.currentConfig.basePrice || total,
      bookingDateTime: nowNZ().toLocaleString('en-NZ',{ timeZone:NZ_TZ }),
      scheduledDate: fmtDateNZ(nowNZ()),
      scheduledTime: selectedUrgencyDetails.time || '',
      urgencyLevel: selectedUrgency || 'emergency',
      urgencyTitle: selectedUrgencyDetails.title || '',
      emergencyType: selectedEmergencyType || '',
      quoteReference: window.winzQuoteReference || '',
      isWinzService: window.currentConfig.isWinz || false,
      vehicleType: selectedVoltageId === '24v' ? 'truck' : 'car',
      vehicleTypeAddon: 0,
      scheduledDateISO: nowNZ().toISOString(),
      timeWindow: selectedUrgencyDetails.time || '',
      gclid: gclid,
      sessionId: sessionId,
      bookingSource: 'booking_form',
      formVersion: '2.1',
      // Battery voltage removed - fuel extraction only
    },
    
    // Enhanced tracking data for complete attribution
    trackingData: {
      gclid: gclid,
      gclidState: gclid ? 'Active' : 'Inactive',
      utm: utmData,
      pageSource: {
        type: 'direct',
        detail: 'Direct visit',
        referrer: document.referrer || '',
        utm: utmData,
        clickIds: {
          gclid: gclid,
          fbclid: null,
          msclkid: null
        }
      },
      device: {
        userAgent: navigator.userAgent,
        platform: /Mobi|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop',
        language: navigator.language || 'en-NZ',
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'Pacific/Auckland',
        screenResolution: `${window.screen?.width || 0}x${window.screen?.height || 0}`,
        viewportSize: `${window.innerWidth || 0}x${window.innerHeight || 0}`
      },
      location: {
        country: geo?.country || 'New Zealand',
        region: geo?.region || 'Unknown',
        city: geo?.city || 'Unknown',
        postalCode: geo?.postalCode || 'Unknown',
        coordinates: {
          latitude: geo?.latitude || null,
          longitude: geo?.longitude || null,
          accuracy: geo?.latitude && geo?.longitude ? 'IP-based' : null
        }
      },
      engagement: {
        timeOnPage: Math.round((Date.now() - (window.pageLoadTime || Date.now())) / 1000),
        scrollDepth: 0, // Could be enhanced with scroll tracking
        clicks: 0, // Could be enhanced with click tracking
        formInteractions: 0, // Could be enhanced with form tracking
        buttonClicks: 0 // Could be enhanced with button tracking
      },
      userJourney: {
        pageHistory: JSON.parse(localStorage.getItem('eek_user_journey') || '[]'),
        totalPages: JSON.parse(localStorage.getItem('eek_user_journey') || '[]').length || 1,
        sessionDuration: Date.now() - (window.sessionStartTime || Date.now()),
        entryPage: JSON.parse(localStorage.getItem('eek_user_journey') || '[]')[0]?.url || window.location.href,
        previousPage: JSON.parse(localStorage.getItem('eek_user_journey') || '[]').slice(-2, -1)[0]?.url || ''
      },
      visitorData: getVisitorData(),
      journeyData: {
        callAttemptId: localStorage.getItem('eek_last_call_attempt_id') || null,
        callTimestamp: localStorage.getItem('eek_last_call_timestamp') || null,
        returnTimestamp: null, // Will be set if this is a return visit
        timeBetweenCallAndReturn: null, // Will be calculated if this is a return visit
        source: 'booking_form'
      },
      eventType: 'payment_generation',
      eventAction: 'booking_payment_link_created',
      timestamp: new Date().toISOString()
    }
  };

  console.log('üí≥ PAYMENT LINK GENERATION - Starting...');
  console.log('üí≥ Payment API URL:', PAYMENT_API_URL);
  console.log('üí≥ Booking data:', bookingData);

  try{
    const response = await fetch(PAYMENT_API_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(bookingData)
    });
    
    console.log('üí≥ Payment API Response:', response.status, response.statusText);

    if (response.ok){
      const result = await response.json();
      console.log('üí≥ Payment API Result:', result);
      
      if (result.url){
        console.log('‚úÖ Payment link generated successfully:', result.url);
        
        // Clear booking state since payment is being processed
        clearStepCompletionState();
        
        btn.classList.remove('processing');
        btn.style.display='none';
        const successDiv = document.createElement('div');
        successDiv.style.cssText='background:#d4edda;border:2px solid #28a745;padding:20px;border-radius:8px;margin-top:20px;';
        successDiv.innerHTML = `
          <h4 style="color:#155724;margin:0 0 15px 0;">‚úì Payment Link Generated Successfully!</h4>
          <p style="color:#155724;margin:10px 0;">Your secure payment link is ready:</p>
          <a href="${result.url}" class="button" style="background:#28a745;font-size:1.2em;padding:15px 30px;display:inline-block;margin:10px 0;">
            Complete Payment ($${total})
          </a>
          <p style="color:#666;font-size:.9em;margin-top:15px;">After payment, you'll receive an SMS confirmation to ${phone} with your booking details.</p>`;
        btn.parentElement.appendChild(successDiv);
        setTimeout(()=>{ window.location.href = result.url; },3000);
      } else {
        console.error('‚ùå No payment URL in response:', result);
        throw new Error('No payment URL received');
      }
    } else {
      const errorText = await response.text();
      console.error('‚ùå Payment API Error Response:', response.status, errorText);
      throw new Error('Server returned '+response.status + ': ' + errorText);
    }
  }catch(err){
    console.error('Error generating payment link:', err);
    btn.disabled=false;
    btn.classList.remove('processing');
    btn.textContent='Generate Payment Link';
    alert('Unable to generate payment link automatically.\n\nPlease try one of these options:\n1. Refresh the page and try again\n2. Use the Call Now button to contact us');
  }
}
</script>
</body>
</html>
