<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Emergency Mobile Mechanic Services - Eek Mobile Mechanical</title>
  <meta name="description" content="Book emergency mobile mechanic services with Eek Mobile Mechanical. Battery jump start, fuel extraction, mechanical diagnostics. Professional service across New Zealand." />
  <meta name="keywords" content="mobile mechanic, emergency mechanic, battery jump start, wrong fuel removal, mobile mechanic NZ" />
  <meta property="og:title" content="Emergency Mobile Mechanic Services - Eek Mobile Mechanical" />
  <meta property="og:description" content="Book emergency mobile mechanic services with Eek Mobile Mechanical. Battery jump start, fuel extraction, mechanical diagnostics. Professional service across New Zealand." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.eek.nz/book-service" />
  <meta property="og:image" content="https://www.eek.nz/og-image.jpg" />

  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <!-- Load base styles from main site -->
  <link rel="stylesheet" href="/eek-style-guide.css">
  
  <!-- Booking-specific style extensions only -->
  <style>
    /* Fallback CSS variables in case main style doesn't load */
    :root {
      --brand: #ff5500;
      --brand2: #ff7700;
      --purple: #6f42c1;
      --ok: #28a745;
      --muted: #6c757d;
    }
    
    /* Extend base styles for booking form - no duplications */
    .booking-container{max-width:900px;margin:20px auto;background:#fff;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.1);overflow:hidden}
    .booking-header{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:30px;text-align:center}
    .booking-header.winz{background:linear-gradient(135deg,var(--purple),#5a32a3)}
    .booking-header h2{margin:0 0 10px 0;font-size:2em}
    .booking-header p{margin:0;font-size:1.1em;opacity:.95}
    .service-stats{background:rgba(255,255,255,.15);padding:15px;border-radius:8px;margin-top:15px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;text-align:center}
    .stat-item{font-size:.9em}.stat-number{font-size:1.8em;font-weight:700;display:block}

    .progress-bar{display:flex;justify-content:space-between;margin:20px 0;padding:0 20px}
    .progress-step{flex:1;text-align:center;position:relative}
    .progress-step::before{content:'';width:30px;height:30px;border-radius:50%;background:#ddd;display:block;margin:0 auto 8px}
    .progress-step.active::before{background:var(--brand)}
    .progress-step.completed::before{background:var(--ok)}
    .progress-step span{font-size:.9em;color:#666}
    .progress-step.active span{color:var(--brand);font-weight:700}

    .booking-steps{padding:30px}
    .step{display:none;text-align:left}
    .step.active{display:block}
    .step h3{color:var(--brand);margin-bottom:20px;font-size:1.4em}
    .step.winz-step h3{background:#f0f0f0;padding:15px;border-radius:8px;color:#333;font-weight:600}

    .emergency-selector{margin:20px 0}
    .emergency-selector label{font-weight:700;font-size:1.05em;display:block;margin-bottom:15px;color:#333}
    .emergency-selector label .required{color:#ff0000}
    .emergency-option{display:flex;align-items:center;padding:15px;border:2px solid #e0e0e0;border-radius:8px;margin-bottom:10px;cursor:pointer;transition:all .2s;background:#fff}
    .emergency-option:hover{border-color:var(--purple);background:#f9f5ff}
    .emergency-option input[type="radio"]{width:20px;height:20px;margin-right:15px;cursor:pointer}
    .emergency-option.selected{border-color:var(--purple);background:#f9f5ff;border-width:3px}
    .emergency-label{font-size:1.05em;color:#333}

    .location-input,.details-input{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:1.05em;margin-bottom:20px;box-sizing:border-box}
    .location-input:focus,.details-input:focus{border-color:var(--brand);outline:none}
    .details-input{height:120px;resize:vertical}

    .timing-notice{background:#fff3cd;border:2px solid #ffeaa7;border-radius:12px;padding:20px;margin:20px 0;text-align:left}
    .timing-notice h4{margin:0 0 10px 0;color:#856404}
    .timing-notice p{margin:8px 0;color:#856404;line-height:1.5}

    .urgency-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin:20px 0}
    .urgency-option{border:2px solid #ddd;border-radius:12px;padding:20px;cursor:pointer;text-align:center;transition:all .3s;background:#fff}
    .urgency-option:hover{border-color:var(--brand);transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,85,0,.15)}
    .urgency-option.selected{border-color:var(--brand);background:linear-gradient(135deg,#fff5f0,#ffe5d9);border-width:3px}
    .urgency-title{font-weight:700;margin-bottom:8px;font-size:1.1em}
    .urgency-time{color:var(--brand);font-size:.95em;margin-bottom:8px;font-weight:600}
    .urgency-description{font-size:.9em;color:#666;margin-bottom:12px}
    .urgency-price{font-size:1.25em;font-weight:800;color:var(--brand)}
    .urgency-price.calculating{color:var(--muted);font-size:1em}

    .voltage-wrap{background:#f8f9fa;border:2px solid #e9ecef;border-radius:12px;padding:16px;margin:16px 0}
    .voltage-title{font-weight:800;margin-bottom:10px}
    .voltage-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
    .voltage-card{border:2px solid #ddd;border-radius:12px;padding:14px;cursor:pointer;background:#fff;transition:all .2s}
    .voltage-card:hover{border-color:var(--brand);transform:translateY(-1px)}
    .voltage-card.selected{border-color:var(--brand);background:linear-gradient(135deg,#fff5f0,#ffe5d9)}
    .voltage-label{font-weight:700}
    .voltage-price{color:var(--brand);font-weight:800;margin-top:6px}

    .reservation-summary{background:#e8f4f8;border-radius:8px;padding:20px;margin:20px 0}
    .reservation-summary h4{margin:0 0 15px 0}
    .summary-item{display:flex;justify-content:space-between;margin:8px 0;align-items:center}
    .summary-item strong{color:var(--brand)}

    .terms-section{background:#f8f9fa;border-radius:8px;padding:20px;margin:20px 0;text-align:left}
    .terms-checkbox{display:flex;align-items:flex-start;gap:10px;margin:15px 0}
    .terms-checkbox input{margin-top:4px;transform:scale(1.2)}
    .terms-text{font-size:.95em;line-height:1.5}
    .terms-text a{color:var(--brand);text-decoration:none}
    .terms-text a:hover{text-decoration:underline}

    .info-box{background:#fff3cd;border:1px solid #ffeaa7;border-radius:8px;padding:15px;margin:15px 0;text-align:left}
    .info-box h4{margin:0 0 10px 0;color:#856404}
    .info-box ul{margin:0;padding-left:20px;color:#856404}

    .contact-info{margin:15px 0}
    .contact-info label{display:block;margin-bottom:8px;font-weight:700}
    .contact-info input{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:1em;margin-bottom:15px;box-sizing:border-box}
    .contact-info input:focus{border-color:var(--brand);outline:none}

    @media (max-width: 768px) {
      .booking-steps{padding:20px}
      .urgency-options{grid-template-columns:1fr}
      .voltage-grid{grid-template-columns:1fr}
      .stats-grid{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>

<!-- These elements will be populated by master config -->
<div id="closedBanner" class="after-hours-banner" style="display: none;">
  <h2 id="closedTitle"></h2>
  <div id="afterHoursMessage"></div>
  <div id="tempUnavailableMessage" style="display: none;"></div>
</div>

<section id="stripePaymentBlock" style="display: none;">
  <!-- Master config will populate this -->
</section>

<header>
  <!-- Logo will be detected and set by master config -->
  <img id="headerImage" alt="Eek Mobile Mechanical - Mobile Mechanic Services" />
  <div class="business-name">Eek Mobile Mechanical</div>
  <h1 id="headerTitle">Emergency Mobile Mechanic Service</h1>
  <p class="tagline" id="headerSubtitle">Mobile Mechanic ‚Ä¢ Pre Purchase Inspections ‚Ä¢ Wrong Fuel Removal ‚Ä¢ Emergency Roadside Repairs ‚Ä¢ 30‚Äì60 Min Response</p>
  <!-- Phone number will be populated by master config -->
  <a class="cta-button phone-link" href="tel:" data-track="header_call">üìû Call <span class="phone-display"></span></a>
</header>

<div class="breadcrumb">
  <a href="/" data-track="breadcrumb_home">Home</a> > 
  <a href="/more-options" data-track="breadcrumb_more_options">More Options</a> > 
  <span id="breadcrumbText">Emergency Service</span>
</div>

<div class="booking-container">
  <div class="booking-header" id="bookingHeader">
    <h2 id="bookingTitle">Book Your Emergency Service</h2>
    <p id="bookingDescription">Professional mobile mechanic service across New Zealand</p>
    <div class="service-stats">
      <div class="stats-grid" id="statsContent"></div>
    </div>
  </div>

  <div class="progress-bar">
    <div class="progress-step active" id="step1-progress"><span>Details</span></div>
    <div class="progress-step" id="step2-progress"><span id="step2Label">Scheduling</span></div>
    <div class="progress-step" id="step3-progress"><span>Confirm</span></div>
  </div>

  <div class="booking-steps">
    <!-- Step 1: Service Details -->
    <div class="step active" id="step1">
      <h3 id="step1Title">Step 1: Service Details</h3>

      <!-- Emergency type selector for WINZ only -->
      <div id="emergencySelector" class="emergency-selector" style="display:none;">
        <label>1. What is your emergency? <span class="required">*</span></label>
        <div id="emergencyOptions"></div>
      </div>

      <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
        <h4 style="margin:0 0 15px 0;color:#333;">Your Information</h4>
        <div class="contact-info">
          <label for="nameInput">Full Name (required)</label>
          <input type="text" id="nameInput" placeholder="John Smith" required autocomplete="name"/>
          <label for="phoneInput">Phone Number (required)</label>
          <input type="tel" id="phoneInput" placeholder="021 234 5678" required inputmode="tel" autocomplete="tel"/>
          <label for="emailInput">Email Address (required)</label>
          <input type="email" id="emailInput" placeholder="your.email@example.com" required autocomplete="email"/>
        </div>
      </div>

      <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
        <h4 style="margin:0 0 15px 0;color:#333;">Vehicle Information</h4>
        <div class="contact-info">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
            <div>
              <label for="regoInput">Registration Number (required)</label>
              <input type="text" id="regoInput" placeholder="ABC123" style="text-transform:uppercase;" required autocapitalize="characters" spellcheck="false"/>
            </div>
            <div>
              <label for="yearInput">Year (required)</label>
              <input type="text" id="yearInput" placeholder="2018" maxlength="4" required pattern="\\d{4}" inputmode="numeric"/>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
            <div>
              <label for="makeInput">Make (required)</label>
              <input type="text" id="makeInput" placeholder="Toyota" required/>
            </div>
            <div>
              <label for="modelInput">Model (required)</label>
              <input type="text" id="modelInput" placeholder="Corolla" required/>
            </div>
          </div>
        </div>
      </div>

      <!-- Voltage selector (only for jump starts) -->
      <div id="voltageSelector" class="voltage-wrap" style="display:none;">
        <div class="voltage-title">Select battery voltage (required for jump starts)</div>
        <div class="voltage-grid" id="voltageGrid"></div>
      </div>

      <label for="locationInput" style="display:block;margin-bottom:8px;font-weight:700;">Where do you need service?</label>
      <input type="text" class="location-input" id="locationInput" placeholder="Enter your address, suburb, or region" required autocomplete="street-address"/>

      <label for="detailsInput" style="display:block;margin-bottom:8px;margin-top:15px;font-weight:700;" id="detailsLabel">Tell us more about your situation:</label>
      <textarea class="details-input" id="detailsInput" placeholder="Describe the issue or what you need help with..."></textarea>

      <div class="info-box" id="serviceInfoBox"></div>

      <div style="text-align:center;margin:20px 0;">
        <button class="button" id="nextBtn" onclick="goToStep2()">Next: Select Time</button>
      </div>
    </div>

    <!-- Step 2: Scheduling (or Quote for WINZ) -->
    <div class="step" id="step2">
      <h3 id="step2Title">Step 2: When do you need service?</h3>

      <div class="timing-notice" id="timingNotice">
        <h4>‚è∞ Important Timing Information</h4>
        <p><strong>Time windows are approximate arrival times.</strong> As a mobile service, a previous job may run long. We'll text you when your tech is on the way.</p>
      </div>

      <div class="urgency-options" id="urgencyOptions"></div>

      <div style="margin:20px 0;">
        <button class="button secondary" onclick="goToStep1()">Back</button>
        <button class="button" id="confirmTimeBtn" onclick="goToStep3()" disabled>Continue</button>
      </div>
    </div>

    <!-- Step 3: Confirmation -->
    <div class="step" id="step3">
      <h3 id="step3Title">Step 3: Review and confirm</h3>

      <div class="reservation-summary">
        <h4>Your Service Request</h4>
        <div class="summary-item"><span>Service:</span><strong id="summaryService"></strong></div>
        <div class="summary-item" id="summaryEmergencyRow" style="display:none;"><span>Emergency Type:</span><strong id="summaryEmergency"></strong></div>
        <div class="summary-item"><span>Location:</span><strong id="summaryLocation"></strong></div>
        <div class="summary-item"><span>Phone:</span><strong id="summaryPhone"></strong></div>
        <div class="summary-item" id="summaryVoltageRow" style="display:none;"><span>Battery Voltage:</span><strong id="summaryVoltage"></strong></div>
        <div class="summary-item" id="summaryUrgencyRow"><span>Response Time:</span><strong id="summaryUrgency"></strong></div>
        <div class="summary-item" id="summaryPriceRow"><span>Service Fee:</span><strong id="summaryPrice"></strong></div>
      </div>

      <div class="timing-notice" id="nextStepsBox" style="background:#e8f8ff;border-color:#bee5eb;">
        <h4>üì± What happens next?</h4>
        <p>1. Click "Generate Payment Link" to create your secure payment link</p>
        <p>2. Complete payment through Stripe's secure checkout</p>
        <p>3. Receive SMS confirmation with your booking details</p>
        <p>4. Get a notification when your technician is on the way</p>
      </div>

      <div class="terms-section">
        <h4>Terms and Conditions</h4>
        <div class="terms-checkbox">
          <input type="checkbox" id="termsAgree" onchange="toggleBookingButton()" />
          <div class="terms-text">
            I agree to the <a href="/terms" target="_blank" data-track="legal_terms">Eek Mobile Mechanical Terms of Service</a> and understand that:
            <ul style="margin:10px 0;padding-left:20px;" id="termsList"></ul>
          </div>
        </div>
      </div>

      <div style="text-align:center;margin:20px 0;">
        <div style="display:flex;justify-content:center;gap:15px;flex-wrap:wrap;">
          <button class="button secondary" onclick="goToStep2()">Back to Selection</button>
          <button class="button" id="generatePaymentBtn" onclick="generatePaymentLink()" disabled>Generate Payment Link</button>
        </div>
        <p style="margin:15px 0;color:#666;font-size:.9em;" id="paymentNote">Secure payment processing powered by Stripe</p>
      </div>
    </div>
  </div>
</div>

<!-- These will be populated by master config -->
<a id="stripePaymentSticky" class="sticky-payment" href="#" data-track="customer_call">üí≥ Make Payment</a>

<footer>
  &copy; 2025 Eek Mobile Mechanical. All rights reserved. | 
  <a href="/privacy" target="_blank" data-track="footer_privacy">Privacy Policy</a> | 
  <a href="/more-options" data-track="more_options_call">More Options</a>
</footer>

<!-- Phone will be populated by master config -->
<a class="sticky-call phone-link" href="tel:" data-track="sticky_call" id="stickyCallButton">üìû Call <span class="phone-display"></span></a>
<a class="sticky-call" href="#closedBanner" id="stickyClosedButton" data-track="customer_support" style="display: none; background: #666;">üïê View Hours</a>

<!-- Master config handles all shared functionality -->
<script src="/eek-master-config.js"></script>

<!-- Booking-specific JavaScript - focused only on booking logic -->
<script>
console.log('üöÄ Booking form loaded - waiting for master config');

// NZ timezone helpers
const NZ_TZ = 'Pacific/Auckland';
function nowNZ(){
  const parts = new Intl.DateTimeFormat('en-NZ',{
    timeZone:NZ_TZ,hour12:false,year:'numeric',month:'2-digit',day:'2-digit',
    hour:'2-digit',minute:'2-digit',second:'2-digit'
  }).formatToParts(new Date());
  const get=t=>parts.find(p=>p.type===t).value;
  return new Date(`${get('year')}-${get('month')}-${get('day')}T${get('hour')}:${get('minute')}:${get('second')}`);
}
function fmtDateNZ(d){
  return d.toLocaleDateString('en-NZ',{timeZone:NZ_TZ,weekday:'long',year:'numeric',month:'long',day:'numeric'});
}

// Booking status tracking
const BOOKING_STATUS = {
  INITIAL: 'booking_started',
  DETAILS_COMPLETE: 'details_complete',
  TIME_SELECTED: 'time_selected',
  TERMS_ACCEPTED: 'terms_accepted',
  PAYMENT_PENDING: 'payment_pending',
  WINZ_QUOTE_SENT: 'winz_quote_sent'
};

const STATUS_COLORS = {
  'booking_started': '#007bff',
  'details_complete': '#28a745',
  'time_selected': '#fd7e14',
  'terms_accepted': '#6f42c1',
  'payment_pending': '#dc3545',
  'winz_quote_sent': '#20c997'
};

// Service configurations - booking form only manages service logic
const serviceConfigs = {
  'jumpstart': {
    title:'Battery Jump Start Service',
    subtitle:"Dead battery? We'll get you started!",
    breadcrumb:'Battery Jump Start',
    bookingTitle:'Battery Jump Start Service',
    bookingDescription:'Professional jump start service ‚Ä¢ Includes battery health check',
    step1Title:'Step 1: Tell us about your battery situation',
    detailsLabel:'Any additional details about the battery problem:',
    detailsPlaceholder:"e.g., Age of battery, if lights were left on, how long it's been dead, etc.",
    serviceCode:'JUMP',
    basePrice:149,
    voltages: [
      { id:'12v', label:'12V (cars, SUVs, utes)', price:149 },
      { id:'24v', label:'24V (trucks, buses)',   price:229 }
    ],
    stats:[
      {number:'30‚Äì90',text:'min arrival'},
      {number:'Free',text:'battery test'},
      {number:'All',text:'makes & models'},
      {number:'Insured',text:'service'}
    ],
    urgencyOptions:[
      {id:'emergency',title:'Emergency Service',time:'30‚Äì90 minutes arrival',description:'Technician dispatched immediately',hidePrice:true}
    ],
    infoContent:`
      <h4>Our Jump Start Service Includes:</h4>
      <ul>
        <li><strong>Professional jump start</strong> using commercial-grade equipment</li>
        <li><strong>Battery voltage test</strong> to check current condition</li>
        <li><strong>Charging system check</strong> to ensure alternator is working</li>
        <li><strong>Battery terminal cleaning</strong> if needed</li>
        <li><strong>Advice on battery replacement</strong> if required</li>
      </ul>`,
    terms:[
      'Service includes professional jump start and battery health assessment',
      'Price calculated based on your vehicle type',
      'Arrival times are approximate - we will SMS you when the technician is on the way',
      'Payment required via secure Stripe checkout'
    ]
  },
  'mechanic': {
    title:'Mobile Mechanic Diagnostic Service',
    subtitle:"Engine problems? We'll diagnose the issue!",
    breadcrumb:'Mechanic Diagnostic',
    bookingTitle:'Mobile Mechanic Diagnostic Service',
    bookingDescription:'Professional mechanical diagnostic ‚Ä¢ On-site assessment',
    step1Title:'Step 1: Tell us about your mechanical problem',
    detailsLabel:'Describe the symptoms and any issues:',
    detailsPlaceholder:"e.g., Engine won't start, warning lights, strange noises, overheating, etc.",
    serviceCode:'DIAG',
    basePrice:249,
    stats:[
      {number:'30‚Äì90',text:'min arrival'},
      {number:'Full',text:'diagnostic scan'},
      {number:'Expert',text:'assessment'},
      {number:'Written',text:'report'}
    ],
    urgencyOptions:[
      {id:'emergency',title:'Emergency Diagnostic',time:'30‚Äì90 minutes arrival',description:'Immediate dispatch for urgent issues',hidePrice:true},
      {id:'scheduled',title:'Scheduled Service',time:'Within 4 hours',description:'Book for later today',hidePrice:true}
    ],
    infoContent:`
      <h4>Our Diagnostic Service Includes:</h4>
      <ul>
        <li><strong>Professional diagnostic scanning</strong> of all vehicle systems</li>
        <li><strong>Mechanical assessment</strong> to identify problems</li>
        <li><strong>Written report</strong> of findings and recommendations</li>
        <li><strong>Cost estimate</strong> for any required repairs</li>
        <li><strong>Expert advice</strong> on next steps</li>
      </ul>`,
    terms:[
      'Service includes comprehensive diagnostic scanning and assessment',
      'Price calculated based on your requirements',
      'Written report provided with findings',
      'Arrival times are approximate due to the nature of mechanical work'
    ]
  },
  'fuel-extraction': {
    title:'Wrong Fuel Extraction Service',
    subtitle:"Put wrong fuel in? We'll extract it safely!",
    breadcrumb:'Fuel Extraction',
    bookingTitle:'Emergency Fuel Extraction Service',
    bookingDescription:"Professional fuel extraction ‚Ä¢ Don't start the engine!",
    step1Title:'Step 1: Tell us about the fuel situation',
    detailsLabel:'Critical details about what happened:',
    detailsPlaceholder:'e.g., How much wrong fuel, have you started engine, petrol in diesel or vice versa, etc.',
    serviceCode:'FUEL',
    basePrice:399,
    stats:[
      {number:'30‚Äì90',text:'min arrival'},
      {number:'Mobile',text:'extraction first'},
      {number:'100%',text:'insured service'},
      {number:'Complete',text:'system flush'}
    ],
    urgencyOptions:[
      {id:'mobile',title:'Mobile Extraction Service',time:'30‚Äì90 minutes arrival',description:'On-site fuel extraction and system flush',price:399},
      {id:'workshop',title:'Workshop Service',time:'Vehicle collection + workshop completion',description:'Complete workshop extraction with comprehensive system service',price:849}
    ],
    infoContent:`
      <h4>CRITICAL: DO NOT START THE ENGINE</h4>
      <ul>
        <li><strong>Professional extraction</strong> of contaminated fuel</li>
        <li><strong>Complete system flush</strong> to remove all traces</li>
        <li><strong>Fresh fuel replacement</strong> with correct fuel type</li>
        <li><strong>System testing</strong> to ensure safe operation</li>
        <li><strong>Fully insured service</strong> for your protection</li>
        <li><strong>Professional assessment</strong> will determine the best approach for your situation</li>
      </ul>`,
    terms:{
      mobile:[
        'In some cases, transfer to workshop may be necessary. Towing costs not included in service price. Additional fees may apply.'
      ],
      workshop:[
        'Towing costs not included in service price',
        'Additional fees may apply for complex extraction requirements'
      ]
    }
  },
  'winz': {
    title:'WINZ Vehicle Repair Quote',
    subtitle:'Get an instant quote for Work and Income assistance',
    breadcrumb:'WINZ Quote',
    bookingTitle:'WINZ Vehicle Repair Quote',
    bookingDescription:'Approved WINZ supplier ‚Ä¢ Instant quotes for vehicle repairs',
    step1Title:'Start Here.',
    step2Title:'Step 2: Generate Your WINZ Quote',
    detailsLabel:'2. Describe the problem in detail:',
    detailsPlaceholder:'Please provide as much detail as possible about the issue...',
    serviceCode:'WINZ',
    basePrice:0,
    hidePrice:true,
    isWinz:true,
    stats:[
      {number:'WINZ',text:'approved supplier'},
      {number:'Instant',text:'quote generation'},
      {number:'Up to $400',text:'assistance available'},
      {number:'1-2 days',text:'approval time'}
    ],
    emergencyTypes: [
      {id:'battery',label:'Flat Battery',description:'Battery won\'t start, needs jump start or replacement'},
      {id:'mechanical',label:'Mechanical Breakdown',description:'Engine problems, won\'t start, warning lights'},
      {id:'misfuel',label:'Misfuel',description:'Wrong fuel in tank (petrol in diesel or vice versa)'}
    ],
    urgencyOptions:[
      {id:'standard',title:'WINZ Quote Generation',time:'Instant digital quote',description:'Submit to Work and Income for approval',hidePrice:true}
    ],
    infoContent:`
      <h4>How This Works:</h4>
      <ul>
        <li><strong>Select your emergency type</strong> from the options above</li>
        <li><strong>Provide vehicle and contact details</strong></li>
        <li><strong>Describe the problem</strong> in as much detail as possible</li>
        <li><strong>Receive instant quote</strong> to submit to WINZ</li>
        <li><strong>Take quote to WINZ</strong> or upload to MyMSD</li>
      </ul>`,
    terms:[
      'Quote valid for 30 days from generation',
      'Subject to WINZ approval and eligibility criteria',
      'Service provided after WINZ approval confirmed',
      'Mobile service - we come to your location'
    ]
  }
};

// API URLs - booking specific
const POWER_AUTOMATE_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/dbc93a177083499caf5a06eeac87683c/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=vXidGdo8qErY4QVv03JeNaGbA79eWEoiOxuDocljL6Q';
const PRICING_API_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/2f31c90260554c5a9d6dcffec47bc6c2/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Ou7iqzZ1YI2PzT_9X-M6PT5iVo2QRboWnFZrO3IBOL4';
const WINZ_API_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/95fc801df59b4250a48919ace91c0276/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=mFpTX4gPrz1u1DbdfF3YqHBnAsW3pnAAj-GWXWvBYYc';

// Global state - booking specific only
let selectedUrgency = null;
let selectedUrgencyDetails = {};
let selectedVoltageId = null;
let selectedVoltagePrice = null;
let selectedEmergencyType = null;
let calculatedPrice = null;

// Helpers
function sanitizePhone(val){ return (val || '').replace(/\D/g,''); }
function sanitizeRego(val){ return (val || '').toUpperCase().replace(/[^A-Z0-9]/g,''); }
function sanitizeText(val){ return (val || '').trim().replace(/\s+/g,' '); }

function buildBookingData(status) {
  const urlParams = new URLSearchParams(window.location.search);
  
  return {
    sessionId: window.sessionId || localStorage.getItem("eek_session_id"),
    bookingStatus: status,
    statusColor: STATUS_COLORS[status] || '#6c757d',
    timestamp: new Date().toISOString(),
    
    name: sanitizeText(document.getElementById('nameInput').value),
    phone: sanitizePhone(document.getElementById('phoneInput').value),
    email: document.getElementById('emailInput').value.trim(),
    location: sanitizeText(document.getElementById('locationInput').value),
    details: document.getElementById('detailsInput').value || '',
    
    rego: sanitizeRego(document.getElementById('regoInput').value),
    vehicleRego: sanitizeRego(document.getElementById('regoInput').value),
    year: document.getElementById('yearInput').value.trim(),
    make: sanitizeText(document.getElementById('makeInput').value),
    model: sanitizeText(document.getElementById('modelInput').value),
    vehicleType: selectedVoltageId === '24v' ? 'truck' : 'car',
    
    service: window.currentService,
    serviceCode: window.currentConfig.serviceCode,
    serviceTitle: window.currentConfig.title,
    
    source: 'booking_form',
    formVersion: '2.2',
    
    // Use master config's stored UTM data
    gclid: localStorage.getItem("eek_gclid") || urlParams.get('gclid') || null,
    utm: {
      source: localStorage.getItem("eek_utm_source") || null,
      medium: localStorage.getItem("eek_utm_medium") || null,
      campaign: localStorage.getItem("eek_utm_campaign") || null,
      term: localStorage.getItem("eek_utm_term") || null,
      content: localStorage.getItem("eek_utm_content") || null
    },

    // Booking specific fields
    ...(status === BOOKING_STATUS.TIME_SELECTED && {
      selectedTime: selectedUrgencyDetails.time || '',
      selectedUrgency: selectedUrgency,
      calculatedPrice: calculatedPrice || window.currentConfig.basePrice,
      finalPrice: getTotalPrice()
    }),

    // WINZ specific fields
    ...(window.currentConfig?.isWinz && selectedEmergencyType && {
      emergencyType: selectedEmergencyType,
      quoteAmount: calculatedPrice || getTotalPrice(),
      quoteReference: window.winzQuoteReference
    }),

    // Jumpstart specific
    ...(window.currentService === 'jumpstart' && selectedVoltageId && {
      selectedVoltage: selectedVoltageId,
      batteryVoltage: selectedVoltageId === '12v' ? '12V' : '24V'
    })
  };
}

async function sendBookingUpdate(status) {
  const data = buildBookingData(status);
  console.log(`üì° Booking ${status}:`, data);
  
  try {
    const response = await fetch(PRICING_API_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    console.log(`‚úÖ API Response: ${response.status}`);
    return response;
  } catch (err) {
    console.error(`‚ùå Error:`, err);
  }
}

// Initialize when master config is ready
document.addEventListener('DOMContentLoaded', function(){
  const urlParams = new URLSearchParams(window.location.search);
  const service = urlParams.get('service') || 'jumpstart';
  const sessionId = urlParams.get('session_id');
  
  console.log('üìå Service:', service);
  
  // Handle session ID
  if (sessionId) {
    window.sessionId = sessionId;
    localStorage.setItem("eek_session_id", sessionId);
  } else {
    window.sessionId = localStorage.getItem("eek_session_id") || `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    localStorage.setItem("eek_session_id", window.sessionId);
  }
  
  // Redirect inspection to dedicated page
  if (service === 'inspection') {
    window.location.href = `https://eek.nz/pre-purchase-vehicle-inspection/${window.location.search}`;
    return;
  }
  
  // Wait for master config, then initialize
  const initBooking = () => {
    if (typeof window.masterConfigLoaded !== 'undefined' && window.masterConfigLoaded) {
      console.log('‚úÖ Master config ready, initializing booking');
      loadServiceConfig(service);
      sendBookingUpdate(BOOKING_STATUS.INITIAL);
    } else {
      setTimeout(initBooking, 50);
    }
  };
  
  initBooking();
});

function loadServiceConfig(serviceType){
  const config = serviceConfigs[serviceType] || serviceConfigs['jumpstart'];
  
  console.log('‚öôÔ∏è Loading service:', config.title);

  // Update page content
  document.title = `${config.title} - Eek Mobile Mechanical`;
  document.getElementById('headerTitle').textContent = config.title;
  document.getElementById('headerSubtitle').textContent = config.subtitle;
  document.getElementById('breadcrumbText').textContent = config.breadcrumb;
  document.getElementById('bookingTitle').textContent = config.bookingTitle;
  document.getElementById('bookingDescription').textContent = config.bookingDescription;
  document.getElementById('step1Title').textContent = config.step1Title;
  document.getElementById('detailsLabel').textContent = config.detailsLabel;
  document.getElementById('detailsInput').placeholder = config.detailsPlaceholder;
  document.getElementById('serviceInfoBox').innerHTML = config.infoContent;

  // Handle WINZ styling
  const bookingHeader = document.getElementById('bookingHeader');
  if (config.isWinz) {
    bookingHeader.classList.add('winz');
    document.getElementById('step1').classList.add('winz-step');
    document.getElementById('nextBtn').textContent = 'Get Quote';
    document.getElementById('step2Label').textContent = 'Quote';
  } else {
    bookingHeader.classList.remove('winz');
    document.getElementById('step1').classList.remove('winz-step');
    document.getElementById('nextBtn').textContent = 'Next: Select Time';
    document.getElementById('step2Label').textContent = 'Scheduling';
  }

  // Populate stats
  document.getElementById('statsContent').innerHTML = config.stats.map(stat =>
    `<div class="stat-item"><span class="stat-number">${stat.number}</span>${stat.text}</div>`
  ).join('');

  // Handle emergency types for WINZ
  const emergencySelector = document.getElementById('emergencySelector');
  if (config.isWinz && config.emergencyTypes) {
    emergencySelector.style.display = 'block';
    document.getElementById('emergencyOptions').innerHTML = config.emergencyTypes.map(e => `
      <div class="emergency-option" onclick="selectEmergencyType('${e.id}', this)">
        <input type="radio" name="emergencyType" value="${e.id}" id="emergency_${e.id}">
        <label for="emergency_${e.id}" class="emergency-label">${e.label}</label>
      </div>
    `).join('');
  } else {
    emergencySelector.style.display = 'none';
  }

  // Handle voltage selection for jumpstart
  const voltageSelector = document.getElementById('voltageSelector');
  if (config.voltages && !config.isWinz) {
    voltageSelector.style.display = 'block';
    document.getElementById('voltageGrid').innerHTML = config.voltages.map(v => `
      <div class="voltage-card" data-id="${v.id}" onclick="selectVoltage('${v.id}', ${v.price}, this)">
        <div class="voltage-label">${v.label}</div>
        <div class="voltage-price">Calculating...</div>
      </div>
    `).join('');
  } else {
    voltageSelector.style.display = 'none';
  }

  // Handle terms
  const termsList = document.getElementById('termsList');
  if (config.terms && Array.isArray(config.terms)) {
    termsList.innerHTML = config.terms.map(term => `<li>${term}</li>`).join('');
  } else {
    termsList.innerHTML = '';
  }

  // Reset state
  selectedVoltageId = null;
  selectedEmergencyType = null;
  selectedUrgency = null;
  selectedUrgencyDetails = {};
  calculatedPrice = null;

  window.currentService = serviceType;
  window.currentConfig = config;
}

function selectEmergencyType(id, el){
  document.querySelectorAll('.emergency-option').forEach(x=>x.classList.remove('selected'));
  el.classList.add('selected');
  el.querySelector('input[type="radio"]').checked = true;
  selectedEmergencyType = id;
}

function selectVoltage(id, price, el){
  document.querySelectorAll('.voltage-card.selected').forEach(x=>x.classList.remove('selected'));
  el.classList.add('selected');
  selectedVoltageId = id;
  selectedVoltagePrice = price;
}

function goToStep1(){
  document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
  document.getElementById('step1').classList.add('active');
  document.querySelectorAll('.progress-step').forEach(el => el.classList.remove('active','completed'));
  document.getElementById('step1-progress').classList.add('active');
}

async function goToStep2(){
  console.log('üìù Step 1 ‚Üí 2');
  
  // Validate all required fields
  const name = document.getElementById('nameInput').value.trim();
  const phone = document.getElementById('phoneInput').value.trim();
  const email = document.getElementById('emailInput').value.trim();
  const location = document.getElementById('locationInput').value.trim();
  const rego = sanitizeRego(document.getElementById('regoInput').value);
  const year = document.getElementById('yearInput').value.trim();
  const make = document.getElementById('makeInput').value.trim();
  const model = document.getElementById('modelInput').value.trim();

  const phoneRegex = /^[\d\s\-\+\(\)]+$/;
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  if (!name) { alert('Please enter your full name'); document.getElementById('nameInput').focus(); return; }
  if (!phone || !phoneRegex.test(phone) || phone.replace(/\D/g,'').length < 9) { 
    alert('Please enter a valid phone number'); document.getElementById('phoneInput').focus(); return; 
  }
  if (!email || !emailRegex.test(email)) { 
    alert('Please enter a valid email address'); document.getElementById('emailInput').focus(); return; 
  }
  if (!location) { alert('Please enter the service location'); document.getElementById('locationInput').focus(); return; }
  if (!rego) { alert('Please enter the vehicle registration'); document.getElementById('regoInput').focus(); return; }
  if (year.length !== 4) { alert('Please enter a 4-digit vehicle year'); document.getElementById('yearInput').focus(); return; }
  if (!make) { alert('Please enter the vehicle make'); document.getElementById('makeInput').focus(); return; }
  if (!model) { alert('Please enter the vehicle model'); document.getElementById('modelInput').focus(); return; }

  // Service specific validation
  if (window.currentConfig.isWinz) {
    if (!selectedEmergencyType) { alert('Please select an emergency type'); return; }
    if (!document.getElementById('detailsInput').value.trim()) { 
      alert('Please describe the problem in detail'); 
      document.getElementById('detailsInput').focus(); 
      return; 
    }
  }
  
  // Voltage selection required for jumpstart
  if (window.currentService === 'jumpstart' && !window.currentConfig.isWinz && !selectedVoltageId) {
    alert('Please select your battery voltage (12V or 24V)');
    return;
  }

  // Get pricing for non-WINZ services
  if (!window.currentConfig.isWinz) {
    const btn = document.getElementById('nextBtn');
    btn.disabled = true;
    btn.textContent = 'Calculating price...';
    
    try {
      const response = await sendBookingUpdate(BOOKING_STATUS.DETAILS_COMPLETE);
      
      if (response?.ok) {
        const responseText = await response.text();
        if (responseText) {
          try {
            const result = JSON.parse(responseText);
            calculatedPrice = result.price || window.currentConfig.basePrice;
          } catch (e) {
            calculatedPrice = window.currentConfig.basePrice;
          }
        } else {
          calculatedPrice = window.currentConfig.basePrice;
        }
        
        // Update voltage prices if jumpstart
        if (window.currentService === 'jumpstart') {
          document.querySelectorAll('.voltage-card').forEach(card => {
            const isV24 = card.dataset.id === '24v';
            const price = isV24 ? Math.round(calculatedPrice * 1.5) : calculatedPrice;
            card.querySelector('.voltage-price').textContent = `$${price}`;
            if (card.dataset.id === selectedVoltageId) {
              selectedVoltagePrice = price;
            }
          });
        }
      }
    } catch (err) {
      console.error('Pricing error:', err);
      calculatedPrice = window.currentConfig.basePrice;
    } finally {
      btn.disabled = false;
      btn.textContent = 'Next: Select Time';
    }
  }

  // Move to step 2
  document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
  document.getElementById('step2').classList.add('active');
  document.getElementById('step1-progress').classList.add('completed');
  document.getElementById('step1-progress').classList.remove('active');
  document.getElementById('step2-progress').classList.add('active');

  // Setup step 2 content
  if (window.currentConfig.isWinz) {
    document.getElementById('step2Title').textContent = 'Step 2: Generate Your WINZ Quote';
    document.getElementById('timingNotice').style.display = 'none';
    document.getElementById('confirmTimeBtn').textContent = 'Generate Quote';
  } else {
    document.getElementById('step2Title').textContent = 'Step 2: When do you need service?';
    document.getElementById('confirmTimeBtn').textContent = 'Continue';
  }

  // Setup urgency options
  const urgencyContainer = document.getElementById('urgencyOptions');
  urgencyContainer.innerHTML = window.currentConfig.urgencyOptions.map(o => {
    const displayPrice = window.currentService === 'fuel-extraction' ? 
      o.price : (calculatedPrice || window.currentConfig.basePrice);
    
    const priceHtml = (o.hidePrice || window.currentConfig.hidePrice) ? 
      '<div class="urgency-price calculating">Price in quote</div>' :
      `<div class="urgency-price">$${displayPrice}</div>`;
    
    const titleText = window.currentService === 'fuel-extraction' ? 
      `${o.title} - $${o.price}` : o.title;
    
    return `
      <div class="urgency-option" onclick="selectUrgency('${o.id}','${o.title}','${o.time}',${o.price || displayPrice},this)">
        <div class="urgency-title">${titleText}</div>
        <div class="urgency-time">${o.time}</div>
        <div class="urgency-description">${o.description}</div>
        ${priceHtml}
      </div>`;
  }).join('');

  // Auto-select single option
  if (window.currentConfig.urgencyOptions.length === 1) {
    const firstOption = window.currentConfig.urgencyOptions[0];
    selectUrgency(firstOption.id, firstOption.title, firstOption.time, 
      calculatedPrice || firstOption.price || 0, 
      urgencyContainer.querySelector('.urgency-option'));
  }
}

function selectUrgency(id, title, time, price, el){
  document.querySelectorAll('.urgency-option.selected').forEach(x => x.classList.remove('selected'));
  el.classList.add('selected');
  selectedUrgency = id;
  selectedUrgencyDetails = { title, time, price: calculatedPrice || price };
  
  // Update terms for fuel-extraction
  if (window.currentService === 'fuel-extraction' && window.currentConfig.terms && !Array.isArray(window.currentConfig.terms)) {
    const termsList = document.getElementById('termsList');
    const termsForSelection = window.currentConfig.terms[id] || [];
    termsList.innerHTML = termsForSelection.map(term => `<li>${term}</li>`).join('');
  }
  
  document.getElementById('confirmTimeBtn').disabled = false;
}

async function goToStep3(){
  console.log('‚è∞ Step 2 ‚Üí 3');
  
  if (!selectedUrgency) {
    alert('Please select a service time');
    return;
  }

  await sendBookingUpdate(BOOKING_STATUS.TIME_SELECTED);

  // Calculate WINZ pricing
  if (window.currentConfig.isWinz) {
    const prices = { battery: 149, mechanical: 249, misfuel: 849 };
    calculatedPrice = prices[selectedEmergencyType] || 299;
    
    if (!window.winzQuoteReference) {
      window.winzQuoteReference = `WINZ-${Date.now()}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
    }
  }

  // Move to step 3
  document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
  document.getElementById('step3').classList.add('active');
  document.getElementById('step2-progress').classList.add('completed');
  document.getElementById('step2-progress').classList.remove('active');
  document.getElementById('step3-progress').classList.add('active');

  updateSummary();
}

function getTotalPrice(){
  if (window.currentConfig.isWinz) return calculatedPrice || 0;
  if (window.currentService === 'jumpstart' && selectedVoltagePrice) return selectedVoltagePrice;
  if (window.currentService === 'fuel-extraction' && selectedUrgency) {
    const option = window.currentConfig.urgencyOptions.find(opt => opt.id === selectedUrgency);
    return option ? option.price : window.currentConfig.basePrice;
  }
  return calculatedPrice || selectedUrgencyDetails.price || window.currentConfig.basePrice;
}

function updateSummary(){
  document.getElementById('summaryService').textContent = window.currentConfig.title;
  document.getElementById('summaryLocation').textContent = document.getElementById('locationInput').value;
  document.getElementById('summaryPhone').textContent = sanitizePhone(document.getElementById('phoneInput').value);
  
  // Emergency type for WINZ
  if (window.currentConfig.isWinz && selectedEmergencyType) {
    document.getElementById('summaryEmergencyRow').style.display = '';
    const emergencyLabel = window.currentConfig.emergencyTypes.find(e => e.id === selectedEmergencyType)?.label || '';
    document.getElementById('summaryEmergency').textContent = emergencyLabel;
  } else {
    document.getElementById('summaryEmergencyRow').style.display = 'none';
  }

  // Voltage for jumpstart
  if (window.currentService === 'jumpstart' && selectedVoltageId && !window.currentConfig.isWinz) {
    document.getElementById('summaryVoltageRow').style.display = '';
    document.getElementById('summaryVoltage').textContent = selectedVoltageId === '12v' ? '12V' : '24V';
  } else {
    document.getElementById('summaryVoltageRow').style.display = 'none';
  }

  // Update display based on service type
  if (window.currentConfig.isWinz) {
    document.getElementById('summaryUrgencyRow').style.display = 'none';
    document.getElementById('summaryPrice').textContent = `$${getTotalPrice()} (quote for WINZ)`;
    
    document.getElementById('nextStepsBox').innerHTML = `
      <h4>üìã Your WINZ Quote is Ready!</h4>
      <p><strong>Quote Amount: $${getTotalPrice()}</strong></p>
      ${window.winzQuoteReference ? `<p>Quote Reference: ${window.winzQuoteReference}</p>` : ''}
      <p>1. Download or print your quote</p>
      <p>2. Take it to your local WINZ office or upload to MyMSD</p>
      <p>3. WINZ will process within 1-2 business days</p>
      <p>4. Once approved, we'll contact you to arrange service</p>
    `;
    
    document.getElementById('generatePaymentBtn').textContent = 'Download WINZ Quote';
    document.getElementById('paymentNote').textContent = 'Quote will be emailed and available for download';
  } else {
    document.getElementById('summaryUrgencyRow').style.display = '';
    document.getElementById('summaryUrgency').textContent = selectedUrgencyDetails.time || '';
    document.getElementById('summaryPrice').textContent = `$${getTotalPrice()}`;
  }
}

function toggleBookingButton(){
  document.getElementById('generatePaymentBtn').disabled = !document.getElementById('termsAgree').checked;
}

function buildRedirectUrl(){
  const baseUrl = 'https://www.eek.nz/thanks';
  const params = new URLSearchParams();
  const urlParams = new URLSearchParams(window.location.search);

  // Basic customer data
  params.append('name', sanitizeText(document.getElementById('nameInput').value));
  params.append('phone', sanitizePhone(document.getElementById('phoneInput').value));
  params.append('email', document.getElementById('emailInput').value.trim());
  params.append('location', sanitizeText(document.getElementById('locationInput').value));
  params.append('rego', sanitizeRego(document.getElementById('regoInput').value));
  params.append('year', document.getElementById('yearInput').value.trim());
  params.append('make', sanitizeText(document.getElementById('makeInput').value));
  params.append('model', sanitizeText(document.getElementById('modelInput').value));
  
  // Service data
  params.append('service', window.currentService);
  params.append('serviceCode', window.currentConfig.serviceCode);
  params.append('serviceTitle', window.currentConfig.title);
  params.append('price', getTotalPrice());
  params.append('details', document.getElementById('detailsInput').value || '');
  params.append('scheduledDate', fmtDateNZ(nowNZ()));
  params.append('timeWindow', selectedUrgencyDetails.time || '');
  params.append('urgencyLevel', selectedUrgency || '');
  params.append('bookingTime', new Date().toISOString());
  
  // Tracking data from master config
  const gclid = localStorage.getItem("eek_gclid") || urlParams.get('gclid');
  if (gclid) params.append('gclid', gclid);
  if (window.sessionId) params.append('session_id', window.sessionId);
  
  // Service specific data
  if (window.currentConfig.isWinz) {
    params.append('emergencyType', selectedEmergencyType || '');
    if (window.winzQuoteReference) params.append('quoteReference', window.winzQuoteReference);
  }
  
  if (window.currentService === 'jumpstart' && !window.currentConfig.isWinz) {
    params.append('batteryVoltage', selectedVoltageId || '');
  }

  return `${baseUrl}?${params.toString()}`;
}

async function generatePaymentLink(){
  if (!document.getElementById('termsAgree').checked) {
    alert('Please accept the terms and conditions');
    return;
  }

  const btn = document.getElementById('generatePaymentBtn');
  btn.disabled = true;
  btn.classList.add('processing');
  
  await sendBookingUpdate(BOOKING_STATUS.TERMS_ACCEPTED);
  
  // Handle WINZ quote generation
  if (window.currentConfig.isWinz) {
    btn.textContent = 'Generating Quote';
    
    try {
      await sendBookingUpdate(BOOKING_STATUS.WINZ_QUOTE_SENT);
      
      // Send to dedicated WINZ endpoint
      await fetch(WINZ_API_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(buildBookingData(BOOKING_STATUS.WINZ_QUOTE_SENT))
      });
      
    } catch (err) {
      console.error('WINZ quote error:', err);
    }
    
    btn.textContent = 'Preparing Quote';
    setTimeout(() => { window.location.href = buildRedirectUrl(); }, 1500);
    return;
  }
  
  // Handle regular payment generation
  await sendBookingUpdate(BOOKING_STATUS.PAYMENT_PENDING);
  btn.textContent = 'Generating Link';

  const total = getTotalPrice();
  const vehicleDescription = [
    sanitizeRego(document.getElementById('regoInput').value),
    document.getElementById('yearInput').value.trim(),
    sanitizeText(document.getElementById('makeInput').value),
    sanitizeText(document.getElementById('modelInput').value)
  ].filter(Boolean).join(' ') || 'Vehicle details not provided';

  const bookingData = {
    rego: sanitizeRego(document.getElementById('regoInput').value) || 'Not provided',
    amount: total * 100,
    currency: 'NZD',
    description: `${window.currentConfig.title} - ${vehicleDescription} - ${document.getElementById('locationInput').value}`,
    redirectUrl: buildRedirectUrl(),
    customerData: {
      name: sanitizeText(document.getElementById('nameInput').value),
      phone: sanitizePhone(document.getElementById('phoneInput').value),
      email: document.getElementById('emailInput').value.trim(),
      location: sanitizeText(document.getElementById('locationInput').value),
      vehicleRego: sanitizeRego(document.getElementById('regoInput').value),
      vehicleYear: document.getElementById('yearInput').value.trim(),
      vehicleMake: sanitizeText(document.getElementById('makeInput').value),
      vehicleModel: sanitizeText(document.getElementById('modelInput').value),
      vehicleDescription,
      service: window.currentService,
      serviceCode: window.currentConfig.serviceCode,
      serviceTitle: window.currentConfig.title,
      details: document.getElementById('detailsInput').value || 'No additional details provided',
      price: `${total}`,
      bookingDateTime: nowNZ().toLocaleString('en-NZ', { timeZone: NZ_TZ }),
      scheduledDate: fmtDateNZ(nowNZ()),
      scheduledTime: selectedUrgencyDetails.time || '',
      urgencyLevel: selectedUrgency || 'emergency',
      gclid: localStorage.getItem("eek_gclid"),
      sessionId: window.sessionId,
      ...(window.currentService === 'jumpstart' ? { 
        batteryVoltage: selectedVoltageId === '12v' ? '12V' : '24V' 
      } : {})
    }
  };

  try {
    const response = await fetch(POWER_AUTOMATE_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(bookingData)
    });

    if (response.ok) {
      const result = await response.json();
      if (result.url) {
        btn.classList.remove('processing');
        btn.style.display = 'none';
        
        const successDiv = document.createElement('div');
        successDiv.style.cssText = 'background:#d4edda;border:2px solid #28a745;padding:20px;border-radius:8px;margin-top:20px;';
        successDiv.innerHTML = `
          <h4 style="color:#155724;margin:0 0 15px 0;">‚úì Payment Link Generated Successfully!</h4>
          <p style="color:#155724;margin:10px 0;">Your secure payment link is ready:</p>
          <a href="${result.url}" class="button" style="background:#28a745;font-size:1.2em;padding:15px 30px;display:inline-block;margin:10px 0;">
            Complete Payment ($${total})
          </a>
          <p style="color:#666;font-size:.9em;margin-top:15px;">After payment, you'll receive an SMS confirmation with your booking details.</p>`;
        btn.parentElement.appendChild(successDiv);
        
        setTimeout(() => { window.location.href = result.url; }, 3000);
      } else {
        throw new Error('No payment URL received');
      }
    } else {
      throw new Error('Server returned ' + response.status);
    }
  } catch (err) {
    console.error('Payment link error:', err);
    btn.disabled = false;
    btn.classList.remove('processing');
    btn.textContent = 'Generate Payment Link';
    alert('Unable to generate payment link automatically.\n\nPlease call us at 0800 769 000 or try refreshing the page.');
  }
}
</script>

</body>
</html>
