<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Don't Buy a Lemon! Pre Purchase Vehicle Inspection - Eek Mobile Mechanical</title>
  <meta name="description" content="Book a comprehensive 45-point pre-purchase vehicle inspection. Mobile service anywhere in New Zealand. Don't buy a lemon! 20% of vehicles we inspect are rejected." />
  <meta name="keywords" content="pre purchase inspection, vehicle inspection, mobile mechanic, car inspection NZ, don't buy a lemon" />
  <meta property="og:title" content="Don't Buy a Lemon! Pre Purchase Vehicle Inspection - Eek Mobile Mechanical" />
  <meta property="og:description" content="Book a comprehensive 45-point pre-purchase vehicle inspection. Mobile service anywhere in New Zealand. Don't buy a lemon! 20% of vehicles we inspect are rejected." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.eek.nz/pre-purchase-vehicle-inspection" />
  <meta property="og:image" content="https://www.eek.nz/lemon.png" />

  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <!-- Load base styles from main site -->
  <link rel="stylesheet" href="/eek-style-guide.css">
  
  <!-- Inspection-specific style extensions only -->
  <style>
    /* Fallback CSS variables in case main style doesn't load */
    :root {
      --brand: #ff5500;
      --brand2: #ff7700;
      --purple: #6f42c1;
      --ok: #28a745;
      --muted: #6c757d;
    }
    
    /* Extend base styles for inspection form - no duplications */
    .booking-container{max-width:900px;margin:20px auto;background:#fff;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.1);overflow:hidden}
    .booking-header{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:30px;text-align:center}
    .booking-header h2{margin:0 0 10px 0;font-size:2em}
    .booking-header p{margin:0;font-size:1.1em;opacity:.95}
    .service-stats{background:rgba(255,255,255,.15);padding:15px;border-radius:8px;margin-top:15px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;text-align:center}
    .stat-item{font-size:.9em}.stat-number{font-size:1.8em;font-weight:700;display:block}

    .progress-bar{display:flex;justify-content:space-between;margin:20px 0;padding:0 20px}
    .progress-step{flex:1;text-align:center;position:relative}
    .progress-step::before{content:'';width:30px;height:30px;border-radius:50%;background:#ddd;display:block;margin:0 auto 8px}
    .progress-step.active::before{background:var(--brand)}
    .progress-step.completed::before{background:var(--ok)}
    .progress-step span{font-size:.9em;color:#666}
    .progress-step.active span{color:var(--brand);font-weight:700}

    .booking-steps{padding:30px}
    .step{display:none;text-align:left}
    .step.active{display:block}
    .step h3{color:var(--brand);margin-bottom:20px;font-size:1.4em}

    .location-input,.details-input{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:1.05em;margin-bottom:20px;box-sizing:border-box}
    .location-input:focus,.details-input:focus{border-color:var(--brand);outline:none}
    .details-input{height:120px;resize:vertical}

    .timing-notice{background:#fff3cd;border:2px solid #ffeaa7;border-radius:12px;padding:20px;margin:20px 0;text-align:left}
    .timing-notice h4{margin:0 0 10px 0;color:#856404}
    .timing-notice p{margin:8px 0;color:#856404;line-height:1.5}

    .urgency-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin:20px 0}
    .urgency-option{border:2px solid #ddd;border-radius:12px;padding:20px;cursor:pointer;text-align:center;transition:all .3s;background:#fff}
    .urgency-option:hover{border-color:var(--brand);transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,85,0,.15)}
    .urgency-option.selected{border-color:var(--brand);background:linear-gradient(135deg,#fff5f0,#ffe5d9);border-width:3px}
    .urgency-title{font-weight:700;margin-bottom:8px;font-size:1.1em}
    .urgency-time{color:var(--brand);font-size:.95em;margin-bottom:8px;font-weight:600}
    .urgency-description{font-size:.9em;color:#666;margin-bottom:12px}
    .urgency-price{font-size:1.25em;font-weight:800;color:var(--brand)}
    .urgency-price.calculating{color:var(--muted);font-size:1em}

    .vehicle-types{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin:20px 0}
    .vehicle-type{border:2px solid #ddd;border-radius:12px;padding:20px;cursor:pointer;text-align:center;transition:all .3s;background:#fff}
    .vehicle-type:hover{border-color:var(--brand);transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,85,0,.15)}
    .vehicle-type.selected{border-color:var(--brand);background:linear-gradient(135deg,#fff5f0,#ffe5d9);border-width:3px}
    .vehicle-type.popular{border-color:var(--ok);background:linear-gradient(135deg,#f0fff4,#e8ffed)}
    .vehicle-type.popular.selected{border-color:var(--ok);background:linear-gradient(135deg,#e8ffed,#d4f8da)}
    .vehicle-type-title{font-weight:700;margin-bottom:8px;font-size:1.1em}
    .vehicle-type-subtitle{color:#666;font-size:.95em;margin-bottom:8px}
    .vehicle-type-price{color:var(--brand);font-weight:800;margin-top:8px;font-size:1.1em}
    .vehicle-type.popular .vehicle-type-price{color:var(--ok)}

    .reservation-summary{background:#e8f4f8;border-radius:8px;padding:20px;margin:20px 0}
    .reservation-summary h4{margin:0 0 15px 0}
    .summary-item{display:flex;justify-content:space-between;margin:8px 0;align-items:center}
    .summary-item strong{color:var(--brand)}

    .terms-section{background:#f8f9fa;border-radius:8px;padding:20px;margin:20px 0;text-align:left}
    .terms-checkbox{display:flex;align-items:flex-start;gap:10px;margin:15px 0}
    .terms-checkbox input{margin-top:4px;transform:scale(1.2)}
    .terms-text{font-size:.95em;line-height:1.5}
    .terms-text a{color:var(--brand);text-decoration:none}
    .terms-text a:hover{text-decoration:underline}

    .info-box{background:linear-gradient(135deg,#fff9e6,#fff3cd);border:2px solid #ffd700;border-radius:12px;padding:20px;margin:20px 0;text-align:left;position:relative;box-shadow:0 2px 8px rgba(255,193,7,.15);min-height:0}
    .info-box:empty{display:none}
    .info-box::before{content:'üí°';position:absolute;top:-10px;left:20px;background:#ffd700;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:14px}
    .info-box h4{margin:0 0 15px 0;color:#b8860b;font-size:1.2em;font-weight:700}
    .info-box ul{margin:10px 0;padding-left:20px;color:#b8860b;line-height:1.6}
    .info-box li{margin:8px 0}

    .contact-info{margin:15px 0}
    .contact-info label{display:block;margin-bottom:8px;font-weight:700}
    .contact-info input{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:1em;margin-bottom:15px;box-sizing:border-box}
    .contact-info input:focus{border-color:var(--brand);outline:none}

    .button{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:14px 28px;border:none;border-radius:10px;cursor:pointer;font-size:1.1em;font-weight:600;text-decoration:none;display:inline-block;transition:all .3s;margin:10px 5px;box-shadow:0 3px 8px rgba(255,85,0,.2);text-align:center;min-width:160px}
    .button:hover{background:linear-gradient(135deg,#e04400,#ff6600);transform:translateY(-2px);box-shadow:0 5px 15px rgba(255,85,0,.3)}
    .button:active{transform:translateY(0);box-shadow:0 2px 5px rgba(255,85,0,.2)}
    .button.secondary{background:linear-gradient(135deg,#6c757d,#868e96);box-shadow:0 3px 8px rgba(108,117,125,.2)}
    .button.secondary:hover{background:linear-gradient(135deg,#545b62,#6c757d);box-shadow:0 5px 15px rgba(108,117,125,.3)}
    .button:disabled{background:#ddd;color:#999;cursor:not-allowed;transform:none;box-shadow:none}
    .button:disabled:hover{background:#ddd;transform:none;box-shadow:none}

    .breadcrumb {
      text-align: center;
      margin: 10px auto;
      max-width: 800px;
      color: #666;
      font-size: 0.9em;
    }

    .breadcrumb a {
      color: #007bff;
      text-decoration: none;
    }

    .breadcrumb a:hover {
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .booking-steps{padding:20px}
      .urgency-options{grid-template-columns:1fr}
      .vehicle-types{grid-template-columns:1fr}
      .stats-grid{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>

<!-- THESE ELEMENTS WILL BE MANAGED BY MASTER CONFIG -->
<div id="closedBanner" class="after-hours-banner" style="display: none;">
  <h2 id="closedTitle">üïê CURRENTLY CLOSED</h2>
  <div id="afterHoursMessage">
    <p><strong>Business Hours:</strong></p>
    <p>Monday - Friday: 7:00 AM - 5:00 PM</p>
    <p>Saturday - Sunday: 7:00 AM - 12:00 PM</p>
    <p>Please call during business hours or book online for next available service</p>
  </div>
  <div id="tempUnavailableMessage" style="display: none;">
    <p><strong>We're currently experiencing high demand</strong></p>
    <p>Our mechanics are fully dispatched on emergency calls</p>
    <p>Please book online for the next available appointment or try calling again shortly</p>
    <a href="#service-selection" class="emergency-btn" data-track="customer_book_online" style="background: rgba(255,255,255,0.25); margin-top: 10px;">üìÖ Book Online Now</a>
  </div>
</div>

<section id="stripePaymentBlock" style="display: none; background-color: #ffffff; padding: 20px; text-align: center; color: #333; border-bottom: 2px solid #ff5500;">
  <div style="background-color: #f5f5f5; padding: 30px; border-radius: 12px; max-width: 700px; margin: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.05);">
    <h1 style="font-size: 2.2em; margin-bottom: 0.5em;">Secure Payment for Inspection</h1>
    <p style="font-size: 1.2em; margin-bottom: 1.5em;">Complete your payment to schedule your pre-purchase inspection ‚Äî fast, safe, and secure.</p>
    <label style="font-size: 1.1em; display: inline-flex; align-items: center; gap: 10px; color: #333;">
      <input type="checkbox" id="termsCheckbox" style="transform: scale(1.5);" />
      <span>I agree to the Eek Mobile Mechanical terms of service 
        <a href="https://www.eek.nz/terms" target="_blank" data-track="legal_terms" onclick="this.href='https://www.eek.nz/terms' + window.location.search" style="color: #ff5500; text-decoration: underline;">
          View terms of use
        </a>
      </span>
    </label>
    <br><br>
    <button id="payNowButton" style="display: none; background-color: #ff5500; color: white; padding: 14px 32px; font-size: 1.2em; border: none; border-radius: 8px; cursor: pointer;">
      Pay Now
    </button>
  </div>
</section>

<!-- HEADER THAT WILL BE MANAGED BY MASTER CONFIG -->
<header>
  <img src="/lemon.png" alt="Don't buy a lemon! Eek Mobile Mechanical Pre Purchase Vehicle Inspection" />
  <div class="business-name">Eek Mobile Mechanical</div>
  <h1 id="headerTitle">Don't Buy a Lemon! Pre Purchase Vehicle Inspection</h1>
  <p class="tagline" id="headerSubtitle">Avoid costly mistakes with our professional vehicle inspection ‚Ä¢ 45-point inspection ‚Ä¢ Written report ‚Ä¢ Mobile service anywhere in NZ</p>
  <a class="cta-button phone-link" href="tel:0800769000" data-track="header_call">üìû Call <span class="phone-display">0800 769 000</span></a>
</header>

<div class="breadcrumb">
  <a href="/" data-track="breadcrumb_home">Home</a> > 
  <a href="/more-options" data-track="breadcrumb_more_options">More Options</a> > 
  <span id="breadcrumbText">Pre Purchase Inspection</span>
</div>

<div class="booking-container">
  <div class="booking-header" id="bookingHeader">
    <h2 id="bookingTitle">Don't Buy a Lemon! Book Your Pre Purchase Inspection</h2>
    <p id="bookingDescription">Professional 45-point certified inspection ‚Ä¢ Mobile service anywhere in NZ</p>
    <div class="service-stats">
      <div class="stats-grid" id="statsContent">
        <div class="stat-item"><span class="stat-number">20%</span>of vehicles rejected</div>
        <div class="stat-item"><span class="stat-number">40%</span>have unaddressed recalls</div>
        <div class="stat-item"><span class="stat-number">25%</span>electrical problems</div>
        <div class="stat-item"><span class="stat-number">39%</span>buyers overpay</div>
      </div>
    </div>
  </div>

  <div class="progress-bar">
    <div class="progress-step active" id="step1-progress"><span>Details</span></div>
    <div class="progress-step" id="step2-progress"><span>Scheduling</span></div>
    <div class="progress-step" id="step3-progress"><span>Vehicle Type</span></div>
    <div class="progress-step" id="step4-progress"><span>Confirm</span></div>
  </div>

  <div class="booking-steps">
    <!-- Step 1: Service Details -->
    <div class="step active" id="step1">
      <h3 id="step1Title">Step 1: Tell us about your inspection</h3>

      <div style="background:#fff3cd;border:2px solid #ffeaa7;border-radius:12px;padding:20px;margin-bottom:20px;text-align:left;">
        <h4 style="margin:0 0 10px 0;color:#856404;">‚ö†Ô∏è Why You Need This Inspection</h4>
        <ul style="margin:0;padding-left:20px;color:#856404;">
          <li><strong>1 in 5 vehicles</strong> we inspect have serious issues (20% rejection rate)</li>
          <li><strong>Nearly 40%</strong> of used cars have unaddressed safety recalls</li>
          <li><strong>25% have electrical problems</strong> that can cost thousands</li>
          <li><strong>39% of buyers overpay</strong> without a professional inspection</li>
        </ul>
      </div>

      <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
        <h4 style="margin:0 0 15px 0;color:#333;">Your Information</h4>
        <div class="contact-info">
          <label for="nameInput">Full Name (required)</label>
          <input type="text" id="nameInput" placeholder="John Smith" required autocomplete="name"/>
          <label for="phoneInput">Phone Number (required)</label>
          <input type="tel" id="phoneInput" placeholder="021 234 5678" required inputmode="tel" autocomplete="tel"/>
          <label for="emailInput">Email Address (required)</label>
          <input type="email" id="emailInput" placeholder="your.email@example.com" required autocomplete="email"/>
        </div>
      </div>

      <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
        <h4 style="margin:0 0 15px 0;color:#333;">Vehicle Information</h4>
        <div class="contact-info">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
            <div>
              <label for="regoInput">Registration Number</label>
              <input type="text" id="regoInput" placeholder="ABC123" style="text-transform:uppercase;" autocapitalize="characters" spellcheck="false"/>
            </div>
            <div>
              <label for="yearInput">Year</label>
              <input type="text" id="yearInput" placeholder="2018" maxlength="4" pattern="\\d{4}" inputmode="numeric"/>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
            <div>
              <label for="makeInput">Make</label>
              <input type="text" id="makeInput" placeholder="Toyota"/>
            </div>
            <div>
              <label for="modelInput">Model</label>
              <input type="text" id="modelInput" placeholder="Corolla"/>
            </div>
          </div>
        </div>
      </div>

      <div style="background:#e8f4f8;padding:15px;border-radius:8px;margin-bottom:20px;">
        <h4 style="margin:0 0 15px 0;color:#333;">Seller Information (required for inspection)</h4>
        <div class="contact-info">
          <label for="sellerNameInput">Seller Name or Dealership Name (required)</label>
          <input type="text" id="sellerNameInput" placeholder="Seller's full name or dealership name" required/>
          <label for="sellerPhoneInput">Seller Phone Number (required)</label>
          <input type="tel" id="sellerPhoneInput" placeholder="021 987 6543" required inputmode="tel" autocomplete="tel"/>
        </div>
      </div>

      <label for="locationInput" style="display:block;margin-bottom:8px;font-weight:700;">Where is the vehicle located?</label>
      <input type="text" class="location-input" id="locationInput" placeholder="Enter address, suburb, or region (e.g. Auckland CBD, Christchurch, Wellington)" required autocomplete="street-address"/>

      <label for="detailsInput" style="display:block;margin-bottom:8px;margin-top:15px;font-weight:700;" id="detailsLabel">Vehicle and inspection details:</label>
      <textarea class="details-input" id="detailsInput" placeholder="e.g., Any specific concerns, dealer or private sale, any known issues, etc."></textarea>

      <div class="info-box" id="serviceInfoBox">
        <h4>Our Pre-Purchase Inspection Includes:</h4>
        <ul>
          <li><strong>Comprehensive certified mechanical inspection</strong> of all major systems</li>
          <li><strong>45-point inspection checklist</strong> covering engine, brakes, suspension, electrical</li>
          <li><strong>Written inspection report</strong> with photos and detailed findings</li>
          <li><strong>Professional recommendation</strong> on whether to proceed with purchase</li>
          <li><strong>Transparent pricing</strong> calculated based on your location and vehicle type</li>
          <li><strong>Mobile service</strong> - we come to any location in New Zealand</li>
        </ul>
      </div>

      <!-- RevU Popup Rating Widget -->
      <div id="popup-rating-widget">
        <script id="popup-rating-widget-script" src="https://widget.reviewability.com/js/popupWidget.min.js" data-gfspw="https://app.revu.cloud/popup-pixel/get/1e8ac54d1020ced847d10f515125aa3ff719d1f3" async></script>
      </div>

      <div style="text-align:center;margin:20px 0;">
        <button class="button" id="nextBtn" onclick="goToStep2()">Next: Select Time</button>
      </div>
    </div>

    <!-- Step 2: Scheduling -->
    <div class="step" id="step2">
      <h3 id="step2Title">Step 2: When do you need the inspection?</h3>

      <div class="timing-notice" id="timingNotice">
        <h4>‚è∞ Inspection Scheduling Information</h4>
        <p><strong>Service Hours:</strong> Monday - Friday: 7:00 AM - 5:00 PM, Saturday - Sunday: 7:00 AM - 12:00 PM</p>
        <p><strong>Inspection time:</strong> Typically takes 60-90 minutes to complete</p>
        <p><strong>Report delivery:</strong> Written report with photos delivered within 24 hours</p>
        <p>Time windows are approximate arrival times. As a mobile service, a previous job may run long. We'll text you when your technician is on the way.</p>
      </div>

      <div class="urgency-options" id="urgencyOptions"></div>

      <div style="margin:20px 0;">
        <button class="button secondary" onclick="goToStep1()">Back</button>
        <button class="button" id="confirmTimeBtn" onclick="goToStep3()" disabled>Continue</button>
      </div>
    </div>

    <!-- Step 3: Vehicle Type -->
    <div class="step" id="step3">
      <h3 id="step3Title">Step 3: Vehicle Type</h3>
      <p style="color:#666;margin-bottom:25px;">Select your vehicle type for accurate inspection pricing:</p>

      <div class="vehicle-types" id="vehicleTypes"></div>

      <div style="margin:20px 0;">
        <button class="button secondary" onclick="goToStep2()">Back</button>
        <button class="button" onclick="goToStep4()">Continue to Review</button>
      </div>
    </div>

    <!-- Step 4: Confirmation -->
    <div class="step" id="step4">
      <h3 id="step4Title">Step 4: Review and confirm</h3>

      <div class="reservation-summary">
        <h4>Your Inspection Booking</h4>
        <div class="summary-item"><span>Service:</span><strong id="summaryService">Pre Purchase Vehicle Inspection</strong></div>
        <div class="summary-item"><span>Location:</span><strong id="summaryLocation"></strong></div>
        <div class="summary-item"><span>Phone:</span><strong id="summaryPhone"></strong></div>
        <div class="summary-item"><span>Date & Time:</span><strong id="summaryDateTime"></strong></div>
        <div class="summary-item"><span>Vehicle Type:</span><strong id="summaryVehicleType"></strong></div>
        <div class="summary-item"><span>Total Fee:</span><strong id="summaryPrice"></strong></div>
      </div>

      <div class="timing-notice" id="nextStepsBox" style="background:#e8f8ff;border-color:#bee5eb;">
        <h4>üì± What happens next?</h4>
        <p>1. Click "Generate Payment Link" to create your secure payment link</p>
        <p>2. Complete payment through Stripe's secure checkout</p>
        <p>3. Receive SMS confirmation with your booking details</p>
        <p>4. Get a notification when your technician is on the way</p>
        <p>5. Receive your detailed written report within 24 hours</p>
      </div>

      <div class="terms-section">
        <h4>Terms and Conditions</h4>
        <div class="terms-checkbox">
          <input type="checkbox" id="termsAgree" onchange="toggleBookingButton()" />
          <div class="terms-text">
            I agree to the <a href="/terms" target="_blank" data-track="legal_terms">Eek Mobile Mechanical Terms of Service</a> and understand that:
            <ul style="margin:10px 0;padding-left:20px;" id="termsList">
              <li>Comprehensive certified 45-point mechanical inspection</li>
              <li>Price calculated based on location and vehicle type</li>
              <li>Written report with photos provided within 24 hours</li>
              <li>Inspection typically takes 60-90 minutes to complete</li>
              <li>Arrival times are approximate - we will SMS you when the technician is on the way</li>
              <li>Payment required via secure Stripe checkout</li>
            </ul>
          </div>
        </div>
      </div>

      <div style="text-align:center;margin:20px 0;">
        <div style="display:flex;justify-content:center;gap:15px;flex-wrap:wrap;">
          <button class="button secondary" onclick="goToStep3()">Back to Selection</button>
          <button class="button" id="generatePaymentBtn" onclick="generatePaymentLink()" disabled>Generate Payment Link</button>
        </div>
        <p style="margin:15px 0;color:#666;font-size:.9em;" id="paymentNote">Secure payment processing powered by Stripe</p>
      </div>
    </div>
  </div>
</div>

<!-- THESE WILL BE MANAGED BY MASTER CONFIG -->
<a id="stripePaymentSticky" class="sticky-payment" href="#" data-track="customer_call">üí≥ Make Payment</a>

<footer>
  &copy; 2025 Eek Mobile Mechanical. All rights reserved. | 
  <a href="/privacy" target="_blank" data-track="footer_privacy">Privacy Policy</a> | 
  <a href="/more-options" data-track="more_options_call">More Options</a>
</footer>

<a class="sticky-call phone-link" href="tel:0800769000" data-track="sticky_call" id="stickyCallButton">üìû Call <span class="phone-display">0800 769 000</span></a>
<a class="sticky-call" href="#closedBanner" id="stickyClosedButton" data-track="customer_support" style="display: none; background: #666;">üïê View Hours</a>

<!-- MASTER CONFIG LOADS FIRST -->
<script src="/eek-master-config.js"></script>

<!-- INSPECTION-SPECIFIC JAVASCRIPT AFTER MASTER CONFIG -->
<script>
console.log('üöÄ Pre-purchase inspection form initializing...');

// Wait for master config to be fully loaded
async function waitForMasterConfig() {
  while (typeof window.EEK_CONFIG === 'undefined' || typeof window.EEK_STATE === 'undefined') {
    console.log('‚è≥ Waiting for master config...');
    await new Promise(resolve => setTimeout(resolve, 100));
  }
  console.log('‚úÖ Master config is ready');
}

// NZ timezone helpers
const NZ_TZ = 'Pacific/Auckland';
function nowNZ(){
  const parts = new Intl.DateTimeFormat('en-NZ',{
    timeZone:NZ_TZ,hour12:false,year:'numeric',month:'2-digit',day:'2-digit',
    hour:'2-digit',minute:'2-digit',second:'2-digit'
  }).formatToParts(new Date());
  const get=t=>parts.find(p=>p.type===t).value;
  return new Date(`${get('year')}-${get('month')}-${get('day')}T${get('hour')}:${get('minute')}:${get('second')}`);
}
function fmtDateNZ(d){
  return d.toLocaleDateString('en-NZ',{timeZone:NZ_TZ,weekday:'long',year:'numeric',month:'long',day:'numeric'});
}
function isWeekendNZ(d){ 
  const g=d.getDay(); 
  return g===0 || g===6; 
}

// Booking status tracking
const BOOKING_STATUS = {
  INITIAL: 'booking_started',
  DETAILS_COMPLETE: 'details_complete',
  TIME_SELECTED: 'time_selected',
  VEHICLE_SELECTED: 'vehicle_selected',
  TERMS_ACCEPTED: 'terms_accepted',
  PAYMENT_PENDING: 'payment_pending'
};

const STATUS_COLORS = {
  'booking_started': '#007bff',
  'details_complete': '#28a745',
  'time_selected': '#fd7e14',
  'vehicle_selected': '#6f42c1',
  'terms_accepted': '#20c997',
  'payment_pending': '#dc3545'
};

// Inspection service configuration
const inspectionConfig = {
  title: 'Pre Purchase Vehicle Inspection',
  subtitle: "Don't buy a lemon! Get a professional inspection",
  breadcrumb: 'Pre Purchase Inspection',
  bookingTitle: 'Don\'t Buy a Lemon! Book Your Pre Purchase Inspection',
  bookingDescription: 'Professional 45-point certified inspection ‚Ä¢ Mobile service anywhere in NZ',
  step1Title: 'Step 1: Tell us about your inspection',
  detailsLabel: 'Vehicle and inspection details:',
  detailsPlaceholder: 'e.g., Any specific concerns, dealer or private sale, any known issues, etc.',
  serviceCode: 'INSP',
  basePrice: {
    weekday: 199,
    weekend: 289
  },
  urgencyOptions: [
    {
      id: 'today',
      title: 'Today (if available)',
      time: 'Within 4 hours',
      description: 'Emergency same-day inspection',
      priceMultiplier: 1.0,
      fixedPrice: 289  // Weekend price for emergency
    },
    {
      id: 'tomorrow',
      title: 'Tomorrow',
      time: 'Next business day',
      description: 'Priority next-day inspection', 
      priceMultiplier: 1.0,
      fixedPrice: 239  // Between weekday and weekend
    },
    {
      id: 'scheduled',
      title: 'Scheduled Service',
      time: 'Within 2-3 days',
      description: 'Standard scheduling',
      priceMultiplier: 1.0,
      fixedPrice: null  // Use calculated or base price
    }
  ],
  vehicleTypes: [
    {
      id: 'standard',
      title: 'Standard Vehicle',
      subtitle: 'Cars, SUVs, Utes under 3500kg',
      note: 'Most common vehicle type',
      addon: 0,
      popular: true
    },
    {
      id: 'commercial',
      title: 'Commercial Vehicle',
      subtitle: 'Vans, trucks, heavy vehicles > 3500kg',
      note: 'Additional inspection time required',
      addon: 39
    },
    {
      id: 'specialty',
      title: 'Classic/Specialty Vehicle',
      subtitle: 'Classics, modified, imports',
      note: 'Specialist expertise required',
      addon: 129
    }
  ],
  terms: [
    'Comprehensive certified 45-point mechanical inspection',
    'Price calculated based on location and vehicle type',
    'Written report with photos provided within 24 hours',
    'Inspection typically takes 60-90 minutes to complete',
    'Arrival times are approximate - we will SMS you when the technician is on the way',
    'Payment required via secure Stripe checkout'
  ]
};

// API URLs - use master config's URLs where available
const POWER_AUTOMATE_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/dbc93a177083499caf5a06eeac87683c/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=vXidGdo8qErY4QVv03JeNaGbA79eWEoiOxuDocljL6Q';

// Global state - booking specific only
let selectedUrgency = null;
let selectedUrgencyDetails = {};
let selectedVehicleType = 'standard';
let vehicleTypeAddon = 0;
let calculatedPrice = null;

// Helper functions
function sanitizePhone(val){ return (val || '').replace(/\D/g,''); }
function sanitizeRego(val){ return (val || '').toUpperCase().replace(/[^A-Z0-9]/g,''); }
function sanitizeText(val){ return (val || '').trim().replace(/\s+/g,' '); }

function buildBookingData(status) {
  const urlParams = new URLSearchParams(window.location.search);
  
  return {
    sessionId: window.EEK_STATE?.sessionId || localStorage.getItem("eek_session_id"),
    bookingStatus: status,
    statusColor: STATUS_COLORS[status] || '#6c757d',
    timestamp: new Date().toISOString(),
    
    name: sanitizeText(document.getElementById('nameInput').value),
    phone: sanitizePhone(document.getElementById('phoneInput').value),
    email: document.getElementById('emailInput').value.trim(),
    location: sanitizeText(document.getElementById('locationInput').value),
    details: document.getElementById('detailsInput').value || '',
    
    rego: sanitizeRego(document.getElementById('regoInput').value),
    vehicleRego: sanitizeRego(document.getElementById('regoInput').value),
    year: document.getElementById('yearInput').value.trim(),
    make: sanitizeText(document.getElementById('makeInput').value),
    model: sanitizeText(document.getElementById('modelInput').value),
    
    // Seller information
    sellerName: sanitizeText(document.getElementById('sellerNameInput').value),
    sellerPhone: sanitizePhone(document.getElementById('sellerPhoneInput').value),
    
    service: 'inspection',
    serviceCode: inspectionConfig.serviceCode,
    serviceTitle: inspectionConfig.title,
    
    source: 'inspection_booking_form',
    formVersion: '2.2',
    
    // Use master config's stored UTM/tracking data
    gclid: window.EEK_STATE?.storedGclidForTracking || localStorage.getItem("eek_gclid") || urlParams.get('gclid') || null,
    utm: window.EEK_STATE?.utmData || {},

    // Booking specific fields
    ...(status === BOOKING_STATUS.TIME_SELECTED && {
      selectedTime: selectedUrgencyDetails.time || '',
      selectedUrgency: selectedUrgency,
      urgencyMultiplier: selectedUrgencyDetails.priceMultiplier || 1.0
    }),

    ...(status === BOOKING_STATUS.VEHICLE_SELECTED || status === BOOKING_STATUS.TERMS_ACCEPTED || status === BOOKING_STATUS.PAYMENT_PENDING) && {
      selectedVehicleType: selectedVehicleType,
      vehicleTypeAddon: vehicleTypeAddon,
      calculatedPrice: getTotalPrice(),
      finalPrice: getTotalPrice()
    }
  };
}

async function sendBookingUpdate(status) {
  const data = buildBookingData(status);
  console.log(`üì° Inspection ${status}:`, data);
  
  try {
    // Use master config's tracking API if available
    const apiUrl = window.EEK_CONFIG?.TRACKING_API_URL || window.EEK_CONFIG?.PRICING_API_URL || 
                   'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/2f31c90260554c5a9d6dcffec47bc6c2/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Ou7iqzZ1YI2PzT_9X-M6PT5iVo2QRboWnFZrO3IBOL4';
    
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    console.log(`‚úÖ API Response: ${response.status}`);
    return response;
  } catch (err) {
    console.error(`‚ùå Error:`, err);
  }
}

// Main initialization function
async function initializeInspectionForm() {
  console.log('üöÄ Starting inspection form initialization...');
  
  // Wait for master config
  await waitForMasterConfig();
  
  const urlParams = new URLSearchParams(window.location.search);
  const sessionId = urlParams.get('session_id');
  
  console.log('üìå Service: Pre Purchase Vehicle Inspection');
  
  // Handle session ID - use master config's session management
  if (sessionId) {
    window.sessionId = sessionId;
    localStorage.setItem("eek_session_id", sessionId);
  } else {
    window.sessionId = window.EEK_STATE?.sessionId || localStorage.getItem("eek_session_id") || 
                      `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    localStorage.setItem("eek_session_id", window.sessionId);
  }
  
  // Initialize booking
  console.log('‚úÖ Initializing inspection with master config integration');
  loadInspectionConfig();
  sendBookingUpdate(BOOKING_STATUS.INITIAL);
  
  console.log('üìä Inspection initialization complete with master config integration');
}

function loadInspectionConfig() {
  console.log('‚öôÔ∏è Loading service:', inspectionConfig.title);

  // Update page content
  document.title = `${inspectionConfig.title} - Eek Mobile Mechanical`;
  document.getElementById('headerTitle').textContent = inspectionConfig.title;
  document.getElementById('headerSubtitle').textContent = inspectionConfig.subtitle;
  document.getElementById('breadcrumbText').textContent = inspectionConfig.breadcrumb;
  document.getElementById('bookingTitle').textContent = inspectionConfig.bookingTitle;
  document.getElementById('bookingDescription').textContent = inspectionConfig.bookingDescription;
  document.getElementById('step1Title').textContent = inspectionConfig.step1Title;
  document.getElementById('detailsLabel').textContent = inspectionConfig.detailsLabel;
  document.getElementById('detailsInput').placeholder = inspectionConfig.detailsPlaceholder;

  // Reset state
  selectedUrgency = null;
  selectedUrgencyDetails = {};
  selectedVehicleType = 'standard';
  vehicleTypeAddon = 0;
  calculatedPrice = null;

  window.currentService = 'inspection';
  window.currentConfig = inspectionConfig;
}

function goToStep1(){
  document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
  document.getElementById('step1').classList.add('active');
  document.querySelectorAll('.progress-step').forEach(el => el.classList.remove('active','completed'));
  document.getElementById('step1-progress').classList.add('active');
}

async function goToStep2(){
  console.log('üìù Step 1 ‚Üí 2');
  
  // Validate all required fields
  const name = document.getElementById('nameInput').value.trim();
  const phone = document.getElementById('phoneInput').value.trim();
  const email = document.getElementById('emailInput').value.trim();
  const location = document.getElementById('locationInput').value.trim();
  const sellerName = document.getElementById('sellerNameInput').value.trim();
  const sellerPhone = document.getElementById('sellerPhoneInput').value.trim();

  const phoneRegex = /^[\d\s\-\+\(\)]+$/;
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  if (!name) { alert('Please enter your full name'); document.getElementById('nameInput').focus(); return; }
  if (!phone || !phoneRegex.test(phone) || phone.replace(/\D/g,'').length < 9) { 
    alert('Please enter a valid phone number'); document.getElementById('phoneInput').focus(); return; 
  }
  if (!email || !emailRegex.test(email)) { 
    alert('Please enter a valid email address'); document.getElementById('emailInput').focus(); return; 
  }
  if (!location) { alert('Please enter the vehicle location'); document.getElementById('locationInput').focus(); return; }
  if (!sellerName) { alert('Please enter the seller\'s name or dealership name'); document.getElementById('sellerNameInput').focus(); return; }
  if (!sellerPhone || !phoneRegex.test(sellerPhone) || sellerPhone.replace(/\D/g,'').length < 9) { 
    alert('Please enter a valid seller phone number'); document.getElementById('sellerPhoneInput').focus(); return; 
  }

  // Get pricing
  const btn = document.getElementById('nextBtn');
  btn.disabled = true;
  btn.textContent = 'Calculating price...';
  
  try {
    const response = await sendBookingUpdate(BOOKING_STATUS.DETAILS_COMPLETE);
    
    if (response?.ok) {
      const responseText = await response.text();
      if (responseText) {
        try {
          const result = JSON.parse(responseText);
          if (result.price) {
            calculatedPrice = result.price;
          }
        } catch (e) {
          // Use default pricing if API response can't be parsed
        }
      }
    }
  } catch (err) {
    console.error('Pricing error:', err);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Next: Select Time';
  }

  // Move to step 2
  document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
  document.getElementById('step2').classList.add('active');
  document.getElementById('step1-progress').classList.add('completed');
  document.getElementById('step1-progress').classList.remove('active');
  document.getElementById('step2-progress').classList.add('active');

  // Setup urgency options
  setupUrgencyOptions();
}

function setupUrgencyOptions() {
  const urgencyContainer = document.getElementById('urgencyOptions');
  const now = nowNZ();
  const basePrice = calculatedPrice || (isWeekendNZ(now) ? inspectionConfig.basePrice.weekend : inspectionConfig.basePrice.weekday);
  
  urgencyContainer.innerHTML = inspectionConfig.urgencyOptions.map(option => {
    // Use fixed price if specified, otherwise use base price
    const price = option.fixedPrice || basePrice;
    
    return `
      <div class="urgency-option" onclick="selectUrgency('${option.id}','${option.title}','${option.time}',${price},this)">
        <div class="urgency-title">${option.title}</div>
        <div class="urgency-time">${option.time}</div>
        <div class="urgency-description">${option.description}</div>
        <div class="urgency-price">$${price}</div>
      </div>`;
  }).join('');
}

function selectUrgency(id, title, time, price, el){
  document.querySelectorAll('.urgency-option.selected').forEach(x => x.classList.remove('selected'));
  el.classList.add('selected');
  selectedUrgency = id;
  selectedUrgencyDetails = { title, time, basePrice: price };
  
  document.getElementById('confirmTimeBtn').disabled = false;
}

async function goToStep3(){
  console.log('‚è∞ Step 2 ‚Üí 3');
  
  if (!selectedUrgency) {
    alert('Please select a service time');
    return;
  }

  await sendBookingUpdate(BOOKING_STATUS.TIME_SELECTED);

  // Move to step 3
  document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
  document.getElementById('step3').classList.add('active');
  document.getElementById('step2-progress').classList.add('completed');
  document.getElementById('step2-progress').classList.remove('active');
  document.getElementById('step3-progress').classList.add('active');

  // Setup vehicle types
  setupVehicleTypes();
}

function setupVehicleTypes() {
  const vehicleContainer = document.getElementById('vehicleTypes');
  const basePrice = selectedUrgencyDetails.basePrice || calculatedPrice || 
    (isWeekendNZ(nowNZ()) ? inspectionConfig.basePrice.weekend : inspectionConfig.basePrice.weekday);
  
  vehicleContainer.innerHTML = inspectionConfig.vehicleTypes.map(type => {
    const totalPrice = basePrice + type.addon;
    const popularClass = type.popular ? 'popular' : '';
    const selectedClass = type.id === 'standard' ? 'selected' : '';
    
    return `
      <div class="vehicle-type ${popularClass} ${selectedClass}" onclick="selectVehicleType('${type.id}', ${type.addon}, this)">
        <div class="vehicle-type-title">${type.title}</div>
        <div class="vehicle-type-subtitle">${type.subtitle}</div>
        <div class="vehicle-type-note">${type.note}</div>
        <div class="vehicle-type-price">$${totalPrice}${type.addon > 0 ? ` (+$${type.addon})` : ''}</div>
      </div>`;
  }).join('');
}

function selectVehicleType(type, addon, el){
  document.querySelectorAll('.vehicle-type.selected').forEach(x=>x.classList.remove('selected'));
  el.classList.add('selected');
  selectedVehicleType = type;
  vehicleTypeAddon = addon;
}

async function goToStep4(){
  console.log('üöó Step 3 ‚Üí 4');
  
  await sendBookingUpdate(BOOKING_STATUS.VEHICLE_SELECTED);
  
  document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
  document.getElementById('step4').classList.add('active');
  document.getElementById('step3-progress').classList.add('completed');
  document.getElementById('step3-progress').classList.remove('active');
  document.getElementById('step4-progress').classList.add('active');
  
  updateSummary();
}

function getTotalPrice(){
  const basePrice = selectedUrgencyDetails.basePrice || calculatedPrice || 
    (isWeekendNZ(nowNZ()) ? inspectionConfig.basePrice.weekend : inspectionConfig.basePrice.weekday);
  return basePrice + vehicleTypeAddon;
}

function updateSummary(){
  document.getElementById('summaryService').textContent = inspectionConfig.title;
  document.getElementById('summaryLocation').textContent = document.getElementById('locationInput').value;
  document.getElementById('summaryPhone').textContent = sanitizePhone(document.getElementById('phoneInput').value);
  
  const dateTimeText = selectedUrgencyDetails.time ? 
    `${selectedUrgencyDetails.title} - ${selectedUrgencyDetails.time}` : 'Not selected';
  document.getElementById('summaryDateTime').textContent = dateTimeText;
  
  const vehicleType = inspectionConfig.vehicleTypes.find(v => v.id === selectedVehicleType);
  const vehicleText = vehicleType ? 
    `${vehicleType.title}${vehicleTypeAddon > 0 ? ` (+$${vehicleTypeAddon})` : ''}` : 'Standard Vehicle';
  document.getElementById('summaryVehicleType').textContent = vehicleText;
  
  document.getElementById('summaryPrice').textContent = `$${getTotalPrice()}`;
}

function toggleBookingButton(){
  document.getElementById('generatePaymentBtn').disabled = !document.getElementById('termsAgree').checked;
}

function buildRedirectUrl(){
  const baseUrl = 'https://www.eek.nz/thanks';
  const params = new URLSearchParams();
  const urlParams = new URLSearchParams(window.location.search);

  // Basic customer data
  params.append('name', sanitizeText(document.getElementById('nameInput').value));
  params.append('phone', sanitizePhone(document.getElementById('phoneInput').value));
  params.append('email', document.getElementById('emailInput').value.trim());
  params.append('location', sanitizeText(document.getElementById('locationInput').value));
  params.append('rego', sanitizeRego(document.getElementById('regoInput').value));
  params.append('year', document.getElementById('yearInput').value.trim());
  params.append('make', sanitizeText(document.getElementById('makeInput').value));
  params.append('model', sanitizeText(document.getElementById('modelInput').value));
  
  // Service data
  params.append('service', 'inspection');
  params.append('serviceCode', inspectionConfig.serviceCode);
  params.append('serviceTitle', inspectionConfig.title);
  params.append('price', getTotalPrice());
  params.append('details', document.getElementById('detailsInput').value || '');
  params.append('scheduledDate', fmtDateNZ(nowNZ()));
  params.append('timeWindow', selectedUrgencyDetails.time || '');
  params.append('urgencyLevel', selectedUrgency || 'scheduled');
  params.append('vehicleType', selectedVehicleType);
  params.append('vehicleAddon', vehicleTypeAddon);
  params.append('bookingTime', new Date().toISOString());
  
  // Seller information
  params.append('sellerName', sanitizeText(document.getElementById('sellerNameInput').value));
  params.append('sellerPhone', sanitizePhone(document.getElementById('sellerPhoneInput').value));
  
  // Tracking data from master config
  const gclid = window.EEK_STATE?.storedGclidForTracking || localStorage.getItem("eek_gclid") || urlParams.get('gclid');
  if (gclid) params.append('gclid', gclid);
  if (window.sessionId) params.append('session_id', window.sessionId);

  return `${baseUrl}?${params.toString()}`;
}

async function generatePaymentLink(){
  if (!document.getElementById('termsAgree').checked) {
    alert('Please accept the terms and conditions');
    return;
  }

  const btn = document.getElementById('generatePaymentBtn');
  btn.disabled = true;
  btn.classList.add('processing');
  
  await sendBookingUpdate(BOOKING_STATUS.TERMS_ACCEPTED);
  
  btn.textContent = 'Generating Link';

  const total = getTotalPrice();
  const vehicleDescription = [
    sanitizeRego(document.getElementById('regoInput').value),
    document.getElementById('yearInput').value.trim(),
    sanitizeText(document.getElementById('makeInput').value),
    sanitizeText(document.getElementById('modelInput').value)
  ].filter(Boolean).join(' ') || 'Vehicle details not provided';

  // Send final update before payment
  await sendBookingUpdate(BOOKING_STATUS.PAYMENT_PENDING);

  const bookingData = {
    rego: sanitizeRego(document.getElementById('regoInput').value) || 'Not provided',
    amount: total * 100,
    currency: 'NZD',
    description: `Pre Purchase Vehicle Inspection - ${vehicleDescription} - ${document.getElementById('locationInput').value}`,
    redirectUrl: buildRedirectUrl(),
    customerData: {
      name: sanitizeText(document.getElementById('nameInput').value),
      phone: sanitizePhone(document.getElementById('phoneInput').value),
      email: document.getElementById('emailInput').value.trim(),
      location: sanitizeText(document.getElementById('locationInput').value),
      vehicleRego: sanitizeRego(document.getElementById('regoInput').value),
      vehicleYear: document.getElementById('yearInput').value.trim(),
      vehicleMake: sanitizeText(document.getElementById('makeInput').value),
      vehicleModel: sanitizeText(document.getElementById('modelInput').value),
      vehicleDescription,
      sellerName: sanitizeText(document.getElementById('sellerNameInput').value),
      sellerPhone: sanitizePhone(document.getElementById('sellerPhoneInput').value),
      service: 'inspection',
      serviceCode: inspectionConfig.serviceCode,
      serviceTitle: inspectionConfig.title,
      details: document.getElementById('detailsInput').value || 'No additional details provided',
      price: `${total}`,
      selectedVehicleType: selectedVehicleType,
      vehicleTypeAddon: vehicleTypeAddon,
      bookingDateTime: nowNZ().toLocaleString('en-NZ', { timeZone: NZ_TZ }),
      scheduledDate: fmtDateNZ(nowNZ()),
      scheduledTime: selectedUrgencyDetails.time || '',
      urgencyLevel: selectedUrgency || 'scheduled',
      gclid: window.EEK_STATE?.storedGclidForTracking || localStorage.getItem("eek_gclid"),
      sessionId: window.sessionId
    }
  };

  try {
    const response = await fetch(POWER_AUTOMATE_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(bookingData)
    });

    if (response.ok) {
      const result = await response.json();
      if (result.url) {
        btn.classList.remove('processing');
        btn.style.display = 'none';
        
        const successDiv = document.createElement('div');
        successDiv.style.cssText = 'background:#d4edda;border:2px solid #28a745;padding:20px;border-radius:8px;margin-top:20px;';
        successDiv.innerHTML = `
          <h4 style="color:#155724;margin:0 0 15px 0;">‚úì Payment Link Generated Successfully!</h4>
          <p style="color:#155724;margin:10px 0;">Your secure payment link is ready:</p>
          <a href="${result.url}" class="button" style="background:#28a745;font-size:1.2em;padding:15px 30px;display:inline-block;margin:10px 0;">
            Complete Payment ($${total})
          </a>
          <p style="color:#666;font-size:.9em;margin-top:15px;">After payment, you'll receive an SMS confirmation with your inspection details.</p>`;
        btn.parentElement.appendChild(successDiv);
        
        setTimeout(() => { window.location.href = result.url; }, 3000);
      } else {
        throw new Error('No payment URL received');
      }
    } else {
      throw new Error('Server returned ' + response.status);
    }
  } catch (err) {
    console.error('Payment link error:', err);
    btn.disabled = false;
    btn.classList.remove('processing');
    btn.textContent = 'Generate Payment Link';
    alert('Unable to generate payment link automatically.\n\nPlease call us at 0800 769 000 or try refreshing the page.');
  }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', initializeInspectionForm);

// Mark that inspection script is loaded (for master config)
window.inspectionFormLoaded = true;
console.log('‚úÖ Inspection form script loaded and ready');
</script>

</body>
</html>
