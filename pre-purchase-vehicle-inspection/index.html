<!-- Power Automate Optimized Email Template - Location Object Fix -->
<table cellpadding="0" cellspacing="0" border="0" style="background-color: #f4f4f4; margin: 0; padding: 0; width: 100%;">
    <tbody><tr>
        <td style="padding: 0;">
            <table cellpadding="0" cellspacing="0" border="0" style="background-color: #ffffff; margin: 0 auto; max-width: 800px; width: 100%;">
                
                <!-- Header -->
                <tbody><tr>
                    <td style="background-color: #007bff; color: white; padding: 20px; text-align: center;">
                        <h1 style="margin: 0 0 10px 0; font-size: 24px; font-family: Arial, sans-serif;">Eek Mobile Mechanical</h1>
                        <h2 style="margin: 0 0 10px 0; font-size: 18px; font-family: Arial, sans-serif; font-weight: normal;">
                            @{coalesce(body('Parse_JSON')?['serviceTitle'], body('Parse_JSON')?['eventAction'], 'Website Interaction')}
                        </h2>
                        <div style="background-color: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 15px; display: inline-block; font-size: 14px; font-family: Arial, sans-serif;">
                            @{coalesce(body('Parse_JSON')?['bookingStatus'], body('Parse_JSON')?['eventAction'], 'INTERACTION LOGGED')}
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; opacity: 0.9;">
                            Session: @{substring(coalesce(body('Parse_JSON')?['sessionId'], 'Unknown'), 0, 25)}...
                        </div>
                    </td>
                </tr>
                
                <!-- Status Bar -->
                <tr>
                    <td style="background-color: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; color: #0d47a1; font-family: Arial, sans-serif; font-size: 14px;">
                        <div style="margin-bottom: 8px;">
                            <strong>Event:</strong> @{coalesce(body('Parse_JSON')?['eventType'], 'Unknown')} - @{coalesce(body('Parse_JSON')?['eventAction'], 'Unknown')} (Sequence: @{coalesce(body('Parse_JSON')?['eventSequence'], 'N/A')})
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Source:</strong> @{coalesce(body('Parse_JSON')?['source'], 'Unknown')} | Form Version: @{coalesce(body('Parse_JSON')?['formVersion'], 'N/A')}
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Device:</strong> @{coalesce(body('Parse_JSON')?['device']?['deviceType'], if(coalesce(body('Parse_JSON')?['device']?['mobile'], false), 'Mobile', 'Desktop'))} | @{coalesce(body('Parse_JSON')?['device']?['operatingSystem'], 'Unknown')} | @{coalesce(body('Parse_JSON')?['device']?['browser'], 'Unknown')}
                        </div>
                        <div>
                            <strong>Timestamp:</strong> @{coalesce(body('Parse_JSON')?['timestamp'], 'N/A')} | NZ Time: @{coalesce(body('Parse_JSON')?['business']?['nzTime'], 'N/A')}
                        </div>
                    </td>
                </tr>
                
                <!-- Customer Information -->
                <tr>
                    <td style="padding: 20px;">
                        <table cellpadding="8" cellspacing="0" border="1" style="background-color: #f8f9fa; border-color: #dee2e6; font-family: Arial, sans-serif; font-size: 14px; width: 100%;">
                            <tbody><tr>
                                <td colspan="2" style="background-color: #e9ecef; font-weight: bold; font-size: 16px; color: #333;">
                                    @{if(not(empty(body('Parse_JSON')?['name'])), 'Customer Details', 'Visitor Information')}
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Name:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['name'], 'Anonymous')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Phone:</td>
                                <td style="color: #333;">
                                    @{coalesce(body('Parse_JSON')?['phone'], 'N/A')} (@{coalesce(body('Parse_JSON')?['phoneNumberType'], 'unknown')})
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Email:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['email'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Details:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['details'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Visit Type:</td>
                                <td style="color: #333;">
                                    @{if(coalesce(body('Parse_JSON')?['visit']?['isFirstVisit'], coalesce(body('Parse_JSON')?['isFirstVisit'], false)), 'First Visit', 'Return Visit')} | 
                                    @{coalesce(body('Parse_JSON')?['visitType'], 'N/A')}
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Visit Summary:</td>
                                <td style="color: #333;">
                                    Visit #@{coalesce(body('Parse_JSON')?['behavior']?['visitCount'], body('Parse_JSON')?['visit']?['visitCount'], '0')} | 
                                    Session #@{coalesce(body('Parse_JSON')?['behavior']?['sessionCount'], '0')} | 
                                    @{coalesce(body('Parse_JSON')?['behavior']?['pageViewCount'], body('Parse_JSON')?['visit']?['pageViewCount'], '0')} pages viewed
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Session Duration:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['visit']?['sessionDuration'], '0')}s</td>
                            </tr>
                        </tbody></table>
                    </td>
                </tr>

                <!-- Location & Geographic Data -->
                <tr>
                    <td style="padding: 20px;">
                        <table cellpadding="8" cellspacing="0" border="1" style="background-color: #e8f5e8; border-color: #4caf50; font-family: Arial, sans-serif; font-size: 14px; width: 100%;">
                            <tbody><tr>
                                <td colspan="2" style="background-color: #c8e6c8; font-weight: bold; font-size: 16px; color: #333;">
                                    Location & Geographic Data
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Timezone:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['location']?['timezone'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Timezone Offset:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['location']?['timezoneOffset'], 'N/A')} | @{coalesce(body('Parse_JSON')?['location']?['timezoneAbbr'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Local Time:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['location']?['localTime'], 'N/A')} (@{coalesce(body('Parse_JSON')?['location']?['localTimeFormat'], 'N/A')})</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Weekday:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['location']?['weekday'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Locale:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['location']?['locale'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Language:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['location']?['language'], coalesce(body('Parse_JSON')?['device']?['language'], 'N/A'))}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Languages:</td>
                                <td style="color: #333;">@{join(coalesce(body('Parse_JSON')?['location']?['languages'], coalesce(body('Parse_JSON')?['device']?['languages'], createArray('N/A'))), ', ')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Currency:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['location']?['currency'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Connection Type:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['location']?['connectionType'], coalesce(body('Parse_JSON')?['connection']?['type'], 'N/A'))}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">ISP Data:</td>
                                <td style="color: #333;">
                                    Type: @{coalesce(body('Parse_JSON')?['location']?['isp']?['effectiveType'], 'N/A')} | 
                                    Speed: @{coalesce(body('Parse_JSON')?['location']?['isp']?['downlink'], 'N/A')}Mbps | 
                                    RTT: @{coalesce(body('Parse_JSON')?['location']?['isp']?['rtt'], 'N/A')}ms
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Screen Resolution:</td>
                                <td style="color: #333;">
                                    @{coalesce(body('Parse_JSON')?['location']?['screenResolution']?['width'], 'N/A')}x@{coalesce(body('Parse_JSON')?['location']?['screenResolution']?['height'], 'N/A')} | 
                                    Ratio: @{coalesce(body('Parse_JSON')?['location']?['screenResolution']?['pixelRatio'], 'N/A')} | 
                                    Color: @{coalesce(body('Parse_JSON')?['location']?['screenResolution']?['colorDepth'], 'N/A')}bit
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Device Orientation:</td>
                                <td style="color: #333;">
                                    Angle: @{coalesce(body('Parse_JSON')?['location']?['deviceOrientation']?['angle'], 'N/A')} | 
                                    Type: @{coalesce(body('Parse_JSON')?['location']?['deviceOrientation']?['type'], 'N/A')}
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Referrer Domain:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['location']?['referrerDomain'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Campaign Geo:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['location']?['campaignGeo'], 'N/A')}</td>
                            </tr>
                        </tbody></table>
                    </td>
                </tr>

                <!-- Attribution & Traffic Data -->
                <tr>
                    <td style="padding: 20px;">
                        <table cellpadding="8" cellspacing="0" border="1" style="background-color: #fff3cd; border-color: #ffc107; font-family: Arial, sans-serif; font-size: 14px; width: 100%;">
                            <tbody><tr>
                                <td colspan="2" style="background-color: #ffeaa7; font-weight: bold; font-size: 16px; color: #333;">
                                    Attribution & Traffic Data
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">GCLID Value:</td>
                                <td style="color: #333; word-break: break-all; font-family: monospace; font-size: 12px;">
                                    @{if(not(empty(body('Parse_JSON')?['gclid'])), body('Parse_JSON')?['gclid'], 'Not Available')}
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">GCLID Status:</td>
                                <td style="color: #333;">
                                    Current: @{if(coalesce(body('Parse_JSON')?['hasCurrentGclid'], false), 'Yes', 'No')} | 
                                    Stored: @{if(coalesce(body('Parse_JSON')?['hasStoredGclid'], false), 'Yes', 'No')} | 
                                    Age: @{coalesce(body('Parse_JSON')?['gclidAge'], 'N/A')} days
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Token Status:</td>
                                <td style="color: #333;">Current Token: @{if(coalesce(body('Parse_JSON')?['hasCurrentToken'], false), 'Yes', 'No')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">UTM Source:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['utm']?['utm_source'], 'Direct')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">UTM Medium:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['utm']?['utm_medium'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">UTM Campaign:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['utm']?['utm_campaign'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">UTM Term:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['utm']?['utm_term'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">UTM Content:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['utm']?['utm_content'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Other Tracking:</td>
                                <td style="color: #333;">
                                    FBCLID: @{coalesce(body('Parse_JSON')?['utm']?['fbclid'], 'N/A')} | 
                                    MSCLKID: @{coalesce(body('Parse_JSON')?['utm']?['msclkid'], 'N/A')} | 
                                    TTCLID: @{coalesce(body('Parse_JSON')?['utm']?['ttclid'], 'N/A')}
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Google Ads Data:</td>
                                <td style="color: #333;">
                                    GAD Source: @{coalesce(body('Parse_JSON')?['utm']?['gad_source'], 'N/A')} | 
                                    Campaign ID: @{coalesce(body('Parse_JSON')?['utm']?['campaignid'], 'N/A')} | 
                                    AdGroup ID: @{coalesce(body('Parse_JSON')?['utm']?['adgroupid'], 'N/A')}
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Keywords:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['utm']?['keyword'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Page Referrer:</td>
                                <td style="color: #333; word-break: break-all;">
                                    @{coalesce(body('Parse_JSON')?['page']?['referrer'], 'Direct')}
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Landing Page:</td>
                                <td style="color: #333; word-break: break-all;">@{coalesce(body('Parse_JSON')?['landingPage'], 'N/A')}</td>
                            </tr>
                        </tbody></table>
                    </td>
                </tr>
                
                <!-- Service & Vehicle Information -->
                <tr>
                    <td style="padding: 20px;">
                        <table cellpadding="8" cellspacing="0" border="1" style="background-color: #e1f5fe; border-color: #0288d1; font-family: Arial, sans-serif; font-size: 14px; width: 100%;">
                            <tbody><tr>
                                <td colspan="2" style="background-color: #b3e5fc; font-weight: bold; font-size: 16px; color: #333;">
                                    Service & Vehicle Information
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Service:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['service'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Service Code:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['serviceCode'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Service Title:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['serviceTitle'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Service Value:</td>
                                <td style="color: #333;">$@{div(coalesce(body('Parse_JSON')?['serviceValue'], 0), 100)}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Registration:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['rego'], coalesce(body('Parse_JSON')?['vehicleRego'], 'N/A'))}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Vehicle:</td>
                                <td style="color: #333;">
                                    @{trim(concat(coalesce(body('Parse_JSON')?['year'], ''), ' ', coalesce(body('Parse_JSON')?['make'], ''), ' ', coalesce(body('Parse_JSON')?['model'], '')))}
                                </td>
                            </tr>
                        </tbody></table>
                    </td>
                </tr>

                <!-- Page & Interaction Data -->
                <tr>
                    <td style="padding: 20px;">
                        <table cellpadding="8" cellspacing="0" border="1" style="background-color: #f3e5f5; border-color: #9c27b0; font-family: Arial, sans-serif; font-size: 14px; width: 100%;">
                            <tbody><tr>
                                <td colspan="2" style="background-color: #e1bee7; font-weight: bold; font-size: 16px; color: #333;">
                                    Page & Interaction Data
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Page Title:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['page']?['title'], 'Unknown')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">URL:</td>
                                <td style="color: #333; word-break: break-all;">@{coalesce(body('Parse_JSON')?['page']?['url'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Path:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['page']?['path'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Search Parameters:</td>
                                <td style="color: #333; word-break: break-all;">@{coalesce(body('Parse_JSON')?['page']?['search'], 'None')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Hash:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['page']?['hash'], 'None')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Domain:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['page']?['domain'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Protocol:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['page']?['protocol'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Page Type:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['pageType'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Previous Page:</td>
                                <td style="color: #333; word-break: break-all;">@{coalesce(body('Parse_JSON')?['visit']?['previousPage'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Viewport:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['page']?['viewport']?['width'], 'N/A')}x@{coalesce(body('Parse_JSON')?['page']?['viewport']?['height'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Scroll Position:</td>
                                <td style="color: #333;">
                                    X: @{coalesce(body('Parse_JSON')?['page']?['scroll']?['x'], '0')}, 
                                    Y: @{coalesce(body('Parse_JSON')?['page']?['scroll']?['y'], '0')} | 
                                    Max: @{coalesce(body('Parse_JSON')?['page']?['scroll']?['maxX'], '0')}x@{coalesce(body('Parse_JSON')?['page']?['scroll']?['maxY'], '0')}
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Page Interaction:</td>
                                <td style="color: #333;">
                                    Time on Page: @{div(coalesce(body('Parse_JSON')?['page']?['timeOnPage'], 0), 1000)}s | 
                                    Focus Time: @{div(coalesce(body('Parse_JSON')?['page']?['focusTime'], 0), 1000)}s | 
                                    Clicks: @{coalesce(body('Parse_JSON')?['page']?['clickCount'], '0')}
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Scroll Percentage:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['page']?['scrollPercentage'], '0')}%</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Load Time:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['loadTime'], coalesce(body('Parse_JSON')?['visit']?['pageLoadTime'], 'N/A'))}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Time on Current Page:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['visit']?['timeOnCurrentPage'], '0')}s</td>
                            </tr>
                        </tbody></table>
                    </td>
                </tr>

                <!-- Behavioral & Engagement Data -->
                <tr>
                    <td style="padding: 20px;">
                        <table cellpadding="8" cellspacing="0" border="1" style="background-color: #ffebee; border-color: #f44336; font-family: Arial, sans-serif; font-size: 14px; width: 100%;">
                            <tbody><tr>
                                <td colspan="2" style="background-color: #ffcdd2; font-weight: bold; font-size: 16px; color: #333;">
                                    Behavioral & Engagement Data
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Engagement Score:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['behavior']?['engagementScore'], '0')}/100</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Time to First Interaction:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['behavior']?['timeToFirstInteraction'], 'N/A')}s</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Bounce Candidate:</td>
                                <td style="color: #333;">@{if(coalesce(body('Parse_JSON')?['behavior']?['bounceCandidate'], false), 'Yes', 'No')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">First Visit:</td>
                                <td style="color: #333;">@{if(coalesce(body('Parse_JSON')?['isFirstVisit'], coalesce(body('Parse_JSON')?['visit']?['isFirstVisit'], false)), 'Yes', 'No')}</td>
                            </tr>
                        </tbody></table>
                    </td>
                </tr>

                <!-- Business Status -->
                <tr>
                    <td style="padding: 20px;">
                        <table cellpadding="8" cellspacing="0" border="1" style="background-color: #e8f5e8; border-color: #4caf50; font-family: Arial, sans-serif; font-size: 14px; width: 100%;">
                            <tbody><tr>
                                <td colspan="2" style="background-color: #c8e6c8; font-weight: bold; font-size: 16px; color: #333;">
                                    Business Status
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">System Status:</td>
                                <td style="color: #333;">@{if(coalesce(body('Parse_JSON')?['business']?['systemActive'], false), 'Active', 'Inactive')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Business Hours:</td>
                                <td style="color: #333;">
                                    During Hours: @{if(coalesce(body('Parse_JSON')?['business']?['duringBusinessHours'], false), 'Yes', 'No')} | 
                                    Local Hours: @{if(coalesce(body('Parse_JSON')?['business']?['localBusinessHours'], false), 'Yes', 'No')}
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Day of Week:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['business']?['dayOfWeek'], 'N/A')} | Weekend: @{if(coalesce(body('Parse_JSON')?['business']?['isWeekend'], false), 'Yes', 'No')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Hour of Day:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['business']?['hourOfDay'], 'N/A')}</td>
                            </tr>
                        </tbody></table>
                    </td>
                </tr>

                <!-- Device & Technical Details -->
                <tr>
                    <td style="padding: 20px;">
                        <table cellpadding="8" cellspacing="0" border="1" style="background-color: #f3e5f5; border-color: #9c27b0; font-family: Arial, sans-serif; font-size: 14px; width: 100%;">
                            <tbody><tr>
                                <td colspan="2" style="background-color: #e1bee7; font-weight: bold; font-size: 16px; color: #333;">
                                    Device & Technical Details
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">User Agent:</td>
                                <td style="color: #333; word-break: break-all; font-size: 12px;">@{coalesce(body('Parse_JSON')?['device']?['userAgent'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Platform:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['device']?['platform'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Mobile Device:</td>
                                <td style="color: #333;">@{if(coalesce(body('Parse_JSON')?['device']?['mobile'], false), 'Yes', 'No')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Touchscreen:</td>
                                <td style="color: #333;">@{if(coalesce(body('Parse_JSON')?['device']?['touchscreen'], false), 'Yes', 'No')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Screen Resolution:</td>
                                <td style="color: #333;">
                                    @{coalesce(body('Parse_JSON')?['device']?['screen']?['width'], 'N/A')}x@{coalesce(body('Parse_JSON')?['device']?['screen']?['height'], 'N/A')} | 
                                    Available: @{coalesce(body('Parse_JSON')?['device']?['screen']?['availWidth'], 'N/A')}x@{coalesce(body('Parse_JSON')?['device']?['screen']?['availHeight'], 'N/A')}
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Color Depth:</td>
                                <td style="color: #333;">
                                    @{coalesce(body('Parse_JSON')?['device']?['screen']?['colorDepth'], 'N/A')} bit | 
                                    Pixel Depth: @{coalesce(body('Parse_JSON')?['device']?['screen']?['pixelDepth'], 'N/A')} bit
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Pixel Ratio:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['device']?['screen']?['pixelRatio'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Device Orientation:</td>
                                <td style="color: #333;">
                                    Angle: @{coalesce(body('Parse_JSON')?['device']?['screen']?['orientation'], 'N/A')}
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Hardware:</td>
                                <td style="color: #333;">
                                    CPU Cores: @{coalesce(body('Parse_JSON')?['device']?['hardwareConcurrency'], 'N/A')} | 
                                    RAM: @{coalesce(body('Parse_JSON')?['device']?['deviceMemory'], 'N/A')}GB | 
                                    Touch Points: @{coalesce(body('Parse_JSON')?['device']?['maxTouchPoints'], 'N/A')}
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Browser Capabilities:</td>
                                <td style="color: #333;">
                                    Cookies: @{if(coalesce(body('Parse_JSON')?['device']?['cookieEnabled'], false), 'Yes', 'No')} | 
                                    Java: @{if(coalesce(body('Parse_JSON')?['device']?['javaEnabled'], false), 'Yes', 'No')} | 
                                    WebGL: @{if(coalesce(body('Parse_JSON')?['device']?['webgl'], false), 'Yes', 'No')} | 
                                    Online: @{if(coalesce(body('Parse_JSON')?['device']?['onLine'], false), 'Yes', 'No')}
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Browser Vendor:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['device']?['vendor'], 'N/A')} | Sub: @{coalesce(body('Parse_JSON')?['device']?['vendorSub'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Do Not Track:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['device']?['doNotTrack'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Language:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['device']?['language'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Languages:</td>
                                <td style="color: #333;">@{join(coalesce(body('Parse_JSON')?['device']?['languages'], createArray('N/A')), ', ')}</td>
                            </tr>
                        </tbody></table>
                    </td>
                </tr>

                <!-- Connection & Network Data -->
                <tr>
                    <td style="padding: 20px;">
                        <table cellpadding="8" cellspacing="0" border="1" style="background-color: #e3f2fd; border-color: #2196f3; font-family: Arial, sans-serif; font-size: 14px; width: 100%;">
                            <tbody><tr>
                                <td colspan="2" style="background-color: #bbdefb; font-weight: bold; font-size: 16px; color: #333;">
                                    Connection & Network Data
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Connection Type:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['connection']?['type'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Effective Type:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['connection']?['effectiveType'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Downlink Speed:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['connection']?['downlink'], coalesce(body('Parse_JSON')?['performance']?['connectionSpeed'], 'N/A'))} Mbps</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Round Trip Time:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['connection']?['rtt'], 'N/A')}ms</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Save Data Mode:</td>
                                <td style="color: #333;">@{if(coalesce(body('Parse_JSON')?['connection']?['saveData'], false), 'Yes', 'No')}</td>
                            </tr>
                        </tbody></table>
                    </td>
                </tr>

                <!-- Storage & Features -->
                <tr>
                    <td style="padding: 20px;">
                        <table cellpadding="8" cellspacing="0" border="1" style="background-color: #fff8e1; border-color: #ff9800; font-family: Arial, sans-serif; font-size: 14px; width: 100%;">
                            <tbody><tr>
                                <td colspan="2" style="background-color: #ffecb3; font-weight: bold; font-size: 16px; color: #333;">
                                    Storage & Browser Features
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Local Storage:</td>
                                <td style="color: #333;">@{if(coalesce(body('Parse_JSON')?['storage']?['localStorageAvailable'], coalesce(body('Parse_JSON')?['features']?['localStorage'], false)), 'Available', 'Not Available')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Session Storage:</td>
                                <td style="color: #333;">@{if(coalesce(body('Parse_JSON')?['storage']?['sessionStorageAvailable'], coalesce(body('Parse_JSON')?['features']?['sessionStorage'], false)), 'Available', 'Not Available')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Cookies:</td>
                                <td style="color: #333;">
                                    Enabled: @{if(coalesce(body('Parse_JSON')?['storage']?['cookiesEnabled'], false), 'Yes', 'No')} | 
                                    3rd Party Blocked: @{if(coalesce(body('Parse_JSON')?['storage']?['thirdPartyCookiesBlocked'], false), 'Yes', 'No')}
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Advanced Features:</td>
                                <td style="color: #333;">
                                    WebGL: @{if(coalesce(body('Parse_JSON')?['features']?['webgl'], false), 'Yes', 'No')} | 
                                    WebGL2: @{if(coalesce(body('Parse_JSON')?['features']?['webgl2'], false), 'Yes', 'No')} | 
                                    Canvas: @{if(coalesce(body('Parse_JSON')?['features']?['canvas'], false), 'Yes', 'No')}
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Modern Features:</td>
                                <td style="color: #333;">
                                    Geolocation: @{if(coalesce(body('Parse_JSON')?['features']?['geolocation'], false), 'Yes', 'No')} | 
                                    Service Worker: @{if(coalesce(body('Parse_JSON')?['features']?['serviceWorker'], false), 'Yes', 'No')} | 
                                    Push Notifications: @{if(coalesce(body('Parse_JSON')?['features']?['pushNotifications'], false), 'Yes', 'No')} | 
                                    WebAssembly: @{if(coalesce(body('Parse_JSON')?['features']?['webAssembly'], false), 'Yes', 'No')}
                                </td>
                            </tr>
                        </tbody></table>
                    </td>
                </tr>

                <!-- Performance Data -->
                <tr>
                    <td style="padding: 20px;">
                        <table cellpadding="8" cellspacing="0" border="1" style="background-color: #fce4ec; border-color: #e91e63; font-family: Arial, sans-serif; font-size: 14px; width: 100%;">
                            <tbody><tr>
                                <td colspan="2" style="background-color: #f8bbd9; font-weight: bold; font-size: 16px; color: #333;">
                                    Performance Data
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Navigation Timing:</td>
                                <td style="color: #333;">
                                    Start: @{coalesce(body('Parse_JSON')?['performance']?['navigationStart'], 'N/A')}ms | 
                                    Load End: @{coalesce(body('Parse_JSON')?['performance']?['loadEventEnd'], 'N/A')}ms
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">DOM Timing:</td>
                                <td style="color: #333;">
                                    Content Loaded: @{coalesce(body('Parse_JSON')?['performance']?['domContentLoadedEventEnd'], 'N/A')}ms | 
                                    Interactive: @{coalesce(body('Parse_JSON')?['performance']?['domInteractive'], 'N/A')}ms | 
                                    Complete: @{coalesce(body('Parse_JSON')?['performance']?['domComplete'], 'N/A')}ms
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Network Timing:</td>
                                <td style="color: #333;">
                                    DNS: @{coalesce(body('Parse_JSON')?['performance']?['timing']?['dns'], coalesce(body('Parse_JSON')?['performance']?['domainLookupStart'], 'N/A'))}ms | 
                                    Connection: @{coalesce(body('Parse_JSON')?['performance']?['timing']?['connection'], coalesce(body('Parse_JSON')?['performance']?['connectStart'], 'N/A'))}ms | 
                                    Response: @{coalesce(body('Parse_JSON')?['performance']?['timing']?['response'], coalesce(body('Parse_JSON')?['performance']?['responseStart'], 'N/A'))}ms
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Paint Timing:</td>
                                <td style="color: #333;">
                                    First Contentful Paint: @{coalesce(body('Parse_JSON')?['performance']?['firstContentfulPaint'], 'N/A')}ms | 
                                    Largest Contentful Paint: @{coalesce(body('Parse_JSON')?['performance']?['largestContentfulPaint'], 'N/A')}ms
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Load Performance:</td>
                                <td style="color: #333;">
                                    DOM Processing: @{coalesce(body('Parse_JSON')?['performance']?['timing']?['domProcessing'], 'N/A')}ms | 
                                    Total Load: @{coalesce(body('Parse_JSON')?['performance']?['timing']?['totalLoad'], 'N/A')}ms
                                </td>
                            </tr>
                        </tbody></table>
                    </td>
                </tr>

                <!-- Page-Specific Data (conditional) -->
                <tr style="@{if(empty(body('Parse_JSON')?['pageSpecific']), 'display: none;', '')}">
                    <td style="padding: 20px;">
                        <table cellpadding="8" cellspacing="0" border="1" style="background-color: #e0f2f1; border-color: #009688; font-family: Arial, sans-serif; font-size: 14px; width: 100%;">
                            <tbody><tr>
                                <td colspan="2" style="background-color: #b2dfdb; font-weight: bold; font-size: 16px; color: #333;">
                                    Page-Specific Data
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Service Selection:</td>
                                <td style="color: #333;">@{if(coalesce(body('Parse_JSON')?['pageSpecific']?['hasServiceSelection'], false), 'Available', 'Not Available')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Payment Block:</td>
                                <td style="color: #333;">@{if(coalesce(body('Parse_JSON')?['pageSpecific']?['hasPaymentBlock'], false), 'Available', 'Not Available')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Closed Banner:</td>
                                <td style="color: #333;">@{if(coalesce(body('Parse_JSON')?['pageSpecific']?['hasClosedBanner'], false), 'Yes', 'No')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Phone Links:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['pageSpecific']?['phoneLinksCount'], '0')} links</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Service Links:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['pageSpecific']?['serviceLinksCount'], '0')} links</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Logo Type:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['pageSpecific']?['logoType'], 'N/A')}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold; width: 30%; color: #555;">Tracked Elements:</td>
                                <td style="color: #333;">@{coalesce(body('Parse_JSON')?['pageSpecific']?['elementsWithTracking'], '0')} elements</td>
                            </tr>
                        </tbody></table>
                    </td>
                </tr>
                
                <!-- Action Buttons -->
                <tr>
                    <td style="padding: 20px; text-align: center; font-family: Arial, sans-serif;">
                        <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #333;">Quick Actions</h3>
                        
                        <table cellpadding="5" cellspacing="0" border="0" style="margin: 0 auto;">
                            <tbody><tr>
                                <td style="padding: 5px;">
                                    <a href="tel:@{coalesce(body('Parse_JSON')?['phone'], '')}" style="display: @{if(not(empty(body('Parse_JSON')?['phone'])), 'inline-block', 'none')}; padding: 12px 24px; background-color: #4caf50; color: white; text-decoration: none; font-weight: bold; border-radius: 4px; font-family: Arial, sans-serif;">
                                         Call Customer
                                    </a>
                                </td>
                                <td style="padding: 5px;">
                                    <a href="https://www.carjam.co.nz/car/?plate=@{coalesce(body('Parse_JSON')?['rego'], coalesce(body('Parse_JSON')?['vehicleRego'], ''))}" style="display: @{if(not(empty(coalesce(body('Parse_JSON')?['rego'], body('Parse_JSON')?['vehicleRego']))), 'inline-block', 'none')}; padding: 12px 24px; background-color: #2196f3; color: white; text-decoration: none; font-weight: bold; border-radius: 4px; font-family: Arial, sans-serif;">
                                         CarJam Lookup
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 5px;">
                                    <a href="https://ads.google.com/aw/conversions@{if(not(empty(body('Parse_JSON')?['gclid'])), concat('?gclid=', body('Parse_JSON')?['gclid']), '')}" style="display: inline-block; padding: 12px 24px; background-color: #ff5722; color: white; text-decoration: none; font-weight: bold; border-radius: 4px; font-family: Arial, sans-serif;">
                                         Google Ads
                                    </a>
                                </td>
                                <td style="padding: 5px;">
                                    <a href="mailto:@{coalesce(body('Parse_JSON')?['email'], '')}" style="display: @{if(not(empty(body('Parse_JSON')?['email'])), 'inline-block', 'none')}; padding: 12px 24px; background-color: #9c27b0; color: white; text-decoration: none; font-weight: bold; border-radius: 4px; font-family: Arial, sans-serif;">
                                         Email Customer
                                    </a>
                                </td>
                            </tr>
                        </tbody></table>
                    </td>
                </tr>
                
                <!-- Footer -->
                <tr>
                    <td style="background-color: #f8f9fa; padding: 15px; text-align: center; font-size: 12px; color: #666; border-top: 1px solid #dee2e6; font-family: Arial, sans-serif;">
                        <div style="font-weight: bold; margin-bottom: 5px;">Eek Mobile Mechanical - Complete Tracking Report</div>
                        <div style="margin-bottom: 5px;">Auto-generated from Power Automate | @{formatDateTime(utcNow(), 'dd/MM/yyyy HH:mm')} NZT</div>
                        <div style="font-size: 11px;">
                            Session: @{coalesce(body('Parse_JSON')?['sessionId'], 'Unknown')} | 
                            Event Sequence: @{coalesce(body('Parse_JSON')?['eventSequence'], 'N/A')} | 
                            Source: @{coalesce(body('Parse_JSON')?['utm']?['utm_source'], 'Direct')} | 
                            GCLID: @{if(coalesce(body('Parse_JSON')?['hasCurrentGclid'], false), 'Active', 'None')}
                        </div>
                        <div style="font-size: 10px; margin-top: 5px; opacity: 0.7;">
                            Fixed template - handles location object properly
                        </div>
                    </td>
                </tr>
                
            </tbody></table>
        </td>
    </tr>
</tbody></table>
