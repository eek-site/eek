[1mdiff --git a/book-service/index.html b/book-service/index.html[m
[1mindex 2034ffd..150f0fe 100644[m
[1m--- a/book-service/index.html[m
[1m+++ b/book-service/index.html[m
[36m@@ -546,6 +546,175 @@[m [mlet selectedEmergencyType = null;[m
 let calculatedPrice = null;[m
 let winzQuoteGenerated = false;[m
 [m
[32m+[m[32m// === STEP COMPLETION TRACKING (Security Safeguard) ===[m
[32m+[m[32mlet stepCompletionState = {[m
[32m+[m[32m  step1Completed: false,[m
[32m+[m[32m  step2Completed: false,[m
[32m+[m[32m  step3Active: false,[m
[32m+[m[32m  step1Timestamp: null,[m
[32m+[m[32m  step2Timestamp: null,[m
[32m+[m[32m  step3Timestamp: null,[m
[32m+[m[32m  validationToken: null[m
[32m+[m[32m};[m
[32m+[m
[32m+[m[32m// Persist step completion state to localStorage (allows customers to resume)[m
[32m+[m[32mfunction saveStepCompletionState() {[m
[32m+[m[32m  try {[m
[32m+[m[32m    localStorage.setItem('eek_booking_step_state', JSON.stringify(stepCompletionState));[m
[32m+[m[32m    console.log('üíæ Step completion state saved to localStorage');[m
[32m+[m[32m  } catch (e) {[m
[32m+[m[32m    console.warn('‚ö†Ô∏è Could not save step state to localStorage:', e);[m
[32m+[m[32m  }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// Restore step completion state from localStorage (for returning customers)[m
[32m+[m[32mfunction restoreStepCompletionState() {[m
[32m+[m[32m  try {[m
[32m+[m[32m    const saved = localStorage.getItem('eek_booking_step_state');[m
[32m+[m[32m    if (saved) {[m
[32m+[m[32m      const parsed = JSON.parse(saved);[m
[32m+[m[32m      // Only restore if it's recent (within 24 hours) to prevent stale state[m
[32m+[m[32m      const maxAge = 24 * 60 * 60 * 1000; // 24 hours[m
[32m+[m[32m      const oldestTimestamp = Math.min([m
[32m+[m[32m        parsed.step1Timestamp ? new Date(parsed.step1Timestamp).getTime() : Date.now(),[m
[32m+[m[32m        parsed.step2Timestamp ? new Date(parsed.step2Timestamp).getTime() : Date.now(),[m
[32m+[m[32m        parsed.step3Timestamp ? new Date(parsed.step3Timestamp).getTime() : Date.now()[m
[32m+[m[32m      );[m
[32m+[m[41m      [m
[32m+[m[32m      if (Date.now() - oldestTimestamp < maxAge) {[m
[32m+[m[32m        stepCompletionState = { ...stepCompletionState, ...parsed };[m
[32m+[m[32m        console.log('‚úÖ Step completion state restored from localStorage');[m
[32m+[m[32m        return true;[m
[32m+[m[32m      } else {[m
[32m+[m[32m        console.log('‚ö†Ô∏è Saved step state expired, clearing');[m
[32m+[m[32m        localStorage.removeItem('eek_booking_step_state');[m
[32m+[m[32m      }[m
[32m+[m[32m    }[m
[32m+[m[32m  } catch (e) {[m
[32m+[m[32m    console.warn('‚ö†Ô∏è Could not restore step state from localStorage:', e);[m
[32m+[m[32m  }[m
[32m+[m[32m  return false;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// Clear step completion state (when booking is completed or abandoned)[m
[32m+[m[32mfunction clearStepCompletionState() {[m
[32m+[m[32m  stepCompletionState = {[m
[32m+[m[32m    step1Completed: false,[m
[32m+[m[32m    step2Completed: false,[m
[32m+[m[32m    step3Active: false,[m
[32m+[m[32m    step1Timestamp: null,[m
[32m+[m[32m    step2Timestamp: null,[m
[32m+[m[32m    step3Timestamp: null,[m
[32m+[m[32m    validationToken: null[m
[32m+[m[32m  };[m
[32m+[m[32m  localStorage.removeItem('eek_booking_step_state');[m
[32m+[m[32m  console.log('üóëÔ∏è Step completion state cleared');[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// Generate a validation token when step 3 is reached[m
[32m+[m[32mfunction generateValidationToken() {[m
[32m+[m[32m  const timestamp = Date.now();[m
[32m+[m[32m  const random = Math.random().toString(36).substr(2, 9);[m
[32m+[m[32m  const data = `${timestamp}-${random}-${sessionId || 'unknown'}`;[m
[32m+[m[32m  // Simple hash for token (not cryptographically secure, but prevents casual bypass)[m
[32m+[m[32m  let hash = 0;[m
[32m+[m[32m  for (let i = 0; i < data.length; i++) {[m
[32m+[m[32m    const char = data.charCodeAt(i);[m
[32m+[m[32m    hash = ((hash << 5) - hash) + char;[m
[32m+[m[32m    hash = hash & hash; // Convert to 32bit integer[m
[32m+[m[32m  }[m
[32m+[m[32m  return `token_${Math.abs(hash).toString(36)}_${timestamp}`;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// Validate that all required steps have been completed[m
[32m+[m[32m// This is more flexible - allows customers who started the process to continue[m
[32m+[m[32mfunction validateStepCompletion() {[m
[32m+[m[32m  const errors = [];[m
[32m+[m[41m  [m
[32m+[m[32m  // Check if we have valid form data (this is the real validation)[m
[32m+[m[32m  // If form is complete, we allow payment even if step state was lost[m
[32m+[m[32m  const hasValidFormData = validateRequiredFields().valid;[m
[32m+[m[41m  [m
[32m+[m[32m  // If form data is valid, we're more lenient about step state[m
[32m+[m[32m  // This allows customers to resume their booking[m
[32m+[m[32m  if (hasValidFormData) {[m
[32m+[m[32m    // Still check that urgency was selected (critical for pricing)[m
[32m+[m[32m    if (!selectedUrgency) {[m
[32m+[m[32m      errors.push('Service time/urgency must be selected');[m
[32m+[m[32m    }[m
[32m+[m[41m    [m
[32m+[m[32m    // If Step 3 is visible and active, that's good enough[m
[32m+[m[32m    const step3Element = document.getElementById('step3');[m
[32m+[m[32m    if (step3Element && step3Element.classList.contains('active')) {[m
[32m+[m[32m      // If we're on step 3 with valid data, allow it[m
[32m+[m[32m      // But we still want to ensure they went through the flow[m
[32m+[m[32m      if (!stepCompletionState.step1Completed && !stepCompletionState.step2Completed) {[m
[32m+[m[32m        // If no step state at all, they might be trying to bypass[m
[32m+[m[32m        // But if form data is complete, they likely filled it out properly[m
[32m+[m[32m        console.log('‚ö†Ô∏è No step state found, but form data is valid - allowing with caution');[m
[32m+[m[32m      }[m
[32m+[m[32m    } else {[m
[32m+[m[32m      errors.push('Please complete all booking steps before generating payment');[m
[32m+[m[32m    }[m
[32m+[m[32m  } else {[m
[32m+[m[32m    // If form data is incomplete, be strict about step completion[m
[32m+[m[32m    if (!stepCompletionState.step1Completed) {[m
[32m+[m[32m      errors.push('Step 1 (Service Details) has not been completed');[m
[32m+[m[32m    }[m
[32m+[m[41m    [m
[32m+[m[32m    if (!stepCompletionState.step2Completed) {[m
[32m+[m[32m      errors.push('Step 2 (Scheduling) has not been completed');[m
[32m+[m[32m    }[m
[32m+[m[41m    [m
[32m+[m[32m    if (!stepCompletionState.step3Active) {[m
[32m+[m[32m      errors.push('Step 3 (Confirmation) is not active');[m
[32m+[m[32m    }[m
[32m+[m[32m  }[m
[32m+[m[41m  [m
[32m+[m[32m  return {[m
[32m+[m[32m    valid: errors.length === 0,[m
[32m+[m[32m    errors: errors[m
[32m+[m[32m  };[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// Validate all required form fields are filled[m
[32m+[m[32mfunction validateRequiredFields() {[m
[32m+[m[32m  const errors = [];[m
[32m+[m[41m  [m
[32m+[m[32m  const name = document.getElementById('nameInput')?.value?.trim();[m
[32m+[m[32m  const phone = document.getElementById('phoneInput')?.value?.trim();[m
[32m+[m[32m  const email = document.getElementById('emailInput')?.value?.trim();[m
[32m+[m[32m  const location = document.getElementById('locationInput')?.value?.trim();[m
[32m+[m[32m  const rego = sanitizeRego(document.getElementById('regoInput')?.value || '');[m
[32m+[m[32m  const year = document.getElementById('yearInput')?.value?.trim();[m
[32m+[m[32m  const make = document.getElementById('makeInput')?.value?.trim();[m
[32m+[m[32m  const model = document.getElementById('modelInput')?.value?.trim();[m
[32m+[m[41m  [m
[32m+[m[32m  if (!name) errors.push('Full name is required');[m
[32m+[m[32m  if (!phone || phone.replace(/\D/g,'').length < 9) errors.push('Valid phone number is required (at least 9 digits)');[m
[32m+[m[32m  if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) errors.push('Valid email address is required');[m
[32m+[m[32m  if (!location) errors.push('Service location is required');[m
[32m+[m[32m  if (!rego) errors.push('Vehicle registration is required');[m
[32m+[m[32m  if (!year || year.replace(/\D/g,'').length !== 4) errors.push('Valid 4-digit vehicle year is required');[m
[32m+[m[32m  if (!make) errors.push('Vehicle make is required');[m
[32m+[m[32m  if (!model) errors.push('Vehicle model is required');[m
[32m+[m[41m  [m
[32m+[m[32m  // Check urgency/time selection[m
[32m+[m[32m  if (!selectedUrgency) {[m
[32m+[m[32m    errors.push('Service time/urgency must be selected');[m
[32m+[m[32m  }[m
[32m+[m[41m  [m
[32m+[m[32m  // WINZ-specific validation[m
[32m+[m[32m  if (window.currentConfig?.isWinz && !selectedEmergencyType) {[m
[32m+[m[32m    errors.push('Emergency type must be selected');[m
[32m+[m[32m  }[m
[32m+[m[41m  [m
[32m+[m[32m  return {[m
[32m+[m[32m    valid: errors.length === 0,[m
[32m+[m[32m    errors: errors[m
[32m+[m[32m  };[m
[32m+[m[32m}[m
[32m+[m
 function sanitizePhone(val){ return (val || '').replace(/\D/g,''); }[m
 function sanitizeRego(val){ return (val || '').toUpperCase().replace(/[^A-Z0-9]/g,''); }[m
 function sanitizeText(val){ return (val || '').trim().replace(/\s+/g,' '); }[m
[36m@@ -808,9 +977,64 @@[m [mdocument.addEventListener('DOMContentLoaded', function(){[m
   }[m
   [m
   loadServiceConfig(service);[m
[32m+[m[41m  [m
[32m+[m[32m  // Restore booking state for returning customers[m
[32m+[m[32m  restoreBookingState();[m
[32m+[m[41m  [m
   sendBookingUpdate(BOOKING_STATUS.INITIAL);[m
 });[m
 [m
[32m+[m[32m// Restore booking state and form data for returning customers[m
[32m+[m[32mfunction restoreBookingState() {[m
[32m+[m[32m  console.log('üîÑ Checking for saved booking state...');[m
[32m+[m[41m  [m
[32m+[m[32m  // Restore step completion state[m
[32m+[m[32m  const stateRestored = restoreStepCompletionState();[m
[32m+[m[41m  [m
[32m+[m[32m  // Restore form field values from visitor data[m
[32m+[m[32m  const visitorData = getVisitorData();[m
[32m+[m[32m  if (visitorData && Object.keys(visitorData).length > 0) {[m
[32m+[m[32m    console.log('üìã Restoring form data from previous session...');[m
[32m+[m[41m    [m
[32m+[m[32m    if (visitorData.name && document.getElementById('nameInput')) {[m
[32m+[m[32m      document.getElementById('nameInput').value = visitorData.name;[m
[32m+[m[32m    }[m
[32m+[m[32m    if (visitorData.phone && document.getElementById('phoneInput')) {[m
[32m+[m[32m      document.getElementById('phoneInput').value = visitorData.phone;[m
[32m+[m[32m    }[m
[32m+[m[32m    if (visitorData.email && document.getElementById('emailInput')) {[m
[32m+[m[32m      document.getElementById('emailInput').value = visitorData.email;[m
[32m+[m[32m    }[m
[32m+[m[41m    [m
[32m+[m[32m    console.log('‚úÖ Form data restored (partial)');[m
[32m+[m[32m  }[m
[32m+[m[41m  [m
[32m+[m[32m  // If customer was on Step 3, restore their progress[m
[32m+[m[32m  if (stateRestored && stepCompletionState.step3Active) {[m
[32m+[m[32m    console.log('üîÑ Customer was on Step 3 - attempting to restore...');[m
[32m+[m[41m    [m
[32m+[m[32m    // Restore urgency selection if we can determine it[m
[32m+[m[32m    // Note: We can't fully restore Step 2 state without more data,[m
[32m+[m[32m    // but we can at least allow them to continue if form is complete[m
[32m+[m[41m    [m
[32m+[m[32m    // Check if form has enough data to proceed[m
[32m+[m[32m    const name = document.getElementById('nameInput')?.value?.trim();[m
[32m+[m[32m    const phone = document.getElementById('phoneInput')?.value?.trim();[m
[32m+[m[32m    const email = document.getElementById('emailInput')?.value?.trim();[m
[32m+[m[32m    const location = document.getElementById('locationInput')?.value?.trim();[m
[32m+[m[41m    [m
[32m+[m[32m    if (name && phone && email && location) {[m
[32m+[m[32m      console.log('‚úÖ Form appears complete - customer can continue from Step 3');[m
[32m+[m[32m      // Don't auto-advance, but allow them to proceed if they click through[m
[32m+[m[32m    } else {[m
[32m+[m[32m      console.log('‚ö†Ô∏è Form incomplete - customer will need to complete steps');[m
[32m+[m[32m      // Reset state if form is too incomplete[m
[32m+[m[32m      stepCompletionState.step3Active = false;[m
[32m+[m[32m      stepCompletionState.validationToken = null;[m
[32m+[m[32m    }[m
[32m+[m[32m  }[m
[32m+[m[32m}[m
[32m+[m
 function loadServiceConfig(serviceType){[m
   const config = serviceConfigs[serviceType] || serviceConfigs['fuel-extraction'];[m
   [m
[36m@@ -925,6 +1149,14 @@[m [mfunction goToStep1(){[m
   document.getElementById('step1').classList.add('active');[m
   document.querySelectorAll('.progress-step').forEach(el => el.classList.remove('active','completed'));[m
   document.getElementById('step1-progress').classList.add('active');[m
[32m+[m[41m  [m
[32m+[m[32m  // Reset step 3 state if going back (but keep step 1 & 2 completion)[m
[32m+[m[32m  if (stepCompletionState.step3Active) {[m
[32m+[m[32m    stepCompletionState.step3Active = false;[m
[32m+[m[32m    stepCompletionState.validationToken = null;[m
[32m+[m[32m    saveStepCompletionState(); // Persist updated state[m
[32m+[m[32m    console.log('‚ö†Ô∏è Step 3 state reset - validation token cleared');[m
[32m+[m[32m  }[m
 }[m
 [m
 async function goToStep2(){[m
[36m@@ -1015,6 +1247,12 @@[m [masync function goToStep2(){[m
   document.getElementById('step1-progress').classList.add('completed');[m
   document.getElementById('step1-progress').classList.remove('active');[m
   document.getElementById('step2-progress').classList.add('active');[m
[32m+[m[41m  [m
[32m+[m[32m  // Mark Step 1 as completed[m
[32m+[m[32m  stepCompletionState.step1Completed = true;[m
[32m+[m[32m  stepCompletionState.step1Timestamp = new Date().toISOString();[m
[32m+[m[32m  saveStepCompletionState(); // Persist to localStorage[m
[32m+[m[32m  console.log('‚úÖ Step 1 marked as completed');[m
 [m
   // Scroll to step 2 with proper alignment[m
   setTimeout(() => {[m
[36m@@ -1128,6 +1366,15 @@[m [masync function goToStep3(){[m
   document.getElementById('step2-progress').classList.remove('active');[m
   document.getElementById('step3-progress').classList.add('active');[m
 [m
[32m+[m[32m  // Mark Step 2 as completed and Step 3 as active[m
[32m+[m[32m  stepCompletionState.step2Completed = true;[m
[32m+[m[32m  stepCompletionState.step2Timestamp = new Date().toISOString();[m
[32m+[m[32m  stepCompletionState.step3Active = true;[m
[32m+[m[32m  stepCompletionState.step3Timestamp = new Date().toISOString();[m
[32m+[m[32m  stepCompletionState.validationToken = generateValidationToken();[m
[32m+[m[32m  saveStepCompletionState(); // Persist to localStorage[m
[32m+[m[32m  console.log('‚úÖ Step 2 marked as completed, Step 3 activated with validation token');[m
[32m+[m
   updateSummary();[m
 }[m
 [m
[36m@@ -1240,10 +1487,89 @@[m [mfunction buildRedirectUrl(){[m
 [m
 async function generatePaymentLink(){[m
   const btn = document.getElementById('generatePaymentBtn');[m
[31m-  if (!document.getElementById('termsAgree').checked){[m
[32m+[m[41m  [m
[32m+[m[32m  // === COMPREHENSIVE VALIDATION SAFEGUARDS ===[m
[32m+[m[32m  console.log('üîí Payment generation validation starting...');[m
[32m+[m[41m  [m
[32m+[m[32m  // 0. Verify button exists and is enabled (prevents direct console calls)[m
[32m+[m[32m  if (!btn) {[m
[32m+[m[32m    console.error('‚ùå Payment button not found');[m
[32m+[m[32m    alert('Payment button not available. Please use the booking form.');[m
[32m+[m[32m    return;[m
[32m+[m[32m  }[m
[32m+[m[41m  [m
[32m+[m[32m  if (btn.disabled && !btn.classList.contains('processing')) {[m
[32m+[m[32m    console.error('‚ùå Payment button is disabled');[m
[32m+[m[32m    alert('Please complete all required steps and accept terms before generating payment link.');[m
[32m+[m[32m    return;[m
[32m+[m[32m  }[m
[32m+[m[41m  [m
[32m+[m[32m  // 1. Check terms acceptance[m
[32m+[m[32m  const termsCheckbox = document.getElementById('termsAgree');[m
[32m+[m[32m  if (!termsCheckbox || !termsCheckbox.checked){[m
     alert('Please accept the terms and conditions');[m
[32m+[m[32m    console.warn('‚ùå Validation failed: Terms not accepted');[m
     return;[m
   }[m
[32m+[m[41m  [m
[32m+[m[32m  // 2. Validate step completion (flexible for returning customers)[m
[32m+[m[32m  const stepValidation = validateStepCompletion();[m
[32m+[m[32m  if (!stepValidation.valid) {[m
[32m+[m[32m    console.error('‚ùå Step completion validation failed:', stepValidation.errors);[m
[32m+[m[32m    // More helpful message for returning customers[m
[32m+[m[32m    const errorMsg = stepValidation.errors.length > 0[m[41m [m
[32m+[m[32m      ? 'Please complete the following:\n\n' + stepValidation.errors.join('\n')[m
[32m+[m[32m      : 'Please complete all booking steps before generating payment link.';[m
[32m+[m[32m    alert(errorMsg);[m
[32m+[m[32m    return;[m
[32m+[m[32m  }[m
[32m+[m[41m  [m
[32m+[m[32m  // 3. Validate all required fields[m
[32m+[m[32m  const fieldValidation = validateRequiredFields();[m
[32m+[m[32m  if (!fieldValidation.valid) {[m
[32m+[m[32m    console.error('‚ùå Field validation failed:', fieldValidation.errors);[m
[32m+[m[32m    alert('Please complete all required fields:\n\n' + fieldValidation.errors.join('\n'));[m
[32m+[m[32m    return;[m
[32m+[m[32m  }[m
[32m+[m[41m  [m
[32m+[m[32m  // 4. Verify Step 3 is actually visible and active (or allow if form is complete)[m
[32m+[m[32m  const step3Element = document.getElementById('step3');[m
[32m+[m[32m  const isStep3Active = step3Element && step3Element.classList.contains('active');[m
[32m+[m[41m  [m
[32m+[m[32m  if (!isStep3Active) {[m
[32m+[m[32m    // If Step 3 is not active but form is complete, allow them to proceed[m
[32m+[m[32m    // This helps returning customers who may have lost UI state[m
[32m+[m[32m    if (fieldValidation.valid && selectedUrgency) {[m
[32m+[m[32m      console.log('‚ö†Ô∏è Step 3 not active, but form is complete - allowing payment generation');[m
[32m+[m[32m      // Auto-advance to Step 3 for them[m
[32m+[m[32m      goToStep3();[m
[32m+[m[32m      // Small delay to let UI update[m
[32m+[m[32m      await new Promise(resolve => setTimeout(resolve, 100));[m
[32m+[m[32m    } else {[m
[32m+[m[32m      console.error('‚ùå Step 3 not active and form incomplete');[m
[32m+[m[32m      alert('Please complete all booking steps before generating payment link.');[m
[32m+[m[32m      return;[m
[32m+[m[32m    }[m
[32m+[m[32m  }[m
[32m+[m[41m  [m
[32m+[m[32m  // 5. Verify urgency/time was selected[m
[32m+[m[32m  if (!selectedUrgency) {[m
[32m+[m[32m    console.error('‚ùå No urgency/time selected');[m
[32m+[m[32m    alert('Please select a service time before generating payment link.');[m
[32m+[m[32m    return;[m
[32m+[m[32m  }[m
[32m+[m[41m  [m
[32m+[m[32m  // 6. Verify price is valid[m
[32m+[m[32m  const totalPrice = getTotalPrice();[m
[32m+[m[32m  if (!totalPrice || totalPrice <= 0) {[m
[32m+[m[32m    console.error('‚ùå Invalid price:', totalPrice);[m
[32m+[m[32m    alert('Invalid service price. Please refresh and try again.');[m
[32m+[m[32m    return;[m
[32m+[m[32m  }[m
[32m+[m[41m  [m
[32m+[m[32m  console.log('‚úÖ All validation checks 