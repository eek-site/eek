<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact EEK Mechanical - Customer Reply</title>
    <meta name="description" content="Send us a message about your vehicle service. Eek Mechanical - Professional mobile mechanics across New Zealand.">
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com https://www.redditstatic.com https://googleads.g.doubleclick.net https://static.cloudflareinsights.com;
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: https:;
        connect-src 'self' https://www.google-analytics.com https://www.redditstatic.com https://pixel-config.reddit.com https://conversions-config.reddit.com https://www.googletagmanager.com https://googleads.g.doubleclick.net https://www.google.com https://www.googleadservices.com https://www.google.hn https://www.eek.nz https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com https://static.cloudflareinsights.com;
        frame-src 'self' https://td.doubleclick.net https://www.googletagmanager.com;
        font-src 'self' data:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">

    <!-- Reddit Pixel -->
    <script>
        !function(w,d){if(!w.rdt){var p=w.rdt=function(){p.sendEvent?p.sendEvent.apply(p,arguments):p.callQueue.push(arguments)};p.callQueue=[];var t=d.createElement("script");t.src="https://www.redditstatic.com/ads/pixel.js",t.async=!0;var s=d.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}}
        (window,document);
        
        function getEmailFromForm() {
            const urlParams = new URLSearchParams(window.location.search);
            const emailParam = urlParams.get('email');
            if (emailParam) return emailParam;
            
            const emailInputs = document.querySelectorAll('input[type="email"], input[name*="email"], input[id*="email"]');
            for (let input of emailInputs) {
                if (input.value && input.value.includes('@')) {
                    return input.value;
                }
            }
            return null;
        }
        
        function getPhoneFromForm() {
            const urlParams = new URLSearchParams(window.location.search);
            const phoneParam = urlParams.get('phone');
            if (phoneParam) return phoneParam;
            
            const phoneInputs = document.querySelectorAll('input[type="tel"], input[name*="phone"], input[id*="phone"]');
            for (let input of phoneInputs) {
                if (input.value) {
                    return input.value;
                }
            }
            return null;
        }
        
        function getUserId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('uid') || urlParams.get('user_id') || urlParams.get('customer_id');
        }
        
        function getMobileIds() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                idfa: urlParams.get('idfa'),
                aaid: urlParams.get('aaid')
            };
        }
        
        const mobileIds = getMobileIds();
        const initConfig = {};
        
        const email = getEmailFromForm();
        const phoneNumber = getPhoneFromForm();
        const externalId = getUserId();
        
        if (email) initConfig.email = email;
        if (phoneNumber) initConfig.phoneNumber = phoneNumber;
        if (externalId) initConfig.externalId = externalId;
        if (mobileIds.idfa) initConfig.idfa = mobileIds.idfa;
        if (mobileIds.aaid) initConfig.aaid = mobileIds.aaid;
        
        rdt('init', 'a2_hf16791nsdhx', Object.keys(initConfig).length > 0 ? initConfig : undefined);
        rdt('track', 'PageVisit');
    </script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17084465163"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'AW-17084465163');
        gtag('config', 'G-DQNKF1YLWR');
    </script>
    
    <!-- Centralized Phone Number Management -->
    <script src="/phone-manager.js?v=20251020.39"></script>
    
    <!-- Unified Tracking System -->
    <script src="/unified-tracking.js?v=20251020.39"></script>
    
    <!-- Centralized Footer Management -->
    <script src="/footer-new.js?v=20251020.39"></script>

    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <style>
        :root {
            /* Brand Colors - Matching EEK Design System */
            --primary: #ff5500;
            --primary-light: #ff7733;
            --primary-dark: #e04400;
            --secondary: #28a745;
            --secondary-light: #20c997;
            --accent: #17a2b8;
            --danger: #dc3545;
            --warning: #ffc107;
            --success: #28a745;
            
            /* Neutral Colors */
            --white: #ffffff;
            --gray-50: #f8f9fa;
            --gray-100: #f5f5f5;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            
            /* Typography */
            --font-primary: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            
            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            /* Transitions */
            --transition-fast: 150ms ease-in-out;
            --transition-normal: 300ms ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            line-height: 1.6;
            color: var(--gray-900);
            background: var(--gray-100);
            min-height: 100vh;
            padding: var(--space-lg);
        }

        /* Header Styles - Matching EEK Brand */
        header {
            background: var(--white);
            padding: var(--space-xl);
            max-width: 800px;
            margin: 0 auto var(--space-xl);
            text-align: center;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }

        header img {
            max-width: 300px;
            height: auto;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-md);
        }

        .business-name {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary);
            margin: var(--space-sm) 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 1.8em;
            margin: var(--space-md) 0 var(--space-sm);
            color: var(--gray-900);
        }

        header .tagline {
            font-size: 1.2em;
            color: var(--gray-600);
        }

        /* Container */
        .container {
            max-width: 700px;
            margin: 0 auto;
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }

        .header-section {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            padding: var(--space-2xl);
            text-align: center;
        }

        .header-section h1 {
            font-size: 2em;
            margin-bottom: var(--space-sm);
            color: var(--white);
        }

        .header-section p {
            opacity: 0.95;
            font-size: 1.1em;
        }

        .form-container {
            padding: var(--space-2xl);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: var(--space-xl);
        }

        label {
            display: block;
            margin-bottom: var(--space-sm);
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.95em;
        }

        input, select, textarea {
            width: 100%;
            padding: var(--space-md);
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: var(--font-primary);
            transition: border-color var(--transition-normal);
            background: var(--white);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 85, 0, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .required {
            color: var(--danger);
            margin-left: 2px;
        }

        .info-text {
            font-size: 0.875rem;
            color: var(--gray-500);
            margin-top: var(--space-xs);
        }

        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: var(--space-sm);
            margin-bottom: var(--space-xl);
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-top: 4px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        /* Button Styles - Matching EEK Design */
        .submit-btn {
            background: var(--primary);
            color: var(--white);
            padding: var(--space-md) var(--space-xl);
            border: none;
            border-radius: var(--radius-md);
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-md);
        }

        .submit-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            background: var(--gray-400);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Message Styles */
        .success-message, .error-message {
            padding: var(--space-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-xl);
            display: none;
            border-left: 4px solid;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            border-color: var(--success);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border-color: var(--danger);
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: var(--space-lg);
        }

        .spinner {
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--space-md);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Section Dividers */
        .section-divider {
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 2px;
            margin: var(--space-xl) 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: var(--space-md);
            }

            .container {
                border-radius: var(--radius-md);
            }

            .header-section {
                padding: var(--space-xl);
            }

            .header-section h1 {
                font-size: 1.5em;
            }

            .form-container {
                padding: var(--space-xl);
            }

            .business-name {
                font-size: 2em;
            }

            header {
                padding: var(--space-lg);
            }
        }

        /* Input Validation Styles */
        input:invalid:not(:placeholder-shown),
        select:invalid:not(:placeholder-shown),
        textarea:invalid:not(:placeholder-shown) {
            border-color: var(--danger);
        }

        input:valid:not(:placeholder-shown),
        select:valid:not(:placeholder-shown),
        textarea:valid:not(:placeholder-shown) {
            border-color: var(--success);
        }
    </style>
</head>
<body>
    <header>
        <img id="headerImage" src="/brand-image.png" alt="Eek Mechanical - Mobile Mechanics NZ" onerror="this.style.display='none'">
        <div class="business-name">Eek Mechanical</div>
        <h1>Customer Contact Form</h1>
        <p class="tagline">Send us a message about your vehicle service</p>
    </header>

    <div class="container">
        <div class="header-section">
            <h1>Get in Touch</h1>
            <p>We're here to help with all your vehicle service needs</p>
        </div>

        <div class="form-container">
            <div class="success-message" id="successMessage">
                <strong>Thank you!</strong> Your message has been sent successfully. We'll get back to you soon.
            </div>
            
            <div class="error-message" id="errorMessage">
                <strong>Sorry,</strong> there was an error sending your message. Please try again or call us directly.
            </div>
            
            <form id="customerReplyForm">
                <!-- Vehicle Information Section -->
                <div class="section-divider"></div>
                <h2 style="color: var(--primary); margin-bottom: var(--space-lg); font-size: 1.3em;">Vehicle Information</h2>
                
                <div class="form-group">
                    <label for="rego">Vehicle Registration <span class="required">*</span></label>
                    <input type="text" id="rego" name="rego" required placeholder="e.g., ABC123" autocomplete="off" autocapitalize="characters" style="text-transform: uppercase;">
                    <div class="info-text">Enter your vehicle's registration number</div>
                </div>
                
                <div class="form-group">
                    <label for="vehicleMake">Vehicle Make</label>
                    <input type="text" id="vehicleMake" name="vehicleMake" placeholder="e.g., Toyota">
                </div>
                
                <div class="form-group">
                    <label for="vehicleModel">Vehicle Model</label>
                    <input type="text" id="vehicleModel" name="vehicleModel" placeholder="e.g., Camry">
                </div>
                
                <div class="form-group">
                    <label for="vehicleYear">Vehicle Year</label>
                    <input type="text" id="vehicleYear" name="vehicleYear" placeholder="e.g., 2020" maxlength="4" pattern="\d{4}" inputmode="numeric">
                </div>
                
                <!-- Customer Information Section -->
                <div class="section-divider"></div>
                <h2 style="color: var(--primary); margin-bottom: var(--space-lg); font-size: 1.3em;">Your Information</h2>
                
                <div class="form-group">
                    <label for="customerName">Your Name <span class="required">*</span></label>
                    <input type="text" id="customerName" name="customerName" required placeholder="Full name" autocomplete="name">
                </div>
                
                <div class="form-group">
                    <label for="email">Email Address <span class="required">*</span></label>
                    <input type="email" id="email" name="email" required placeholder="your.email@example.com" autocomplete="email">
                </div>
                
                <div class="form-group">
                    <label for="phone">Phone Number <span class="required">*</span></label>
                    <input type="tel" id="phone" name="phone" required placeholder="+64 21 123 4567" autocomplete="tel">
                </div>
                
                <div class="form-group">
                    <label for="preferredContact">Preferred Contact Method</label>
                    <select id="preferredContact" name="preferredContact">
                        <option value="email">Email</option>
                        <option value="phone">Phone Call</option>
                        <option value="text">Text Message</option>
                        <option value="any">Any Method</option>
                    </select>
                </div>
                
                <!-- Message Details Section -->
                <div class="section-divider"></div>
                <h2 style="color: var(--primary); margin-bottom: var(--space-lg); font-size: 1.3em;">Message Details</h2>
                
                <div class="form-group">
                    <label for="messageType">Message Type <span class="required">*</span></label>
                    <select id="messageType" name="messageType" required>
                        <option value="">Select a type...</option>
                        <option value="booking">New Booking Request</option>
                        <option value="update">Update on Current Service</option>
                        <option value="inquiry">General Inquiry</option>
                        <option value="quote">Quote Request</option>
                        <option value="feedback">Feedback</option>
                        <option value="complaint">Complaint</option>
                        <option value="urgent">Urgent Issue</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="message">Your Message <span class="required">*</span></label>
                    <textarea id="message" name="message" required placeholder="Please describe what you need help with..."></textarea>
                </div>
                
                <!-- Additional Information Section -->
                <div class="section-divider"></div>
                <h2 style="color: var(--primary); margin-bottom: var(--space-lg); font-size: 1.3em;">Additional Information</h2>
                
                <div class="form-group">
                    <label for="serviceLocation">Preferred Service Location</label>
                    <input type="text" id="serviceLocation" name="serviceLocation" placeholder="e.g., Auckland CBD, Home address" autocomplete="street-address">
                </div>
                
                <div class="form-group">
                    <label for="urgency">Urgency Level</label>
                    <select id="urgency" name="urgency">
                        <option value="normal">Normal - Within a week</option>
                        <option value="soon">Soon - Within 2-3 days</option>
                        <option value="urgent">Urgent - Within 24 hours</option>
                        <option value="emergency">Emergency - ASAP</option>
                    </select>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="allowMarketing" name="allowMarketing">
                    <label for="allowMarketing">I'd like to receive service reminders and special offers</label>
                </div>
                
                <!-- Hidden fields for tracking -->
                <input type="hidden" id="timestamp" name="timestamp">
                <input type="hidden" id="timezone" name="timezone">
                <input type="hidden" id="userAgent" name="userAgent">
                <input type="hidden" id="referrer" name="referrer">
                <input type="hidden" id="screenResolution" name="screenResolution">
                <input type="hidden" id="language" name="language">
                <input type="hidden" id="platform" name="platform">
                <input type="hidden" id="sessionId" name="sessionId">
                <input type="hidden" id="gclid" name="gclid">
                <input type="hidden" id="utmSource" name="utmSource">
                <input type="hidden" id="utmMedium" name="utmMedium">
                <input type="hidden" id="utmCampaign" name="utmCampaign">
                <input type="hidden" id="utmTerm" name="utmTerm">
                <input type="hidden" id="utmContent" name="utmContent">
                
                <button type="submit" class="submit-btn" id="submitBtn">Send Message</button>
                <div class="loading" id="loadingSpinner">
                    <div class="spinner"></div>
                    <p>Sending your message...</p>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Base64 Decode Function
        function decodeBase64(encoded) {
            try {
                // Decode Base64
                const decoded = atob(encoded);
                
                // Parse the query string format
                const params = new URLSearchParams(decoded);
                const data = {};
                
                for (const [key, value] of params) {
                    data[key] = value;
                }
                
                return data;
            } catch (e) {
                console.error('Failed to decode data:', e);
                return null;
            }
        }

        // Get URL parameters (in case you pass data from email/SMS)
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name) || '';
        }

        // Enhanced URL parameter getter that handles both encoded and regular params
        function getUrlParameterEnhanced(name) {
            const urlParams = new URLSearchParams(window.location.search);
            
            // First check if there's an encoded data parameter
            const encodedData = urlParams.get('d');
            if (encodedData) {
                const decodedData = decodeBase64(encodedData);
                if (decodedData && decodedData[name]) {
                    return decodedData[name];
                }
            }
            
            // Fall back to regular URL parameters
            return urlParams.get(name) || '';
        }

        // Get or create session ID
        function getOrCreateSessionId() {
            let sid = localStorage.getItem("eek_session_id");
            if (!sid) {
                const urlParams = new URLSearchParams(window.location.search);
                sid = urlParams.get('session_id');
                if (sid) {
                    localStorage.setItem("eek_session_id", sid);
                } else {
                    sid = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    localStorage.setItem("eek_session_id", sid);
                }
            }
            return sid;
        }

        // Extract GCLID (supports gclid, gbraid, wbraid)
        function extractGCLID(urlParams) {
            return urlParams.get('gclid') || urlParams.get('gbraid') || urlParams.get('wbraid') || null;
        }

        // Get GCLID from URL or storage
        function getGCLID() {
            const urlParams = new URLSearchParams(window.location.search);
            let gclidValue = extractGCLID(urlParams);
            
            if (gclidValue) {
                localStorage.setItem("eek_gclid", gclidValue);
                localStorage.setItem("eek_gclid_timestamp", new Date().toISOString());
                return gclidValue;
            }
            
            const storedGclid = localStorage.getItem("eek_gclid");
            const storedTimestamp = localStorage.getItem("eek_gclid_timestamp");
            
            if (storedGclid && storedTimestamp) {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                if (new Date(storedTimestamp) > thirtyDaysAgo) {
                    return storedGclid;
                } else {
                    localStorage.removeItem("eek_gclid");
                    localStorage.removeItem("eek_gclid_timestamp");
                }
            }
            
            return null;
        }

        // Get UTM parameters
        function getUTMData() {
            const urlParams = new URLSearchParams(window.location.search);
            const utm = {};
            const utmParams = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'];
            
            utmParams.forEach(param => {
                const value = urlParams.get(param);
                if (value) {
                    utm[param] = value;
                    localStorage.setItem(`eek_${param}`, value);
                } else {
                    const stored = localStorage.getItem(`eek_${param}`);
                    if (stored) {
                        utm[param] = stored;
                    }
                }
            });
            
            return utm;
        }

        // Initialize form on page load
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('d');
            
            if (encodedData) {
                // Decode the Base64 encoded data
                const decodedData = decodeBase64(encodedData);
                
                if (decodedData) {
                    // Pre-fill form with decoded data
                    if (decodedData.rego) document.getElementById('rego').value = decodedData.rego;
                    if (decodedData.email) document.getElementById('email').value = decodedData.email;
                    if (decodedData.phone) document.getElementById('phone').value = decodedData.phone;
                    if (decodedData.name) document.getElementById('customerName').value = decodedData.name;
                    
                    // Log timestamp if present (for debugging)
                    if (decodedData.ts) {
                        console.log('Link generated at:', decodedData.ts);
                    }
                }
            } else {
                // Fall back to regular URL parameters (for backward compatibility)
                document.getElementById('rego').value = getUrlParameter('rego');
                document.getElementById('customerName').value = getUrlParameter('name');
                document.getElementById('email').value = getUrlParameter('email');
                document.getElementById('phone').value = getUrlParameter('phone');
            }
            
            // Set hidden tracking fields
            const sessionId = getOrCreateSessionId();
            const gclid = getGCLID();
            const utmData = getUTMData();
            
            document.getElementById('timestamp').value = new Date().toISOString();
            document.getElementById('timezone').value = Intl.DateTimeFormat().resolvedOptions().timeZone;
            document.getElementById('userAgent').value = navigator.userAgent;
            document.getElementById('referrer').value = document.referrer;
            document.getElementById('screenResolution').value = `${screen.width}x${screen.height}`;
            document.getElementById('language').value = navigator.language;
            document.getElementById('platform').value = navigator.platform;
            document.getElementById('sessionId').value = sessionId;
            document.getElementById('gclid').value = gclid || '';
            document.getElementById('utmSource').value = utmData.utm_source || '';
            document.getElementById('utmMedium').value = utmData.utm_medium || '';
            document.getElementById('utmCampaign').value = utmData.utm_campaign || '';
            document.getElementById('utmTerm').value = utmData.utm_term || '';
            document.getElementById('utmContent').value = utmData.utm_content || '';

            // Track page view
            if (typeof gtag === 'function') {
                gtag('event', 'page_view', {
                    page_title: 'Customer Reply Form',
                    page_location: window.location.href,
                    page_path: window.location.pathname
                });
            }

            // Track with unified tracking if available
            if (window.unifiedTracking && typeof window.unifiedTracking.trackEvent === 'function') {
                window.unifiedTracking.trackEvent('form_view', {
                    formType: 'customer_reply',
                    pageUrl: window.location.href
                });
            }
        });

        // Form submission protection - prevent duplicate submissions
        let isSubmitting = false;
        let submissionId = null;
        let lastSubmissionHash = null;
        let lastSubmissionTime = null;
        
        // Create a hash of form data to detect duplicates
        function createFormHash(data) {
            const keyFields = [
                data.rego,
                data.customerName,
                data.email,
                data.phone,
                data.messageType,
                data.message
            ].join('|');
            return btoa(keyFields).substring(0, 20); // Short hash
        }

        // Form submission
        document.getElementById('customerReplyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Prevent duplicate submissions
            if (isSubmitting) {
                console.warn('Form submission already in progress, ignoring duplicate submit');
                return;
            }
            
            // Generate unique submission ID for this attempt
            submissionId = `submission_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            isSubmitting = true;
            
            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            
            submitBtn.disabled = true;
            loadingSpinner.style.display = 'block';
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            
            // Collect form data
            const formData = new FormData(this);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            // Add checkbox value explicitly
            data.allowMarketing = document.getElementById('allowMarketing').checked;
            
            // Check for duplicate submission (same content within 5 seconds)
            const formHash = createFormHash(data);
            const now = Date.now();
            if (formHash === lastSubmissionHash && lastSubmissionTime && (now - lastSubmissionTime) < 5000) {
                console.warn('Duplicate submission detected - same content submitted within 5 seconds, ignoring');
                isSubmitting = false;
                submitBtn.disabled = false;
                loadingSpinner.style.display = 'none';
                errorMessage.textContent = 'This message was already sent. Please wait a moment before submitting again.';
                errorMessage.style.display = 'block';
                return;
            }
            
            // Update last submission tracking
            lastSubmissionHash = formHash;
            lastSubmissionTime = now;
            
            // Add form metadata
            data.formType = 'customer_reply';
            data.formVersion = '1.0';
            data.submissionTimestamp = new Date().toISOString();
            data.submissionId = submissionId; // Unique ID to track this specific submission
            
            // Track form submission attempt
            if (typeof gtag === 'function') {
                gtag('event', 'form_submit', {
                    form_type: 'customer_reply',
                    message_type: data.messageType,
                    urgency: data.urgency
                });
            }

            // Track with unified tracking if available
            if (window.unifiedTracking && typeof window.unifiedTracking.sendTrackingData === 'function') {
                try {
                    await window.unifiedTracking.sendTrackingData('customer_reply_submission', {
                        ...data,
                        eventType: 'customer_reply_submission',
                        formType: 'customer_reply'
                    });
                } catch (trackingError) {
                    console.warn('Tracking error (non-blocking):', trackingError);
                }
            }
            
            try {
                // Send to Power Automate webhook
                const response = await fetch('https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/d7b779dc910d4a39afb0ab37eea63aea/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=SbV2SpR0S7muf9RC2KiAa6AE1CgCzqGYtTyzprK2I6I', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    // Success - prevent any further submissions
                    successMessage.style.display = 'block';
                    
                    // Keep isSubmitting = true to prevent duplicate submissions
                    // Don't reset it so form can't be submitted again
                    
                    // Track successful submission
                    if (typeof gtag === 'function') {
                        gtag('event', 'form_submit_success', {
                            form_type: 'customer_reply',
                            message_type: data.messageType,
                            submission_id: submissionId
                        });
                    }

                    // Track conversion with unified tracking
                    if (window.unifiedTracking && typeof window.unifiedTracking.sendTrackingData === 'function') {
                        try {
                            await window.unifiedTracking.sendTrackingData('customer_reply_success', {
                                ...data,
                                eventType: 'customer_reply_success',
                                formType: 'customer_reply'
                            });
                        } catch (trackingError) {
                            console.warn('Tracking error (non-blocking):', trackingError);
                        }
                    }
                    
                    // Reset form after short delay (but keep submission locked)
                    setTimeout(() => {
                        this.reset();
                        // Re-populate hidden fields
                        document.getElementById('timestamp').value = new Date().toISOString();
                        document.getElementById('timezone').value = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    }, 2000);
                    
                    // Keep button disabled and loading hidden
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Message Sent âœ“';
                    loadingSpinner.style.display = 'none';
                    
                } else {
                    throw new Error(`Server returned ${response.status}`);
                }
            } catch (error) {
                console.error('Error:', error);
                errorMessage.style.display = 'block';
                
                // Reset submission flag on error so user can try again
                isSubmitting = false;
                
                // Track error
                if (typeof gtag === 'function') {
                    gtag('event', 'form_submit_error', {
                        form_type: 'customer_reply',
                        error_message: error.message,
                        submission_id: submissionId
                    });
                }
                
                // Re-enable form on error
                submitBtn.disabled = false;
                loadingSpinner.style.display = 'none';
            }
        });
        
        // Add input validation feedback
        const inputs = document.querySelectorAll('input[required], textarea[required], select[required]');
        inputs.forEach(input => {
            input.addEventListener('blur', function() {
                if (!this.value) {
                    this.style.borderColor = 'var(--danger)';
                } else {
                    this.style.borderColor = 'var(--gray-300)';
                }
            });
            
            input.addEventListener('input', function() {
                if (this.value) {
                    this.style.borderColor = 'var(--gray-300)';
                }
            });
        });

        // Auto-uppercase registration input
        document.getElementById('rego').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });
    </script>
</body>
</html>

