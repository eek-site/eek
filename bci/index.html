<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buyer Created Invoice | EEK Mechanical</title>
  <meta name="description" content="Buyer Created Invoice system for EEK Mechanical suppliers. NZ IRD compliant taxable supply information.">
  <meta name="robots" content="noindex, nofollow">
  <meta property="og:title" content="Buyer Created Invoice | EEK Mechanical">
  <meta property="og:description" content="Generate IRD-compliant buyer created invoices.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.eek.nz/bci">

  <!-- Security Headers -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://static.cloudflareinsights.com https://cdnjs.cloudflare.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' data: https:;
    connect-src 'self' https://www.eek.nz https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com https://static.cloudflareinsights.com;
    frame-src 'self';">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">

  <!-- Centralized Scripts -->
  <script src="/data-sanitizer.js?v=20251224.1"></script>
  <script src="/phone-manager.js?v=20251020"></script>
  <script src="/unified-tracking.js?v=20251224.1"></script>
  <script src="/footer-new.js?v=20251020"></script>
  
  <!-- PDF Generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <style>
    :root {
      --primary: #0a2540;
      --primary-light: #1a3a5c;
      --accent: #00d4aa;
      --accent-dark: #00b894;
      --warning: #f39c12;
      --danger: #e74c3c;
      --success: #27ae60;
      --text: #f8f9fa;
      --text-muted: #8899a6;
      --surface: rgba(255,255,255,0.06);
      --surface-hover: rgba(255,255,255,0.1);
      --border: rgba(255,255,255,0.12);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(145deg, #0a2540 0%, #0d3251 40%, #134e6f 100%);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container { max-width: 900px; margin: 0 auto; padding: 0 20px; }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      padding: 35px 0;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="2" height="60" fill="rgba(255,255,255,0.1)"/><rect x="40" y="10" width="2" height="80" fill="rgba(255,255,255,0.08)"/><rect x="60" y="30" width="2" height="50" fill="rgba(255,255,255,0.1)"/><rect x="80" y="15" width="2" height="70" fill="rgba(255,255,255,0.07)"/></svg>') repeat;
      opacity: 0.5;
    }

    .header-content { position: relative; z-index: 2; text-align: center; }
    .header h1 { 
      font-family: 'Space Mono', monospace;
      font-size: 2.2em; 
      margin-bottom: 10px; 
      color: var(--primary);
      letter-spacing: -1px;
    }
    .header .subtitle { font-size: 1em; color: var(--primary); opacity: 0.8; }

    .compliance-badge {
      display: inline-block;
      background: var(--primary);
      color: var(--accent);
      padding: 8px 18px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: 600;
      margin-top: 15px;
      font-family: 'Space Mono', monospace;
      letter-spacing: 0.5px;
    }

    /* Navigation */
    .nav {
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid var(--border);
    }

    .nav-content { display: flex; justify-content: center; padding: 12px 0; gap: 25px; flex-wrap: wrap; }
    .nav a { color: var(--text-muted); text-decoration: none; font-weight: 500; font-size: 0.9em; transition: color 0.2s; }
    .nav a:hover { color: var(--accent); }

    /* Main Section */
    .main-section { padding: 40px 0; }

    /* Invoice Card */
    .invoice-card {
      background: var(--surface);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 35px;
      border: 1px solid var(--border);
      box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    }

    .invoice-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 30px;
      padding-bottom: 25px;
      border-bottom: 2px solid var(--border);
      flex-wrap: wrap;
      gap: 20px;
    }

    .invoice-title {
      font-family: 'Space Mono', monospace;
      font-size: 1.5em;
      color: var(--accent);
      margin-bottom: 5px;
    }

    .invoice-subtitle {
      color: var(--text-muted);
      font-size: 0.85em;
    }

    .invoice-number-section {
      text-align: right;
    }

    .invoice-number {
      font-family: 'Space Mono', monospace;
      font-size: 1.1em;
      color: var(--text);
      margin-bottom: 5px;
    }

    .invoice-date {
      color: var(--text-muted);
      font-size: 0.85em;
    }

    /* Party Details */
    .parties-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    @media (max-width: 700px) {
      .parties-grid { grid-template-columns: 1fr; }
    }

    .party-box {
      background: var(--surface);
      border-radius: 10px;
      padding: 20px;
      border: 1px solid var(--border);
    }

    .party-label {
      font-size: 0.7em;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--accent);
      margin-bottom: 12px;
      font-weight: 700;
    }

    .party-name {
      font-size: 1.1em;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    .party-detail {
      font-size: 0.85em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .party-detail strong {
      color: var(--text);
    }

    /* Form Sections */
    .form-section {
      margin-bottom: 28px;
    }

    .form-section-title {
      font-size: 0.7em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--accent);
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .form-group { margin-bottom: 18px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }

    @media (max-width: 600px) {
      .form-row, .form-row-3 { grid-template-columns: 1fr; }
      .invoice-card { padding: 25px 18px; }
    }

    label { 
      display: block; 
      font-weight: 500; 
      color: var(--text); 
      margin-bottom: 6px; 
      font-size: 0.85em;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.95em;
      transition: all 0.2s ease;
      background: rgba(255,255,255,0.05);
      color: var(--text);
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.08);
      box-shadow: 0 0 0 3px rgba(0,212,170,0.15);
    }

    input::placeholder, textarea::placeholder { color: var(--text-muted); }
    input:disabled, input[readonly] { background: rgba(255,255,255,0.02); color: var(--text-muted); }
    select option { background: var(--primary); color: var(--text); }
    textarea { resize: vertical; min-height: 80px; }

    .input-prefix { position: relative; }
    .input-prefix span {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-weight: 500;
    }
    .input-prefix input { padding-left: 32px; }

    .help-text { font-size: 0.75em; color: var(--text-muted); margin-top: 4px; }

    /* Line Items Table */
    .line-items-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }

    .line-items-table th {
      text-align: left;
      padding: 12px 10px;
      font-size: 0.75em;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--accent);
      border-bottom: 2px solid var(--border);
      font-weight: 600;
    }

    .line-items-table th:last-child {
      text-align: right;
    }

    .line-items-table td {
      padding: 14px 10px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    .line-items-table td:last-child {
      text-align: right;
    }

    .line-items-table .item-label {
      font-weight: 500;
      color: var(--text);
    }

    .line-items-table .item-unit {
      color: var(--text-muted);
      font-size: 0.85em;
    }

    .line-items-table input[type="number"] {
      width: 120px;
      text-align: right;
      padding: 10px 12px;
    }

    .line-items-table .qty-input {
      width: 80px;
      text-align: center;
    }

    /* Totals */
    .totals-section {
      margin-top: 25px;
      padding-top: 20px;
      border-top: 2px solid var(--border);
    }

    .totals-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      font-size: 0.95em;
    }

    .totals-row.subtotal {
      color: var(--text-muted);
    }

    .totals-row.gst {
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      padding-bottom: 15px;
    }

    .totals-row.total {
      font-size: 1.3em;
      font-weight: 700;
      color: var(--accent);
      padding-top: 15px;
    }

    .totals-row .label { }
    .totals-row .value { 
      font-family: 'Space Mono', monospace;
    }

    /* Bank Details Box */
    .bank-details-box {
      background: rgba(0,212,170,0.08);
      border: 1px solid rgba(0,212,170,0.25);
      border-radius: 10px;
      padding: 20px;
      margin-top: 25px;
    }

    .bank-details-title {
      font-size: 0.75em;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--accent);
      margin-bottom: 12px;
      font-weight: 700;
    }

    .bank-inputs { display: grid; grid-template-columns: 70px 80px 110px 60px; gap: 8px; }
    @media (max-width: 500px) { .bank-inputs { grid-template-columns: 1fr 1fr; } }
    .bank-inputs input { text-align: center; font-family: 'Space Mono', monospace; }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 16px 32px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: var(--primary);
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 15px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-family: 'Space Mono', monospace;
      letter-spacing: 0.5px;
    }

    .btn:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 10px 30px rgba(0,212,170,0.3);
    }
    .btn:active { transform: translateY(0); }
    .btn:disabled { 
      background: var(--text-muted); 
      cursor: not-allowed; 
      transform: none; 
      box-shadow: none; 
    }

    .btn-secondary {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn-secondary:hover {
      background: var(--surface-hover);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .btn-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 20px;
    }

    @media (max-width: 500px) {
      .btn-row { grid-template-columns: 1fr; }
    }

    .spinner {
      width: 18px; height: 18px;
      border: 2px solid rgba(10,37,64,0.3);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Alerts */
    .alert {
      padding: 14px 18px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
      font-size: 0.9em;
      display: none;
    }
    .alert-success { background: rgba(39,174,96,0.15); color: #2ecc71; border: 1px solid rgba(39,174,96,0.3); }
    .alert-error { background: rgba(231,76,60,0.15); color: #e74c3c; border: 1px solid rgba(231,76,60,0.3); }
    .alert-info { background: rgba(0,212,170,0.1); color: var(--accent); border: 1px solid rgba(0,212,170,0.3); }

    .hidden { display: none !important; }

    /* IRD Compliance Notice */
    .compliance-notice {
      background: rgba(243,156,18,0.1);
      border: 1px solid rgba(243,156,18,0.3);
      border-radius: 8px;
      padding: 15px 18px;
      margin-top: 25px;
      font-size: 0.8em;
      color: var(--warning);
    }

    .compliance-notice strong {
      display: block;
      margin-bottom: 5px;
    }

    /* Success Modal */
    .success-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    .success-modal.show { display: flex; }

    .success-modal-content {
      background: linear-gradient(145deg, var(--primary) 0%, var(--primary-light) 100%);
      border-radius: 16px;
      padding: 50px;
      max-width: 480px;
      width: 90%;
      text-align: center;
      border: 1px solid var(--border);
      box-shadow: 0 30px 60px rgba(0,0,0,0.5);
      animation: modalSlide 0.3s ease;
    }

    @keyframes modalSlide {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .success-icon { font-size: 4em; margin-bottom: 20px; }
    .success-modal-content h2 { color: var(--accent); margin-bottom: 15px; font-size: 1.5em; }
    .success-modal-content p { color: var(--text-muted); margin-bottom: 25px; }

    /* Print Styles for PDF */
    @media print {
      body { background: white; color: black; }
      .nav, .btn, .alert, .compliance-notice { display: none; }
      .invoice-card { box-shadow: none; border: 1px solid #ddd; }
    }

    /* PDF Preview Container */
    #pdfPreview {
      background: white;
      color: #333;
      padding: 40px;
      border-radius: 8px;
      display: none;
    }

    #pdfPreview .invoice-title { color: #0a2540; }
    #pdfPreview .party-label { color: #00b894; }
    #pdfPreview .form-section-title { color: #00b894; border-color: #ddd; }
    #pdfPreview .party-detail { color: #666; }
    #pdfPreview .party-detail strong { color: #333; }
    #pdfPreview .totals-row.total { color: #00b894; }
  </style>
</head>
<body>

<!-- Header -->
<header class="header">
  <div class="container">
    <div class="header-content">
      <h1>BUYER CREATED INVOICE</h1>
      <p class="subtitle">Taxable Supply Information ¬∑ EEK Mechanical Ltd</p>
      <div class="compliance-badge">NZ IRD COMPLIANT ¬∑ GST REGISTERED</div>
    </div>
  </div>
</header>

<!-- Navigation -->
<nav class="nav">
  <div class="container">
    <div class="nav-content">
      <a href="#form">Invoice Form</a>
      <a href="/">‚Üê Back to Home</a>
      <a href="tel:098724612">üìû 09 872 4612</a>
    </div>
  </div>
</nav>

<!-- Main Content -->
<main class="main-section" id="form">
  <div class="container">

    <!-- No Parameter Section -->
    <div id="noParamSection" class="invoice-card hidden">
      <div class="invoice-header">
        <div>
          <div class="invoice-title">Access Required</div>
          <div class="invoice-subtitle">This page requires a valid job reference</div>
        </div>
      </div>
      <p style="color: var(--text-muted); margin-bottom: 20px;">
        To create a Buyer Created Invoice, you need to access this page with a valid job reference from the system.
      </p>
      <p style="color: var(--text-muted);">
        If you're a supplier needing to submit an invoice, please use our 
        <a href="/supplier-upload" style="color: var(--accent);">Supplier Upload Portal</a> instead.
      </p>
      <p style="color: var(--text-muted); margin-top: 20px;">
        For assistance, contact us at <a href="tel:098724612" style="color: var(--accent);">09 872 4612</a> or via our 
        <a href="/supplier" style="color: var(--accent);">supplier contact form</a>.
      </p>
    </div>

    <!-- BCI Form Section -->
    <div id="bciSection" class="invoice-card hidden">
      
      <div id="alertLoading" class="alert alert-info">
        ‚è≥ Loading job data...
      </div>
      <div id="alertError" class="alert alert-error">
        ‚ùå <span id="errorText">Something went wrong.</span>
      </div>
      <div id="alertSuccess" class="alert alert-success">
        ‚úÖ Invoice created and submitted successfully!
      </div>

      <!-- Invoice Header -->
      <div class="invoice-header">
        <div>
          <div class="invoice-title">TAX INVOICE</div>
          <div class="invoice-subtitle">Buyer Created ¬∑ Taxable Supply Information</div>
        </div>
        <div class="invoice-number-section">
          <div class="invoice-number">BCI-<span id="invoiceNumber">000000</span></div>
          <div class="invoice-date">Date: <span id="invoiceDate"></span></div>
        </div>
      </div>

      <!-- Parties -->
      <div class="parties-grid">
        <!-- Supplier (Invoice From) -->
        <div class="party-box">
          <div class="party-label">From (Supplier)</div>
          <div class="party-name" id="supplierNameDisplay">Loading...</div>
          <div class="party-detail" id="supplierAddressDisplay"></div>
          <div class="party-detail"><strong>GST:</strong> <span id="supplierGstDisplay">-</span></div>
          <div class="party-detail"><strong>Phone:</strong> <span id="supplierPhoneDisplay">-</span></div>
          <div class="party-detail"><strong>Bank:</strong> <span id="supplierBankDisplay">-</span></div>
        </div>

        <!-- Buyer (Invoice To - EEK) -->
        <div class="party-box">
          <div class="party-label">To (Buyer)</div>
          <div class="party-name">EEK Mechanical Ltd</div>
          <div class="party-detail">Suite 14603, Level 1</div>
          <div class="party-detail">6 Johnsonville Road</div>
          <div class="party-detail">Johnsonville, Wellington 6037</div>
          <div class="party-detail"><strong>Phone:</strong> 09 872 4612</div>
        </div>
      </div>

      <form id="bciForm" novalidate>
        <!-- Supplier Details (Editable) -->
        <div class="form-section">
          <div class="form-section-title">Supplier Details</div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="supplierName">Business Name <span style="color: var(--danger);">*</span></label>
              <input type="text" id="supplierName" name="supplierName" required placeholder="Supplier Business Name">
            </div>
            <div class="form-group">
              <label for="supplierGst">GST Number <span style="color: var(--danger);">*</span></label>
              <input type="text" id="supplierGst" name="supplierGst" required placeholder="XXX-XXX-XXX" maxlength="13">
              <div class="help-text">Format: XXX-XXX-XXX</div>
            </div>
          </div>

          <div class="form-group">
            <label for="supplierAddress">Business Address <span style="color: var(--danger);">*</span></label>
            <input type="text" id="supplierAddress" name="supplierAddress" required placeholder="Street Address, City, Postcode">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="supplierPhone">Phone Number</label>
              <input type="tel" id="supplierPhone" name="supplierPhone" placeholder="09 123 4567 or 021 123 4567">
            </div>
            <div class="form-group">
              <label for="supplierEmail">Email</label>
              <input type="email" id="supplierEmail" name="supplierEmail" placeholder="accounts@supplier.co.nz">
            </div>
          </div>

          <div class="form-group">
            <label>Bank Account <span style="color: var(--danger);">*</span></label>
            <div class="bank-inputs">
              <input type="text" id="bank1" name="bank1" placeholder="XX" maxlength="2" required>
              <input type="text" id="bank2" name="bank2" placeholder="XXXX" maxlength="4" required>
              <input type="text" id="bank3" name="bank3" placeholder="XXXXXXX" maxlength="8" required>
              <input type="text" id="bank4" name="bank4" placeholder="XXX" maxlength="3" required>
            </div>
            <div class="help-text">NZ bank account format: XX-XXXX-XXXXXXX-XXX</div>
          </div>
        </div>

        <!-- Job Reference -->
        <div class="form-section">
          <div class="form-section-title">Job Reference</div>
          <div class="form-row">
            <div class="form-group">
              <label for="jobRego">Vehicle Registration</label>
              <input type="text" id="jobRego" name="jobRego" placeholder="ABC123" style="text-transform: uppercase;">
            </div>
            <div class="form-group">
              <label for="jobDate">Date of Service <span style="color: var(--danger);">*</span></label>
              <input type="date" id="jobDate" name="jobDate" required>
            </div>
          </div>
          <div class="form-group">
            <label for="jobDescription">Service Description</label>
            <textarea id="jobDescription" name="jobDescription" placeholder="Brief description of services provided..."></textarea>
          </div>
        </div>

        <!-- Line Items -->
        <div class="form-section">
          <div class="form-section-title">Invoice Line Items (Excl. GST)</div>
          
          <table class="line-items-table">
            <thead>
              <tr>
                <th>Description</th>
                <th>Qty/Units</th>
                <th>Amount ($)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <span class="item-label">Labour</span>
                </td>
                <td>
                  <input type="number" class="qty-input" id="labourQty" placeholder="-" min="0" step="0.5">
                  <span class="item-unit">hrs</span>
                </td>
                <td>
                  <div class="input-prefix">
                    <span>$</span>
                    <input type="number" id="labourAmount" class="line-amount" placeholder="0.00" min="0" step="0.01">
                  </div>
                </td>
              </tr>
              <tr>
                <td>
                  <span class="item-label">Fuel Extracted</span>
                </td>
                <td>
                  <input type="number" class="qty-input" id="fuelExtractedQty" placeholder="-" min="0" step="0.1">
                  <span class="item-unit">ltrs</span>
                </td>
                <td>
                  <div class="input-prefix">
                    <span>$</span>
                    <input type="number" id="fuelExtractedAmount" class="line-amount" placeholder="0.00" min="0" step="0.01">
                  </div>
                </td>
              </tr>
              <tr>
                <td>
                  <span class="item-label">Fuel Replaced</span>
                </td>
                <td>
                  <input type="number" class="qty-input" id="fuelReplacedQty" placeholder="-" min="0" step="0.1">
                  <span class="item-unit">ltrs</span>
                </td>
                <td>
                  <div class="input-prefix">
                    <span>$</span>
                    <input type="number" id="fuelReplacedAmount" class="line-amount" placeholder="0.00" min="0" step="0.01">
                  </div>
                </td>
              </tr>
              <tr>
                <td>
                  <span class="item-label">Towing Throughput</span>
                </td>
                <td>
                  <input type="number" class="qty-input" id="towingQty" placeholder="-" min="0" step="1">
                  <span class="item-unit">km</span>
                </td>
                <td>
                  <div class="input-prefix">
                    <span>$</span>
                    <input type="number" id="towingAmount" class="line-amount" placeholder="0.00" min="0" step="0.01">
                  </div>
                </td>
              </tr>
              <tr>
                <td>
                  <span class="item-label">Parts / Freight / Sundries</span>
                </td>
                <td>
                  <span class="item-unit">-</span>
                </td>
                <td>
                  <div class="input-prefix">
                    <span>$</span>
                    <input type="number" id="partsAmount" class="line-amount" placeholder="0.00" min="0" step="0.01">
                  </div>
                </td>
              </tr>
            </tbody>
          </table>

          <!-- Totals -->
          <div class="totals-section">
            <div class="totals-row subtotal">
              <span class="label">Subtotal (Excl. GST)</span>
              <span class="value" id="subtotalDisplay">$0.00</span>
            </div>
            <div class="totals-row gst">
              <span class="label">GST (15%)</span>
              <span class="value" id="gstDisplay">$0.00</span>
            </div>
            <div class="totals-row total">
              <span class="label">Total (Incl. GST)</span>
              <span class="value" id="totalDisplay">$0.00</span>
            </div>
          </div>
        </div>

        <!-- Hidden Fields -->
        <input type="hidden" id="bookingId" name="bookingId">
        <input type="hidden" id="sessionId" name="sessionId">
        <input type="hidden" id="timestamp" name="timestamp">
        <input type="hidden" id="subtotal" name="subtotal">
        <input type="hidden" id="gstAmount" name="gstAmount">
        <input type="hidden" id="totalAmount" name="totalAmount">

        <!-- Compliance Notice -->
        <div class="compliance-notice">
          <strong>‚ö†Ô∏è NZ IRD Taxable Supply Information</strong>
          This is a Buyer Created Invoice issued under an agreement between EEK Mechanical Ltd and the supplier. 
          Both parties are GST registered. The supplier should not issue their own tax invoice for this supply. 
          Records of this agreement are maintained by both parties as required by the Goods and Services Tax Act 1985.
        </div>

        <!-- Action Buttons -->
        <div class="btn-row">
          <button type="button" class="btn btn-secondary" id="previewBtn">
            üìÑ Preview PDF
          </button>
          <button type="submit" class="btn" id="submitBtn">
            ‚úì Create &amp; Submit Invoice
          </button>
        </div>

      </form>
    </div>

  </div>
</main>

<!-- Success Modal -->
<div class="success-modal" id="successModal">
  <div class="success-modal-content">
    <div class="success-icon">‚úÖ</div>
    <h2>Invoice Created!</h2>
    <p>BCI has been created and submitted for processing. A PDF copy has been generated.</p>
    <button class="btn" id="modalDownloadBtn">üì• Download PDF</button>
    <button class="btn btn-secondary" id="modalCloseBtn" style="margin-top: 10px;">Close</button>
  </div>
</div>

<!-- PDF Preview (hidden, used for generation) -->
<div id="pdfPreview"></div>

<!-- Footer injected by footer-new.js -->

<script>
// ============================================
// CONFIGURATION
// ============================================
const CONFIG = {
  SHAREPOINT_LOOKUP_URL: 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/c35b9414a0be42f88182ae7e6e409f1d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=2ztt24wScLuAfifD0pjzovseRDKXBAEtCQtScGMgPqQ',
  
  BCI_SUBMIT_URL: 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/b884bb04c6594edb906cdfdb22193b2f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=z7Dd14tvZp2UVGe4DfXewImCbHHJmo3lXsTJmle1jA8',
  
  EEK_DETAILS: {
    name: 'EEK Mechanical Ltd',
    address: 'Suite 14603, Level 1, 6 Johnsonville Road, Johnsonville, Wellington 6037',
    phone: '09 872 4612',
    email: 'accounts@eek.nz'
  }
};

// State
let bookingData = null;
let generatedPdfBlob = null;

// ============================================
// UTILITY FUNCTIONS
// ============================================
function decodeBase64(encoded) {
  try {
    return atob(encoded).trim();
  } catch (e) {
    console.error('Decode error:', e);
    return null;
  }
}

function normalizeValue(val) {
  if (val === null || val === undefined) return '';
  return String(val).trim();
}

function formatCurrency(amount) {
  return '$' + parseFloat(amount || 0).toFixed(2);
}

function formatDate(date) {
  const d = date || new Date();
  return d.toLocaleDateString('en-NZ', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function generateInvoiceNumber() {
  const now = new Date();
  const year = now.getFullYear().toString().slice(-2);
  const month = (now.getMonth() + 1).toString().padStart(2, '0');
  const day = now.getDate().toString().padStart(2, '0');
  const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
  return `${year}${month}${day}${random}`;
}

function getOrCreateSessionId() {
  let sid = localStorage.getItem('eek_session_id');
  if (!sid) {
    sid = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    localStorage.setItem('eek_session_id', sid);
  }
  return sid;
}

// ============================================
// SHAREPOINT DATA FETCH
// ============================================
async function fetchBookingData(bookingId) {
  if (!bookingId) return null;
  
  try {
    const res = await fetch(CONFIG.SHAREPOINT_LOOKUP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ bookingId: String(bookingId) })
    });
    
    if (!res.ok) return null;
    
    const result = await res.json();
    if (result.success && result.bookingData) {
      return JSON.parse(atob(result.bookingData));
    }
    return null;
  } catch (err) {
    console.error('SharePoint fetch error:', err);
    return null;
  }
}

// ============================================
// FORM POPULATION
// ============================================
function populateForm(data) {
  if (!data) return;
  
  const supplierData = data.supplierData || data;
  
  const getValue = (...keys) => {
    for (const key of keys) {
      if (data[key]) return data[key];
      if (supplierData[key]) return supplierData[key];
    }
    return null;
  };
  
  // Supplier Details
  const supplierName = getValue('supplierName', 'Supplier', 'mechanicName', 'businessName');
  if (supplierName) {
    document.getElementById('supplierName').value = normalizeValue(supplierName);
    document.getElementById('supplierNameDisplay').textContent = normalizeValue(supplierName);
  }
  
  const supplierAddress = getValue('supplierAddress', 'address', 'Address');
  if (supplierAddress) {
    document.getElementById('supplierAddress').value = normalizeValue(supplierAddress);
    document.getElementById('supplierAddressDisplay').textContent = normalizeValue(supplierAddress);
  }
  
  const supplierGst = getValue('supplierGst', 'gstNumber', 'GST', 'GstNumber');
  if (supplierGst) {
    document.getElementById('supplierGst').value = normalizeValue(supplierGst);
    document.getElementById('supplierGstDisplay').textContent = normalizeValue(supplierGst);
  }
  
  const supplierPhone = getValue('supplierPhone', 'TextJobToMobileNumber', 'phone', 'Phone');
  if (supplierPhone) {
    document.getElementById('supplierPhone').value = normalizeValue(supplierPhone);
    document.getElementById('supplierPhoneDisplay').textContent = normalizeValue(supplierPhone);
  }
  
  const supplierEmail = getValue('supplierEmail', 'EmailJobToSupplier', 'email', 'Email');
  if (supplierEmail) {
    document.getElementById('supplierEmail').value = normalizeValue(supplierEmail);
  }
  
  // Bank Account
  const bank = getValue('bankAccount', 'Bank', 'bank');
  if (bank && typeof bank === 'string') {
    const parts = bank.split('-');
    if (parts.length === 4) {
      document.getElementById('bank1').value = parts[0];
      document.getElementById('bank2').value = parts[1];
      document.getElementById('bank3').value = parts[2];
      document.getElementById('bank4').value = parts[3];
      document.getElementById('supplierBankDisplay').textContent = bank;
    }
  }
  
  // Job Details
  const rego = getValue('rego', 'Rego', 'vehicleRego');
  if (rego) {
    document.getElementById('jobRego').value = normalizeValue(rego).toUpperCase();
  }
  
  const description = getValue('description', 'JobNotes', 'jobNotes', 'notes');
  if (description) {
    document.getElementById('jobDescription').value = normalizeValue(description);
  }
  
  console.log('‚úÖ Form populated from data');
}

// ============================================
// CALCULATIONS
// ============================================
function calculateTotals() {
  const amounts = document.querySelectorAll('.line-amount');
  let subtotal = 0;
  
  amounts.forEach(input => {
    const val = parseFloat(input.value) || 0;
    subtotal += val;
  });
  
  const gst = subtotal * 0.15;
  const total = subtotal + gst;
  
  document.getElementById('subtotalDisplay').textContent = formatCurrency(subtotal);
  document.getElementById('gstDisplay').textContent = formatCurrency(gst);
  document.getElementById('totalDisplay').textContent = formatCurrency(total);
  
  document.getElementById('subtotal').value = subtotal.toFixed(2);
  document.getElementById('gstAmount').value = gst.toFixed(2);
  document.getElementById('totalAmount').value = total.toFixed(2);
  
  return { subtotal, gst, total };
}

// ============================================
// PDF GENERATION
// ============================================
async function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');
  
  const pageWidth = 210;
  const margin = 20;
  const contentWidth = pageWidth - (margin * 2);
  let y = 20;
  
  // Helper functions
  const addText = (text, x, yPos, options = {}) => {
    doc.setFontSize(options.size || 10);
    doc.setFont('helvetica', options.style || 'normal');
    doc.setTextColor(options.color || '#333333');
    doc.text(text, x, yPos);
    return doc.getTextDimensions(text).h + 2;
  };
  
  // Header
  doc.setFillColor(0, 180, 148);
  doc.rect(0, 0, pageWidth, 35, 'F');
  
  addText('BUYER CREATED INVOICE', margin, 15, { size: 18, style: 'bold', color: '#0a2540' });
  addText('Taxable Supply Information', margin, 23, { size: 10, color: '#0a2540' });
  addText('NZ IRD COMPLIANT', margin, 30, { size: 8, style: 'bold', color: '#0a2540' });
  
  // Invoice Number & Date (right side)
  const invNum = 'BCI-' + document.getElementById('invoiceNumber').textContent;
  const invDate = document.getElementById('invoiceDate').textContent;
  doc.setFontSize(10);
  doc.setTextColor('#0a2540');
  doc.text(invNum, pageWidth - margin, 15, { align: 'right' });
  doc.text('Date: ' + invDate, pageWidth - margin, 22, { align: 'right' });
  
  y = 45;
  
  // Party Details - Two columns
  const colWidth = (contentWidth - 10) / 2;
  
  // From (Supplier)
  doc.setFillColor(245, 245, 245);
  doc.rect(margin, y, colWidth, 45, 'F');
  doc.setDrawColor(200, 200, 200);
  doc.rect(margin, y, colWidth, 45, 'S');
  
  addText('FROM (SUPPLIER)', margin + 5, y + 8, { size: 8, style: 'bold', color: '#00b894' });
  addText(document.getElementById('supplierName').value || '-', margin + 5, y + 16, { size: 10, style: 'bold' });
  addText(document.getElementById('supplierAddress').value || '-', margin + 5, y + 23, { size: 9, color: '#666666' });
  addText('GST: ' + (document.getElementById('supplierGst').value || '-'), margin + 5, y + 30, { size: 9 });
  addText('Phone: ' + (document.getElementById('supplierPhone').value || '-'), margin + 5, y + 36, { size: 9 });
  const bankAccount = [
    document.getElementById('bank1').value,
    document.getElementById('bank2').value,
    document.getElementById('bank3').value,
    document.getElementById('bank4').value
  ].filter(v => v).join('-');
  addText('Bank: ' + (bankAccount || '-'), margin + 5, y + 42, { size: 9 });
  
  // To (EEK)
  const col2X = margin + colWidth + 10;
  doc.setFillColor(245, 245, 245);
  doc.rect(col2X, y, colWidth, 45, 'F');
  doc.rect(col2X, y, colWidth, 45, 'S');
  
  addText('TO (BUYER)', col2X + 5, y + 8, { size: 8, style: 'bold', color: '#00b894' });
  addText('EEK Mechanical Ltd', col2X + 5, y + 16, { size: 10, style: 'bold' });
  addText('Suite 14603, Level 1, 6 Johnsonville Rd', col2X + 5, y + 23, { size: 9, color: '#666666' });
  addText('Johnsonville, Wellington 6037, NZ', col2X + 5, y + 30, { size: 9, color: '#666666' });
  addText('Phone: 09 872 4612', col2X + 5, y + 36, { size: 9 });
  
  y += 55;
  
  // Job Reference
  addText('JOB REFERENCE', margin, y, { size: 8, style: 'bold', color: '#00b894' });
  y += 6;
  doc.setDrawColor(0, 180, 148);
  doc.line(margin, y, margin + 50, y);
  y += 6;
  
  const jobRego = document.getElementById('jobRego').value || '-';
  const jobDate = document.getElementById('jobDate').value || '-';
  const jobDesc = document.getElementById('jobDescription').value || '-';
  
  addText('Vehicle: ' + jobRego + '     Date of Service: ' + jobDate, margin, y, { size: 9 });
  y += 6;
  if (jobDesc && jobDesc !== '-') {
    const descLines = doc.splitTextToSize('Description: ' + jobDesc, contentWidth);
    doc.setFontSize(9);
    doc.text(descLines, margin, y);
    y += descLines.length * 5;
  }
  
  y += 8;
  
  // Line Items Table
  addText('LINE ITEMS', margin, y, { size: 8, style: 'bold', color: '#00b894' });
  y += 6;
  doc.line(margin, y, margin + 50, y);
  y += 8;
  
  // Table Header
  doc.setFillColor(240, 240, 240);
  doc.rect(margin, y - 4, contentWidth, 8, 'F');
  addText('Description', margin + 2, y, { size: 8, style: 'bold' });
  addText('Qty/Units', margin + 90, y, { size: 8, style: 'bold' });
  addText('Amount', pageWidth - margin - 2, y, { size: 8, style: 'bold' });
  doc.text('Amount', pageWidth - margin - 2, y, { align: 'right' });
  
  y += 8;
  
  // Line items
  const lineItems = [
    { label: 'Labour', qty: document.getElementById('labourQty').value, unit: 'hrs', amount: document.getElementById('labourAmount').value },
    { label: 'Fuel Extracted', qty: document.getElementById('fuelExtractedQty').value, unit: 'ltrs', amount: document.getElementById('fuelExtractedAmount').value },
    { label: 'Fuel Replaced', qty: document.getElementById('fuelReplacedQty').value, unit: 'ltrs', amount: document.getElementById('fuelReplacedAmount').value },
    { label: 'Towing Throughput', qty: document.getElementById('towingQty').value, unit: 'km', amount: document.getElementById('towingAmount').value },
    { label: 'Parts / Freight / Sundries', qty: '-', unit: '', amount: document.getElementById('partsAmount').value }
  ];
  
  lineItems.forEach(item => {
    if (parseFloat(item.amount) > 0) {
      addText(item.label, margin + 2, y, { size: 9 });
      const qtyText = item.qty ? item.qty + ' ' + item.unit : '-';
      addText(qtyText, margin + 90, y, { size: 9, color: '#666666' });
      doc.text(formatCurrency(item.amount), pageWidth - margin - 2, y, { align: 'right' });
      y += 7;
    }
  });
  
  y += 5;
  doc.setDrawColor(200, 200, 200);
  doc.line(margin, y, pageWidth - margin, y);
  y += 8;
  
  // Totals
  const totals = calculateTotals();
  
  addText('Subtotal (Excl. GST)', margin + 100, y, { size: 9, color: '#666666' });
  doc.text(formatCurrency(totals.subtotal), pageWidth - margin - 2, y, { align: 'right' });
  y += 7;
  
  addText('GST (15%)', margin + 100, y, { size: 9, color: '#666666' });
  doc.text(formatCurrency(totals.gst), pageWidth - margin - 2, y, { align: 'right' });
  y += 3;
  doc.line(margin + 100, y, pageWidth - margin, y);
  y += 7;
  
  doc.setFontSize(12);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor('#00b894');
  doc.text('TOTAL (Incl. GST)', margin + 100, y);
  doc.text(formatCurrency(totals.total), pageWidth - margin - 2, y, { align: 'right' });
  
  y += 15;
  
  // Payment Details
  doc.setFillColor(232, 245, 243);
  doc.rect(margin, y, contentWidth, 20, 'F');
  doc.setDrawColor(0, 180, 148);
  doc.rect(margin, y, contentWidth, 20, 'S');
  
  addText('PAYMENT DETAILS', margin + 5, y + 6, { size: 8, style: 'bold', color: '#00b894' });
  addText('Bank Account: ' + (bankAccount || '-'), margin + 5, y + 13, { size: 9 });
  addText('Reference: ' + invNum, margin + 100, y + 13, { size: 9 });
  
  y += 30;
  
  // IRD Compliance Notice
  doc.setFillColor(255, 248, 230);
  doc.rect(margin, y, contentWidth, 25, 'F');
  doc.setDrawColor(243, 156, 18);
  doc.rect(margin, y, contentWidth, 25, 'S');
  
  doc.setFontSize(7);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor('#b7791f');
  doc.text('NZ IRD TAXABLE SUPPLY INFORMATION', margin + 5, y + 6);
  
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(7);
  const noticeText = 'This is a Buyer Created Invoice issued under an agreement between EEK Mechanical Ltd and the supplier. Both parties are GST registered. The supplier should not issue their own tax invoice for this supply. Records of this agreement are maintained by both parties as required by the Goods and Services Tax Act 1985.';
  const noticeLines = doc.splitTextToSize(noticeText, contentWidth - 10);
  doc.text(noticeLines, margin + 5, y + 12);
  
  // Footer
  doc.setFontSize(8);
  doc.setTextColor('#999999');
  doc.text('Generated by EEK Mechanical Ltd | www.eek.nz | 09 872 4612', pageWidth / 2, 285, { align: 'center' });
  
  return doc;
}

async function previewPDF() {
  try {
    const doc = await generatePDF();
    const pdfBlob = doc.output('blob');
    const pdfUrl = URL.createObjectURL(pdfBlob);
    window.open(pdfUrl, '_blank');
  } catch (error) {
    console.error('PDF preview error:', error);
    alert('Error generating PDF preview: ' + error.message);
  }
}

async function downloadPDF() {
  if (generatedPdfBlob) {
    const link = document.createElement('a');
    link.href = URL.createObjectURL(generatedPdfBlob);
    link.download = `BCI-${document.getElementById('invoiceNumber').textContent}.pdf`;
    link.click();
  }
}

// ============================================
// FORM SUBMISSION
// ============================================
async function submitBCI(e) {
  e.preventDefault();
  
  const submitBtn = document.getElementById('submitBtn');
  const alertError = document.getElementById('alertError');
  const errorText = document.getElementById('errorText');
  const successModal = document.getElementById('successModal');
  
  alertError.style.display = 'none';
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="spinner"></span> Processing...';
  
  try {
    // Validate required fields
    const requiredFields = ['supplierName', 'supplierGst', 'supplierAddress', 'jobDate'];
    for (const fieldId of requiredFields) {
      const field = document.getElementById(fieldId);
      if (!field.value.trim()) {
        throw new Error(`Please fill in all required fields`);
      }
    }
    
    // Validate bank account
    const bankFields = ['bank1', 'bank2', 'bank3', 'bank4'];
    for (const fieldId of bankFields) {
      if (!document.getElementById(fieldId).value.trim()) {
        throw new Error('Please enter complete bank account details');
      }
    }
    
    // Calculate totals
    const totals = calculateTotals();
    if (totals.total <= 0) {
      throw new Error('Please enter at least one line item amount');
    }
    
    // Generate PDF
    const doc = await generatePDF();
    generatedPdfBlob = doc.output('blob');
    const pdfBase64 = doc.output('datauristring').split(',')[1];
    
    // Build payload
    const bankAccount = bankFields.map(id => document.getElementById(id).value).join('-');
    const invoiceNumber = 'BCI-' + document.getElementById('invoiceNumber').textContent;
    
    const payload = {
      formType: 'buyer_created_invoice',
      formVersion: '1.0',
      submissionId: `bci_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      submittedAt: new Date().toISOString(),
      
      // Invoice details
      invoiceNumber: invoiceNumber,
      invoiceDate: document.getElementById('invoiceDate').textContent,
      
      // Supplier details (matching supplier-upload field names)
      supplierName: document.getElementById('supplierName').value.trim(),
      supplierGst: document.getElementById('supplierGst').value.trim(),
      supplierAddress: document.getElementById('supplierAddress').value.trim(),
      supplierPhone: document.getElementById('supplierPhone').value.trim(),
      supplierEmail: document.getElementById('supplierEmail').value.trim(),
      bankAccount: bankAccount,
      
      // Job details (matching supplier-upload field names)
      rego: document.getElementById('jobRego').value.trim().toUpperCase(),
      jobDate: document.getElementById('jobDate').value,
      description: document.getElementById('jobDescription').value.trim(),
      
      // Amount field for compatibility
      amount: totals.total,
      
      // Line items
      labourQty: parseFloat(document.getElementById('labourQty').value) || 0,
      labourAmount: parseFloat(document.getElementById('labourAmount').value) || 0,
      fuelExtractedQty: parseFloat(document.getElementById('fuelExtractedQty').value) || 0,
      fuelExtractedAmount: parseFloat(document.getElementById('fuelExtractedAmount').value) || 0,
      fuelReplacedQty: parseFloat(document.getElementById('fuelReplacedQty').value) || 0,
      fuelReplacedAmount: parseFloat(document.getElementById('fuelReplacedAmount').value) || 0,
      towingQty: parseFloat(document.getElementById('towingQty').value) || 0,
      towingAmount: parseFloat(document.getElementById('towingAmount').value) || 0,
      partsAmount: parseFloat(document.getElementById('partsAmount').value) || 0,
      
      // Fuel litres for compatibility with supplier-upload
      litresExtracted: parseFloat(document.getElementById('fuelExtractedQty').value) || 0,
      litresIntroduced: parseFloat(document.getElementById('fuelReplacedQty').value) || 0,
      
      // Totals
      subtotal: totals.subtotal,
      gstAmount: totals.gst,
      totalAmount: totals.total,
      
      // Invoice file fields (matching supplier-upload exactly)
      invoiceLink: '',
      invoiceFileName: `${invoiceNumber}.pdf`,
      invoiceFileType: 'application/pdf',
      invoiceFileSize: pdfBase64.length,
      invoiceFileBase64: pdfBase64,
      
      // Fields array for dynamic email builder (matching supplier-upload)
      fields: [
        { name: 'Invoice Number', value: invoiceNumber },
        { name: 'Invoice Type', value: 'Buyer Created Invoice (BCI)' },
        { name: 'Supplier Name', value: document.getElementById('supplierName').value.trim() },
        { name: 'Supplier GST', value: document.getElementById('supplierGst').value.trim() },
        { name: 'Supplier Address', value: document.getElementById('supplierAddress').value.trim() },
        { name: 'Supplier Phone', value: document.getElementById('supplierPhone').value.trim() || 'Not provided' },
        { name: 'Supplier Email', value: document.getElementById('supplierEmail').value.trim() || 'Not provided' },
        { name: 'Bank Account', value: bankAccount },
        { name: 'Rego', value: document.getElementById('jobRego').value.trim().toUpperCase() || '-' },
        { name: 'Date of Service', value: document.getElementById('jobDate').value },
        { name: 'Description', value: document.getElementById('jobDescription').value.trim() || 'Buyer Created Invoice' },
        { name: 'Labour', value: '$' + (parseFloat(document.getElementById('labourAmount').value) || 0).toFixed(2) },
        { name: 'Fuel Extracted', value: '$' + (parseFloat(document.getElementById('fuelExtractedAmount').value) || 0).toFixed(2) },
        { name: 'Fuel Replaced', value: '$' + (parseFloat(document.getElementById('fuelReplacedAmount').value) || 0).toFixed(2) },
        { name: 'Towing', value: '$' + (parseFloat(document.getElementById('towingAmount').value) || 0).toFixed(2) },
        { name: 'Parts/Sundries', value: '$' + (parseFloat(document.getElementById('partsAmount').value) || 0).toFixed(2) },
        { name: 'Subtotal', value: '$' + totals.subtotal.toFixed(2) },
        { name: 'GST (15%)', value: '$' + totals.gst.toFixed(2) },
        { name: 'Total (Incl. GST)', value: '$' + totals.total.toFixed(2) }
      ],
      
      // Tracking
      bookingId: document.getElementById('bookingId').value || '',
      sessionId: getOrCreateSessionId(),
      timestamp: new Date().toISOString()
    };
    
    // Sanitize if available
    const sanitizedPayload = window.dataSanitizer 
      ? window.dataSanitizer.sanitizeForFlow(payload)
      : payload;
    
    // Submit to Power Automate
    const response = await fetch(CONFIG.BCI_SUBMIT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(sanitizedPayload)
    });
    
    if (response.ok) {
      successModal.classList.add('show');
      
      if (window.unifiedTracking?.sendTrackingData) {
        window.unifiedTracking.sendTrackingData('bci_submit_success', {
          invoiceNumber: invoiceNumber,
          amount: totals.total
        });
      }
    } else {
      throw new Error('Server returned ' + response.status);
    }
    
  } catch (error) {
    console.error('BCI submission error:', error);
    errorText.textContent = error.message || 'Something went wrong. Please try again.';
    alertError.style.display = 'block';
    submitBtn.disabled = false;
    submitBtn.innerHTML = '‚úì Create & Submit Invoice';
  }
}

// ============================================
// EVENT LISTENERS & INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', async function() {
  const urlParams = new URLSearchParams(window.location.search);
  
  // Check for encoded parameter (can be ?d= or just the value after ?)
  let encodedData = urlParams.get('d');
  if (!encodedData) {
    // Check if the entire query string is the encoded value
    const queryString = window.location.search.substring(1);
    if (queryString && !queryString.includes('=')) {
      encodedData = queryString;
    }
  }
  
  // Set invoice date and number
  document.getElementById('invoiceDate').textContent = formatDate(new Date());
  document.getElementById('invoiceNumber').textContent = generateInvoiceNumber();
  document.getElementById('jobDate').valueAsDate = new Date();
  
  // Track page view
  if (window.unifiedTracking?.trackEvent) {
    window.unifiedTracking.trackEvent('page_view', {
      page: 'bci',
      hasBookingId: !!encodedData
    });
  }
  
  // No parameter - show access required message
  if (!encodedData) {
    document.getElementById('noParamSection').classList.remove('hidden');
    return;
  }
  
  // Has parameter - show BCI form
  document.getElementById('bciSection').classList.remove('hidden');
  document.getElementById('alertLoading').style.display = 'block';
  
  // Decode booking ID
  const bookingId = decodeBase64(encodedData);
  
  if (bookingId) {
    document.getElementById('bookingId').value = bookingId;
    
    // Fetch data from SharePoint
    bookingData = await fetchBookingData(bookingId);
    if (bookingData) {
      populateForm(bookingData);
    }
  }
  
  document.getElementById('alertLoading').style.display = 'none';
  
  // Setup event listeners
  
  // Bank field auto-advance
  const bankFields = ['bank1', 'bank2', 'bank3', 'bank4'];
  bankFields.forEach((id, i) => {
    document.getElementById(id).addEventListener('input', function() {
      this.value = this.value.replace(/\D/g, '');
      if (this.value.length >= this.maxLength && i < bankFields.length - 1) {
        document.getElementById(bankFields[i + 1]).focus();
      }
      // Update display
      const bankAccount = bankFields.map(fid => document.getElementById(fid).value).filter(v => v).join('-');
      document.getElementById('supplierBankDisplay').textContent = bankAccount || '-';
    });
  });
  
  // GST formatting
  document.getElementById('supplierGst').addEventListener('input', function() {
    let val = this.value.replace(/[^\d-]/g, '');
    this.value = val;
    document.getElementById('supplierGstDisplay').textContent = val || '-';
  });
  
  // Rego uppercase
  document.getElementById('jobRego').addEventListener('input', function() {
    this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
  });
  
  // Live update displays
  document.getElementById('supplierName').addEventListener('input', function() {
    document.getElementById('supplierNameDisplay').textContent = this.value || 'Loading...';
  });
  
  document.getElementById('supplierAddress').addEventListener('input', function() {
    document.getElementById('supplierAddressDisplay').textContent = this.value || '';
  });
  
  document.getElementById('supplierPhone').addEventListener('input', function() {
    document.getElementById('supplierPhoneDisplay').textContent = this.value || '-';
  });
  
  // Calculate totals on amount change
  document.querySelectorAll('.line-amount').forEach(input => {
    input.addEventListener('input', calculateTotals);
  });
  
  // Preview button
  document.getElementById('previewBtn').addEventListener('click', previewPDF);
  
  // Form submission
  document.getElementById('bciForm').addEventListener('submit', submitBCI);
  
  // Modal buttons
  document.getElementById('modalDownloadBtn').addEventListener('click', downloadPDF);
  document.getElementById('modalCloseBtn').addEventListener('click', function() {
    document.getElementById('successModal').classList.remove('show');
  });
});
</script>

</body>
</html>

