<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Login | EEK Mechanical</title>
  <meta name="description" content="Secure admin access for EEK Mechanical NZ-Wide Mobile Mechanics" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <!-- Microsoft Authentication Library -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    
    :root {
      --eek-cyan: #0ea5e9;
      --eek-cyan-dark: #0284c7;
      --eek-cyan-light: #38bdf8;
      --eek-teal: #14b8a6;
      --eek-dark: #0f172a;
      --eek-gray: #64748b;
      --eek-light: #f0f9ff;
      --eek-white: #ffffff;
      --eek-success: #22c55e;
      --eek-warning: #f59e0b;
      --eek-error: #ef4444;
    }
    
    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
      position: relative;
      overflow: hidden;
    }
    
    /* Animated background pattern */
    .bg-grid {
      position: absolute;
      inset: 0;
      background-image: 
        linear-gradient(rgba(14, 165, 233, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(14, 165, 233, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      animation: gridMove 20s linear infinite;
    }
    
    @keyframes gridMove {
      0% { transform: translate(0, 0); }
      100% { transform: translate(50px, 50px); }
    }
    
    /* Floating orbs */
    .orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(60px);
      opacity: 0.4;
      animation: float 15s ease-in-out infinite;
    }
    .orb-1 {
      width: 400px;
      height: 400px;
      background: var(--eek-cyan);
      top: -200px;
      right: -100px;
      animation-delay: 0s;
    }
    .orb-2 {
      width: 300px;
      height: 300px;
      background: var(--eek-teal);
      bottom: -150px;
      left: -100px;
      animation-delay: -5s;
    }
    
    @keyframes float {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(30px, -30px) scale(1.05); }
      66% { transform: translate(-20px, 20px) scale(0.95); }
    }
    
    .login-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      box-shadow: 
        0 25px 50px -12px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.1);
      width: 100%;
      max-width: 420px;
      padding: 48px 40px;
      position: relative;
      z-index: 1;
      animation: cardIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    @keyframes cardIn {
      from { opacity: 0; transform: translateY(40px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    /* Accent bar */
    .login-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: linear-gradient(90deg, var(--eek-cyan), var(--eek-teal));
      border-radius: 0 0 4px 4px;
    }
    
    .logo-section {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .logo-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, var(--eek-cyan), var(--eek-teal));
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 30px -10px rgba(14, 165, 233, 0.5);
      position: relative;
      overflow: hidden;
    }
    
    .logo-icon::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
      transform: rotate(45deg);
      animation: shimmer 3s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }
    
    .logo-icon span {
      font-size: 28px;
      font-weight: 800;
      color: white;
      letter-spacing: -1px;
      position: relative;
      z-index: 1;
    }
    
    .brand-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--eek-cyan);
      text-transform: uppercase;
      letter-spacing: 3px;
      margin-bottom: 8px;
    }
    
    h1 {
      font-size: 26px;
      font-weight: 700;
      color: var(--eek-dark);
      margin-bottom: 8px;
    }
    
    .subtitle {
      color: var(--eek-gray);
      font-size: 15px;
    }
    
    .login-form {
      margin-top: 32px;
    }
    
    .btn {
      width: 100%;
      padding: 16px 24px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      transition: all 0.2s ease;
      margin-bottom: 12px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--eek-cyan), var(--eek-cyan-dark));
      color: white;
      box-shadow: 0 4px 14px -4px rgba(14, 165, 233, 0.5);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px -4px rgba(14, 165, 233, 0.6);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }
    
    .btn-secondary {
      background: var(--eek-light);
      color: var(--eek-gray);
      border: 1px dashed #cbd5e1;
    }
    
    .btn-secondary:hover {
      background: #e0f2fe;
      color: var(--eek-cyan-dark);
      border-color: var(--eek-cyan);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .microsoft-icon {
      width: 20px;
      height: 20px;
    }
    
    /* Messages */
    .message {
      padding: 14px 16px;
      border-radius: 10px;
      margin-top: 16px;
      font-size: 14px;
      display: none;
      animation: msgIn 0.3s ease;
    }
    
    @keyframes msgIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .msg-error { background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; }
    .msg-success { background: #f0fdf4; border: 1px solid #bbf7d0; color: #14532d; }
    .msg-warning { background: #fffbeb; border: 1px solid #fed7aa; color: #92400e; }
    .msg-info { background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; }
    
    /* Loading */
    .loading {
      display: none;
      text-align: center;
      padding: 20px 0;
    }
    
    .loading.active { display: block; }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e2e8f0;
      border-top-color: var(--eek-cyan);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Security badges */
    .security-row {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 28px;
      padding-top: 24px;
      border-top: 1px solid #e2e8f0;
    }
    
    .security-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--eek-gray);
    }
    
    .security-badge svg {
      width: 14px;
      height: 14px;
      color: var(--eek-success);
    }
    
    /* Footer */
    .footer-links {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }
    
    .footer-links a {
      color: var(--eek-gray);
      text-decoration: none;
      font-size: 13px;
      transition: color 0.2s;
    }
    
    .footer-links a:hover {
      color: var(--eek-cyan);
    }
    
    @media (max-width: 480px) {
      .login-card { padding: 36px 24px; }
      h1 { font-size: 22px; }
      .security-row { flex-direction: column; gap: 12px; align-items: center; }
    }
  </style>
</head>
<body>
  <div class="bg-grid"></div>
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>

  <div class="login-card">
    <div class="logo-section">
      <div class="logo-icon">
        <span>EEK</span>
      </div>
      <div class="brand-name">EEK Mechanical</div>
      <h1>Admin Portal</h1>
      <p class="subtitle">NZ-Wide Mobile Mechanics</p>
    </div>

    <div class="login-form">
      <button id="loginBtn" class="btn btn-primary" onclick="signIn()">
        <svg class="microsoft-icon" viewBox="0 0 21 21">
          <rect x="1" y="1" width="9" height="9" fill="#f25022"/>
          <rect x="11" y="1" width="9" height="9" fill="#7fba00"/>
          <rect x="1" y="11" width="9" height="9" fill="#00a4ef"/>
          <rect x="11" y="11" width="9" height="9" fill="#ffb900"/>
        </svg>
        Sign in with Microsoft
      </button>

      <button id="demoBtn" class="btn btn-secondary" onclick="skipLogin()">
        Continue in Demo Mode
      </button>
    </div>

    <div id="errorMsg" class="message msg-error"></div>
    <div id="successMsg" class="message msg-success"></div>
    <div id="warningMsg" class="message msg-warning"></div>
    <div id="infoMsg" class="message msg-info"></div>

    <div id="loadingDiv" class="loading">
      <div class="spinner"></div>
      <p style="color: var(--eek-gray);">Authenticating...</p>
    </div>

    <div class="security-row">
      <div class="security-badge">
        <svg fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2H7V7a3 3 0 015.905-.75 1 1 0 001.937-.5A5.002 5.002 0 0010 2z"/></svg>
        <span>Encrypted</span>
      </div>
      <div class="security-badge">
        <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/></svg>
        <span>SSO</span>
      </div>
      <div class="security-badge">
        <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/></svg>
        <span>Audit Log</span>
      </div>
    </div>

    <div class="footer-links">
      <a href="https://www.eek.nz">Home</a>
      <a href="mailto:zx@eek.nz">Support</a>
    </div>
  </div>

  <script>
    // Safety: work even if MSAL CDN fails
    const LogLevel = (window.msal && window.msal.LogLevel) ? window.msal.LogLevel
      : { Error: 0, Warning: 1, Info: 2, Verbose: 3 };

    let msalInstance = null, authInProgress = false;

    // MSAL Configuration - Update with your Azure AD details
    const msalConfig = {
      auth: {
        clientId: 'YOUR_CLIENT_ID_HERE', // Replace with Azure AD App Client ID
        authority: 'https://login.microsoftonline.com/common',
        redirectUri: window.location.origin + '/admin/',
        navigateToLoginRequestUrl: false
      },
      cache: {
        cacheLocation: 'sessionStorage',
        storeAuthStateInCookie: true
      },
      system: {
        allowNativeBroker: false,
        windowHashTimeout: 60000,
        iframeHashTimeout: 60000,
        loadFrameTimeout: 10000,
        loggerOptions: {
          loggerCallback: (level, message, containsPii) => {
            if (containsPii) return;
            if (message?.includes('popup') || message?.includes('window closed')) return;
            if (level === LogLevel.Error) console.error('[MSAL]', message);
          },
          logLevel: LogLevel.Warning
        }
      }
    };

    const loginRequest = { scopes: ['openid', 'profile', 'user.read'], prompt: 'select_account' };

    function handleResponse(response) {
      if (response) {
        const account = response.account;
        msalInstance.setActiveAccount(account);
        sessionStorage.setItem('msalAccount', JSON.stringify(account));
        sessionStorage.setItem('userAuthenticated', 'true');
        sessionStorage.setItem('userName', account.name || account.username);
        showMsg('success', `Welcome, ${account.name || 'user'}! Redirecting...`);
        setTimeout(() => { window.location.href = '/admin/'; }, 1200);
      }
    }

    async function initializeMsal() {
      try {
        if (!window.msal || !window.msal.PublicClientApplication) {
          console.warn('MSAL not loaded. Demo mode available.');
          return;
        }
        msalInstance = new msal.PublicClientApplication(msalConfig);

        if (typeof msalInstance.initialize === 'function') {
          await msalInstance.initialize();
        }

        const response = await msalInstance.handleRedirectPromise();
        if (response) { handleResponse(response); return; }

        checkExistingSession();
      } catch (error) {
        console.error('MSAL init error:', error);
      }
    }

    function checkExistingSession() {
      if (sessionStorage.getItem('userAuthenticated') === 'true') {
        showMsg('success', 'Already signed in. Redirecting...');
        setTimeout(() => { window.location.href = '/admin/'; }, 800);
        return;
      }
      
      if (!msalInstance) return;
      const account = msalInstance.getActiveAccount() || msalInstance.getAllAccounts()[0];
      if (account) {
        msalInstance.setActiveAccount(account);
        sessionStorage.setItem('userAuthenticated', 'true');
        sessionStorage.setItem('userName', account.name || account.username);
        showMsg('success', 'Already signed in. Redirecting...');
        setTimeout(() => { window.location.href = '/admin/'; }, 800);
      }
    }

    async function signIn() {
      if (authInProgress) { showMsg('info', 'Authentication in progress...'); return; }
      hideAllMsgs();

      if (!window.msal || !msalInstance) {
        showMsg('warning', 'Microsoft sign-in unavailable. Using demo mode...');
        setTimeout(() => { skipLogin(); }, 1500);
        return;
      }

      authInProgress = true;
      setButtons(false);
      document.getElementById('loadingDiv').classList.add('active');

      try {
        await msalInstance.loginRedirect(loginRequest);
      } catch (error) {
        handleAuthError(error);
        document.getElementById('loadingDiv').classList.remove('active');
        authInProgress = false;
        setButtons(true);
      }
    }

    function skipLogin() {
      sessionStorage.setItem('userAuthenticated', 'true');
      sessionStorage.setItem('userName', 'Demo User');
      sessionStorage.setItem('demoMode', 'true');
      showMsg('success', 'Demo mode. Redirecting...');
      setTimeout(() => { window.location.href = '/admin/'; }, 800);
    }

    function handleAuthError(error) {
      console.error('Auth error:', error);
      const code = error?.errorCode || '';
      const msg = (error?.errorMessage || error?.message || '').toLowerCase();

      if (code === 'user_cancelled' || msg.includes('user_cancelled')) {
        showMsg('warning', 'Sign-in cancelled.');
      } else if (code === 'interaction_in_progress') {
        showMsg('warning', 'Sign-in in progress...');
      } else if (code === 'network_error' || msg.includes('network')) {
        showMsg('error', 'Network error. Check your connection.');
      } else {
        showMsg('error', 'Authentication failed. Try again or use demo mode.');
      }
    }

    function setButtons(enabled) {
      document.getElementById('loginBtn').disabled = !enabled;
      document.getElementById('demoBtn').disabled = !enabled;
    }

    function showMsg(type, text) {
      hideAllMsgs();
      const el = document.getElementById(type + 'Msg');
      if (el) { el.textContent = text; el.style.display = 'block'; }
    }

    function hideAllMsgs() {
      ['error', 'success', 'warning', 'info'].forEach(t => {
        const el = document.getElementById(t + 'Msg');
        if (el) el.style.display = 'none';
      });
    }

    window.addEventListener('DOMContentLoaded', () => { initializeMsal(); });
  </script>
</body>
</html>
