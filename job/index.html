<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Job Form | Eek Mechanical</title>
  <meta name="description" content="Create new service jobs for Eek Mechanical">
  <meta name="robots" content="noindex, nofollow">

  <!-- Security Headers -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://static.cloudflareinsights.com;
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    connect-src 'self' https://www.eek.nz https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com https://static.cloudflareinsights.com;
    font-src 'self' data:;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">

  <!-- Centralized Phone Number Management -->
  <script src="/phone-manager.js"></script>
  
  <!-- Unified Tracking System (Internal Analytics) -->
  <script src="/unified-tracking.js"></script>
  
  <!-- Centralized Footer Management -->
  <script src="/footer-new.js"></script>

  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary-color:#ff5500;--primary-dark:#e04400;--secondary-color:#ff7700;
      --success-color:#10b981;--warning-color:#f59e0b;--error-color:#ef4444;
      --info-color:#3b82f6;--text-primary:#1e293b;--text-secondary:#64748b;
      --border-color:#e2e8f0;--bg-light:#f8fafc;--bg-white:#ffffff;
      --shadow-sm:0 1px 2px 0 rgba(0,0,0,.05);--shadow-md:0 4px 6px -1px rgba(0,0,0,.1);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1);--shadow-xl:0 20px 25px -5px rgba(0,0,0,.1)
    }
    body{font-family:'Segoe UI',-apple-system,BlinkMacSystemFont,sans-serif;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);min-height:100vh;color:#fff;padding:20px}
    
    /* Header */
    .header{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));box-shadow:var(--shadow-md);border-radius:12px 12px 0 0;position:relative;overflow:hidden;padding:40px 0;margin-bottom:0}
    .header::before{content:'';position:absolute;top:-50%;right:-50%;width:200%;height:200%;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.1)"/></svg>') repeat;animation:float 15s infinite linear}
    @keyframes float{0%{transform:translateX(0) translateY(0)}100%{transform:translateX(-50px) translateY(-50px)}}
    .header-content{max-width:1400px;margin:0 auto;padding:0 30px;text-align:center;position:relative;z-index:2}
    .header h1{font-size:2.8em;margin-bottom:15px;text-shadow:2px 2px 4px rgba(0,0,0,0.3)}
    .header .subtitle{font-size:1.2em;opacity:0.9;margin-bottom:20px}
    .security-badge{display:inline-block;background:rgba(255,255,255,0.2);backdrop-filter:blur(10px);padding:8px 20px;border-radius:25px;font-size:0.9em;font-weight:bold;border:1px solid rgba(255,255,255,0.3)}

    /* Main Form */
    .container{max-width:1400px;margin:0 auto}
    .form-container{background:var(--bg-white);color:var(--text-primary);border-radius:0 0 12px 12px;padding:32px;box-shadow:var(--shadow-lg);border:1px solid var(--border-color)}
    
    /* Form Sections */
    .form-section{margin-bottom:32px;padding-bottom:24px;border-bottom:2px solid var(--border-color)}
    .form-section:last-child{border-bottom:none}
    .section-title{font-size:1.1em;font-weight:600;color:var(--primary-color);margin-bottom:20px;display:flex;align-items:center;gap:8px}
    .section-icon{width:28px;height:28px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px}
    
    /* Form Grid */
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px}
    .form-group{display:flex;flex-direction:column}
    .form-label{font-size:.85em;color:var(--text-secondary);font-weight:600;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
    .required{color:var(--error-color)}
    .form-input,.form-select,.form-textarea{padding:12px 16px;border:2px solid var(--border-color);border-radius:8px;font-size:1em;background:var(--bg-white);transition:all .2s;color:var(--text-primary)}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(255,85,0,.1)}
    .form-input:disabled,.form-input[readonly]{background:#f8f9fa;cursor:not-allowed;opacity:0.7}
    .form-textarea{resize:vertical;min-height:100px;font-family:inherit}
    
    /* Type Selector */
    .type-selector{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
    .type-btn{padding:14px;background:var(--bg-white);border:2px solid var(--border-color);border-radius:10px;cursor:pointer;font-weight:600;text-align:center;transition:all .2s;position:relative;overflow:hidden}
    .type-btn:hover{border-color:var(--primary-color);transform:translateY(-2px);box-shadow:var(--shadow-md)}
    .type-btn.selected{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:#fff;border-color:var(--primary-color)}
    .type-btn.selected::after{content:'‚úì';position:absolute;top:4px;right:8px;font-size:16px}
    .type-icon{display:block;font-size:24px;margin-bottom:4px}
    .type-label{font-size:.9em}
    
    /* Conditional Sections */
    .conditional-section{display:none;animation:slideDown .3s ease}
    .conditional-section.show{display:block}
    @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    
    /* Flags */
    .flag-group{display:flex;gap:20px;flex-wrap:wrap}
    .flag-item{display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 16px;border:2px solid var(--border-color);border-radius:8px;transition:all .2s}
    .flag-item:hover{border-color:var(--primary-color);background:var(--bg-light)}
    .flag-checkbox{width:20px;height:20px;cursor:pointer}
    .flag-item.checked{background:linear-gradient(135deg,rgba(255,85,0,.1),rgba(255,119,0,.1));border-color:var(--primary-color)}
    

    /* Submit Section */
    .submit-section{display:flex;justify-content:space-between;align-items:center;padding-top:24px;border-top:2px solid var(--border-color);margin-top:32px}
    .submit-actions{display:flex;gap:12px}
    .btn-submit{padding:14px 32px;border-radius:10px;border:none;cursor:pointer;font-weight:600;font-size:1em;transition:all .2s}
    .btn-primary{background:linear-gradient(135deg,var(--success-color),#059669);color:#fff}
    .btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:var(--shadow-lg)}
    .btn-primary:disabled{background:#6c757d;cursor:not-allowed}
    .btn-secondary{background:var(--bg-light);color:var(--text-primary);border:2px solid var(--border-color)}
    
    /* Loading & Messages */
    .loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999}
    .loading-overlay.show{display:flex}
    .loading-content{background:var(--bg-white);padding:32px;border-radius:16px;text-align:center;color:var(--text-primary)}
    .spinner{width:48px;height:48px;border:4px solid var(--border-color);border-top:4px solid var(--primary-color);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    .message{padding:16px;border-radius:10px;margin-bottom:20px;display:none;animation:slideDown .3s ease}
    .message.show{display:block}
    .message.success{background:#d1fae5;border:1px solid #6ee7b7;color:#065f46}
    .message.error{background:#fee2e2;border:1px solid #fca5a5;color:#991b1b}
    .message.warning{background:#fed7aa;border:1px solid #fdba74;color:#92400e}
    
    /* Responsive */
    @media(max-width:768px){
      body{padding:10px}
      .form-grid{grid-template-columns:1fr}
      .type-selector{grid-template-columns:repeat(2,1fr)}
      .submit-section{flex-direction:column;gap:16px}
      .header h1{font-size:2em}
      .form-container{padding:20px}
    }
    
    :focus-visible{outline:2px solid var(--primary-color);outline-offset:2px}
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1>üìã Job Form</h1>
      <p class="subtitle">Create New Service Job</p>
      <div class="security-badge">üîí Secure Submission</div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Messages -->
    <div id="successMessage" class="message success"></div>
    <div id="errorMessage" class="message error"></div>
    <div id="warningMessage" class="message warning"></div>

    <!-- Form Container -->
    <div class="form-container">
      <form id="jobForm" onsubmit="handleSubmit(event)">
        


        <!-- Basic Information -->
        <div class="form-section">
          <div class="section-title">
            <div class="section-icon">üìã</div>
            <span>Basic Information</span>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">
                ID
              </label>
              <input type="text" id="id" name="Id" class="form-input" placeholder="Auto-generated" readonly>
            </div>
            <div class="form-group">
              <label class="form-label">
                Rego <span class="required">*</span>
              </label>
              <input type="text" id="rego" name="Rego" class="form-input" placeholder="ABC123" style="text-transform:uppercase" maxlength="10" required>
            </div>
            <div class="form-group">
              <label class="form-label">
                Email
              </label>
              <input type="email" id="email" name="Email" class="form-input" placeholder="customer@email.com">
            </div>
            <div class="form-group">
              <label class="form-label">
                Client Mobile
              </label>
              <input type="tel" id="clientMobileNumber" name="ClientMobileNumber" class="form-input" placeholder="021 123 4567">
            </div>
          </div>
        </div>

        <!-- Job Type Selection -->
        <div class="form-section">
          <div class="section-title">
            <div class="section-icon">üíº</div>
            <span>Job Type (Tab through or click)</span>
          </div>
          <div class="type-selector" id="typeSelector">
            <button type="button" class="type-btn" data-type="Supplier" tabindex="0">
              <span class="type-icon">üè≠</span>
              <span class="type-label">Supplier</span>
            </button>
            <button type="button" class="type-btn" data-type="Billable" tabindex="0">
              <span class="type-icon">üíµ</span>
              <span class="type-label">Billable</span>
            </button>
            <button type="button" class="type-btn" data-type="Deposit" tabindex="0">
              <span class="type-icon">üè¶</span>
              <span class="type-label">Deposit</span>
            </button>
            <button type="button" class="type-btn" data-type="Refund" tabindex="0">
              <span class="type-icon">‚Ü©Ô∏è</span>
              <span class="type-label">Refund</span>
            </button>
            <button type="button" class="type-btn" data-type="Reimbursement" tabindex="0">
              <span class="type-icon">üí≥</span>
              <span class="type-label">Reimbursement</span>
            </button>
            <button type="button" class="type-btn" data-type="Close Job" tabindex="0">
              <span class="type-icon">‚úÖ</span>
              <span class="type-label">Close Job</span>
            </button>
            <button type="button" class="type-btn" data-type="DNC" tabindex="0">
              <span class="type-icon">üö´</span>
              <span class="type-label">DNC</span>
            </button>
          </div>
          <input type="hidden" id="jobType" name="Type" required>
        </div>

        <!-- Category Selection (Billable only) -->
        <div class="form-section conditional-section" id="categorySection">
          <div class="section-title">
            <div class="section-icon">üì¶</div>
            <span>Category</span>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">
                Select Category <span class="required">*</span>
              </label>
              <select id="categorySelect" name="Category" class="form-input">
                <option value="">Select...</option>
                <option value="Labour">Labour</option>
                <option value="FuelDisposal">Fuel Disposal</option>
                <option value="Parts">Parts</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Financial Information (Conditional) -->
        <div class="form-section conditional-section" id="financialSection">
          <div class="section-title">
            <div class="section-icon">üí∞</div>
            <span>Financial Details</span>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" id="amountLabel">
                Amount
              </label>
              <input type="number" id="amount" name="Amount" class="form-input" placeholder="0.00" step="0.01" min="0">
            </div>
          </div>
        </div>

        <!-- Supplier Information (Conditional) -->
        <div class="form-section conditional-section" id="supplierSection">
          <div class="section-title">
            <div class="section-icon">üè≠</div>
            <span>Supplier Information</span>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">
                Supplier Name <span class="required">*</span>
              </label>
              <input type="text" id="supplierName" name="Supplier" class="form-input" placeholder="Supplier Company Ltd">
            </div>
            <div class="form-group">
              <label class="form-label">
                Supplier Email <span class="required">*</span>
              </label>
              <input type="email" id="supplierEmail" name="EmailJobToSupplier" class="form-input" placeholder="supplier@company.com">
            </div>
            <div class="form-group">
              <label class="form-label">
                Supplier Phone <span class="required">*</span>
              </label>
              <input type="tel" id="supplierPhone" name="TextJobToMobileNumber" class="form-input" placeholder="09 123 4567">
            </div>
            <div class="form-group">
              <label class="form-label">
                Bank Account
              </label>
              <input type="text" id="bankAccount" name="Bank" class="form-input" placeholder="00-0000-0000000-00">
            </div>
            <div class="form-group">
              <label class="form-label">
                Text Supplier?
              </label>
              <div class="flag-item">
                <input type="checkbox" id="textSupplier" name="TextSupplier" class="flag-checkbox" value="Yes">
                <span>Yes, text supplier</span>
              </div>
            </div>
          </div>
        </div>



        <!-- Job Details -->
        <div class="form-section" id="jobNotesSection">
          <div class="section-title">
            <div class="section-icon">üìù</div>
            <span>Job Details</span>
          </div>
          <div class="form-group" style="margin-bottom:20px">
            <label class="form-label">
              Job Notes
            </label>
            <textarea id="jobNotes" name="JobNotes" class="form-textarea" placeholder="Enter job notes and details..." rows="5"></textarea>
          </div>
        </div>

        <!-- Additional Flags -->
        <div class="form-section">
          <div class="section-title">
            <div class="section-icon">üè¥</div>
            <span>Additional Options</span>
          </div>
          <div class="form-grid">
            <div class="form-group" id="paidGroup">
              <label class="form-label">
                Payment Type (Paid?)
              </label>
              <select id="paidFlag" name="Paid" class="form-input">
                <option value="">Select...</option>
                <option value="Bank">Bank</option>
                <option value="Cash">Cash</option>
                <option value="Credit Card">Credit Card</option>
                <option value="No">No</option>
                <option value="Reimbursable">Reimbursable</option>
              </select>
            </div>
          </div>
          <div class="flag-group" style="margin-top:20px" id="closePostGroup">
            <label class="flag-item">
              <input type="checkbox" id="closePostFlag" name="CloseAndPostJobForBilling" class="flag-checkbox" value="Yes">
              <span>Close and Post Job For Billing</span>
            </label>
          </div>
        </div>

        <!-- Submit Section -->
        <div class="submit-section">
          <div>
            <span style="color:var(--text-secondary);font-size:.9em">
              All fields marked with <span class="required">*</span> are required
            </span>
          </div>
          <div class="submit-actions">
            <button type="button" class="btn-submit btn-secondary" onclick="clearForm()">Clear Form</button>
            <button type="submit" class="btn-submit btn-primary" id="submitBtn">Submit Job</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <div>Submitting job...</div>
    </div>
  </div>

  <script>
    'use strict';

    // SharePoint Lookup API URL (for fetching existing data)
    const SHAREPOINT_LOOKUP_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/c35b9414a0be42f88182ae7e6e409f1d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=2ztt24wScLuAfifD0pjzovseRDKXBAEtCQtScGMgPqQ';

    // SharePoint Update API URL (for saving full merged data to EncodedData)
    const SHAREPOINT_UPDATE_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ebc96da57e35479b8dd03a6abd06686c/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=abw4-RdaVDllhMuODkPGn0iMZtuXjhmnaYyUOefn5F4';

    // Excel API URL (for writing job-specific fields to xlsm)
    const EXCEL_WRITE_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ca2a97affbc449419b28ecb274d4c737/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=s2OFNz6J6KdjOKUUF1SRkZKo4UiPh01_uSzxy4Bg7Yw';

    // State
    let selectedType = null;
    let sharepointId = null; // Store SharePoint ID for submission
    let originalBookingData = null; // Store original booking data for merging

    // Base64 Decode Function - decodes SharePoint ID
    function decodeBase64(encoded) {
      try {
        const decoded = atob(encoded).trim();
        console.log('üîì Base64 decoded:', decoded);
        
        if (decoded) {
          return { bookingId: decoded };
        }
        
        console.warn('‚ö†Ô∏è Decoded string is empty');
        return null;
      } catch (e) {
        console.error('‚ùå Failed to decode:', e);
        return null;
      }
    }

    // Fetch job data from SharePoint (if bookingId is provided)
    async function fetchJobDataFromSharePoint(bookingId) {
      console.log('üîç Fetching job data from SharePoint for bookingId:', bookingId);
      console.log('üîó Using API endpoint:', SHAREPOINT_LOOKUP_URL);
      
      if (!bookingId) {
        console.warn('‚ö†Ô∏è No bookingId provided');
        return null;
      }
      
      try {
        const requestBody = { bookingId: String(bookingId) };
        console.log('üì§ Sending request:', requestBody);
        
        const res = await fetch(SHAREPOINT_LOOKUP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });
        
        console.log('üì• Response status:', res.status, res.statusText);
        
        if (!res.ok) {
          const errorText = await res.text();
          console.error('‚ùå HTTP Error Response:', errorText);
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const result = await res.json();
        console.log('üì¶ Raw API response:', result);
        
        if (result.success && result.bookingData) {
          const json = atob(result.bookingData);
          const decoded = JSON.parse(json);
          decoded.sharepointId = bookingId;
          decoded.sharepointStatus = result.status;
          decoded.retrievedAt = new Date().toISOString();
          // Store sharepointId for form submission
          sharepointId = bookingId;
          // Store original data for merging on submit
          originalBookingData = decoded;
          console.log('‚úÖ SharePoint data retrieved and decoded successfully:', decoded);
          return decoded;
        } else {
          console.warn('‚ö†Ô∏è SharePoint API returned:', {
            success: result.success,
            hasBookingData: !!result.bookingData,
            fullResponse: result
          });
        }
        return null;
      } catch (err) {
        console.error('‚ùå SharePoint fetch error:', err);
        console.error('‚ùå Error details:', {
          message: err.message,
          stack: err.stack,
          name: err.name
        });
        return null;
      }
    }

    // Populate form from booking data
    function populateFormFromData(bookingData) {
      if (!bookingData) return;

      console.log('üìù Populating form from booking data:', bookingData);

      // Get customerData if it exists (nested structure from BookingData)
      const customerData = bookingData.customerData || {};
      
      // Helper to get value from root or customerData (checks multiple key variations)
      const getValue = (...keys) => {
        for (const key of keys) {
          if (bookingData[key] !== undefined && bookingData[key] !== null && bookingData[key] !== '') {
            return bookingData[key];
          }
          if (customerData[key] !== undefined && customerData[key] !== null && customerData[key] !== '') {
            return customerData[key];
          }
        }
        return null;
      };

      // Normalize value helper - decodes HTML entities for proper rendering
      const normalizeValue = (value) => {
        if (value === null || value === undefined) return '';
        let str = String(value).trim();
        // Decode HTML entities (apostrophes, ampersands, etc.)
        const textarea = document.createElement('textarea');
        textarea.innerHTML = str;
        return textarea.value;
      };

      // Vehicle Information - check both EncodedData (Rego) and BookingData (rego, vehicleRego)
      const regoValue = getValue('Rego', 'rego', 'vehicleRego');
      if (regoValue) {
        const field = document.getElementById('rego');
        if (field) {
          field.value = normalizeValue(regoValue);
          console.log('‚úÖ Set rego =', regoValue);
        }
      }
      
      // Contact Information - check both EncodedData (Email) and BookingData (email, customerEmail)
      const emailValue = getValue('Email', 'email', 'customerEmail');
      if (emailValue) {
        const field = document.getElementById('email');
        if (field) {
          field.value = normalizeValue(emailValue);
          console.log('‚úÖ Set email =', emailValue);
        }
      }
      
      // Phone - check both EncodedData (ClientMobileNumber) and BookingData (phone, customerPhone)
      const phoneValue = getValue('ClientMobileNumber', 'phone', 'customerPhone');
      if (phoneValue) {
        const field = document.getElementById('clientMobileNumber');
        if (field) {
          field.value = normalizeValue(phoneValue);
          console.log('‚úÖ Set phone =', phoneValue);
        }
      }

      // Amount - only populate from EncodedData (job form), not from BookingData (Stripe)
      // Check for Costings, Chargeables, or Reimbursement field names
      const costingsValue = getValue('Costings');
      const chargeablesValue = getValue('Chargeables');
      const reimbursementValue = getValue('Reimbursement');
      const amountValue = costingsValue || chargeablesValue || reimbursementValue;
      
      if (amountValue) {
        const field = document.getElementById('amount');
        if (field) {
          field.value = parseFloat(amountValue);
          console.log('‚úÖ Set amount =', amountValue);
        }
      }
      // Note: Do NOT populate from BookingData 'amount' field - that's Stripe cents

      // Job Notes (from description or JobNotes)
      const descriptionValue = getValue('JobNotes', 'description', 'jobNotes', 'notes');
      if (descriptionValue) {
        const field = document.getElementById('jobNotes');
        if (field) {
          field.value = normalizeValue(descriptionValue);
          console.log('‚úÖ Set jobNotes =', descriptionValue);
        }
      }

      // Supplier Information
      const supplierNameValue = getValue('Supplier', 'supplierName', 'supplier');
      if (supplierNameValue) {
        const field = document.getElementById('supplierName');
        if (field) {
          field.value = normalizeValue(supplierNameValue);
          console.log('‚úÖ Set supplierName =', supplierNameValue);
        }
      }

      const supplierEmailValue = getValue('EmailJobToSupplier', 'supplierEmail');
      if (supplierEmailValue) {
        const field = document.getElementById('supplierEmail');
        if (field) {
          field.value = normalizeValue(supplierEmailValue);
          console.log('‚úÖ Set supplierEmail =', supplierEmailValue);
        }
      }

      const supplierPhoneValue = getValue('TextJobToMobileNumber', 'supplierPhone');
      if (supplierPhoneValue) {
        const field = document.getElementById('supplierPhone');
        if (field) {
          field.value = normalizeValue(supplierPhoneValue);
          console.log('‚úÖ Set supplierPhone =', supplierPhoneValue);
        }
      }

      // Bank Account
      const bankValue = getValue('Bank', 'bankAccount');
      if (bankValue) {
        const field = document.getElementById('bankAccount');
        if (field) {
          field.value = normalizeValue(bankValue);
          console.log('‚úÖ Set bankAccount =', bankValue);
        }
      }

      // Text Supplier checkbox
      const textSupplierValue = getValue('TextSupplier');
      if (textSupplierValue === 'Yes') {
        const field = document.getElementById('textSupplier');
        if (field) {
          field.checked = true;
          field.closest('.flag-item')?.classList.add('checked');
          console.log('‚úÖ Set textSupplier = Yes');
        }
      }

      // Payment Type (Paid) dropdown
      const paidValue = getValue('Paid', 'paid', 'PaymentType', 'paymentType');
      if (paidValue) {
        const field = document.getElementById('paidFlag');
        if (field) {
          const normalizedPaid = normalizeValue(paidValue);
          const validOptions = ['Bank', 'Cash', 'Credit Card', 'No', 'Reimbursable'];
          if (validOptions.includes(normalizedPaid)) {
            field.value = normalizedPaid;
            console.log('‚úÖ Set paidFlag =', normalizedPaid);
          }
        }
      }

      // Close and Post flag
      const closePostValue = getValue('CloseAndPostJobForBilling');
      if (closePostValue === 'Yes') {
        const field = document.getElementById('closePostFlag');
        if (field) {
          field.checked = true;
          field.closest('.flag-item')?.classList.add('checked');
          console.log('‚úÖ Set closePostFlag = Yes');
        }
      }

      // Handle type selection if present
      const typeValue = getValue('Type', 'type');
      if (typeValue) {
        selectType(typeValue);
      }

      console.log('‚úÖ Form populated from booking data');
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ Job form page initialized');
      
      const urlParams = new URLSearchParams(window.location.search);
      const encodedData = urlParams.get('d');
      
      let bookingId = null;
      
      // Decode base64 SharePoint ID if present
      if (encodedData) {
        const decoded = decodeBase64(encodedData);
        if (decoded) {
          bookingId = decoded.bookingId;
          console.log('üîë Decoded bookingId:', bookingId);
        }
      } else {
        // Fall back to regular URL parameter
        bookingId = urlParams.get('bookingId');
      }
      
      // Fetch data from SharePoint and prefill form
      if (bookingId) {
        console.log('üîÑ Fetching SharePoint data for bookingId:', bookingId);
        const sharePointData = await fetchJobDataFromSharePoint(bookingId);
        if (sharePointData) {
          console.log('‚úÖ SharePoint data received:', sharePointData);
          sharepointId = bookingId;
          populateFormFromData(sharePointData);
        } else {
          console.warn('‚ö†Ô∏è No SharePoint data returned for bookingId:', bookingId);
          showWarning('Could not load booking data');
        }
      }

      // Setup form handlers
      setupTypeSelector();
      setupCategorySelector();
      setupAmountCalculations();
      setupKeyboardShortcuts();
      setupFlagToggles();
      
      // Generate ID if not populated
      if (!document.getElementById('id').value) {
        generateJobId();
      }
    });

    // Generate Job ID
    function generateJobId() {
      const timestamp = Date.now();
      const random = Math.floor(Math.random() * 1000);
      document.getElementById('id').value = `EEK${timestamp}${random}`;
    }

    // Type Selection
    function setupTypeSelector() {
      const buttons = document.querySelectorAll('.type-btn');
      
      buttons.forEach(btn => {
        btn.addEventListener('click', () => selectType(btn.dataset.type));
        btn.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            selectType(btn.dataset.type);
          }
        });
      });
    }

    function selectType(type) {
      selectedType = type;
      document.getElementById('jobType').value = type;

      // Update UI
      document.querySelectorAll('.type-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.type === type);
      });

      // Reset form sections
      document.getElementById('categorySection').classList.remove('show');
      document.getElementById('financialSection').classList.remove('show');
      document.getElementById('supplierSection').classList.remove('show');
      document.getElementById('jobNotesSection').style.display = 'none';
      document.getElementById('paidGroup').style.display = 'none';
      document.getElementById('closePostGroup').style.display = 'none';
      
      // Clear defaults
      document.getElementById('jobNotes').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('amount').required = false;

      // DNC - just rego and fixed job notes, nothing editable
      if (type === 'DNC') {
        // Auto-set job notes and submit immediately possible
        document.getElementById('jobNotes').value = '[DNC]';
        return;
      }

      // Close Job - rego, editable job notes, auto-set Close/Post=Yes
      if (type === 'Close Job') {
        document.getElementById('jobNotesSection').style.display = '';
        document.getElementById('jobNotes').value = 'Release Payment Received (Stripe)';
        document.getElementById('closePostFlag').checked = true;
        return;
      }

      // Supplier - Name=Mechanic, optional amount/bank, supplier details
      if (type === 'Supplier') {
        document.getElementById('financialSection').classList.add('show');
        document.getElementById('supplierSection').classList.add('show');
        document.getElementById('jobNotesSection').style.display = '';
        document.getElementById('paidGroup').style.display = '';
        document.getElementById('closePostGroup').style.display = '';
        document.getElementById('amountLabel').textContent = 'Costings';
        return;
      }

      // Deposit - Name=Payment, amount, job notes
      if (type === 'Deposit') {
        document.getElementById('financialSection').classList.add('show');
        document.getElementById('jobNotesSection').style.display = '';
        document.getElementById('paidGroup').style.display = '';
        document.getElementById('closePostGroup').style.display = '';
        document.getElementById('amountLabel').textContent = 'Reimbursement';
        document.getElementById('amount').required = true;
        return;
      }

      // Billable - category dropdown with defaults
      if (type === 'Billable') {
        document.getElementById('categorySection').classList.add('show');
        document.getElementById('financialSection').classList.add('show');
        document.getElementById('jobNotesSection').style.display = '';
        document.getElementById('paidGroup').style.display = '';
        document.getElementById('closePostGroup').style.display = '';
        document.getElementById('amountLabel').textContent = 'Chargeables';
        document.getElementById('amount').required = true;
        return;
      }

      // Refund / Reimbursement - amount, job notes, paid, close/post
      if (type === 'Refund' || type === 'Reimbursement') {
        document.getElementById('financialSection').classList.add('show');
        document.getElementById('jobNotesSection').style.display = '';
        document.getElementById('paidGroup').style.display = '';
        document.getElementById('closePostGroup').style.display = '';
        document.getElementById('amountLabel').textContent = 'Reimbursement';
        document.getElementById('amount').required = true;
        return;
      }
    }

    // Handle Billable category selection - set defaults
    function setupCategorySelector() {
      const categorySelect = document.getElementById('categorySelect');
      categorySelect.addEventListener('change', function() {
        const defaults = {
          'Labour': { notes: 'Labour @ 4 hrs x $172.50/hr', amount: 690 },
          'FuelDisposal': { notes: 'Fuel Disposal Fee @ 80Ltrs x $4.31/Ltr', amount: 344.8 },
          'Parts': { notes: 'Filter/Freight/Sundries', amount: 280 }
        };
        
        const selected = this.value;
        if (defaults[selected]) {
          document.getElementById('jobNotes').value = defaults[selected].notes;
          document.getElementById('amount').value = defaults[selected].amount;
        }
      });
    }

    // Amount field setup (no GST calculation needed - values are incl GST)
    function setupAmountCalculations() {
      // No calculation needed - single field for amount incl GST
    }

    // Flag toggle styling
    function setupFlagToggles() {
      document.querySelectorAll('.flag-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          this.closest('.flag-item')?.classList.toggle('checked', this.checked);
        });
      });
    }

// Form Submission - two calls: SharePoint (full data) and Excel (job fields only)
    async function handleSubmit(event) {
      event.preventDefault();
      
      if (!validateForm()) return;

      showLoading(true);

      try {
        // Collect both data sets
        const fullData = collectFormData();  // Full merged data for SharePoint
        const excelData = collectExcelData(); // Job-specific fields for Excel

        // 1. Update SharePoint with full merged data
        console.log('üì§ Updating SharePoint with full data:', fullData);
        const spResponse = await fetch(SHAREPOINT_UPDATE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(fullData)
        });

        if (!spResponse.ok) {
          const errorText = await spResponse.text();
          throw new Error(`SharePoint update failed: ${spResponse.status} - ${errorText}`);
        }
        console.log('‚úÖ SharePoint updated successfully');

        // 2. Write to Excel with job-specific fields only
        console.log('üì§ Writing to Excel:', excelData);
        const excelResponse = await fetch(EXCEL_WRITE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(excelData)
        });

        if (!excelResponse.ok) {
          const errorText = await excelResponse.text();
          throw new Error(`Excel write failed: ${excelResponse.status} - ${errorText}`);
        }
        console.log('‚úÖ Excel updated successfully');
        
        showSuccess('Job submitted successfully!');
        
        if (typeof gtag === 'function') {
          gtag('event', 'form_submit_success', {
            form_type: 'job'
          });
        }
        
        // Clear form after 2 seconds
        setTimeout(() => {
          clearForm();
        }, 2000);

      } catch (error) {
        console.error('Submission error:', error);
        showError(`Failed to submit job: ${error.message}`);
        
        if (typeof gtag === 'function') {
          gtag('event', 'form_submit_error', {
            form_type: 'job',
            error_message: error.message
          });
        }
      } finally {
        showLoading(false);
      }
    }

    // Collect Excel-specific data (only fields relevant to job type)
    function collectExcelData() {
      const type = document.getElementById('jobType').value;
      const data = {
        Rego: document.getElementById('rego').value.toUpperCase(),
        Type: type
      };
      const fields = [
        { name: 'Rego', value: data.Rego },
        { name: 'Type', value: type }
      ];

      if (type === 'Supplier') {
        data.Name = 'Mechanic';
        data.Supplier = document.getElementById('supplierName').value;
        data.Costings = parseFloat(document.getElementById('amount').value) || '';
        data.JobNotes = document.getElementById('jobNotes').value;
        data.Paid = document.getElementById('paidFlag').value || '';
        data.CloseAndPostJobForBilling = document.getElementById('closePostFlag').checked ? 'Yes' : 'No';
        data.Bank_Account = document.getElementById('bankAccount').value;
        data.Supp_Email = document.getElementById('supplierEmail').value;
        data.Supp_Phone = document.getElementById('supplierPhone').value;
        
        fields.push({ name: 'Name', value: data.Name });
        fields.push({ name: 'Supplier', value: data.Supplier });
        if (data.Costings) fields.push({ name: 'Costings', value: data.Costings });
        fields.push({ name: 'JobNotes', value: data.JobNotes });
        fields.push({ name: 'Paid', value: data.Paid });
        fields.push({ name: 'CloseAndPostJobForBilling', value: data.CloseAndPostJobForBilling });
        fields.push({ name: 'Bank_Account', value: data.Bank_Account });
        fields.push({ name: 'Supp_Email', value: data.Supp_Email });
        fields.push({ name: 'Supp_Phone', value: data.Supp_Phone });
      }
      
      else if (type === 'Billable') {
        data.Name = document.getElementById('categorySelect').value;
        data.JobNotes = document.getElementById('jobNotes').value;
        data.Chargeables = parseFloat(document.getElementById('amount').value) || '';
        data.Paid = document.getElementById('paidFlag').value || '';
        data.CloseAndPostJobForBilling = document.getElementById('closePostFlag').checked ? 'Yes' : 'No';
        
        fields.push({ name: 'Name', value: data.Name });
        fields.push({ name: 'JobNotes', value: data.JobNotes });
        if (data.Chargeables) fields.push({ name: 'Chargeables', value: data.Chargeables });
        fields.push({ name: 'Paid', value: data.Paid });
        fields.push({ name: 'CloseAndPostJobForBilling', value: data.CloseAndPostJobForBilling });
      }
      
      else if (type === 'Deposit') {
        data.Name = 'Payment';
        data.Reimbursement = parseFloat(document.getElementById('amount').value) || '';
        data.JobNotes = document.getElementById('jobNotes').value;
        data.Paid = document.getElementById('paidFlag').value || '';
        data.CloseAndPostJobForBilling = document.getElementById('closePostFlag').checked ? 'Yes' : 'No';
        
        fields.push({ name: 'Name', value: data.Name });
        if (data.Reimbursement) fields.push({ name: 'Reimbursement', value: data.Reimbursement });
        fields.push({ name: 'JobNotes', value: data.JobNotes });
        fields.push({ name: 'Paid', value: data.Paid });
        fields.push({ name: 'CloseAndPostJobForBilling', value: data.CloseAndPostJobForBilling });
      }
      
      else if (type === 'Refund' || type === 'Reimbursement') {
        data.Reimbursement = parseFloat(document.getElementById('amount').value) || '';
        data.JobNotes = document.getElementById('jobNotes').value;
        data.Paid = document.getElementById('paidFlag').value || '';
        data.CloseAndPostJobForBilling = document.getElementById('closePostFlag').checked ? 'Yes' : 'No';
        
        if (data.Reimbursement) fields.push({ name: 'Reimbursement', value: data.Reimbursement });
        fields.push({ name: 'JobNotes', value: data.JobNotes });
        fields.push({ name: 'Paid', value: data.Paid });
        fields.push({ name: 'CloseAndPostJobForBilling', value: data.CloseAndPostJobForBilling });
      }
      
      else if (type === 'Close Job') {
        data.JobNotes = document.getElementById('jobNotes').value;
        data.CloseAndPostJobForBilling = 'Yes';
        fields.push({ name: 'JobNotes', value: data.JobNotes });
        fields.push({ name: 'CloseAndPostJobForBilling', value: 'Yes' });
      }
      
      else if (type === 'DNC') {
        data.JobNotes = '[DNC]';
        fields.push({ name: 'JobNotes', value: '[DNC]' });
      }

      data.fields = fields;
      return data;
    }

    // Collect form data - merges with original data
    function collectFormData() {
      const fields = [];
      
      // Start with original booking data if it exists
      const formData = originalBookingData ? { ...originalBookingData } : {};
      
      // Add form metadata
      formData.formType = 'job';
      formData.formVersion = '2.0';
      formData.submittedAt = new Date().toISOString();
      
      // Helper to add field to both flat and array format
      const addField = (name, value) => {
        if (value !== null && value !== undefined && value !== '') {
          fields.push({ name, value });
          formData[name] = value;
        }
      };

      const type = document.getElementById('jobType').value;

      // Basic fields - always sent
      addField('Id', document.getElementById('id').value);
      addField('Rego', document.getElementById('rego').value.toUpperCase());
      addField('Email', document.getElementById('email').value);
      addField('ClientMobileNumber', document.getElementById('clientMobileNumber').value);
      addField('Type', type);
      addField('StartTime', new Date().toISOString());
      
      // SharePoint ID (if data was fetched from SharePoint)
      if (sharepointId) {
        addField('SharePointId', sharepointId);
        addField('BookingId', sharepointId);
      }

      // Type-specific fields
      if (type === 'Supplier') {
        addField('Name', 'Mechanic');
        // Supplier fields
        addField('Supplier', document.getElementById('supplierName').value);
        addField('EmailJobToSupplier', document.getElementById('supplierEmail').value);
        addField('TextJobToMobileNumber', document.getElementById('supplierPhone').value);
        addField('Bank', document.getElementById('bankAccount').value);
        addField('TextSupplier', document.getElementById('textSupplier').checked ? 'Yes' : '');
        // Financial - Costings
        const costings = parseFloat(document.getElementById('amount').value) || 0;
        if (costings > 0) {
          addField('Costings', costings);
        }
        addField('JobNotes', document.getElementById('jobNotes').value);
        addField('Paid', document.getElementById('paidFlag').value || '');
        addField('CloseAndPostJobForBilling', document.getElementById('closePostFlag').checked ? 'Yes' : 'No');
      }
      
      else if (type === 'Billable') {
        addField('Name', document.getElementById('categorySelect').value);
        addField('JobNotes', document.getElementById('jobNotes').value);
        // Financial - Chargeables
        const chargeables = parseFloat(document.getElementById('amount').value) || 0;
        if (chargeables > 0) {
          addField('Chargeables', chargeables);
        }
        addField('Paid', document.getElementById('paidFlag').value || '');
        addField('CloseAndPostJobForBilling', document.getElementById('closePostFlag').checked ? 'Yes' : 'No');
      }
      
      else if (type === 'Deposit') {
        addField('Name', 'Payment');
        addField('JobNotes', document.getElementById('jobNotes').value);
        // Financial - Reimbursement
        const reimbursement = parseFloat(document.getElementById('amount').value) || 0;
        if (reimbursement > 0) {
          addField('Reimbursement', reimbursement);
        }
        addField('Paid', document.getElementById('paidFlag').value || '');
        addField('CloseAndPostJobForBilling', document.getElementById('closePostFlag').checked ? 'Yes' : 'No');
      }
      
      else if (type === 'Refund' || type === 'Reimbursement') {
        addField('JobNotes', document.getElementById('jobNotes').value);
        // Financial - Reimbursement
        const reimbursement = parseFloat(document.getElementById('amount').value) || 0;
        if (reimbursement > 0) {
          addField('Reimbursement', reimbursement);
        }
        addField('Paid', document.getElementById('paidFlag').value || '');
        addField('CloseAndPostJobForBilling', document.getElementById('closePostFlag').checked ? 'Yes' : 'No');
      }
      
      else if (type === 'Close Job') {
        addField('JobNotes', document.getElementById('jobNotes').value);
        addField('CloseAndPostJobForBilling', 'Yes');
      }
      
      else if (type === 'DNC') {
        addField('JobNotes', '[DNC]');
      }

      // Add the fields array
      formData.fields = fields;

      return formData;
    }

    function validateForm() {
      const form = document.getElementById('jobForm');
      
      // Check HTML5 validation
      if (!form.checkValidity()) {
        form.reportValidity();
        return false;
      }

      // Check type selection
      if (!selectedType) {
        showError('Please select a job type');
        document.getElementById('typeSelector').scrollIntoView({ behavior: 'smooth' });
        return false;
      }

      // Supplier validation
      if (selectedType === 'Supplier') {
        if (!document.getElementById('supplierName').value) {
          showError('Supplier name is required');
          document.getElementById('supplierName').focus();
          return false;
        }
        if (!document.getElementById('supplierEmail').value) {
          showError('Supplier email is required');
          document.getElementById('supplierEmail').focus();
          return false;
        }
        if (!document.getElementById('supplierPhone').value) {
          showError('Supplier phone is required');
          document.getElementById('supplierPhone').focus();
          return false;
        }
      }

      // Billable validation - must select category
      if (selectedType === 'Billable') {
        if (!document.getElementById('categorySelect').value) {
          showError('Please select a category');
          document.getElementById('categorySelect').focus();
          return false;
        }
        if (!document.getElementById('amount').value || parseFloat(document.getElementById('amount').value) <= 0) {
          showError('Please enter a valid amount');
          document.getElementById('amount').focus();
          return false;
        }
      }

      // Financial validation for Deposit, Refund, Reimbursement
      if (['Deposit', 'Refund', 'Reimbursement'].includes(selectedType)) {
        if (!document.getElementById('amount').value || parseFloat(document.getElementById('amount').value) <= 0) {
          showError('Please enter a valid amount');
          document.getElementById('amount').focus();
          return false;
        }
      }

      return true;
    }

    // Utility Functions
    function clearForm() {
      document.getElementById('jobForm').reset();
      selectedType = null;
      document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('selected'));
      document.querySelectorAll('.conditional-section').forEach(section => section.classList.remove('show'));
      document.querySelectorAll('.flag-item').forEach(item => item.classList.remove('checked'));
      document.getElementById('jobNotesSection').style.display = 'none';
      document.getElementById('paidGroup').style.display = 'none';
      document.getElementById('closePostGroup').style.display = 'none';
      generateJobId();
    }

    // Keyboard Shortcuts
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // Ctrl+Enter to submit
        if (e.ctrlKey && e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('jobForm').requestSubmit();
        }
        
        // Esc to clear focus
        if (e.key === 'Escape') {
          document.activeElement.blur();
        }

        // Alt+1-7 for type selection
        if (e.altKey && e.key >= '1' && e.key <= '7') {
          const types = ['Supplier', 'Billable', 'Deposit', 'Refund', 'Reimbursement', 'Close Job', 'DNC'];
          const index = parseInt(e.key) - 1;
          if (types[index]) {
            selectType(types[index]);
          }
        }
      });
    }

    // UI Functions
    function showLoading(show) {
      document.getElementById('loadingOverlay').classList.toggle('show', show);
    }

    function showMessage(message, type) {
      const messageEl = document.getElementById(`${type}Message`);
      messageEl.textContent = message;
      messageEl.classList.add('show');
      
      setTimeout(() => {
        messageEl.classList.remove('show');
      }, 5000);
    }

    function showSuccess(message) { showMessage(message, 'success'); }
    function showError(message) { showMessage(message, 'error'); }
    function showWarning(message) { showMessage(message, 'warning'); }
  </script>
</body>
</html>
