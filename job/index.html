<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Job Form | Eek Mechanical</title>
  <meta name="description" content="Create new service jobs for Eek Mechanical">
  <meta name="robots" content="noindex, nofollow">

  <!-- Security Headers -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://static.cloudflareinsights.com;
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    connect-src 'self' https://www.eek.nz https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com https://static.cloudflareinsights.com;
    font-src 'self' data:;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">

  <!-- Centralized Phone Number Management -->
  <script src="/phone-manager.js"></script>
  
  <!-- Unified Tracking System (Internal Analytics) -->
  <script src="/unified-tracking.js"></script>
  
  <!-- Centralized Footer Management -->
  <script src="/footer-new.js"></script>

  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary-color:#ff5500;--primary-dark:#e04400;--secondary-color:#ff7700;
      --success-color:#10b981;--warning-color:#f59e0b;--error-color:#ef4444;
      --info-color:#3b82f6;--text-primary:#1e293b;--text-secondary:#64748b;
      --border-color:#e2e8f0;--bg-light:#f8fafc;--bg-white:#ffffff;
      --shadow-sm:0 1px 2px 0 rgba(0,0,0,.05);--shadow-md:0 4px 6px -1px rgba(0,0,0,.1);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1);--shadow-xl:0 20px 25px -5px rgba(0,0,0,.1)
    }
    body{font-family:'Segoe UI',-apple-system,BlinkMacSystemFont,sans-serif;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);min-height:100vh;color:#fff;padding:20px}
    
    /* Header */
    .header{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));box-shadow:var(--shadow-md);border-radius:12px 12px 0 0;position:relative;overflow:hidden;padding:40px 0;margin-bottom:0}
    .header::before{content:'';position:absolute;top:-50%;right:-50%;width:200%;height:200%;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.1)"/></svg>') repeat;animation:float 15s infinite linear}
    @keyframes float{0%{transform:translateX(0) translateY(0)}100%{transform:translateX(-50px) translateY(-50px)}}
    .header-content{max-width:1400px;margin:0 auto;padding:0 30px;text-align:center;position:relative;z-index:2}
    .header h1{font-size:2.8em;margin-bottom:15px;text-shadow:2px 2px 4px rgba(0,0,0,0.3)}
    .header .subtitle{font-size:1.2em;opacity:0.9;margin-bottom:20px}
    .security-badge{display:inline-block;background:rgba(255,255,255,0.2);backdrop-filter:blur(10px);padding:8px 20px;border-radius:25px;font-size:0.9em;font-weight:bold;border:1px solid rgba(255,255,255,0.3)}

    /* Main Form */
    .container{max-width:1400px;margin:0 auto}
    .form-container{background:var(--bg-white);color:var(--text-primary);border-radius:0 0 12px 12px;padding:32px;box-shadow:var(--shadow-lg);border:1px solid var(--border-color)}
    
    /* Form Sections */
    .form-section{margin-bottom:32px;padding-bottom:24px;border-bottom:2px solid var(--border-color)}
    .form-section:last-child{border-bottom:none}
    .section-title{font-size:1.1em;font-weight:600;color:var(--primary-color);margin-bottom:20px;display:flex;align-items:center;gap:8px}
    .section-icon{width:28px;height:28px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px}
    
    /* Form Grid */
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px}
    .form-group{display:flex;flex-direction:column}
    .form-label{font-size:.85em;color:var(--text-secondary);font-weight:600;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
    .required{color:var(--error-color)}
    .form-input,.form-select,.form-textarea{padding:12px 16px;border:2px solid var(--border-color);border-radius:8px;font-size:1em;background:var(--bg-white);transition:all .2s;color:var(--text-primary)}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(255,85,0,.1)}
    .form-input:disabled,.form-input[readonly]{background:#f8f9fa;cursor:not-allowed;opacity:0.7}
    .form-textarea{resize:vertical;min-height:100px;font-family:inherit}
    
    /* Type Selector */
    .type-selector{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
    .type-btn{padding:14px;background:var(--bg-white);border:2px solid var(--border-color);border-radius:10px;cursor:pointer;font-weight:600;text-align:center;transition:all .2s;position:relative;overflow:hidden}
    .type-btn:hover{border-color:var(--primary-color);transform:translateY(-2px);box-shadow:var(--shadow-md)}
    .type-btn.selected{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:#fff;border-color:var(--primary-color)}
    .type-btn.selected::after{content:'‚úì';position:absolute;top:4px;right:8px;font-size:16px}
    .type-icon{display:block;font-size:24px;margin-bottom:4px}
    .type-label{font-size:.9em}
    
    /* Conditional Sections */
    .conditional-section{display:none;animation:slideDown .3s ease}
    .conditional-section.show{display:block}
    @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    
    /* Flags */
    .flag-group{display:flex;gap:20px;flex-wrap:wrap}
    .flag-item{display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 16px;border:2px solid var(--border-color);border-radius:8px;transition:all .2s}
    .flag-item:hover{border-color:var(--primary-color);background:var(--bg-light)}
    .flag-checkbox{width:20px;height:20px;cursor:pointer}
    .flag-item.checked{background:linear-gradient(135deg,rgba(255,85,0,.1),rgba(255,119,0,.1));border-color:var(--primary-color)}
    
    /* Quick Fill */
    .quick-fill{background:var(--bg-light);padding:16px;border-radius:10px;margin-bottom:20px;border:2px dashed var(--primary-color)}
    .quick-fill-title{font-weight:600;color:var(--primary-color);margin-bottom:10px}
    .quick-actions{display:flex;gap:10px;flex-wrap:wrap}
    .quick-btn{padding:8px 16px;background:var(--bg-white);border:1px solid var(--border-color);border-radius:6px;cursor:pointer;font-size:.9em;transition:all .2s;color:var(--text-primary)}
    .quick-btn:hover{background:var(--primary-color);color:#fff;transform:translateY(-1px)}
    
    /* Submit Section */
    .submit-section{display:flex;justify-content:space-between;align-items:center;padding-top:24px;border-top:2px solid var(--border-color);margin-top:32px}
    .submit-actions{display:flex;gap:12px}
    .btn-submit{padding:14px 32px;border-radius:10px;border:none;cursor:pointer;font-weight:600;font-size:1em;transition:all .2s}
    .btn-primary{background:linear-gradient(135deg,var(--success-color),#059669);color:#fff}
    .btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:var(--shadow-lg)}
    .btn-primary:disabled{background:#6c757d;cursor:not-allowed}
    .btn-secondary{background:var(--bg-light);color:var(--text-primary);border:2px solid var(--border-color)}
    
    /* Loading & Messages */
    .loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999}
    .loading-overlay.show{display:flex}
    .loading-content{background:var(--bg-white);padding:32px;border-radius:16px;text-align:center;color:var(--text-primary)}
    .spinner{width:48px;height:48px;border:4px solid var(--border-color);border-top:4px solid var(--primary-color);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    .message{padding:16px;border-radius:10px;margin-bottom:20px;display:none;animation:slideDown .3s ease}
    .message.show{display:block}
    .message.success{background:#d1fae5;border:1px solid #6ee7b7;color:#065f46}
    .message.error{background:#fee2e2;border:1px solid #fca5a5;color:#991b1b}
    .message.warning{background:#fed7aa;border:1px solid #fdba74;color:#92400e}
    
    /* Responsive */
    @media(max-width:768px){
      body{padding:10px}
      .form-grid{grid-template-columns:1fr}
      .type-selector{grid-template-columns:repeat(2,1fr)}
      .submit-section{flex-direction:column;gap:16px}
      .header h1{font-size:2em}
      .form-container{padding:20px}
    }
    
    :focus-visible{outline:2px solid var(--primary-color);outline-offset:2px}
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1>üìã Job Form</h1>
      <p class="subtitle">Create New Service Job</p>
      <div class="security-badge">üîí Secure Submission</div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Messages -->
    <div id="successMessage" class="message success"></div>
    <div id="errorMessage" class="message error"></div>
    <div id="warningMessage" class="message warning"></div>

    <!-- Form Container -->
    <div class="form-container">
      <form id="jobForm" onsubmit="handleSubmit(event)">
        
        <!-- Quick Fill Section -->
        <div class="quick-fill">
          <div class="quick-fill-title">‚ö° Quick Fill Templates</div>
          <div class="quick-actions" id="quickFillButtons">
            <button type="button" class="quick-btn" onclick="quickFill('fuel-extraction')">Fuel Extraction</button>
            <button type="button" class="quick-btn" onclick="quickFill('tyre-change')">Tyre Change</button>
            <button type="button" class="quick-btn" onclick="quickFill('jump-start')">Jump Start</button>
            <button type="button" class="quick-btn" onclick="quickFill('fuel-delivery')">Fuel Delivery</button>
            <button type="button" class="quick-btn" onclick="quickFill('lockout')">Lockout</button>
            <button type="button" class="quick-btn" onclick="quickFill('towing')">Towing</button>
          </div>
        </div>

        <!-- Basic Information -->
        <div class="form-section">
          <div class="section-title">
            <div class="section-icon">üìã</div>
            <span>Basic Information</span>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">
                ID
              </label>
              <input type="text" id="id" name="Id" class="form-input" placeholder="Auto-generated" readonly>
            </div>
            <div class="form-group">
              <label class="form-label">
                Email <span class="required">*</span>
              </label>
              <input type="email" id="email" name="Email" class="form-input" placeholder="customer@email.com" required>
            </div>
            <div class="form-group">
              <label class="form-label">
                Name <span class="required">*</span>
              </label>
              <input type="text" id="name" name="Name" class="form-input" placeholder="John Smith" required>
            </div>
            <div class="form-group">
              <label class="form-label">
                Rego <span class="required">*</span>
              </label>
              <input type="text" id="rego" name="Rego" class="form-input" placeholder="ABC123" style="text-transform:uppercase" maxlength="10" required>
            </div>
            <div class="form-group">
              <label class="form-label">
                Client Mobile Number
              </label>
              <input type="tel" id="clientMobileNumber" name="ClientMobileNumber" class="form-input" placeholder="021 123 4567">
            </div>
          </div>
        </div>

        <!-- Job Type Selection -->
        <div class="form-section">
          <div class="section-title">
            <div class="section-icon">üíº</div>
            <span>Job Type (Tab through or click)</span>
          </div>
          <div class="type-selector" id="typeSelector">
            <button type="button" class="type-btn" data-type="Billable" tabindex="0">
              <span class="type-icon">üíµ</span>
              <span class="type-label">Billable</span>
            </button>
            <button type="button" class="type-btn" data-type="Supplier" tabindex="0">
              <span class="type-icon">üè≠</span>
              <span class="type-label">Supplier</span>
            </button>
            <button type="button" class="type-btn" data-type="Refund" tabindex="0">
              <span class="type-icon">‚Ü©Ô∏è</span>
              <span class="type-label">Refund</span>
            </button>
            <button type="button" class="type-btn" data-type="Reimbursement" tabindex="0">
              <span class="type-icon">üí≥</span>
              <span class="type-label">Reimbursement</span>
            </button>
            <button type="button" class="type-btn" data-type="Deposit" tabindex="0">
              <span class="type-icon">üè¶</span>
              <span class="type-label">Deposit</span>
            </button>
            <button type="button" class="type-btn" data-type="Warranty" tabindex="0">
              <span class="type-icon">üõ°Ô∏è</span>
              <span class="type-label">Warranty</span>
            </button>
            <button type="button" class="type-btn" data-type="Internal" tabindex="0">
              <span class="type-icon">üè¢</span>
              <span class="type-label">Internal</span>
            </button>
            <button type="button" class="type-btn" data-type="Other" tabindex="0">
              <span class="type-icon">üì¶</span>
              <span class="type-label">Other</span>
            </button>
          </div>
          <input type="hidden" id="jobType" name="Type" required>
        </div>

        <!-- Financial Information (Conditional) -->
        <div class="form-section conditional-section" id="financialSection">
          <div class="section-title">
            <div class="section-icon">üí∞</div>
            <span>Financial Details</span>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">
                Amount (excl. GST) <span class="required">*</span>
              </label>
              <input type="number" id="amount" name="Amount" class="form-input" placeholder="0.00" step="0.01" min="0">
            </div>
            <div class="form-group">
              <label class="form-label">
                GST Amount
              </label>
              <input type="number" id="gstAmount" name="GSTAmount" class="form-input" placeholder="0.00" step="0.01" min="0" readonly>
            </div>
            <div class="form-group">
              <label class="form-label">
                Total (incl. GST)
              </label>
              <input type="number" id="totalAmount" name="TotalIncGST" class="form-input" placeholder="0.00" step="0.01" min="0" readonly>
            </div>
          </div>
        </div>

        <!-- Supplier Information (Conditional) -->
        <div class="form-section conditional-section" id="supplierSection">
          <div class="section-title">
            <div class="section-icon">üè≠</div>
            <span>Supplier Information</span>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">
                Supplier Name <span class="required">*</span>
              </label>
              <input type="text" id="supplierName" name="Supplier" class="form-input" placeholder="Supplier Company Ltd">
            </div>
            <div class="form-group">
              <label class="form-label">
                Supplier Email <span class="required">*</span>
              </label>
              <input type="email" id="supplierEmail" name="EmailJobToSupplier" class="form-input" placeholder="supplier@company.com">
            </div>
            <div class="form-group">
              <label class="form-label">
                Supplier Phone <span class="required">*</span>
              </label>
              <input type="tel" id="supplierPhone" name="TextJobToMobileNumber" class="form-input" placeholder="09 123 4567">
            </div>
            <div class="form-group">
              <label class="form-label">
                Bank Account
              </label>
              <input type="text" id="bankAccount" name="Bank" class="form-input" placeholder="12-3456-7890123-00">
            </div>
            <div class="form-group">
              <label class="form-label">
                Text Supplier?
              </label>
              <div class="flag-item">
                <input type="checkbox" id="textSupplier" name="TextSupplier" class="flag-checkbox" value="Yes">
                <span>Yes, text supplier</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Timing Information -->
        <div class="form-section">
          <div class="section-title">
            <div class="section-icon">‚è∞</div>
            <span>Timing Information</span>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">
                Start Time
              </label>
              <input type="datetime-local" id="startTime" name="StartTime" class="form-input">
            </div>
          </div>
        </div>

        <!-- Job Details -->
        <div class="form-section">
          <div class="section-title">
            <div class="section-icon">üìù</div>
            <span>Job Details</span>
          </div>
          <div class="form-group" style="margin-bottom:20px">
            <label class="form-label">
              Job Notes
            </label>
            <textarea id="jobNotes" name="JobNotes" class="form-textarea" placeholder="Enter job notes and details..." rows="5"></textarea>
          </div>
        </div>

        <!-- Additional Flags -->
        <div class="form-section">
          <div class="section-title">
            <div class="section-icon">üè¥</div>
            <span>Additional Options</span>
          </div>
          <div class="flag-group">
            <label class="flag-item">
              <input type="checkbox" id="paidFlag" name="Paid" class="flag-checkbox" value="Bank">
              <span>Paid?</span>
            </label>
            <label class="flag-item">
              <input type="checkbox" id="closePostFlag" name="CloseAndPostJobForBilling" class="flag-checkbox" value="Yes">
              <span>Close and Post Job For Billing</span>
            </label>
            <label class="flag-item">
              <input type="checkbox" id="existingClient" name="ExistingClient" class="flag-checkbox" value="Yes">
              <span>Existing Client</span>
            </label>
            <label class="flag-item">
              <input type="checkbox" id="chargeables" name="Chargeables" class="flag-checkbox" value="Yes">
              <span>Chargeables</span>
            </label>
          </div>
        </div>

        <!-- Submit Section -->
        <div class="submit-section">
          <div>
            <span style="color:var(--text-secondary);font-size:.9em">
              All fields marked with <span class="required">*</span> are required
            </span>
          </div>
          <div class="submit-actions">
            <button type="button" class="btn-submit btn-secondary" onclick="clearForm()">Clear Form</button>
            <button type="submit" class="btn-submit btn-primary" id="submitBtn">Submit Job</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <div>Submitting job...</div>
    </div>
  </div>

  <script>
    'use strict';

    // SharePoint Lookup API URL (for fetching existing data)
    const SHAREPOINT_LOOKUP_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/c35b9414a0be42f88182ae7e6e409f1d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=2ztt24wScLuAfifD0pjzovseRDKXBAEtCQtScGMgPqQ';

    // Power Automate endpoint for job submission
    const POWER_AUTOMATE_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ca2a97affbc449419b28ecb274d4c737/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=s2OFNz6J6KdjOKUUF1SRkZKo4UiPh01_uSzxy4Bg7Yw';

    // State
    let selectedType = null;

    // Base64 Decode Function - handles URL params format (same as customer-reply.html)
    function decodeBase64(encoded) {
      try {
        // Decode Base64
        const decoded = atob(encoded);
        console.log('üîì Base64 decoded to string:', decoded);
        
        // Parse the query string format (same approach as customer-reply.html)
        const params = new URLSearchParams(decoded);
        const data = {};
        
        for (const [key, value] of params) {
          data[key] = value;
        }
        
        // Check if we got meaningful key-value pairs
        // If all values are empty, it's likely just a plain string treated as a key
        const hasValues = Object.values(data).some(val => val && val.trim().length > 0);
        const hasMultipleKeys = Object.keys(data).length > 1;
        
        // If we have actual key-value pairs with values, return the data object
        if (hasValues || hasMultipleKeys) {
          console.log('‚úÖ Parsed as URL params:', data);
          return data;
        }
        
        // If we only have one key with empty value, it's likely a plain string
        // Fall back: treat decoded string as plain bookingId
        // This handles cases where just the bookingId number/string is encoded (e.g., "292")
        if (decoded && decoded.trim()) {
          const result = { bookingId: decoded.trim() };
          console.log('‚úÖ Treated as plain bookingId:', result);
          return result;
        }
        
        console.warn('‚ö†Ô∏è Decoded string is empty or whitespace');
        return null;
      } catch (e) {
        console.error('‚ùå Failed to decode data:', e);
        return null;
      }
    }

    // Fetch job data from SharePoint (if bookingId is provided)
    async function fetchJobDataFromSharePoint(bookingId) {
      console.log('üîç Fetching job data from SharePoint for bookingId:', bookingId);
      console.log('üîó Using API endpoint:', SHAREPOINT_LOOKUP_URL);
      
      if (!bookingId) {
        console.warn('‚ö†Ô∏è No bookingId provided');
        return null;
      }
      
      try {
        const requestBody = { bookingId: String(bookingId) };
        console.log('üì§ Sending request:', requestBody);
        
        const res = await fetch(SHAREPOINT_LOOKUP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });
        
        console.log('üì• Response status:', res.status, res.statusText);
        
        if (!res.ok) {
          const errorText = await res.text();
          console.error('‚ùå HTTP Error Response:', errorText);
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const result = await res.json();
        console.log('üì¶ Raw API response:', result);
        
        if (result.success && result.bookingData) {
          const json = atob(result.bookingData);
          const decoded = JSON.parse(json);
          decoded.sharepointId = bookingId;
          decoded.sharepointStatus = result.status;
          decoded.retrievedAt = new Date().toISOString();
          console.log('‚úÖ SharePoint data retrieved and decoded successfully:', decoded);
          return decoded;
        } else {
          console.warn('‚ö†Ô∏è SharePoint API returned:', {
            success: result.success,
            hasBookingData: !!result.bookingData,
            fullResponse: result
          });
        }
        return null;
      } catch (err) {
        console.error('‚ùå SharePoint fetch error:', err);
        console.error('‚ùå Error details:', {
          message: err.message,
          stack: err.stack,
          name: err.name
        });
        return null;
      }
    }

    // Populate form from data
    // Populate form from booking data (copied from customer-reply.html)
    function populateFormFromData(bookingData) {
      if (!bookingData) return;

      console.log('üìù Populating form from booking data:', bookingData);

      // Get customerData if it exists (nested structure)
      const customerData = bookingData.customerData || {};
      
      // Helper to get value from root or customerData
      const getValue = (...keys) => {
        for (const key of keys) {
          if (bookingData[key] !== undefined && bookingData[key] !== null && bookingData[key] !== '') {
            return bookingData[key];
          }
          if (customerData[key] !== undefined && customerData[key] !== null && customerData[key] !== '') {
            return customerData[key];
          }
        }
        return null;
      };

      // Normalize value helper (same as customer-reply.html)
      const normalizeValue = (value) => {
        if (value === null || value === undefined) return '';
        return String(value).trim();
      };

      // Vehicle Information
      const regoValue = getValue('rego', 'vehicleRego');
      if (regoValue) {
        const field = document.getElementById('rego');
        if (field) {
          field.value = normalizeValue(regoValue);
          console.log('‚úÖ Set rego =', regoValue);
        }
      }
      
      // Contact Information
      const nameValue = getValue('name', 'customerName');
      if (nameValue) {
        const field = document.getElementById('name');
        if (field) {
          field.value = normalizeValue(nameValue);
          console.log('‚úÖ Set name =', nameValue);
        } else {
          console.warn('‚ö†Ô∏è Field not found: name');
        }
      } else {
        console.log('‚ö†Ô∏è No name value found. customerData:', customerData);
      }
      
      const emailValue = getValue('email', 'customerEmail');
      if (emailValue) {
        const field = document.getElementById('email');
        if (field) {
          field.value = normalizeValue(emailValue);
          console.log('‚úÖ Set email =', emailValue);
        } else {
          console.warn('‚ö†Ô∏è Field not found: email');
        }
      } else {
        console.log('‚ö†Ô∏è No email value found. customerData:', customerData);
      }
      
      const phoneValue = getValue('phone', 'customerPhone');
      if (phoneValue) {
        const field = document.getElementById('clientMobileNumber');
        if (field) {
          field.value = normalizeValue(phoneValue);
          console.log('‚úÖ Set clientMobileNumber =', phoneValue);
        } else {
          console.warn('‚ö†Ô∏è Field not found: clientMobileNumber');
        }
      } else {
        console.log('‚ö†Ô∏è No phone value found. customerData:', customerData);
      }

      // Amount
      const amountValue = getValue('amount');
      if (amountValue) {
        const field = document.getElementById('amount');
        if (field) {
          field.value = normalizeValue(amountValue);
          console.log('‚úÖ Set amount =', amountValue);
          // Trigger GST calculation
          const event = new Event('input', { bubbles: true });
          field.dispatchEvent(event);
        } else {
          console.warn('‚ö†Ô∏è Field not found: amount');
        }
      } else {
        console.log('‚ö†Ô∏è No amount value found');
      }

      // Handle type selection if present
      const typeValue = bookingData.Type || bookingData.type;
      if (typeValue) {
        selectType(typeValue);
      }

      console.log('‚úÖ Form populated from booking data');
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ Job form page initialized');
      
      const urlParams = new URLSearchParams(window.location.search);
      const encodedData = urlParams.get('d');
      
      let bookingId = null;
      let decodedData = null;
      
      // Decode base64 data if present
      if (encodedData) {
        decodedData = decodeBase64(encodedData);
        if (decodedData) {
          console.log('üìã Decoded data:', decodedData);
          
          // Extract bookingId from decoded data
          // Handle case where decodeBase64 might return a string instead of object
          if (typeof decodedData === 'string') {
            console.log('‚ö†Ô∏è decodedData is a string, converting to object');
            bookingId = decodedData.trim();
            decodedData = { bookingId: bookingId };
          } else {
            bookingId = decodedData.bookingId || decodedData.bookingid || decodedData.Id || decodedData.ID || null;
          }
          
          console.log('üîë Extracted bookingId:', bookingId);
          console.log('üì¶ Final decodedData object:', decodedData);
          
          // Populate form from decoded data (will be overridden by SharePoint if available)
          populateFormFromData(decodedData);
        }
      } else {
        // Fall back to regular URL parameters
        bookingId = urlParams.get('bookingId');
      }
      
      // Fetch additional data from SharePoint if bookingId is provided
      if (bookingId) {
        console.log('üîÑ Attempting to fetch SharePoint data for bookingId:', bookingId);
        const sharePointData = await fetchJobDataFromSharePoint(bookingId);
        if (sharePointData) {
          console.log('‚úÖ SharePoint data received:', sharePointData);
          // Merge data: SharePoint as base, URL/base64 data overrides it
          const mergedData = { ...sharePointData, ...decodedData };
          populateFormFromData(mergedData);
        } else {
          console.warn('‚ö†Ô∏è No SharePoint data returned for bookingId:', bookingId);
          if (decodedData) {
            // If SharePoint fetch fails but we have decoded data, use that
            console.log('üìù Using decoded data only (no SharePoint data available)');
            populateFormFromData(decodedData);
          }
        }
      } else if (decodedData) {
        // No bookingId, but we have decoded data - use it directly
        console.log('üìù Using decoded data only (no bookingId for SharePoint lookup)');
        populateFormFromData(decodedData);
      }

      // Setup form handlers
      setupTypeSelector();
      setupAmountCalculations();
      setupKeyboardShortcuts();
      setupFlagToggles();
      
      // Generate ID if not populated
      if (!document.getElementById('id').value) {
        generateJobId();
      }
    });

    // Generate Job ID
    function generateJobId() {
      const timestamp = Date.now();
      const random = Math.floor(Math.random() * 1000);
      document.getElementById('id').value = `EEK${timestamp}${random}`;
    }

    // Type Selection
    function setupTypeSelector() {
      const buttons = document.querySelectorAll('.type-btn');
      
      buttons.forEach(btn => {
        btn.addEventListener('click', () => selectType(btn.dataset.type));
        btn.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            selectType(btn.dataset.type);
          }
        });
      });
    }

    function selectType(type) {
      selectedType = type;
      document.getElementById('jobType').value = type;

      // Update UI
      document.querySelectorAll('.type-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.type === type);
      });

      // Show/hide conditional sections
      const financialSection = document.getElementById('financialSection');
      const supplierSection = document.getElementById('supplierSection');

      // Financial section for Billable, Supplier, Refund, Reimbursement, Deposit
      const showFinancial = ['Billable', 'Supplier', 'Refund', 'Reimbursement', 'Deposit'].includes(type);
      financialSection.classList.toggle('show', showFinancial);
      
      // Supplier section only for Supplier type
      supplierSection.classList.toggle('show', type === 'Supplier');

      // Update required fields
      if (type === 'Supplier') {
        document.getElementById('supplierEmail').required = true;
        document.getElementById('supplierPhone').required = true;
        document.getElementById('supplierName').required = true;
      } else {
        document.getElementById('supplierEmail').required = false;
        document.getElementById('supplierPhone').required = false;
        document.getElementById('supplierName').required = false;
      }

      // Update financial fields requirement
      document.getElementById('amount').required = showFinancial;
    }

    // Amount Calculations
    function setupAmountCalculations() {
      const amountInput = document.getElementById('amount');
      const gstInput = document.getElementById('gstAmount');
      const totalInput = document.getElementById('totalAmount');

      amountInput.addEventListener('input', () => {
        const amount = parseFloat(amountInput.value) || 0;
        const gst = amount * 0.15; // 15% GST
        const total = amount + gst;

        gstInput.value = gst.toFixed(2);
        totalInput.value = total.toFixed(2);
      });
    }

    // Flag toggle styling
    function setupFlagToggles() {
      document.querySelectorAll('.flag-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          this.closest('.flag-item')?.classList.toggle('checked', this.checked);
        });
      });
    }

    // Quick Fill Templates
    function quickFill(template) {
      const templates = {
        'fuel-extraction': {
          fault: 'Wrong fuel in vehicle',
          serviceRequired: 'Fuel extraction and system flush',
          type: 'Billable',
          amount: 399
        },
        'tyre-change': {
          fault: 'Flat tyre',
          serviceRequired: 'Tyre change service',
          type: 'Billable'
        },
        'jump-start': {
          fault: 'Dead battery',
          serviceRequired: 'Jump start service',
          type: 'Billable'
        },
        'fuel-delivery': {
          fault: 'Out of fuel',
          serviceRequired: 'Fuel delivery',
          type: 'Billable'
        },
        'lockout': {
          fault: 'Keys locked in vehicle',
          serviceRequired: 'Vehicle unlock service',
          type: 'Billable'
        },
        'towing': {
          fault: 'Vehicle breakdown',
          serviceRequired: 'Towing service',
          type: 'Billable'
        }
      };

      const data = templates[template];
      if (data) {
        document.getElementById('jobNotes').value = `Fault: ${data.fault}\nService Required: ${data.serviceRequired}`;
        if (data.amount) {
          document.getElementById('amount').value = data.amount;
          // Trigger GST calculation
          const event = new Event('input', { bubbles: true });
          document.getElementById('amount').dispatchEvent(event);
        }
        selectType(data.type);
        showSuccess('Template applied');
      }
    }

    // Form Submission
    async function handleSubmit(event) {
      event.preventDefault();
      
      if (!validateForm()) return;

      showLoading(true);

      try {
        const formData = collectFormData();

        // Check if endpoint is configured
        if (POWER_AUTOMATE_URL === 'YOUR_POWER_AUTOMATE_ENDPOINT_HERE') {
          throw new Error('Power Automate endpoint not configured. Please update POWER_AUTOMATE_URL in the script.');
        }

        // Submit to Power Automate
        const response = await fetch(POWER_AUTOMATE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Server returned ${response.status}: ${errorText}`);
        }

        const result = await response.json();
        
        showSuccess('Job submitted successfully!');
        
        if (typeof gtag === 'function') {
          gtag('event', 'form_submit_success', {
            form_type: 'job'
          });
        }
        
        // Clear form after 2 seconds
        setTimeout(() => {
          clearForm();
        }, 2000);

      } catch (error) {
        console.error('Submission error:', error);
        showError(`Failed to submit job: ${error.message}`);
        
        if (typeof gtag === 'function') {
          gtag('event', 'form_submit_error', {
            form_type: 'job',
            error_message: error.message
          });
        }
      } finally {
        showLoading(false);
      }
    }

    // Collect form data - sends BOTH flat fields AND fields array for Power Automate flexibility
    function collectFormData() {
      const fields = [];
      const formData = {
        formType: 'job',
        formVersion: '2.0',
        submittedAt: new Date().toISOString()
      };
      
      // Helper to add field to both flat and array format
      const addField = (name, value) => {
        if (value !== null && value !== undefined && value !== '') {
          fields.push({ name, value });
          formData[name] = value;
        }
      };

      // Basic fields
      addField('Id', document.getElementById('id').value);
      addField('Email', document.getElementById('email').value);
      addField('Name', document.getElementById('name').value);
      addField('Rego', document.getElementById('rego').value.toUpperCase());
      addField('Type', document.getElementById('jobType').value);
      addField('ClientMobileNumber', document.getElementById('clientMobileNumber').value);
      addField('StartTime', document.getElementById('startTime').value || new Date().toISOString());
      
      // Financial fields
      const amount = parseFloat(document.getElementById('amount').value) || 0;
      if (amount > 0) {
        addField('Amount', amount);
        addField('GSTAmount', parseFloat(document.getElementById('gstAmount').value) || 0);
        addField('TotalIncGST', parseFloat(document.getElementById('totalAmount').value) || amount);
      }

      // Supplier fields
      addField('Supplier', document.getElementById('supplierName').value);
      addField('EmailJobToSupplier', document.getElementById('supplierEmail').value);
      addField('TextJobToMobileNumber', document.getElementById('supplierPhone').value);
      addField('Bank', document.getElementById('bankAccount').value);
      addField('TextSupplier', document.getElementById('textSupplier').checked ? 'Yes' : '');

      // Job details
      addField('JobNotes', document.getElementById('jobNotes').value);

      // Flags
      addField('Paid', document.getElementById('paidFlag').checked ? 'Bank' : '');
      addField('CloseAndPostJobForBilling', document.getElementById('closePostFlag').checked ? 'Yes' : 'No');
      addField('ExistingClient', document.getElementById('existingClient').checked ? 'Yes' : '');
      addField('Chargeables', document.getElementById('chargeables').checked ? 'Yes' : '');

      // Add the fields array
      formData.fields = fields;

      return formData;
    }

    function validateForm() {
      const form = document.getElementById('jobForm');
      
      // Check HTML5 validation
      if (!form.checkValidity()) {
        form.reportValidity();
        return false;
      }

      // Check type selection
      if (!selectedType) {
        showError('Please select a job type');
        document.getElementById('typeSelector').scrollIntoView({ behavior: 'smooth' });
        return false;
      }

      // Supplier validation
      if (selectedType === 'Supplier') {
        const requiredSupplierFields = ['supplierName', 'supplierEmail', 'supplierPhone'];
        for (const fieldId of requiredSupplierFields) {
          if (!document.getElementById(fieldId).value) {
            showError('All supplier fields are required for Supplier type jobs');
            document.getElementById(fieldId).focus();
            return false;
          }
        }
      }

      // Financial validation for applicable types
      if (['Billable', 'Supplier', 'Refund', 'Reimbursement', 'Deposit'].includes(selectedType)) {
        if (!document.getElementById('amount').value || parseFloat(document.getElementById('amount').value) <= 0) {
          showError('Please enter a valid amount for this job type');
          document.getElementById('amount').focus();
          return false;
        }
      }

      return true;
    }

    // Utility Functions
    function clearForm() {
      document.getElementById('jobForm').reset();
      selectedType = null;
      document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('selected'));
      document.querySelectorAll('.conditional-section').forEach(section => section.classList.remove('show'));
      document.querySelectorAll('.flag-item').forEach(item => item.classList.remove('checked'));
      document.getElementById('gstAmount').value = '';
      document.getElementById('totalAmount').value = '';
      generateJobId();
    }

    // Keyboard Shortcuts
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // Ctrl+Enter to submit
        if (e.ctrlKey && e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('jobForm').requestSubmit();
        }
        
        // Esc to clear focus
        if (e.key === 'Escape') {
          document.activeElement.blur();
        }

        // Alt+1-8 for type selection
        if (e.altKey && e.key >= '1' && e.key <= '8') {
          const types = ['Billable', 'Supplier', 'Refund', 'Reimbursement', 'Deposit', 'Warranty', 'Internal', 'Other'];
          const index = parseInt(e.key) - 1;
          if (types[index]) {
            selectType(types[index]);
          }
        }
      });
    }

    // UI Functions
    function showLoading(show) {
      document.getElementById('loadingOverlay').classList.toggle('show', show);
    }

    function showMessage(message, type) {
      const messageEl = document.getElementById(`${type}Message`);
      messageEl.textContent = message;
      messageEl.classList.add('show');
      
      setTimeout(() => {
        messageEl.classList.remove('show');
      }, 5000);
    }

    function showSuccess(message) { showMessage(message, 'success'); }
    function showError(message) { showMessage(message, 'error'); }
    function showWarning(message) { showMessage(message, 'warning'); }
  </script>
</body>
</html>
