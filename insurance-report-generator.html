<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EEK Insurance Report Generator</title>
    <!-- Data Sanitizer for cleaning data before sending to flows -->
    <script src="/data-sanitizer.js?v=20251224.1"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: slideIn 0.4s ease-out;
        }

        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .section {
            transition: all 0.3s ease;
        }

        .section.collapsed {
            max-height: 60px;
            overflow: hidden;
        }

        .section.expanded {
            max-height: 5000px;
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="glass rounded-3xl p-8 mb-6 animate-in">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">EEK Insurance Report</h1>
            <p class="text-gray-600">Fill in the details below - we'll send to Power Automate</p>
        </div>

        <form id="reportForm" class="space-y-6">
            <!-- Section 1: Basic Info -->
            <div class="glass rounded-3xl p-6 section expanded animate-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 cursor-pointer" onclick="toggleSection(this)">
                    üìã Basic Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Registration</label>
                        <input type="text" name="REGO"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="ABC123" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Report Date</label>
                        <input type="date" name="REPORT_DATE"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Client Name</label>
                        <input type="text" name="CLIENT_NAME"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Insurer</label>
                        <input type="text" name="INSURER"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="AA Insurance, Tower, AMI" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Claim Number</label>
                        <input type="text" name="CLAIM_NUMBER"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            required>
                    </div>
                </div>
            </div>

            <!-- Section 2: Vehicle Details -->
            <div class="glass rounded-3xl p-6 section expanded animate-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 cursor-pointer" onclick="toggleSection(this)">
                    üöó Vehicle Details
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Make</label>
                        <input type="text" name="VEHICLE_MAKE"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Toyota" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Model</label>
                        <input type="text" name="VEHICLE_MODEL"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Hilux" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                        <input type="number" name="VEHICLE_YEAR"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="2019" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">VIN</label>
                        <input type="text" name="VIN_NUMBER"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="17 characters">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Engine Type</label>
                        <input type="text" name="ENGINE_TYPE"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="2.8L Diesel Turbo" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fuel System Type</label>
                        <input type="text" name="FUEL_SYSTEM_TYPE"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Common Rail Direct Injection" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Odometer (km)</label>
                        <input type="text" name="ODOMETER"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="45,230" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pre-Incident Condition</label>
                        <input type="text" name="VEHICLE_CONDITION"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Excellent working order" required>
                    </div>
                </div>
            </div>

            <!-- Section 3: Incident Details -->
            <div class="glass rounded-3xl p-6 section expanded animate-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 cursor-pointer" onclick="toggleSection(this)">
                    ‚ö†Ô∏è Incident Details
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Incident Date</label>
                        <input type="date" name="INCIDENT_DATE"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Incident Time</label>
                        <input type="text" name="INCIDENT_TIME"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="14:30" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                        <input type="text" name="INCIDENT_LOCATION"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="BP Station, 123 Main Road, Auckland" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contamination Type</label>
                        <select name="CONTAMINATION_TYPE"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            required>
                            <option value="">Select...</option>
                            <option value="Petrol in Diesel">Petrol in Diesel</option>
                            <option value="Diesel in Petrol">Diesel in Petrol</option>
                            <option value="AdBlue in Fuel">AdBlue in Fuel</option>
                            <option value="Water in Fuel">Water in Fuel</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Engine Start Status</label>
                        <select name="ENGINE_START_STATUS"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            required>
                            <option value="">Select...</option>
                            <option value="Engine NOT started after contamination">Engine NOT started</option>
                            <option value="Engine started briefly then stopped">Started briefly</option>
                            <option value="Engine ran for several minutes before stopping">Ran several minutes</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Litres Extracted</label>
                        <input type="number" name="LITERS_EXTRACTED" id="litersExtracted"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="65" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tank Capacity (L)</label>
                        <input type="number" name="TANK_CAPACITY" id="tankCapacity" value="60"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="60" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Litres Refueled</label>
                        <input type="number" name="LITERS_REFUELED"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="70" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contamination %</label>
                        <input type="text" name="CONTAMINATION_PERCENT" id="contaminationPercent" readonly
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 bg-gray-100 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Calculated automatically">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Correct Fuel Type</label>
                        <input type="text" name="CORRECT_FUEL_TYPE"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Diesel" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Incident Description</label>
                        <textarea name="INCIDENT_DESCRIPTION" rows="3"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Describe what happened..." required></textarea>
                    </div>
                </div>
            </div>

            <!-- Section 4: Technical Assessment -->
            <div class="glass rounded-3xl p-6 section expanded animate-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 cursor-pointer" onclick="toggleSection(this)">
                    üîß Technical Assessment
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contamination Impact
                            (Technical)</label>
                        <textarea name="CONTAMINATION_IMPACT_TECHNICAL" rows="4"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Technical analysis of contamination impact..." required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Technical Findings</label>
                        <textarea name="TECHNICAL_FINDINGS" rows="3"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Overall technical findings..." required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Emergency Justification</label>
                        <textarea name="EMERGENCY_JUSTIFICATION" rows="3"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Why emergency service was required..." required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Testing Procedure</label>
                        <textarea name="TESTING_PROCEDURE" rows="3"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Testing performed..." required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Initial Response</label>
                        <textarea name="INITIAL_RESPONSE" rows="2"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Initial emergency response actions..." required></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fuel Pressure Spec</label>
                            <input type="text" name="FUEL_PRESSURE_SPEC"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                placeholder="1800 bar">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ECU Codes</label>
                            <input type="text" name="ECU_CODES"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                placeholder="N/A or fault codes">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 5: Component Analysis -->
            <div class="glass rounded-3xl p-6 section expanded animate-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 cursor-pointer" onclick="toggleSection(this)">
                    ‚öôÔ∏è Component Analysis
                </h2>

                <!-- Fuel Pump -->
                <div class="mb-6 p-4 bg-white bg-opacity-50 rounded-lg">
                    <h3 class="font-semibold text-lg mb-3">Fuel Pump</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Condition</label>
                            <select name="FUEL_PUMP_CONDITION"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">Select...</option>
                                <option value="Contaminated">Contaminated</option>
                                <option value="Damaged">Damaged</option>
                                <option value="Replaced">Replaced</option>
                                <option value="Not Affected">Not Affected</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Action</label>
                            <select name="FUEL_PUMP_ACTION"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">Select...</option>
                                <option value="Flush & Test">Flush & Test</option>
                                <option value="Replace">Replace</option>
                                <option value="Inspect Only">Inspect Only</option>
                                <option value="Not Applicable">Not Applicable</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Technical Justification</label>
                        <textarea name="FUEL_PUMP_TECHNICAL" rows="2"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Technical justification..."></textarea>
                    </div>
                </div>

                <!-- Injectors -->
                <div class="mb-6 p-4 bg-white bg-opacity-50 rounded-lg">
                    <h3 class="font-semibold text-lg mb-3">Fuel Injectors</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Condition</label>
                            <select name="INJECTOR_CONDITION"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">Select...</option>
                                <option value="Contaminated">Contaminated</option>
                                <option value="Damaged">Damaged</option>
                                <option value="Replaced">Replaced</option>
                                <option value="Not Affected">Not Affected</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Action</label>
                            <select name="INJECTOR_ACTION"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">Select...</option>
                                <option value="Professional Flush">Professional Flush</option>
                                <option value="Replace">Replace</option>
                                <option value="Ultrasonic Clean">Ultrasonic Clean</option>
                                <option value="Not Applicable">Not Applicable</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Technical Justification</label>
                        <textarea name="INJECTOR_TECHNICAL" rows="2"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Technical justification..."></textarea>
                    </div>
                </div>

                <!-- Catalytic Converter -->
                <div class="mb-6 p-4 bg-white bg-opacity-50 rounded-lg">
                    <h3 class="font-semibold text-lg mb-3">Catalytic Converter</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Condition</label>
                            <select name="CATALYTIC_CONDITION"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">Select...</option>
                                <option value="Not Affected">Not Affected</option>
                                <option value="At Risk">At Risk</option>
                                <option value="Contaminated">Contaminated</option>
                                <option value="N/A (Diesel)">N/A (Diesel)</option>
                                <option value="Damaged">Damaged</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Action</label>
                            <select name="CATALYTIC_ACTION"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">Select...</option>
                                <option value="Monitor">Monitor</option>
                                <option value="No Action Required">No Action Required</option>
                                <option value="Replace">Replace</option>
                                <option value="N/A">N/A</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Technical Notes</label>
                        <textarea name="CATALYTIC_TECHNICAL" rows="2"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Technical notes or N/A..."></textarea>
                    </div>
                </div>

                <!-- Spark Plugs -->
                <div class="mb-6 p-4 bg-white bg-opacity-50 rounded-lg">
                    <h3 class="font-semibold text-lg mb-3">Spark Plugs</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Condition</label>
                            <select name="SPARK_PLUG_CONDITION"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">Select...</option>
                                <option value="Normal">Normal</option>
                                <option value="Fouled">Fouled</option>
                                <option value="Replaced">Replaced</option>
                                <option value="N/A (Diesel)">N/A (Diesel)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Action</label>
                            <select name="SPARK_PLUG_ACTION"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">Select...</option>
                                <option value="Inspect & Clean">Inspect & Clean</option>
                                <option value="Replace">Replace</option>
                                <option value="No Action">No Action</option>
                                <option value="N/A">N/A</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Technical Notes</label>
                        <textarea name="SPARK_PLUG_TECHNICAL" rows="2"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Technical notes or N/A..."></textarea>
                    </div>
                </div>

                <!-- Filter & Components -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Filter Technical
                            Justification</label>
                        <textarea name="FILTER_TECHNICAL_JUSTIFICATION" rows="2"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Why filter was replaced..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Components Replaced</label>
                        <textarea name="COMPONENTS_REPLACED" rows="2"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="List of components replaced..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Components Cost Breakdown</label>
                        <textarea name="COMPONENTS_COST_BREAKDOWN" rows="3"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Fuel filter: $85.00&#10;Seal kit: $45.00"></textarea>
                    </div>
                </div>
            </div>

            <!-- Section 6: Costs -->
            <div class="glass rounded-3xl p-6 section expanded animate-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 cursor-pointer" onclick="toggleSection(this)">
                    üí∞ Cost Breakdown
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Callout Cost ($)</label>
                        <input type="number" step="0.01" name="CALLOUT_COST"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent cost-input"
                            placeholder="150.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Diagnostic Cost ($)</label>
                        <input type="number" step="0.01" name="DIAGNOSTIC_COST"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent cost-input"
                            placeholder="85.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Extraction Cost ($)</label>
                        <input type="number" step="0.01" name="EXTRACTION_COST"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent cost-input"
                            placeholder="420.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Labor Cost ($)</label>
                        <input type="number" step="0.01" name="LABOR_COST"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent cost-input"
                            placeholder="340.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fuel Cost ($)</label>
                        <input type="number" step="0.01" name="FUEL_COST"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent cost-input"
                            placeholder="125.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Parts Cost ($)</label>
                        <input type="number" step="0.01" name="PARTS_COST"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent cost-input"
                            placeholder="130.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Consumables Cost ($)</label>
                        <input type="number" step="0.01" name="CONSUMABLES_COST"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent cost-input"
                            placeholder="95.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Arrival Time (AOS)</label>
                        <input type="text" name="AOS"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="45 minutes">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Amount Paid (APAID)</label>
                        <input type="text" name="APAID"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="N/A or amount">
                    </div>
                </div>
                <div class="mt-6 p-4 bg-purple-100 rounded-lg">
                    <div class="flex justify-between mb-2">
                        <span class="font-medium">Subtotal (ex GST):</span>
                        <span id="subtotal" class="font-bold">$0.00</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="font-medium">GST (15%):</span>
                        <span id="gst" class="font-bold">$0.00</span>
                    </div>
                    <div class="flex justify-between text-lg border-t-2 border-purple-300 pt-2">
                        <span class="font-bold">Total (incl GST):</span>
                        <span id="total" class="font-bold text-purple-700">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="glass rounded-3xl p-6 animate-in">
                <button type="button" onclick="submitToPowerAutomate()"
                    class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-4 px-6 rounded-xl hover:from-purple-700 hover:to-pink-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                    ‚ú® Submit to Power Automate
                </button>
            </div>
        </form>

        <!-- Status Message -->
        <div id="statusMessage" class="glass rounded-3xl p-6 mt-6 hidden animate-in">
            <p id="statusText" class="text-center text-lg font-semibold"></p>
        </div>
    </div>

    <script>
        // Field order matching your Excel InsurerRecord table
        const FIELD_ORDER = [
            'REGO', 'REPORT_DATE', 'INCIDENT_DATE', 'INSURER', 'CLAIM_NUMBER', 'CLIENT_NAME',
            'VEHICLE_MAKE', 'VEHICLE_MODEL', 'VEHICLE_YEAR', 'VIN_NUMBER', 'ENGINE_TYPE',
            'FUEL_SYSTEM_TYPE', 'ODOMETER', 'VEHICLE_CONDITION', 'INCIDENT_TIME',
            'INCIDENT_LOCATION', 'CONTAMINATION_TYPE', 'LITERS_EXTRACTED', 'ENGINE_START_STATUS',
            'INCIDENT_DESCRIPTION', 'CONTAMINATION_IMPACT_TECHNICAL', 'FUEL_PUMP_CONDITION',
            'FUEL_PUMP_ACTION', 'FUEL_PUMP_TECHNICAL', 'INJECTOR_CONDITION', 'INJECTOR_ACTION',
            'INJECTOR_TECHNICAL', 'CATALYTIC_CONDITION', 'CATALYTIC_ACTION', 'CATALYTIC_TECHNICAL',
            'SPARK_PLUG_CONDITION', 'SPARK_PLUG_ACTION', 'SPARK_PLUG_TECHNICAL',
            'FILTER_TECHNICAL_JUSTIFICATION', 'COMPONENTS_REPLACED', 'TECHNICAL_FINDINGS',
            'TESTING_PROCEDURE', 'INITIAL_RESPONSE', 'EMERGENCY_JUSTIFICATION', 'CORRECT_FUEL_TYPE',
            'FUEL_PRESSURE_SPEC', 'ECU_CODES', 'LITERS_REFUELED', 'TANK_CAPACITY', 'CONTAMINATION_PERCENT', 'COMPONENTS_COST_BREAKDOWN',
            'PARTS_COST', 'CALLOUT_COST', 'DIAGNOSTIC_COST', 'EXTRACTION_COST', 'FUEL_COST', 'LABOR_COST',
            'CONSUMABLES_COST', 'STOTAL', 'TOTAL_COST', 'AOS', 'APAID'
        ];

        // Auto-set today's date
        document.querySelector('input[name="REPORT_DATE"]').valueAsDate = new Date();

        // Load URL parameters on page load
        // Call immediately if DOM ready, otherwise wait
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadFromURL);
        } else {
            loadFromURL();
        }

        function loadFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const base64Data = urlParams.get('data');
            
            if (!base64Data) {
                // No data parameter - redirect to home page
                alert('Access denied. This form must be accessed via the EEK job management system.');
                window.location.href = 'https://www.eek.nz';
                return;
            }
            
            try {
                // Decode Base64
                const jsonString = atob(base64Data);
                console.log('Decoded JSON:', jsonString);
                
                // Parse JSON
                const data = JSON.parse(jsonString);
                console.log('Parsed data:', data);
                
                // Fill all fields
                Object.keys(data).forEach(key => {
                    const field = document.querySelector(`[name="${key}"]`);
                    if (field && data[key]) {
                        if (field.tagName === 'SELECT') {
                            field.value = data[key];
                        } else if (field.type === 'date') {
                            field.value = data[key];
                        } else {
                            field.value = data[key];
                        }
                        console.log(`Filled ${key}:`, data[key]);
                    }
                });
                
                // Recalculate totals and contamination
                calculateTotals();
                calculateContamination();
                
                console.log('Data loaded successfully!');
            } catch (e) {
                console.error('Error loading data:', e);
                alert('Invalid or corrupted data. Redirecting to home page.');
                window.location.href = 'https://www.eek.nz';
            }
        }

        // Calculate costs in real-time
        const costInputs = document.querySelectorAll('.cost-input');
        costInputs.forEach(input => {
            input.addEventListener('input', calculateTotals);
        });

        // Calculate contamination percentage
        function calculateContamination() {
            const extracted = parseFloat(document.getElementById('litersExtracted').value) || 0;
            const tankCapacity = parseFloat(document.getElementById('tankCapacity').value) || 60;
            
            if (tankCapacity > 0 && extracted > 0) {
                const percent = (extracted / tankCapacity) * 100;
                document.getElementById('contaminationPercent').value = percent.toFixed(1) + '%';
            } else {
                document.getElementById('contaminationPercent').value = '';
            }
        }

        // Add event listeners for contamination calculation
        document.getElementById('litersExtracted').addEventListener('input', calculateContamination);
        document.getElementById('tankCapacity').addEventListener('input', calculateContamination);

        function calculateTotals() {
            let subtotal = 0;
            costInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                subtotal += value;
            });

            const gst = subtotal * 0.15;
            const total = subtotal + gst;

            document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('gst').textContent = '$' + gst.toFixed(2);
            document.getElementById('total').textContent = '$' + total.toFixed(2);

            // Update hidden fields
            document.querySelector('input[name="STOTAL"]').value = subtotal.toFixed(2);
            document.querySelector('input[name="TOTAL_COST"]').value = total.toFixed(2);
        }

        // Add hidden fields for calculated totals
        const form = document.getElementById('reportForm');
        ['STOTAL', 'TOTAL_COST'].forEach(field => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = field;
            form.appendChild(input);
        });

        function toggleSection(header) {
            const section = header.parentElement;
            section.classList.toggle('collapsed');
            section.classList.toggle('expanded');
        }

        async function submitToPowerAutomate() {
            const formData = new FormData(document.getElementById('reportForm'));

            // Check if required fields are filled
            const form = document.getElementById('reportForm');
            if (!form.checkValidity()) {
                alert('Please fill in all required fields');
                form.reportValidity();
                return;
            }

            // Build data object in correct field order
            const data = {};
            FIELD_ORDER.forEach(field => {
                data[field] = formData.get(field) || '';
            });

            // Show loading status
            const statusDiv = document.getElementById('statusMessage');
            const statusText = document.getElementById('statusText');
            statusDiv.classList.remove('hidden');
            statusText.textContent = '‚è≥ Submitting to Power Automate...';
            statusText.className = 'text-center text-lg font-semibold text-blue-600';

            try {
                // Sanitize data before sending to prevent anomalies
                const sanitizedData = window.dataSanitizer 
                    ? window.dataSanitizer.sanitizeForFlow(data)
                    : data;
                
                // Power Automate HTTP trigger URL
                const powerAutomateURL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/410623b8b5d34c35b981a022a916a9a8/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=TW94Td80KAoXk_CEVPd7UiCRxm4ANOkVgw9yGfi1o6E';

                const response = await fetch(powerAutomateURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(sanitizedData)
                });

                if (response.ok) {
                    const result = await response.json();

                    // Handle success response from Power Automate
                    if (result.success) {
                        statusText.innerHTML = `‚úÖ <strong>Success!</strong><br>${result.message}<br><small>REGO: ${result.rego}</small>`;
                        statusText.className = 'text-center text-lg font-semibold text-green-600';

                        // Clear form after 3 seconds
                        setTimeout(() => {
                            if (confirm('Data saved successfully! Clear form for next entry?')) {
                                form.reset();
                                statusDiv.classList.add('hidden');
                                document.querySelector('input[name="REPORT_DATE"]').valueAsDate = new Date();
                            }
                        }, 2000);
                    } else {
                        // Handle failure response from Power Automate
                        statusText.innerHTML = `‚ö†Ô∏è <strong>Warning:</strong><br>${result.message}`;
                        statusText.className = 'text-center text-lg font-semibold text-orange-600';
                    }
                } else {
                    throw new Error('HTTP error: ' + response.status);
                }
            } catch (error) {
                console.error('Error:', error);
                statusText.innerHTML = '‚ùå <strong>Error submitting data.</strong><br>Check your internet connection and try again.<br><small>Details in browser console (F12)</small>';
                statusText.className = 'text-center text-lg font-semibold text-red-600';
            }
        }
    </script>
</body>

</html>
