<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Supplier Upload Portal | Eek Mechanical</title>
  <meta name="description" content="Secure document upload portal for Eek Mechanical suppliers. Submit invoices, job sheets, certificates, and other required documentation." />
  <meta name="keywords" content="supplier upload, invoice submission, document portal, job sheets, certificates, eek suppliers" />
  <meta property="og:title" content="Supplier Upload Portal | Eek Mechanical" />
  <meta property="og:description" content="Secure portal for suppliers to upload invoices and documents to the Eek Mechanical system." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.eek.nz/supplier-upload" />
  <meta property="og:image" content="https://www.eek.nz/supplier-upload-og-image.jpg" />

  <!-- Google tag (gtag.js) for Google Ads Conversion Tracking -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17084465163"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'AW-17084465163');
  </script>

  <!-- Google Analytics tag -->
  <script>
    gtag('config', 'G-DQNKF1YLWR');
  </script>
  
  <!-- Centralized Phone Number Management -->
  <script src="/phone-manager.js"></script>
  
  <!-- Centralized Tracking Management -->
  <script src="/tracking-manager.js"></script>
  
  <!-- Unified Tracking System -->
  <script src="/unified-tracking.js?v=20250124"></script>
  
  <!-- Centralized Footer Management -->
  <script src="/footer-new.js?v=20250121"></script>

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Eek Mechanical Supplier Upload Portal",
    "description": "Secure document upload system for suppliers to submit invoices and documentation.",
    "url": "https://www.eek.nz/supplier-upload",
    "applicationCategory": "BusinessApplication",
    "operatingSystem": "Web Browser",
    "parentOrganization": {
      "@type": "LocalBusiness",
      "name": "Eek Mechanical"
    }
  }
  </script>

  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #fff;
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #ff5500 0%, #ff7700 100%);
      padding: 40px 0;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
      animation: float 15s infinite linear;
    }

    @keyframes float {
      0% { transform: translateX(0) translateY(0); }
      100% { transform: translateX(-50px) translateY(-50px); }
    }

    .header-content {
      position: relative;
      z-index: 2;
      text-align: center;
    }

    .header h1 {
      font-size: 2.8em;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header .subtitle {
      font-size: 1.2em;
      opacity: 0.9;
      margin-bottom: 20px;
    }

    .security-badge {
      display: inline-block;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      padding: 8px 20px;
      border-radius: 25px;
      font-size: 0.9em;
      font-weight: bold;
      border: 1px solid rgba(255,255,255,0.3);
    }

    /* Navigation */
    .nav {
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid #333;
    }

    .nav-content {
      display: flex;
      justify-content: center;
      padding: 15px 0;
      gap: 30px;
    }

    .nav a {
      color: #ccc;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
      position: relative;
    }

    .nav a:hover {
      color: #ff5500;
    }

    /* Authentication Section */
    .auth-section {
      padding: 60px 0;
    }

    .auth-container {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      padding: 50px;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      text-align: center;
    }

    .auth-container h2 {
      color: #ff5500;
      font-size: 2.2em;
      margin-bottom: 20px;
    }

    .auth-container p {
      font-size: 1.2em;
      margin-bottom: 30px;
      color: #ddd;
    }

    .auth-button {
      background: linear-gradient(135deg, #0078d4, #106ebe);
      color: white;
      padding: 18px 40px;
      border: none;
      border-radius: 50px;
      font-size: 1.2em;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 10px;
      box-shadow: 0 10px 30px rgba(0,120,212,0.3);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
    }

    .auth-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(0,120,212,0.4);
      background: linear-gradient(135deg, #106ebe, #005a9e);
    }

    .upload-button {
      background: linear-gradient(135deg, #ff5500, #ff7700);
      box-shadow: 0 10px 30px rgba(255,85,0,0.3);
    }

    .upload-button:hover {
      background: linear-gradient(135deg, #ff7700, #e04400);
      box-shadow: 0 15px 40px rgba(255,85,0,0.4);
    }

    /* Status Messages */
    .status-message {
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      text-align: center;
      font-weight: 500;
    }

    .status-message.info {
      background: rgba(23,162,184,0.2);
      border: 1px solid #17a2b8;
      color: #17a2b8;
    }

    .status-message.warning {
      background: rgba(255,193,7,0.2);
      border: 1px solid #ffc107;
      color: #ffc107;
    }

    .status-message.error {
      background: rgba(220,53,69,0.2);
      border: 1px solid #dc3545;
      color: #dc3545;
    }

    /* Guidelines */
    .upload-guidelines {
      background: rgba(255,255,255,0.05);
      border-left: 4px solid #ff5500;
      padding: 25px;
      margin: 30px 0;
      border-radius: 10px;
    }

    .upload-guidelines h4 {
      color: #ff5500;
      margin-bottom: 15px;
    }

    .upload-guidelines ul {
      list-style: none;
      padding: 0;
    }

    .upload-guidelines li {
      padding: 5px 0;
      position: relative;
      padding-left: 25px;
    }

    .upload-guidelines li::before {
      content: '‚úì';
      position: absolute;
      left: 0;
      color: #28a745;
      font-weight: bold;
    }

    /* Footer */
    .footer {
      background: rgba(0,0,0,0.8);
      color: #666;
      padding: 30px 0;
      text-align: center;
      margin-top: 60px;
    }

    .footer a {
      color: #ff5500;
      text-decoration: none;
    }

    /* Hidden state */
    .hidden {
      display: none !important;
    }

    /* Microsoft branding */
    .ms-logo {
      width: 20px;
      height: 20px;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 23 23"><path fill="%23f35325" d="M1 1h10v10H1z"/><path fill="%2381bc06" d="M12 1h10v10H12z"/><path fill="%2305a6f0" d="M1 12h10v10H1z"/><path fill="%23ffba08" d="M12 12h10v10H12z"/></svg>') no-repeat center;
      background-size: contain;
      display: inline-block;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 2em;
      }
      
      .auth-container {
        padding: 30px 20px;
      }
      
      .nav-content {
        flex-direction: column;
        gap: 15px;
      }
      
      .auth-button {
        width: 100%;
        justify-content: center;
      }
    }

    /* Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }
  </style>
  
  <!-- Centralized Phone Number Management -->
  <script src="/phone-manager.js"></script>
  
  <!-- Centralized Tracking Management -->
  <script src="/tracking-manager.js"></script>
  
  <!-- Centralized Footer Management -->
  <script src="/footer-new.js?v=20250121"></script>
</head>
<body>

<header class="header">
  <div class="container">
    <div class="header-content">
      <h1>üìÅ Supplier Upload Portal</h1>
      <p class="subtitle">Secure Document Submission System</p>
      <div class="security-badge">üîí Bank-Level Security | SSL Encrypted</div>
    </div>
  </div>
</header>

<nav class="nav">
  <div class="container">
    <div class="nav-content">
      <a href="#auth">Secure Access</a>
      <a href="#guidelines">Guidelines</a>
      <a href="/supplier">‚Üê Supplier Portal</a>
      <a href="tel:+6498724612">üìû Support</a>
    </div>
  </div>
</nav>

<section id="auth" class="auth-section">
  <div class="container">
    <div class="auth-container">
      <!-- Login Button (shown when not authenticated) -->
      <div id="loginContainer">
        <h2>üîê Secure Supplier Access</h2>
        <p>Access the secure Microsoft Forms upload system for invoices, job sheets, and supplier documentation.</p>
        
        <div class="status-message info">
          <strong>üîí Enhanced Security:</strong> This system uses Microsoft Enterprise authentication to ensure your documents are submitted securely to the correct Eek supplier account.
        </div>
        
        <button id="loginButton" class="auth-button">
          <div class="ms-logo"></div>
          Sign in with Microsoft
        </button>
        
        <div style="margin-top: 20px; font-size: 0.9em; color: #ccc;">
          <p>You'll be redirected to Microsoft's secure login system</p>
        </div>
      </div>

      <!-- Upload Button (shown when authenticated) -->
      <div id="uploadContainer" class="hidden">
        <h2>‚úÖ Authentication Successful</h2>
        <p id="uploadDescription">You're now authenticated as an Eek supplier. Click below to access the secure document upload form.</p>
        
        <div id="uploadInfoMessage" class="status-message info">
          <strong>üìã Ready to Upload:</strong> You can now submit invoices, job sheets, certificates, and other supplier documentation through our secure Microsoft Forms system.
        </div>
        
        <div id="uploadButtons">
          <!-- Invoice Upload Button (default) -->
          <a id="invoiceUploadButton" href="#" class="auth-button upload-button" target="_blank">
            üìÑ Upload Invoice Documents
          </a>
          
          <!-- Pre-purchase Inspection Button (when ?pp parameter) -->
          <a id="ppUploadButton" href="#" class="auth-button upload-button" target="_blank" style="background: linear-gradient(135deg, #28a745, #20c997);">
            üîç Upload Pre-Purchase Inspection
          </a>
        </div>
        
        <div style="margin-top: 20px; font-size: 0.9em; color: #ccc;">
          <p>The form will open in a new tab with your supplier credentials pre-filled</p>
        </div>
      </div>

      <!-- Error Message Container -->
      <div id="errorContainer" class="hidden">
        <div class="status-message error">
          <strong>‚ö†Ô∏è Authentication Configuration Issue:</strong><br>
          The authentication system needs to be configured properly. Please contact IT support at 
          <a href="tel:+6498724612" style="color: #dc3545;">+64 9 872 4612</a> for assistance.
          <br><br>
          <small>Error: Redirect URI mismatch in Azure AD application registration</small>
        </div>
      </div>
    </div>
  </div>
</section>

<section id="guidelines" class="upload-section">
  <div class="container">
    <div class="upload-guidelines">
      <h4>üìã Upload Guidelines</h4>
      <ul id="generalGuidelines">
        <li>Documents should be clear, legible, and in acceptable formats</li>
        <li>Maximum file size: 10MB per file</li>
        <li>Supported formats: PDF, JPG, PNG</li>
        <li>Ensure contact information matches your supplier records</li>
      </ul>
      
      <!-- Invoice-specific guidelines -->
      <ul id="invoiceGuidelines">
        <li>All invoices must include job reference numbers when applicable</li>
        <li>Include GST details on all invoices (if applicable)</li>
        <li>Include purchase order numbers when provided</li>
      </ul>
      
      <!-- Pre-purchase inspection guidelines -->
      <ul id="ppGuidelines" class="hidden">
        <li>Include all required inspection photos and documentation</li>
        <li>Clearly label each inspection item with reference numbers</li>
        <li>Include inspection date and inspector details</li>
        <li>Submit reports within 24 hours of inspection completion</li>
      </ul>
    </div>
    
    <div class="upload-guidelines">
      <h4>üîí Security & Privacy</h4>
      <ul>
        <li>All uploads are encrypted using bank-level SSL security</li>
        <li>Documents are stored in secure, access-controlled systems</li>
        <li>Only authorized Eek personnel can access your submissions</li>
        <li>Files are automatically scanned for viruses and malware</li>
        <li>Data is retained according to our privacy policy</li>
        <li>You will receive email confirmation of successful uploads</li>
      </ul>
    </div>

    <div class="upload-guidelines">
      <h4>üîß Technical Requirements</h4>
      <ul>
        <li>Azure AD application must be configured with correct redirect URIs</li>
        <li>Redirect URI must exactly match: https://www.eek.nz/supplier-upload</li>
        <li>Application requires proper permissions and tenant configuration</li>
        <li>Contact IT support if authentication issues persist</li>
      </ul>
    </div>
  </div>
</section>

<!-- Footer will be added by footer.js -->

<script>
// Microsoft Authentication Configuration
const config = {
  clientId: "23549916-65b7-485c-aca0-55ca600331a2",
  tenantId: "61ffc6bc-d9ce-458b-8120-d32187c3770d", // Correct tenant ID with the missing '1'
  loginHint: "supplier.upload@eek.nz",
  redirectUri: "https://www.eek.nz/supplier-upload",
  // Form URLs
  invoiceFormUrl: "https://forms.office.com/Pages/ResponsePage.aspx?id=vMb_Yc7Zi0WBINMhh8N3DSnleyJD3nBGm0qPafV8nlFURFAwNUxPNVUxWEpBNDJKWlhZV0tLR0I4VC4u&login_hint=supplier.upload@eek.nz",
  ppFormUrl: "https://forms.office.com/Pages/ResponsePage.aspx?id=vMb_Yc7Zi0WBINMhh8N3DSnleyJD3nBGm0qPafV8nlFUMTg2OVQ5OFo5U0NYTFNOV09HWktHUjJKSy4u&login_hint=supplier.upload@eek.nz"
};

// Check authentication status on page load
document.addEventListener('DOMContentLoaded', function() {
  checkAuthenticationStatus();
  setupEventListeners();
  configureFormType(); // Configure which form to show based on URL parameters
});

function configureFormType() {
  const urlParams = new URLSearchParams(window.location.search);
  const isPP = urlParams.has('pp');
  
  // Store the form type in sessionStorage to persist through authentication
  if (isPP) {
    sessionStorage.setItem('formType', 'pp');
  } else if (!sessionStorage.getItem('formType')) {
    sessionStorage.setItem('formType', 'invoice');
  }
  
  // Get the actual form type (from URL or sessionStorage)
  const formType = isPP ? 'pp' : sessionStorage.getItem('formType');
  const isPrePurchase = (formType === 'pp');
  
  // Get elements
  const invoiceButton = document.getElementById('invoiceUploadButton');
  const ppButton = document.getElementById('ppUploadButton');
  const description = document.getElementById('uploadDescription');
  const infoMessage = document.getElementById('uploadInfoMessage');
  const invoiceGuidelines = document.getElementById('invoiceGuidelines');
  const ppGuidelines = document.getElementById('ppGuidelines');
  
  if (isPrePurchase) {
    // Pre-purchase inspection mode
    invoiceButton.style.display = 'none';
    ppButton.style.display = 'inline-flex';
    
    description.textContent = "You're authenticated for pre-purchase inspection upload. Click below to submit inspection documentation.";
    infoMessage.innerHTML = '<strong>üîç Pre-Purchase Inspection:</strong> Upload inspection reports, photos, and documentation through our secure Microsoft Forms system.';
    
    // Show PP guidelines, hide invoice guidelines
    invoiceGuidelines.classList.add('hidden');
    ppGuidelines.classList.remove('hidden');
    
    // Update page title and header
    document.title = 'Pre-Purchase Inspection Upload | Eek Mechanical';
    document.querySelector('.header h1').textContent = 'üîç Pre-Purchase Inspection Upload';
    document.querySelector('.header .subtitle').textContent = 'Secure Inspection Documentation System';
  } else {
    // Default invoice mode
    invoiceButton.style.display = 'inline-flex';
    ppButton.style.display = 'none';
    
    description.textContent = "You're now authenticated as an Eek supplier. Click below to access the secure document upload form.";
    infoMessage.innerHTML = '<strong>üìã Ready to Upload:</strong> You can now submit invoices, job sheets, certificates, and other supplier documentation through our secure Microsoft Forms system.';
    
    // Show invoice guidelines, hide PP guidelines
    invoiceGuidelines.classList.remove('hidden');
    ppGuidelines.classList.add('hidden');
    
    // Keep default title and header
    document.title = 'Supplier Upload Portal | Eek Mechanical';
    document.querySelector('.header h1').textContent = 'üìÅ Supplier Upload Portal';
    document.querySelector('.header .subtitle').textContent = 'Secure Document Submission System';
  }
}

function checkAuthenticationStatus() {
  // Check URL fragment for authentication token
  const fragment = window.location.hash.substring(1);
  const params = new URLSearchParams(fragment);
  
  // Check for authentication errors first
  if (params.has('error')) {
    const error = params.get('error');
    const errorDescription = params.get('error_description');
    
    console.error('Authentication error:', error, errorDescription);
    showErrorInterface('Authentication error: ' + error);
    return;
  }
  
  // Check for ID token (successful authentication)
  if (params.has('id_token')) {
    // Token received - show upload interface
    showUploadInterface();
    
    // Clean up URL
    window.history.replaceState({}, document.title, window.location.pathname);
    
    // Track successful authentication
    if (typeof gtag !== 'undefined') {
      gtag('event', 'supplier_authentication_success', {
        'event_category': 'Authentication',
        'event_label': 'Microsoft Auth Success'
      });
    }
  } else {
    // No authentication yet - show login interface
    showLoginInterface();
  }
}

function showLoginInterface() {
  document.getElementById('loginContainer').classList.remove('hidden');
  document.getElementById('uploadContainer').classList.add('hidden');
  document.getElementById('errorContainer').classList.add('hidden');
}

function showUploadInterface() {
  document.getElementById('loginContainer').classList.add('hidden');
  document.getElementById('uploadContainer').classList.remove('hidden');
  document.getElementById('errorContainer').classList.add('hidden');
  
  // Re-configure the form type after authentication to ensure correct button shows
  configureFormType();
  
  // Set the upload button links based on stored form type
  const formType = sessionStorage.getItem('formType');
  const isPP = (formType === 'pp');
  
  if (isPP) {
    document.getElementById('ppUploadButton').href = config.ppFormUrl;
  } else {
    document.getElementById('invoiceUploadButton').href = config.invoiceFormUrl;
  }
}

function showErrorInterface(errorMessage) {
  document.getElementById('loginContainer').classList.add('hidden');
  document.getElementById('uploadContainer').classList.add('hidden');
  document.getElementById('errorContainer').classList.remove('hidden');
  
  // Update error message if needed
  const errorContainer = document.querySelector('#errorContainer .status-message');
  if (errorMessage.includes('redirect_uri')) {
    errorContainer.innerHTML = `
      <strong>‚ö†Ô∏è Azure AD Configuration Issue:</strong><br>
      The redirect URI is not properly configured in the Azure AD application registration. 
      The IT administrator needs to add this exact URL to the application:
      <br><br>
      <code style="background: rgba(0,0,0,0.3); padding: 5px; border-radius: 3px;">https://www.eek.nz/supplier-upload</code>
      <br><br>
      Please contact IT support at <a href="tel:+6498724612" style="color: #dc3545;">+64 9 872 4612</a> for assistance.
      <br><br>
      <small>Technical details: ${errorMessage}</small>
    `;
  }
}

function setupEventListeners() {
  // Login button click handler
  document.getElementById('loginButton').addEventListener('click', function() {
    initiateAuthentication();
  });

  // Invoice upload button click handler
  document.getElementById('invoiceUploadButton').addEventListener('click', function() {
    if (typeof gtag !== 'undefined') {
      gtag('event', 'supplier_invoice_form_access', {
        'event_category': 'Supplier',
        'event_label': 'Invoice Upload Form Access'
      });
    }
  });

  // Pre-purchase upload button click handler
  document.getElementById('ppUploadButton').addEventListener('click', function() {
    if (typeof gtag !== 'undefined') {
      gtag('event', 'supplier_pp_form_access', {
        'event_category': 'Supplier',
        'event_label': 'Pre-Purchase Inspection Form Access'
      });
    }
  });
}

async function initiateAuthentication() {
  const nonce = Date.now().toString();
  
  // Microsoft OAuth 2.0 implicit flow with ID tokens
  const authUrl = `https://login.microsoftonline.com/${config.tenantId}/oauth2/v2.0/authorize` +
    `?client_id=${encodeURIComponent(config.clientId)}` +
    `&response_type=id_token` +
    `&redirect_uri=${encodeURIComponent(config.redirectUri)}` +
    `&response_mode=fragment` +
    `&scope=openid` +
    `&login_hint=${encodeURIComponent(config.loginHint)}` +
    `&domain_hint=organizations` +
    `&prompt=login` +
    `&nonce=${nonce}`;
  
  // Track authentication attempt
  if (typeof gtag !== 'undefined') {
    gtag('event', 'supplier_authentication_attempt', {
      'event_category': 'Authentication',
      'event_label': 'Microsoft Auth Initiated'
    });
  }
  
  try {
    // Redirect to Microsoft authentication
    window.location.href = authUrl;
  } catch (error) {
    console.error('Failed to initiate authentication:', error);
    showErrorInterface('Failed to start authentication process');
  }
}

// PKCE helper functions
function generateCodeVerifier() {
  const array = new Uint8Array(32);
  crypto.getRandomValues(array);
  return base64URLEncode(array);
}

async function generateCodeChallenge(verifier) {
  const encoder = new TextEncoder();
  const data = encoder.encode(verifier);
  const hash = await crypto.subtle.digest('SHA-256', data);
  return base64URLEncode(new Uint8Array(hash));
}

function base64URLEncode(buffer) {
  return btoa(String.fromCharCode.apply(null, buffer))
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=/g, '');
}

// Track page visits
window.addEventListener('load', function() {
  if (typeof gtag !== 'undefined') {
    gtag('event', 'supplier_upload_page_view', {
      'page_title': 'Supplier Upload Portal',
      'page_location': window.location.href,
      'event_category': 'Supplier'
    });
  }
});

// Handle authentication errors more gracefully
window.addEventListener('error', function(e) {
  console.error('Application error:', e);
  
  // Only show error UI if it's auth-related
  if (e.message && e.message.toLowerCase().includes('auth')) {
    showErrorInterface('An authentication error occurred');
  }
});

// Handle URL hash changes (for Single Page App behavior)
window.addEventListener('hashchange', function() {
  checkAuthenticationStatus();
});
</script>

</body>
</html>
