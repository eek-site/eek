<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Supplier Upload Portal | Eek Mechanical</title>
  <meta name="description" content="Secure document upload portal for Eek Mechanical suppliers. Submit invoices, job sheets, certificates, and other required documentation." />
  <meta name="keywords" content="supplier upload, invoice submission, document portal, job sheets, certificates, eek suppliers" />
  <meta property="og:title" content="Supplier Upload Portal | Eek Mechanical" />
  <meta property="og:description" content="Secure portal for suppliers to upload invoices and documents to the Eek Mechanical system." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.eek.nz/supplier-upload" />
  <meta property="og:image" content="https://www.eek.nz/supplier-upload-og-image.jpg" />

  <!-- Centralized Phone Number Management -->
  <script src="/phone-manager.js"></script>
  
  <!-- Unified Tracking System (Internal Analytics) -->
  <script src="/unified-tracking.js?v={{ site.version }}"></script>
  
  <!-- Centralized Footer Management -->
  <script src="/footer-new.js?v=20250121"></script>

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Eek Mechanical Supplier Upload Portal",
    "description": "Secure document upload system for suppliers to submit invoices and documentation.",
    "url": "https://www.eek.nz/supplier-upload",
    "applicationCategory": "BusinessApplication",
    "operatingSystem": "Web Browser",
    "parentOrganization": {
      "@type": "LocalBusiness",
      "name": "Eek Mechanical"
    }
  }
  </script>

  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #fff;
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #ff5500 0%, #ff7700 100%);
      padding: 40px 0;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
      animation: float 15s infinite linear;
    }

    @keyframes float {
      0% { transform: translateX(0) translateY(0); }
      100% { transform: translateX(-50px) translateY(-50px); }
    }

    .header-content {
      position: relative;
      z-index: 2;
      text-align: center;
    }

    .header h1 {
      font-size: 2.8em;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header .subtitle {
      font-size: 1.2em;
      opacity: 0.9;
      margin-bottom: 20px;
    }

    .security-badge {
      display: inline-block;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      padding: 8px 20px;
      border-radius: 25px;
      font-size: 0.9em;
      font-weight: bold;
      border: 1px solid rgba(255,255,255,0.3);
    }

    /* Navigation */
    .nav {
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid #333;
    }

    .nav-content {
      display: flex;
      justify-content: center;
      padding: 15px 0;
      gap: 30px;
    }

    .nav a {
      color: #ccc;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
      position: relative;
    }

    .nav a:hover {
      color: #ff5500;
    }

    /* Authentication Section */
    .auth-section {
      padding: 60px 0;
    }

    .auth-container {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      padding: 50px;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      text-align: center;
    }

    .auth-container h2 {
      color: #ff5500;
      font-size: 2.2em;
      margin-bottom: 20px;
    }

    .auth-container p {
      font-size: 1.2em;
      margin-bottom: 30px;
      color: #ddd;
    }

    .auth-button {
      background: linear-gradient(135deg, #0078d4, #106ebe);
      color: white;
      padding: 18px 40px;
      border: none;
      border-radius: 50px;
      font-size: 1.2em;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 10px;
      box-shadow: 0 10px 30px rgba(0,120,212,0.3);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
    }

    .auth-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(0,120,212,0.4);
      background: linear-gradient(135deg, #106ebe, #005a9e);
    }

    .upload-button {
      background: linear-gradient(135deg, #ff5500, #ff7700);
      box-shadow: 0 10px 30px rgba(255,85,0,0.3);
    }

    .upload-button:hover {
      background: linear-gradient(135deg, #ff7700, #e04400);
      box-shadow: 0 15px 40px rgba(255,85,0,0.4);
    }

    /* Status Messages */
    .status-message {
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      text-align: center;
      font-weight: 500;
    }

    .status-message.info {
      background: rgba(23,162,184,0.2);
      border: 1px solid #17a2b8;
      color: #17a2b8;
    }

    .status-message.warning {
      background: rgba(255,193,7,0.2);
      border: 1px solid #ffc107;
      color: #ffc107;
    }

    .status-message.error {
      background: rgba(220,53,69,0.2);
      border: 1px solid #dc3545;
      color: #dc3545;
    }

    /* Guidelines */
    .upload-guidelines {
      background: rgba(255,255,255,0.05);
      border-left: 4px solid #ff5500;
      padding: 25px;
      margin: 30px 0;
      border-radius: 10px;
    }

    .upload-guidelines h4 {
      color: #ff5500;
      margin-bottom: 15px;
    }

    .upload-guidelines ul {
      list-style: none;
      padding: 0;
    }

    .upload-guidelines li {
      padding: 5px 0;
      position: relative;
      padding-left: 25px;
    }

    .upload-guidelines li::before {
      content: '‚úì';
      position: absolute;
      left: 0;
      color: #28a745;
      font-weight: bold;
    }

    /* Footer */
    .footer {
      background: rgba(0,0,0,0.8);
      color: #666;
      padding: 30px 0;
      text-align: center;
      margin-top: 60px;
    }

    .footer a {
      color: #ff5500;
      text-decoration: none;
    }

    /* Hidden state */
    .hidden {
      display: none !important;
    }

    /* Microsoft branding */
    .ms-logo {
      width: 20px;
      height: 20px;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 23 23"><path fill="%23f35325" d="M1 1h10v10H1z"/><path fill="%2381bc06" d="M12 1h10v10H12z"/><path fill="%2305a6f0" d="M1 12h10v10H1z"/><path fill="%23ffba08" d="M12 12h10v10H12z"/></svg>') no-repeat center;
      background-size: contain;
      display: inline-block;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 2em;
      }
      
      .auth-container {
        padding: 30px 20px;
      }
      
      .nav-content {
        flex-direction: column;
        gap: 15px;
      }
      
      .auth-button {
        width: 100%;
        justify-content: center;
      }
    }

    /* Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }

    /* File Upload Zone */
    #fileDropZone {
      transition: all 0.3s ease;
    }

    #fileDropZone:hover {
      border-color: #ff5500;
      background: rgba(255,85,0,0.1);
    }

    #fileDropZone.dragover {
      border-color: #ff5500;
      background: rgba(255,85,0,0.2);
    }

    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      margin: 5px 0;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      border: 1px solid #444;
    }

    .file-item-name {
      flex: 1;
      color: #fff;
      font-size: 0.9em;
      margin-right: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .file-item-size {
      color: #888;
      font-size: 0.85em;
      margin-right: 10px;
    }

    .file-item-remove {
      background: #dc3545;
      color: #fff;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
    }

    .file-item-remove:hover {
      background: #c82333;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
  
  <!-- Centralized Phone Number Management -->
  <script src="/phone-manager.js"></script>
  
  <!-- Unified Tracking System (replaces tracking-manager.js) -->
  <script src="/unified-tracking.js?v={{ site.version }}"></script>
  
  <!-- Centralized Footer Management -->
  <script src="/footer-new.js?v=20250121"></script>
</head>
<body>

<header class="header">
  <div class="container">
    <div class="header-content">
      <h1>üìÅ Supplier Upload Portal</h1>
      <p class="subtitle">Secure Document Submission System</p>
      <div class="security-badge">üîí Bank-Level Security | SSL Encrypted</div>
    </div>
  </div>
</header>

<nav class="nav">
  <div class="container">
    <div class="nav-content">
      <a href="#auth">Secure Access</a>
      <a href="#guidelines">Guidelines</a>
      <a href="/supplier">‚Üê Supplier Portal</a>
      <a href="tel:+6498724612">üìû Support</a>
    </div>
  </div>
</nav>



<!-- Fuel Extraction Job Submission Form (shown when query string present) -->
<section id="jobSubmissionSection" class="auth-section" style="display: none;">
  <div class="container">
    <div class="auth-container">
      <h2>‚õΩ Fuel Extraction Job Submission</h2>
      <p>Submit a fuel extraction job for processing. Data will be loaded from SharePoint using the booking ID.</p>
      
      <form id="fuelExtractionForm" style="margin-top: 30px;">
        <div style="margin-bottom: 20px;">
          <label for="jobRego" style="display: block; margin-bottom: 8px; font-weight: 600; color: #fff;">Vehicle Registration <span style="color: #dc3545;">*</span></label>
          <input type="text" id="jobRego" name="rego" required style="width: 100%; padding: 12px; border: 2px solid #444; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; font-size: 1em; text-transform: uppercase;" placeholder="ABC123" maxlength="10">
        </div>
        
        <div style="margin-bottom: 20px;">
          <label for="supplierName" style="display: block; margin-bottom: 8px; font-weight: 600; color: #fff;">Supplier Name <span style="color: #dc3545;">*</span></label>
          <input type="text" id="supplierName" name="supplierName" required style="width: 100%; padding: 12px; border: 2px solid #444; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; font-size: 1em;" placeholder="Supplier Company Ltd">
        </div>
        
        <div style="margin-bottom: 20px;">
          <label for="supplierEmail" style="display: block; margin-bottom: 8px; font-weight: 600; color: #fff;">Supplier Email <span style="color: #dc3545;">*</span></label>
          <input type="email" id="supplierEmail" name="supplierEmail" required style="width: 100%; padding: 12px; border: 2px solid #444; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; font-size: 1em;" placeholder="supplier@company.com">
        </div>
        
        <div style="margin-bottom: 20px;">
          <label for="supplierPhone" style="display: block; margin-bottom: 8px; font-weight: 600; color: #fff;">Supplier Phone <span style="color: #dc3545;">*</span></label>
          <input type="tel" id="supplierPhone" name="supplierPhone" required style="width: 100%; padding: 12px; border: 2px solid #444; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; font-size: 1em;" placeholder="09 123 4567">
        </div>
        
        <div style="margin-bottom: 20px;">
          <label for="jobEmail" style="display: block; margin-bottom: 8px; font-weight: 600; color: #fff;">Customer Email</label>
          <input type="email" id="jobEmail" name="email" style="width: 100%; padding: 12px; border: 2px solid #444; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; font-size: 1em;" placeholder="customer@email.com">
        </div>
        
        <div style="margin-bottom: 20px;">
          <label for="jobPhone" style="display: block; margin-bottom: 8px; font-weight: 600; color: #fff;">Customer Mobile</label>
          <input type="tel" id="jobPhone" name="phone" style="width: 100%; padding: 12px; border: 2px solid #444; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; font-size: 1em;" placeholder="021 123 4567">
        </div>
        
        <div style="margin-bottom: 20px;">
          <label for="jobNotes" style="display: block; margin-bottom: 8px; font-weight: 600; color: #fff;">Job Notes</label>
          <textarea id="jobNotes" name="notes" rows="4" style="width: 100%; padding: 12px; border: 2px solid #444; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; font-size: 1em; resize: vertical;" placeholder="Enter job details, location, and any relevant information..."></textarea>
        </div>
        
        <button type="submit" id="jobSubmitBtn" class="auth-button upload-button" style="width: 100%; margin-top: 10px;">
          ‚õΩ Submit Fuel Extraction Job
        </button>
      </form>
      
      <div id="jobSuccessMessage" class="status-message info hidden" style="margin-top: 20px;">
        <strong>‚úÖ Success!</strong> Your fuel extraction job has been submitted successfully.
      </div>
      
      <div id="jobErrorMessage" class="status-message error hidden" style="margin-top: 20px;">
        <strong>‚ùå Error:</strong> <span id="jobErrorText">Something went wrong. Please try again.</span>
      </div>
    </div>
  </div>
</section>

<!-- Invoice Upload Form Section (shown when query string with bookingId present) -->
<section id="invoiceUploadSection" class="auth-section" style="display: none;">
  <div class="container">
    <div class="auth-container">
      <h2>üìÑ Invoice Upload</h2>
      <p>Upload your invoice documents. Data will be loaded from SharePoint using the booking ID.</p>
      
      <div id="invoiceAlertSuccess" class="status-message info hidden" style="margin-top: 20px;">
        <strong>‚úÖ Success!</strong> Your invoice has been uploaded successfully.
      </div>
      <div id="invoiceAlertError" class="status-message error hidden" style="margin-top: 20px;">
        <strong>‚ùå Error:</strong> <span id="invoiceErrorText">Something went wrong. Please try again.</span>
      </div>
      
      <form id="invoiceUploadForm" style="margin-top: 30px;" novalidate>
        <!-- Vehicle Section -->
        <div style="margin-bottom: 28px;">
          <div style="font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #ff5500; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid rgba(255,255,255,0.2);">Vehicle Details</div>
          <div style="margin-bottom: 20px;">
            <label for="invoiceRego" style="display: block; font-weight: 600; color: #fff; margin-bottom: 6px; font-size: 0.9rem;">Registration <span style="color: #dc3545;">*</span></label>
            <input type="text" id="invoiceRego" name="rego" required style="width: 100%; padding: 12px 16px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; font-size: 1rem; background: rgba(255,255,255,0.1); color: #fff; text-transform: uppercase;" placeholder="ABC123" maxlength="10">
          </div>
        </div>

        <!-- Supplier Section -->
        <div style="margin-bottom: 28px;">
          <div style="font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #ff5500; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid rgba(255,255,255,0.2);">Supplier / Mechanic Details</div>
          <div style="margin-bottom: 20px;">
            <label for="invoiceSupplierName" style="display: block; font-weight: 600; color: #fff; margin-bottom: 6px; font-size: 0.9rem;">Name <span style="color: #dc3545;">*</span></label>
            <input type="text" id="invoiceSupplierName" name="supplierName" required style="width: 100%; padding: 12px 16px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; font-size: 1rem; background: rgba(255,255,255,0.1); color: #fff;" placeholder="John Smith">
          </div>
          <div style="margin-bottom: 20px;">
            <label for="invoiceSupplierEmail" style="display: block; font-weight: 600; color: #fff; margin-bottom: 6px; font-size: 0.9rem;">Email <span style="color: #dc3545;">*</span></label>
            <input type="email" id="invoiceSupplierEmail" name="supplierEmail" required style="width: 100%; padding: 12px 16px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; font-size: 1rem; background: rgba(255,255,255,0.1); color: #fff;" placeholder="mechanic@example.com">
          </div>
          <div style="margin-bottom: 20px;">
            <label for="invoiceSupplierPhone" style="display: block; font-weight: 600; color: #fff; margin-bottom: 6px; font-size: 0.9rem;">Phone</label>
            <input type="tel" id="invoiceSupplierPhone" name="supplierPhone" style="width: 100%; padding: 12px 16px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; font-size: 1rem; background: rgba(255,255,255,0.1); color: #fff;" placeholder="021 123 4567">
          </div>
        </div>

        <!-- Payment Section -->
        <div style="margin-bottom: 28px;">
          <div style="font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #ff5500; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid rgba(255,255,255,0.2);">Payment Details</div>
          <div style="margin-bottom: 20px;">
            <label for="invoiceAmount" style="display: block; font-weight: 600; color: #fff; margin-bottom: 6px; font-size: 0.9rem;">Amount <span style="color: #dc3545;">*</span></label>
            <div style="position: relative;">
              <span style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #ccc; font-weight: 500;">$</span>
              <input type="number" id="invoiceAmount" name="amount" required step="0.01" min="0" style="width: 100%; padding: 12px 16px; padding-left: 32px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; font-size: 1rem; background: rgba(255,255,255,0.1); color: #fff;" placeholder="0.00">
            </div>
          </div>
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; color: #fff; margin-bottom: 6px; font-size: 0.9rem;">Bank Account <span style="color: #dc3545;">*</span></label>
            <div style="display: grid; grid-template-columns: 80px 80px 120px 60px; gap: 8px;">
              <input type="text" id="invoiceBank1" name="bank1" placeholder="XX" maxlength="2" required style="text-align: center; padding: 12px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; font-size: 1rem; background: rgba(255,255,255,0.1); color: #fff;">
              <input type="text" id="invoiceBank2" name="bank2" placeholder="XXXX" maxlength="4" required style="text-align: center; padding: 12px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; font-size: 1rem; background: rgba(255,255,255,0.1); color: #fff;">
              <input type="text" id="invoiceBank3" name="bank3" placeholder="XXXXXXX" maxlength="8" required style="text-align: center; padding: 12px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; font-size: 1rem; background: rgba(255,255,255,0.1); color: #fff;">
              <input type="text" id="invoiceBank4" name="bank4" placeholder="XXX" maxlength="3" required style="text-align: center; padding: 12px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; font-size: 1rem; background: rgba(255,255,255,0.1); color: #fff;">
            </div>
            <div style="font-size: 0.8rem; color: #888; margin-top: 4px;">NZ bank account format: XX-XXXX-XXXXXXX-XXX</div>
          </div>
        </div>

        <!-- Invoice Section -->
        <div style="margin-bottom: 28px;">
          <div style="font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #ff5500; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid rgba(255,255,255,0.2);">Invoice</div>
          <div style="margin-bottom: 20px;">
            <label for="invoiceFile" style="display: block; font-weight: 600; color: #fff; margin-bottom: 6px; font-size: 0.9rem;">Invoice PDF/Image <span style="color: #dc3545;">*</span></label>
            <input type="file" id="invoiceFile" name="invoiceFile" accept=".pdf,.jpg,.jpeg,.png" required style="width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; font-size: 1rem; background: rgba(255,255,255,0.1); color: #fff; cursor: pointer;">
            <div style="font-size: 0.8rem; color: #888; margin-top: 4px;">Accepted formats: PDF, JPG, PNG (max 10MB)</div>
          </div>
        </div>

        <!-- Hidden fields -->
        <input type="hidden" id="invoiceBookingId" name="bookingId" value="">

        <button type="submit" id="invoiceSubmitBtn" class="auth-button upload-button" style="width: 100%; margin-top: 10px;">
          üì§ Upload Invoice
        </button>
      </form>
    </div>
  </div>
</section>

<!-- Contact Form Section (shown when no query string) -->
<section id="contactFormSection" class="auth-section" style="display: none;">
  <div class="container">
    <div class="auth-container">
      <h2>üìß Request New Upload Path</h2>
      <p>The supplier upload system has been updated. If you need a new upload path for your supplier payment submissions, please complete the form below.</p>
      
      <div class="status-message info">
        <strong>‚ÑπÔ∏è What's Changed:</strong> The upload system now requires authentication. If you're a supplier and need access, please request a new upload path using this form.
      </div>
      
      <form id="contactForm" style="margin-top: 30px;">
        <div style="margin-bottom: 20px;">
          <label for="contactName" style="display: block; margin-bottom: 8px; font-weight: 600; color: #fff;">Your Name <span style="color: #dc3545;">*</span></label>
          <input type="text" id="contactName" name="name" required style="width: 100%; padding: 12px; border: 2px solid #444; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; font-size: 1em;" placeholder="John Smith">
        </div>
        
        <div style="margin-bottom: 20px;">
          <label for="contactEmail" style="display: block; margin-bottom: 8px; font-weight: 600; color: #fff;">Email Address <span style="color: #dc3545;">*</span></label>
          <input type="email" id="contactEmail" name="email" required style="width: 100%; padding: 12px; border: 2px solid #444; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; font-size: 1em;" placeholder="your.email@example.com">
        </div>
        
        <div style="margin-bottom: 20px;">
          <label for="contactPhone" style="display: block; margin-bottom: 8px; font-weight: 600; color: #fff;">Phone Number</label>
          <input type="tel" id="contactPhone" name="phone" style="width: 100%; padding: 12px; border: 2px solid #444; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; font-size: 1em;" placeholder="021 123 4567">
        </div>
        
        <div style="margin-bottom: 20px;">
          <label for="contactSubject" style="display: block; margin-bottom: 8px; font-weight: 600; color: #fff;">Subject <span style="color: #dc3545;">*</span></label>
          <select id="contactSubject" name="subject" required style="width: 100%; padding: 12px; border: 2px solid #444; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; font-size: 1em;">
            <option value="Request New Upload Path" selected>Request New Upload Path</option>
            <option value="General Inquiry">General Inquiry</option>
            <option value="Technical Support">Technical Support</option>
            <option value="Other">Other</option>
          </select>
        </div>
        
        <div style="margin-bottom: 20px;">
          <label for="contactMessage" style="display: block; margin-bottom: 8px; font-weight: 600; color: #fff;">Message <span style="color: #dc3545;">*</span></label>
          <textarea id="contactMessage" name="message" required rows="5" style="width: 100%; padding: 12px; border: 2px solid #444; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; font-size: 1em; resize: vertical;" placeholder="Please provide details about your supplier account and why you need a new upload path..."></textarea>
        </div>
        
        <button type="submit" id="contactSubmitBtn" class="auth-button" style="width: 100%; margin-top: 10px;">
          üìß Send Request
        </button>
      </form>
      
      <div id="contactSuccessMessage" class="status-message info hidden" style="margin-top: 20px;">
        <strong>‚úÖ Success!</strong> Your request has been submitted. We'll get back to you soon.
      </div>
      
      <div id="contactErrorMessage" class="status-message error hidden" style="margin-top: 20px;">
        <strong>‚ùå Error:</strong> Something went wrong. Please try again or call us at <a href="tel:0800769000" style="color: #dc3545;">0800 769 000</a>.
      </div>
    </div>
  </div>
</section>

<section id="guidelines" class="upload-section">
  <div class="container">
    <div class="upload-guidelines">
      <h4>üìã Upload Guidelines</h4>
      <ul id="generalGuidelines">
        <li>Documents should be clear, legible, and in acceptable formats</li>
        <li>Maximum file size: 10MB per file</li>
        <li>Supported formats: PDF, JPG, PNG</li>
        <li>Ensure contact information matches your supplier records</li>
      </ul>
      
      <!-- Invoice-specific guidelines -->
      <ul id="invoiceGuidelines">
        <li>All invoices must include job reference numbers when applicable</li>
        <li>Include GST details on all invoices (if applicable)</li>
        <li>Include purchase order numbers when provided</li>
      </ul>
      
      <!-- Pre-purchase inspection guidelines -->
      <ul id="ppGuidelines" class="hidden">
        <li>Include all required inspection photos and documentation</li>
        <li>Clearly label each inspection item with reference numbers</li>
        <li>Include inspection date and inspector details</li>
        <li>Submit reports within 24 hours of inspection completion</li>
      </ul>
    </div>
    
    <div class="upload-guidelines">
      <h4>üîí Security & Privacy</h4>
      <ul>
        <li>All uploads are encrypted using bank-level SSL security</li>
        <li>Documents are stored in secure, access-controlled systems</li>
        <li>Only authorized Eek personnel can access your submissions</li>
        <li>Files are automatically scanned for viruses and malware</li>
        <li>Data is retained according to our privacy policy</li>
        <li>You will receive email confirmation of successful uploads</li>
      </ul>
    </div>

    <div class="upload-guidelines">
      <h4>üîß Technical Requirements</h4>
      <ul>
        <li>Azure AD application must be configured with correct redirect URIs</li>
        <li>Redirect URI must exactly match: https://www.eek.nz/supplier-upload</li>
        <li>Application requires proper permissions and tenant configuration</li>
        <li>Contact IT support if authentication issues persist</li>
      </ul>
    </div>
  </div>
</section>

<!-- Footer will be added by footer.js -->

<script>
// Power Automate endpoint for general contact forms
const POWER_AUTOMATE_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/252cde504791494e823972d9651d0cee/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Qw5TH6rHqrevOeXH2VjtBtLGb1ggI7zRCIYEhBl3Xrw';

// SharePoint Lookup API URL (for fetching existing data)
const SHAREPOINT_LOOKUP_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/c35b9414a0be42f88182ae7e6e409f1d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=2ztt24wScLuAfifD0pjzovseRDKXBAEtCQtScGMgPqQ';

// SharePoint Update API URL (for saving full merged data to EncodedData)
const SHAREPOINT_UPDATE_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ebc96da57e35479b8dd03a6abd06686c/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=abw4-RdaVDllhMuODkPGn0iMZtuXjhmnaYyUOefn5F4';

// Excel API URL (for writing job-specific fields to xlsm)
const EXCEL_WRITE_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ca2a97affbc449419b28ecb274d4c737/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=s2OFNz6J6KdjOKUUF1SRkZKo4UiPh01_uSzxy4Bg7Yw';

// Invoice Upload API URL (for submitting invoices with file attachments)
const INVOICE_UPLOAD_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/b884bb04c6594edb906cdfdb22193b2f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=z7Dd14tvZp2UVGe4DfXewImCbHHJmo3lXsTJmle1jA8';

// State
let sharepointId = null;
let originalBookingData = null;

// Base64 Decode Function
function decodeBase64(encoded) {
  try {
    const decoded = atob(encoded).trim();
    if (decoded) {
      return { bookingId: decoded };
    }
    return null;
  } catch (e) {
    console.error('Failed to decode:', e);
    return null;
  }
}

// Fetch job data from SharePoint
async function fetchJobDataFromSharePoint(bookingId) {
  if (!bookingId) return null;
  
  try {
    const res = await fetch(SHAREPOINT_LOOKUP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ bookingId: String(bookingId) })
    });
    
    if (!res.ok) return null;
    
    const result = await res.json();
    if (result.success && result.bookingData) {
      const json = atob(result.bookingData);
      const decoded = JSON.parse(json);
      decoded.sharepointId = bookingId;
      sharepointId = bookingId;
      originalBookingData = decoded;
      return decoded;
    }
    return null;
  } catch (err) {
    console.error('SharePoint fetch error:', err);
    return null;
  }
}

// Populate form from booking data
function populateFormFromData(bookingData) {
  if (!bookingData) return;
  
  const customerData = bookingData.customerData || {};
  const getValue = (...keys) => {
    for (const key of keys) {
      if (bookingData[key] !== undefined && bookingData[key] !== null && bookingData[key] !== '') {
        return bookingData[key];
      }
      if (customerData[key] !== undefined && customerData[key] !== null && customerData[key] !== '') {
        return customerData[key];
      }
    }
    return null;
  };
  
  const normalizeValue = (value) => {
    if (value === null || value === undefined) return '';
    const textarea = document.createElement('textarea');
    textarea.innerHTML = String(value).trim();
    return textarea.value;
  };
  
  // Vehicle Registration (for job form)
  const regoValue = getValue('Rego', 'rego', 'vehicleRego');
  if (regoValue) {
    const jobRegoField = document.getElementById('jobRego');
    const invoiceRegoField = document.getElementById('invoiceRego');
    if (jobRegoField) jobRegoField.value = normalizeValue(regoValue);
    if (invoiceRegoField) invoiceRegoField.value = normalizeValue(regoValue);
  }
  
  // Supplier Information (for both forms)
  const supplierNameValue = getValue('Supplier', 'supplierName', 'supplier');
  if (supplierNameValue) {
    const supplierNameField = document.getElementById('supplierName');
    const invoiceSupplierNameField = document.getElementById('invoiceSupplierName');
    if (supplierNameField) supplierNameField.value = normalizeValue(supplierNameValue);
    if (invoiceSupplierNameField) invoiceSupplierNameField.value = normalizeValue(supplierNameValue);
  }
  
  const supplierEmailValue = getValue('EmailJobToSupplier', 'supplierEmail', 'SupplierEmail');
  if (supplierEmailValue) {
    const supplierEmailField = document.getElementById('supplierEmail');
    const invoiceSupplierEmailField = document.getElementById('invoiceSupplierEmail');
    if (supplierEmailField) supplierEmailField.value = normalizeValue(supplierEmailValue);
    if (invoiceSupplierEmailField) invoiceSupplierEmailField.value = normalizeValue(supplierEmailValue);
  }
  
  const supplierPhoneValue = getValue('TextJobToMobileNumber', 'supplierPhone', 'SupplierPhone');
  if (supplierPhoneValue) {
    const supplierPhoneField = document.getElementById('supplierPhone');
    const invoiceSupplierPhoneField = document.getElementById('invoiceSupplierPhone');
    if (supplierPhoneField) supplierPhoneField.value = normalizeValue(supplierPhoneValue);
    if (invoiceSupplierPhoneField) invoiceSupplierPhoneField.value = normalizeValue(supplierPhoneValue);
  }
  
  // Customer Information (for job form)
  const emailValue = getValue('Email', 'email', 'customerEmail');
  if (emailValue) {
    const jobEmailField = document.getElementById('jobEmail');
    if (jobEmailField) jobEmailField.value = normalizeValue(emailValue);
  }
  
  const phoneValue = getValue('ClientMobileNumber', 'phone', 'customerPhone');
  if (phoneValue) {
    const jobPhoneField = document.getElementById('jobPhone');
    if (jobPhoneField) jobPhoneField.value = normalizeValue(phoneValue);
  }
  
  // Job Notes (for job form)
  const notesValue = getValue('JobNotes', 'description', 'jobNotes', 'notes');
  if (notesValue) {
    const jobNotesField = document.getElementById('jobNotes');
    if (jobNotesField) jobNotesField.value = normalizeValue(notesValue);
  }
  
  // Invoice Amount (convert from cents to dollars if present)
  const amountValue = getValue('Costings', 'Chargeables', 'Reimbursement', 'amount');
  if (amountValue) {
    const invoiceAmountField = document.getElementById('invoiceAmount');
    if (invoiceAmountField) {
      // If amount is in cents (large number), convert to dollars
      const numValue = parseFloat(amountValue);
      if (numValue > 1000 && numValue % 100 === 0) {
        invoiceAmountField.value = (numValue / 100).toFixed(2);
      } else {
        invoiceAmountField.value = numValue;
      }
    }
  }
  
  // Bank Account (if present in booking data)
  const bankValue = getValue('Bank', 'bankAccount');
  if (bankValue && typeof bankValue === 'string') {
    const bankParts = bankValue.split('-');
    if (bankParts.length === 4) {
      const bank1Field = document.getElementById('invoiceBank1');
      const bank2Field = document.getElementById('invoiceBank2');
      const bank3Field = document.getElementById('invoiceBank3');
      const bank4Field = document.getElementById('invoiceBank4');
      if (bank1Field) bank1Field.value = bankParts[0];
      if (bank2Field) bank2Field.value = bankParts[1];
      if (bank3Field) bank3Field.value = bankParts[2];
      if (bank4Field) bank4Field.value = bankParts[3];
    }
  }
}

// Page initialization
document.addEventListener('DOMContentLoaded', async function() {
  const hasQueryString = window.location.search.length > 0;
  
  if (!hasQueryString) {
    // Show contact form
    document.getElementById('jobSubmissionSection').style.display = 'none';
    document.getElementById('invoiceUploadSection').style.display = 'none';
    document.getElementById('contactFormSection').style.display = 'block';
    document.getElementById('guidelines').style.display = 'none';
    setupContactForm();
  } else {
    // Check if this is a job submission or invoice upload (has 'd' parameter for bookingId)
    const urlParams = new URLSearchParams(window.location.search);
    const encodedData = urlParams.get('d');
    const formType = urlParams.get('type'); // 'invoice' or 'job' or default to 'job'
    let bookingId = null;
    
    if (encodedData) {
      const decoded = decodeBase64(encodedData);
      if (decoded) {
        bookingId = decoded.bookingId;
      }
    } else {
      bookingId = urlParams.get('bookingId');
    }
    
    if (bookingId) {
      // Set bookingId in invoice form if it exists
      const invoiceBookingIdField = document.getElementById('invoiceBookingId');
      if (invoiceBookingIdField) {
        invoiceBookingIdField.value = bookingId;
      }
      
      // Fetch and populate data
      const sharePointData = await fetchJobDataFromSharePoint(bookingId);
      if (sharePointData) {
        populateFormFromData(sharePointData);
      }
      
      // Show appropriate form based on type parameter
      if (formType === 'invoice') {
        // Show invoice upload form
        document.getElementById('contactFormSection').style.display = 'none';
        document.getElementById('jobSubmissionSection').style.display = 'none';
        document.getElementById('invoiceUploadSection').style.display = 'block';
        document.getElementById('guidelines').style.display = 'none';
        setupInvoiceUploadForm();
      } else {
        // Show job submission form (default)
        document.getElementById('contactFormSection').style.display = 'none';
        document.getElementById('invoiceUploadSection').style.display = 'none';
        document.getElementById('jobSubmissionSection').style.display = 'block';
        document.getElementById('guidelines').style.display = 'none';
        setupJobSubmissionForm();
      }
    } else {
      // No bookingId - show contact form
      document.getElementById('jobSubmissionSection').style.display = 'none';
      document.getElementById('invoiceUploadSection').style.display = 'none';
      document.getElementById('contactFormSection').style.display = 'block';
      setupContactForm();
    }
  }
});

function setupJobSubmissionForm() {
  const form = document.getElementById('fuelExtractionForm');
  const submitBtn = document.getElementById('jobSubmitBtn');
  const successMsg = document.getElementById('jobSuccessMessage');
  const errorMsg = document.getElementById('jobErrorMessage');
  const errorText = document.getElementById('jobErrorText');
  
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Hide previous messages
    successMsg.classList.add('hidden');
    errorMsg.classList.add('hidden');
    
    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ Submitting...';
    
    try {
      // Collect form data
      const formData = {
        formType: 'fuel_extraction_job',
        formVersion: '1.0',
        submittedAt: new Date().toISOString(),
        
        // Basic fields
        Rego: document.getElementById('jobRego').value.toUpperCase(),
        Email: document.getElementById('jobEmail').value.trim(),
        ClientMobileNumber: document.getElementById('jobPhone').value.trim(),
        JobNotes: document.getElementById('jobNotes').value.trim(),
        
        // Supplier fields
        Supplier: document.getElementById('supplierName').value.trim(),
        EmailJobToSupplier: document.getElementById('supplierEmail').value.trim(),
        TextJobToMobileNumber: document.getElementById('supplierPhone').value.trim(),
        
        // SharePoint ID if available
        SharePointId: sharepointId,
        BookingId: sharepointId,
        
        // Fields array for Power Automate
        fields: [
          { name: 'Rego', value: document.getElementById('jobRego').value.toUpperCase() },
          { name: 'Email', value: document.getElementById('jobEmail').value.trim() },
          { name: 'ClientMobileNumber', value: document.getElementById('jobPhone').value.trim() },
          { name: 'JobNotes', value: document.getElementById('jobNotes').value.trim() },
          { name: 'Supplier', value: document.getElementById('supplierName').value.trim() },
          { name: 'EmailJobToSupplier', value: document.getElementById('supplierEmail').value.trim() },
          { name: 'TextJobToMobileNumber', value: document.getElementById('supplierPhone').value.trim() }
        ]
      };
      
      // Add SharePoint ID if available
      if (sharepointId) {
        formData.fields.push({ name: 'SharePointId', value: sharepointId });
        formData.fields.push({ name: 'BookingId', value: sharepointId });
      }
      
      // Merge with original booking data if available
      const fullData = originalBookingData ? { ...originalBookingData, ...formData } : formData;
      
      // 1. Update SharePoint with full merged data
      const spResponse = await fetch(SHAREPOINT_UPDATE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(fullData)
      });
      
      if (!spResponse.ok) {
        const errorText = await spResponse.text();
        throw new Error(`SharePoint update failed: ${spResponse.status} - ${errorText}`);
      }
      
      // 2. Write to Excel
      const excelData = {
        Rego: formData.Rego,
        Type: 'Supplier',
        Name: 'Mechanic',
        Supplier: formData.Supplier,
        JobNotes: formData.JobNotes,
        Supp_Email: formData.EmailJobToSupplier,
        Supp_Phone: formData.TextJobToMobileNumber,
        fields: [
          { name: 'Rego', value: formData.Rego },
          { name: 'Type', value: 'Supplier' },
          { name: 'Name', value: 'Mechanic' },
          { name: 'Supplier', value: formData.Supplier },
          { name: 'JobNotes', value: formData.JobNotes },
          { name: 'Supp_Email', value: formData.EmailJobToSupplier },
          { name: 'Supp_Phone', value: formData.TextJobToMobileNumber }
        ]
      };
      
      const excelResponse = await fetch(EXCEL_WRITE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(excelData)
      });
      
      if (!excelResponse.ok) {
        const errorText = await excelResponse.text();
        throw new Error(`Excel write failed: ${excelResponse.status} - ${errorText}`);
      }
      
      successMsg.classList.remove('hidden');
      form.reset();
      
    } catch (error) {
      console.error('Form submission error:', error);
      errorText.textContent = error.message;
      errorMsg.classList.remove('hidden');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '‚õΩ Submit Fuel Extraction Job';
    }
  });
}

// Convert file to base64
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => {
      const base64 = reader.result.split(',')[1];
      resolve(base64);
    };
    reader.onerror = error => reject(error);
  });
}

function setupInvoiceUploadForm() {
  const form = document.getElementById('invoiceUploadForm');
  const submitBtn = document.getElementById('invoiceSubmitBtn');
  const alertSuccess = document.getElementById('invoiceAlertSuccess');
  const alertError = document.getElementById('invoiceAlertError');
  const errorText = document.getElementById('invoiceErrorText');
  
  // Auto-advance bank account fields
  const bankFields = ['invoiceBank1', 'invoiceBank2', 'invoiceBank3', 'invoiceBank4'];
  bankFields.forEach((fieldId, index) => {
    const field = document.getElementById(fieldId);
    if (field) {
      field.addEventListener('input', function(e) {
        this.value = this.value.replace(/\D/g, '');
        if (this.value.length >= this.maxLength && index < bankFields.length - 1) {
          const nextField = document.getElementById(bankFields[index + 1]);
          if (nextField) nextField.focus();
        }
      });
    }
  });
  
  // Uppercase rego
  const regoField = document.getElementById('invoiceRego');
  if (regoField) {
    regoField.addEventListener('input', function(e) {
      this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });
  }
  
  // Form submission protection
  let isSubmitting = false;
  let submissionId = null;
  
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (isSubmitting) {
      console.warn('Form submission already in progress, ignoring duplicate submit');
      return;
    }
    
    submissionId = `submission_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    isSubmitting = true;
    
    alertSuccess.classList.add('hidden');
    alertError.classList.add('hidden');
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 10px;"><span style="width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite;"></span> Uploading...</span>';
    
    try {
      // Build bank account string
      const bankAccount = [
        document.getElementById('invoiceBank1').value,
        document.getElementById('invoiceBank2').value,
        document.getElementById('invoiceBank3').value,
        document.getElementById('invoiceBank4').value
      ].join('-');
      
      // Get form values
      const rego = document.getElementById('invoiceRego').value.trim();
      const supplierName = document.getElementById('invoiceSupplierName').value.trim();
      const supplierEmail = document.getElementById('invoiceSupplierEmail').value.trim();
      const supplierPhone = document.getElementById('invoiceSupplierPhone').value.trim();
      const amount = parseFloat(document.getElementById('invoiceAmount').value) || 0;
      
      // Build formData with fields array for dynamic email builder
      const formData = {
        formType: 'invoice_upload',
        formVersion: '1.0',
        submissionId: submissionId,
        submittedAt: new Date().toISOString(),
        
        // Flat fields for flow processing
        rego: rego,
        supplierName: supplierName,
        supplierEmail: supplierEmail,
        supplierPhone: supplierPhone,
        amount: amount,
        bankAccount: bankAccount,
        
        // Fields array for dynamic email builder
        fields: [
          { name: 'Rego', value: rego },
          { name: 'Supplier Name', value: supplierName },
          { name: 'Supplier Email', value: supplierEmail },
          { name: 'Supplier Phone', value: supplierPhone },
          { name: 'Amount', value: '$' + amount.toFixed(2) },
          { name: 'Bank Account', value: bankAccount }
        ]
      };
      
      // Include bookingId if available
      const bookingIdValue = document.getElementById('invoiceBookingId').value;
      if (bookingIdValue) {
        formData.bookingId = bookingIdValue;
        formData.SharePointId = bookingIdValue;
        formData.BookingId = bookingIdValue;
        formData.fields.push({ name: 'BookingId', value: bookingIdValue });
      }
      
      // Handle file upload - convert to base64
      const fileInput = document.getElementById('invoiceFile');
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        formData.invoiceFileName = file.name;
        formData.invoiceFileType = file.type;
        formData.invoiceFileBase64 = await fileToBase64(file);
        formData.fields.push({ name: 'Invoice File', value: file.name });
      }
      
      // Merge with original booking data if available
      const fullData = originalBookingData ? { ...originalBookingData, ...formData } : formData;
      
      if (typeof gtag === 'function') {
        gtag('event', 'form_submit', {
          form_type: 'invoice_upload',
          amount: formData.amount
        });
      }
      
      const response = await fetch(INVOICE_UPLOAD_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(fullData)
      });
      
      if (response.ok) {
        if (typeof gtag === 'function') {
          gtag('event', 'form_submit_success', {
            form_type: 'invoice_upload',
            amount: formData.amount,
            submission_id: submissionId
          });
        }
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Invoice Uploaded ‚úì';
        alertSuccess.classList.remove('hidden');
        form.reset();
        
        // Reset bookingId if it was set
        if (bookingIdValue) {
          document.getElementById('invoiceBookingId').value = bookingIdValue;
        }
        
      } else {
        throw new Error('Server returned ' + response.status);
      }
      
    } catch (error) {
      console.error('Submission error:', error);
      errorText.textContent = '‚ùå ' + (error.message || 'Something went wrong. Please try again.');
      alertError.classList.remove('hidden');
      
      isSubmitting = false;
      
      if (typeof gtag === 'function') {
        gtag('event', 'form_submit_error', {
          form_type: 'invoice_upload',
          error_message: error.message,
          submission_id: submissionId
        });
      }
    } finally {
      if (!isSubmitting || !alertSuccess.classList.contains('hidden')) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'üì§ Upload Invoice';
      }
    }
  });
}

function setupContactForm() {
  const form = document.getElementById('contactForm');
  const submitBtn = document.getElementById('contactSubmitBtn');
  const successMsg = document.getElementById('contactSuccessMessage');
  const errorMsg = document.getElementById('contactErrorMessage');
  
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Hide previous messages
    successMsg.classList.add('hidden');
    errorMsg.classList.add('hidden');
    
    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ Sending...';
    
    try {
      const formData = {
        formType: 'supplier_upload_request',
        formVersion: '1.0',
        submittedAt: new Date().toISOString(),
        
        // Form fields
        name: document.getElementById('contactName').value.trim(),
        email: document.getElementById('contactEmail').value.trim(),
        phone: document.getElementById('contactPhone').value.trim(),
        subject: document.getElementById('contactSubject').value,
        message: document.getElementById('contactMessage').value.trim(),
        
        // Fields array for dynamic email builder
        fields: [
          { name: 'Name', value: document.getElementById('contactName').value.trim() },
          { name: 'Email', value: document.getElementById('contactEmail').value.trim() },
          { name: 'Phone', value: document.getElementById('contactPhone').value.trim() || 'Not provided' },
          { name: 'Subject', value: document.getElementById('contactSubject').value },
          { name: 'Message', value: document.getElementById('contactMessage').value.trim() }
        ]
      };
      
      const response = await fetch(POWER_AUTOMATE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
      
      if (response.ok) {
        successMsg.classList.remove('hidden');
        form.reset();
        
        if (typeof gtag === 'function') {
          gtag('event', 'form_submit_success', {
            form_type: 'supplier_upload_request'
          });
        }
      } else {
        throw new Error('Server returned ' + response.status);
      }
    } catch (error) {
      console.error('Form submission error:', error);
      errorMsg.classList.remove('hidden');
      
      if (typeof gtag === 'function') {
        gtag('event', 'form_submit_error', {
          form_type: 'supplier_upload_request',
          error_message: error.message
        });
      }
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'üìß Send Request';
    }
  });
}

</script>

</body>
</html>
