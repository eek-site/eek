<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supplier Upload Portal | Eek Mechanical</title>
  <meta name="description" content="Secure document upload portal for Eek Mechanical suppliers. Submit invoices, job sheets, and documentation.">
  <meta name="keywords" content="supplier upload, invoice submission, document portal, eek mechanical">
  <meta property="og:title" content="Supplier Upload Portal | Eek Mechanical">
  <meta property="og:description" content="Secure portal for suppliers to upload invoices and documents.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.eek.nz/supplier-upload">

  <!-- Security Headers -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://static.cloudflareinsights.com;
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    connect-src 'self' https://www.eek.nz https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com https://static.cloudflareinsights.com;
    frame-src 'self';
    font-src 'self' data:;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">

  <!-- Centralized Scripts -->
  <script src="/phone-manager.js?v=20251020"></script>
  <script src="/unified-tracking.js?v=20251020"></script>
  <script src="/footer-new.js?v=20251020"></script>

  <!-- Schema.org Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Eek Mechanical Supplier Upload Portal",
    "description": "Secure document upload system for suppliers to submit invoices and documentation.",
    "url": "https://www.eek.nz/supplier-upload",
    "applicationCategory": "BusinessApplication",
    "operatingSystem": "Web Browser",
    "parentOrganization": {
      "@type": "LocalBusiness",
      "name": "Eek Mechanical"
    }
  }
  </script>

  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #fff;
      line-height: 1.6;
      min-height: 100vh;
    }

    .container { max-width: 1000px; margin: 0 auto; padding: 0 20px; }
    .container-narrow { max-width: 650px; margin: 0 auto; padding: 0 20px; }

    /* Header */
    .header {
      background: linear-gradient(135deg, #ff5500 0%, #ff7700 100%);
      padding: 40px 0;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%; right: -50%;
      width: 200%; height: 200%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
      animation: float 15s infinite linear;
    }

    @keyframes float {
      0% { transform: translateX(0) translateY(0); }
      100% { transform: translateX(-50px) translateY(-50px); }
    }

    .header-content { position: relative; z-index: 2; text-align: center; }
    .header h1 { font-size: 2.5em; margin-bottom: 15px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
    .header .subtitle { font-size: 1.1em; opacity: 0.9; margin-bottom: 20px; }

    .security-badge {
      display: inline-block;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      padding: 8px 20px;
      border-radius: 25px;
      font-size: 0.9em;
      font-weight: bold;
      border: 1px solid rgba(255,255,255,0.3);
    }

    /* Navigation */
    .nav {
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid #333;
    }

    .nav-content { display: flex; justify-content: center; padding: 15px 0; gap: 30px; flex-wrap: wrap; }
    .nav a { color: #ccc; text-decoration: none; font-weight: 500; transition: color 0.3s ease; }
    .nav a:hover { color: #ff5500; }

    /* Main Section */
    .main-section { padding: 50px 0; }

    /* Form Card */
    .form-card {
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      padding: 40px;
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }

    .form-card h2 { color: #ff5500; font-size: 1.8em; margin-bottom: 10px; }
    .form-card > p { color: #bbb; margin-bottom: 25px; font-size: 1.05em; }

    .form-section { margin-bottom: 28px; }

    .form-section-title {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #ff5500;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid rgba(255,255,255,0.15);
    }

    .form-group { margin-bottom: 20px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

    @media (max-width: 600px) {
      .form-row { grid-template-columns: 1fr; }
      .form-card { padding: 25px 20px; }
      .header h1 { font-size: 1.8em; }
      .nav-content { flex-direction: column; align-items: center; gap: 12px; }
    }

    label { display: block; font-weight: 600; color: #fff; margin-bottom: 6px; font-size: 0.9rem; }
    label .required { color: #ef4444; }

    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.2s ease;
      background: rgba(255,255,255,0.08);
      color: #fff;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #ff5500;
      background: rgba(255,255,255,0.12);
      box-shadow: 0 0 0 4px rgba(255,85,0,0.15);
    }

    input::placeholder, textarea::placeholder { color: rgba(255,255,255,0.4); }

    input[type="file"] { padding: 10px; cursor: pointer; }
    input[type="file"]::file-selector-button {
      background: #ff5500;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 12px;
      font-weight: 500;
      transition: background 0.2s;
    }
    input[type="file"]::file-selector-button:hover { background: #e04400; }

    textarea { resize: vertical; min-height: 100px; }
    select option { background: #1a1a2e; color: #fff; }

    .input-prefix, .input-suffix { position: relative; }
    .input-prefix span, .input-suffix span {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255,255,255,0.5);
      font-weight: 500;
    }
    .input-prefix span { left: 16px; }
    .input-suffix span { right: 16px; }
    .input-prefix input { padding-left: 32px; }
    .input-suffix input { padding-right: 32px; }

    .bank-inputs { display: grid; grid-template-columns: 70px 80px 110px 60px; gap: 8px; }
    @media (max-width: 500px) { .bank-inputs { grid-template-columns: 1fr 1fr; } }
    .bank-inputs input { text-align: center; }

    .help-text { font-size: 0.8rem; color: rgba(255,255,255,0.5); margin-top: 4px; }

    input:disabled, input[readonly], textarea:disabled, textarea[readonly] {
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.6);
      cursor: not-allowed;
    }

    /* Help Popout Modals */
    .help-triggers {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .help-trigger {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 20px;
      font-size: 0.8rem;
      color: rgba(255,255,255,0.8);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .help-trigger:hover {
      background: rgba(255,85,0,0.2);
      border-color: #ff5500;
      color: #fff;
    }

    .help-trigger .help-icon {
      font-size: 1em;
    }

    .help-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .help-modal.show {
      display: flex;
    }

    .help-modal-content {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border-radius: 20px;
      padding: 30px;
      max-width: 550px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 30px 60px rgba(0,0,0,0.5);
      animation: modalSlide 0.3s ease;
    }

    .help-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .help-modal-header h3 {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #ff5500;
      font-size: 1.3em;
    }

    .help-modal-close {
      background: none;
      border: none;
      color: rgba(255,255,255,0.6);
      font-size: 1.5em;
      cursor: pointer;
      padding: 5px;
      line-height: 1;
    }

    .help-modal-close:hover {
      color: #fff;
    }

    .help-steps {
      margin-bottom: 20px;
    }

    .help-step {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
    }

    .help-step-number {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      background: #ff5500;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.85rem;
    }

    .help-step-content {
      flex: 1;
    }

    .help-step-content strong {
      display: block;
      margin-bottom: 4px;
      color: #fff;
    }

    .help-step-content p {
      color: rgba(255,255,255,0.7);
      font-size: 0.9rem;
      margin: 0;
    }

    .help-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: linear-gradient(135deg, #ff5500 0%, #ff7700 100%);
      color: #fff;
      text-decoration: none;
      border-radius: 25px;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .help-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(255,85,0,0.4);
    }

    .help-tip {
      margin-top: 16px;
      padding: 12px 16px;
      background: rgba(255,85,0,0.1);
      border-left: 3px solid #ff5500;
      border-radius: 0 8px 8px 0;
      font-size: 0.85rem;
      color: rgba(255,255,255,0.8);
    }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 16px 32px;
      background: linear-gradient(135deg, #ff5500 0%, #ff7700 100%);
      color: #fff;
      border: none;
      border-radius: 50px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
      box-shadow: 0 10px 30px rgba(255,85,0,0.3);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn:hover { transform: translateY(-2px); box-shadow: 0 15px 40px rgba(255,85,0,0.4); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { background: #555; cursor: not-allowed; transform: none; box-shadow: none; }

    .btn-secondary { background: linear-gradient(135deg, #0078d4, #106ebe); box-shadow: 0 10px 30px rgba(0,120,212,0.3); }
    .btn-secondary:hover { box-shadow: 0 15px 40px rgba(0,120,212,0.4); }

    .spinner {
      width: 20px; height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Alerts */
    .alert {
      padding: 16px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 500;
      display: none;
    }
    .alert-success { background: rgba(40,167,69,0.15); color: #5cb85c; border: 1px solid rgba(40,167,69,0.3); }
    .alert-error { background: rgba(220,53,69,0.15); color: #e74c3c; border: 1px solid rgba(220,53,69,0.3); }
    .alert-info { background: rgba(23,162,184,0.15); color: #17a2b8; border: 1px solid rgba(23,162,184,0.3); }
    .alert a { color: inherit; }

    .hidden { display: none !important; }

    /* Guidelines */
    .guidelines-section { padding: 30px 0 50px; }

    .upload-guidelines {
      background: rgba(255,255,255,0.05);
      border-left: 4px solid #ff5500;
      padding: 20px 25px;
      margin: 15px 0;
      border-radius: 8px;
    }

    .upload-guidelines h4 { color: #ff5500; margin-bottom: 12px; font-size: 1em; }
    .upload-guidelines ul { list-style: none; padding: 0; }
    .upload-guidelines li {
      padding: 6px 0;
      padding-left: 25px;
      position: relative;
      color: #aaa;
      font-size: 0.95em;
    }
    .upload-guidelines li::before {
      content: '‚úì';
      position: absolute;
      left: 0;
      color: #28a745;
      font-weight: bold;
    }

    /* Success Modal */
    .success-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    .success-modal.show { display: flex; }

    .success-modal-content {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border-radius: 20px;
      padding: 50px;
      max-width: 480px;
      width: 90%;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 30px 60px rgba(0,0,0,0.5);
      animation: modalSlide 0.3s ease;
    }

    @keyframes modalSlide {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .success-icon { font-size: 4em; margin-bottom: 20px; }
    .success-modal-content h2 { color: #28a745; margin-bottom: 15px; font-size: 1.6em; }
    .success-modal-content p { color: #8892b0; margin-bottom: 25px; }
  </style>
</head>
<body>

<!-- Header -->
<header class="header">
  <div class="container">
    <div class="header-content">
      <h1>üìÅ Supplier Upload Portal</h1>
      <p class="subtitle">Secure Document Submission System</p>
      <div class="security-badge">üîí Bank-Level Security | SSL Encrypted</div>
    </div>
  </div>
</header>

<!-- Navigation -->
<nav class="nav">
  <div class="container">
    <div class="nav-content">
      <a href="#form">Upload Form</a>
      <a href="#guidelines">Guidelines</a>
      <a href="/">‚Üê Back to Home</a>
      <a href="tel:0800769000">üìû 0800 769 000</a>
    </div>
  </div>
</nav>

<!-- Main Content -->
<main class="main-section" id="form">
  <div class="container-narrow">

    <!-- ======================================== -->
    <!-- CONTACT FORM (no ?d= parameter)         -->
    <!-- ======================================== -->
    <div id="contactSection" class="form-card hidden" style="scroll-margin-top:100px;">
      <h2>üìß Request Upload Access</h2>
      <p>Need to submit an invoice or documentation? Request your secure upload link below.</p>

      <div id="contactAlertSuccess" class="alert alert-success">
        ‚úÖ Request submitted successfully! We'll send your upload link shortly.
      </div>
      <div id="contactAlertError" class="alert alert-error">
        ‚ùå Something went wrong. Please try again or call <a href="tel:0800769000">0800 769 000</a>
      </div>

      <form id="contactForm" novalidate>
        <div class="form-section">
          <div class="form-section-title">Your Details</div>
          
          <div class="form-group">
            <label for="contactName">Full Name <span class="required">*</span></label>
            <input type="text" id="contactName" name="name" required placeholder="John Smith">
          </div>

          <div class="form-group">
            <label for="contactEmail">Email Address <span class="required">*</span></label>
            <input type="email" id="contactEmail" name="email" required placeholder="you@company.com">
          </div>

          <div class="form-group">
            <label for="contactPhone">Phone Number</label>
            <input type="tel" id="contactPhone" name="phone" placeholder="021 123 4567">
          </div>

          <div class="form-group">
            <label for="contactCompany">Company Name</label>
            <input type="text" id="contactCompany" name="company" placeholder="Your Company Ltd">
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title">Request Details</div>
          
          <div class="form-group">
            <label for="contactSubject">Subject <span class="required">*</span></label>
            <select id="contactSubject" name="subject" required>
              <option value="Request Upload Path">Request Upload Path</option>
              <option value="Invoice Submission Query">Invoice Submission Query</option>
              <option value="Technical Support">Technical Support</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <label for="contactMessage">Message <span class="required">*</span></label>
            <textarea id="contactMessage" name="message" required placeholder="Please describe what you need to upload and any relevant job or reference numbers..."></textarea>
          </div>
        </div>

        <button type="submit" class="btn btn-secondary" id="contactSubmitBtn">
          üìß Send Request
        </button>
      </form>
    </div>

    <!-- ======================================== -->
    <!-- INVOICE UPLOAD FORM (with ?d= parameter) -->
    <!-- ======================================== -->
    <div id="invoiceSection" class="form-card hidden">
      <h2>‚õΩ Fuel Extraction Invoice</h2>
      <p>Submit your job details and invoice for payment processing.</p>

      <div id="invoiceAlertSuccess" class="alert alert-success">
        ‚úÖ Invoice submitted successfully! Payment will be processed shortly.
      </div>
      <div id="invoiceAlertError" class="alert alert-error">
        ‚ùå <span id="invoiceErrorText">Something went wrong. Please try again.</span>
      </div>
      <div id="invoiceAlertLoading" class="alert alert-info">
        ‚è≥ Loading job data from system...
      </div>

      <form id="invoiceForm" novalidate>
        <!-- Vehicle Section -->
        <div class="form-section">
          <div class="form-section-title">Vehicle Details</div>
          <div class="form-group">
            <label for="rego">Registration <span class="required">*</span></label>
            <input type="text" id="rego" name="rego" required placeholder="ABC123" maxlength="10" style="text-transform:uppercase;">
          </div>
        </div>

        <!-- Fuel Section -->
        <div class="form-section">
          <div class="form-section-title">Fuel Details</div>
          <div class="form-row">
            <div class="form-group">
              <label for="litresExtracted">Litres Extracted <span class="required">*</span></label>
              <div class="input-suffix">
                <input type="number" id="litresExtracted" name="litresExtracted" required placeholder="0" min="0" step="0.1">
                <span>L</span>
              </div>
            </div>
            <div class="form-group">
              <label for="litresIntroduced">Litres Introduced <span class="required">*</span></label>
              <div class="input-suffix">
                <input type="number" id="litresIntroduced" name="litresIntroduced" required placeholder="0" min="0" step="0.1">
                <span>L</span>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label for="description">Job Description</label>
            <textarea id="description" name="description" placeholder="E.g., Petrol in diesel tank, drained fuel system, flushed lines, added 50L diesel..."></textarea>
          </div>
        </div>

        <!-- Supplier Section -->
        <div class="form-section">
          <div class="form-section-title">Supplier / Mechanic Details</div>
          <div class="form-group">
            <label for="supplierName">Name <span class="required">*</span></label>
            <input type="text" id="supplierName" name="supplierName" required placeholder="John Smith">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="supplierEmail">Email <span class="required">*</span></label>
              <input type="email" id="supplierEmail" name="supplierEmail" required placeholder="mechanic@example.com">
            </div>
            <div class="form-group">
              <label for="supplierPhone">Phone</label>
              <input type="tel" id="supplierPhone" name="supplierPhone" placeholder="021 123 4567">
            </div>
          </div>
        </div>

        <!-- Payment Section -->
        <div class="form-section">
          <div class="form-section-title">Payment Details</div>
          <div class="form-group">
            <label for="amount">Invoice Amount <span class="required">*</span></label>
            <div class="input-prefix">
              <span>$</span>
              <input type="number" id="amount" name="amount" required placeholder="0.00" min="0" step="0.01">
            </div>
          </div>
          <div class="form-group">
            <label>Bank Account <span class="required">*</span></label>
            <div class="bank-inputs">
              <input type="text" id="bank1" name="bank1" placeholder="XX" maxlength="2" required>
              <input type="text" id="bank2" name="bank2" placeholder="XXXX" maxlength="4" required>
              <input type="text" id="bank3" name="bank3" placeholder="XXXXXXX" maxlength="8" required>
              <input type="text" id="bank4" name="bank4" placeholder="XXX" maxlength="3" required>
            </div>
            <div class="help-text">NZ bank account format: XX-XXXX-XXXXXXX-XXX</div>
          </div>
        </div>

        <!-- Invoice Document Section - SIMPLE -->
        <div class="form-section">
          <div class="form-section-title">Invoice <span class="required">*</span></div>
          
          <div class="form-group">
            <label for="invoiceLink">Invoice Link</label>
            <input type="url" id="invoiceLink" name="invoiceLink" placeholder="https://in.xero.com/...">
            <div class="help-text">Paste your invoice link from Xero, MYOB, or QuickBooks</div>
            
            <!-- Help triggers -->
            <div class="help-triggers">
              <span class="help-trigger" onclick="showHelpModal('xero')">
                <span class="help-icon">‚ùì</span> How to get Xero link
              </span>
              <span class="help-trigger" onclick="showHelpModal('myob')">
                <span class="help-icon">‚ùì</span> How to get MYOB link
              </span>
              <span class="help-trigger" onclick="showHelpModal('quickbooks')">
                <span class="help-icon">‚ùì</span> How to get QuickBooks link
              </span>
            </div>
          </div>

          <div class="form-group" style="margin-top: 16px;">
            <label>Or upload a file instead</label>
            <input type="file" id="invoiceFile" name="invoiceFile" accept=".pdf,.jpg,.jpeg,.png">
            <div class="help-text">PDF, JPG, PNG (max 10MB)</div>
          </div>
        </div>

        <!-- Hidden Tracking Fields -->
        <input type="hidden" id="bookingId" name="bookingId">
        <input type="hidden" id="sessionId" name="sessionId">
        <input type="hidden" id="timestamp" name="timestamp">
        <input type="hidden" id="timezone" name="timezone">
        <input type="hidden" id="userAgent" name="userAgent">
        <input type="hidden" id="referrer" name="referrer">
        <input type="hidden" id="screenResolution" name="screenResolution">
        <input type="hidden" id="language" name="language">
        <input type="hidden" id="platform" name="platform">

        <button type="submit" class="btn" id="invoiceSubmitBtn">
          üì§ Submit Invoice for Payment
        </button>
      </form>
    </div>

  </div>
</main>

<!-- Guidelines Section -->
<section class="guidelines-section" id="guidelines">
  <div class="container">
    <div class="upload-guidelines">
      <h4>üìã Upload Guidelines</h4>
      <ul>
        <li>Invoices must include your business name and bank account details</li>
        <li>Include the vehicle registration and job description</li>
        <li>Maximum file size: 10MB per document</li>
        <li>Accepted formats: PDF, JPG, PNG ‚Äî or paste a link from Xero/MYOB</li>
        <li>Ensure all figures are clearly legible</li>
      </ul>
    </div>

    <div class="upload-guidelines">
      <h4>üîó Using Invoice Links</h4>
      <ul>
        <li>Copy the invoice link directly from Xero, MYOB, or your accounting software</li>
        <li>In Xero: Click "Email" on the invoice, then copy the online invoice link</li>
        <li>We'll store the link with your submission for reference</li>
        <li>If you prefer, you can also upload a PDF copy instead</li>
      </ul>
    </div>

    <div class="upload-guidelines">
      <h4>üîí Security & Privacy</h4>
      <ul>
        <li>All uploads are encrypted using bank-level SSL security</li>
        <li>Documents are stored in secure, access-controlled systems</li>
        <li>Only authorized Eek Mechanical personnel can access submissions</li>
        <li>Files are automatically scanned for security threats</li>
        <li>You will receive email confirmation of successful uploads</li>
      </ul>
    </div>

    <div class="upload-guidelines">
      <h4>üí≥ Payment Processing</h4>
      <ul>
        <li>Payments are processed via <a href="https://www.anz.co.nz/business/manage-your-banking/digital-banking-tools/direct-online/" target="_blank" rel="noopener" style="color:#ff5500;">ANZ Direct Online</a> batch payment system</li>
        <li>Domestic NZ payments are available 7 days a week, including weekends and public holidays</li>
        <li>Same-day payments are processed immediately when submitted before cut-off</li>
        <li>ANZ processes payments from 4am on the payment date to ANZ accounts instantly</li>
        <li>Payments to other NZ banks are sent from 9am on the payment date</li>
        <li>Ensure your bank account details are correct ‚Äî incorrect details will delay payment</li>
        <li>You'll receive confirmation when your invoice is processed</li>
        <li>For payment queries, <a href="#contact" id="showContactLink" style="color:#ff5500;cursor:pointer;">submit a request here</a></li>
      </ul>
    </div>
  </div>
</section>

<!-- Success Modal -->
<div class="success-modal" id="successModal">
  <div class="success-modal-content">
    <div class="success-icon">‚úÖ</div>
    <h2>Invoice Submitted!</h2>
    <p>Thank you. Your invoice has been received and queued for payment via ANZ batch processing.</p>
    <button class="btn" id="modalCloseBtn">Return to Home</button>
  </div>
</div>

<!-- Footer injected by footer-new.js -->

<!-- Help Modals -->
<!-- Xero Help Modal -->
<div class="help-modal" id="helpModalXero">
  <div class="help-modal-content">
    <div class="help-modal-header">
      <h3>üìò Get Invoice Link from Xero</h3>
      <button class="help-modal-close" onclick="closeHelpModal('xero')">&times;</button>
    </div>
    
    <div class="help-steps">
      <div class="help-step">
        <div class="help-step-number">1</div>
        <div class="help-step-content">
          <strong>Open Your Invoice</strong>
          <p>Find and open the invoice you want to share (no need to email it first)</p>
        </div>
      </div>
      
      <div class="help-step">
        <div class="help-step-number">2</div>
        <div class="help-step-content">
          <strong>Get the Link</strong>
          <p><strong>On desktop:</strong> Click the ‚Ä¢‚Ä¢‚Ä¢ menu ‚Üí "Get link" ‚Üí Copy<br>
          <strong>On mobile:</strong> Tap "Options" ‚Üí "Share"</p>
        </div>
      </div>
      
      <div class="help-step">
        <div class="help-step-number">3</div>
        <div class="help-step-content">
          <strong>Paste Here</strong>
          <p>Paste the link into the Invoice Link field above</p>
        </div>
      </div>
    </div>
    
    <div class="help-tip">
      üí° <strong>Tips:</strong><br>
      ‚Ä¢ Works from the Xero app on your phone<br>
      ‚Ä¢ Draft invoices are auto-approved when you copy the link<br>
      ‚Ä¢ You don't need to email the invoice first
    </div>
    
    <div style="margin-top: 20px;">
      <a href="https://central.xero.com/s/article/Share-an-online-invoice-link-with-your-customer" target="_blank" rel="noopener" class="help-link">
        üìñ Xero Help Article ‚Üí
      </a>
    </div>
  </div>
</div>

<!-- MYOB Help Modal -->
<div class="help-modal" id="helpModalMyob">
  <div class="help-modal-content">
    <div class="help-modal-header">
      <h3>üìó Get Invoice Link from MYOB</h3>
      <button class="help-modal-close" onclick="closeHelpModal('myob')">&times;</button>
    </div>
    
    <div class="help-steps">
      <div class="help-step">
        <div class="help-step-number">1</div>
        <div class="help-step-content">
          <strong>Open Your Invoice</strong>
          <p>Find and open the invoice you want to share</p>
        </div>
      </div>
      
      <div class="help-step">
        <div class="help-step-number">2</div>
        <div class="help-step-content">
          <strong>Get the Link</strong>
          <p><strong>On desktop:</strong> Click "Share" ‚Üí "Copy link"<br>
          <strong>On mobile:</strong> Tap the share icon ‚Üí Copy link</p>
        </div>
      </div>
      
      <div class="help-step">
        <div class="help-step-number">3</div>
        <div class="help-step-content">
          <strong>Paste Here</strong>
          <p>Paste the link into the Invoice Link field above</p>
        </div>
      </div>
    </div>
    
    <div class="help-tip">
      üí° <strong>Tips:</strong><br>
      ‚Ä¢ Works from the MYOB app on your phone<br>
      ‚Ä¢ You can also click "View PDF" ‚Üí "Copy Link"<br>
      ‚Ä¢ Online invoices update in real-time if you make changes
    </div>
    
    <div style="margin-top: 20px;">
      <a href="https://www.myob.com/au/support/myob-business/sales/online-invoicing/sending-an-online-invoice-link-to-a-customer" target="_blank" rel="noopener" class="help-link">
        üìñ MYOB Help Article ‚Üí
      </a>
    </div>
  </div>
</div>

<!-- QuickBooks Help Modal -->
<div class="help-modal" id="helpModalQuickbooks">
  <div class="help-modal-content">
    <div class="help-modal-header">
      <h3>üìï Get Invoice Link from QuickBooks</h3>
      <button class="help-modal-close" onclick="closeHelpModal('quickbooks')">&times;</button>
    </div>
    
    <div class="help-steps">
      <div class="help-step">
        <div class="help-step-number">1</div>
        <div class="help-step-content">
          <strong>Open Your Invoice</strong>
          <p>Find and open the invoice you want to share</p>
        </div>
      </div>
      
      <div class="help-step">
        <div class="help-step-number">2</div>
        <div class="help-step-content">
          <strong>Get the Link</strong>
          <p><strong>On desktop:</strong> Click dropdown next to "Save and Close" ‚Üí "Share link" ‚Üí Copy<br>
          <strong>On mobile:</strong> Open invoice in browser, use same steps above</p>
        </div>
      </div>
      
      <div class="help-step">
        <div class="help-step-number">3</div>
        <div class="help-step-content">
          <strong>Paste Here</strong>
          <p>Paste the link into the Invoice Link field above</p>
        </div>
      </div>
    </div>
    
    <div class="help-tip">
      üí° <strong>Tips:</strong><br>
      ‚Ä¢ QuickBooks needs an email in the customer field first (use yours if needed)<br>
      ‚Ä¢ Keyboard shortcut: Ctrl + Alt + L to share link<br>
      ‚Ä¢ Mobile app: sign into QBO through your phone's browser
    </div>
    
    <div style="margin-top: 20px;">
      <a href="https://quickbooks.intuit.com/learn-support/en-us/reports-and-accounting/how-do-i-send-invoices-through-text-messages/00/1107539" target="_blank" rel="noopener" class="help-link">
        üìñ QuickBooks Help Article ‚Üí
      </a>
    </div>
  </div>
</div>

<script>
// ============================================
// HELP MODAL FUNCTIONS
// ============================================
function showHelpModal(platform) {
  const modalId = 'helpModal' + platform.charAt(0).toUpperCase() + platform.slice(1);
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
  }
}

function closeHelpModal(platform) {
  const modalId = 'helpModal' + platform.charAt(0).toUpperCase() + platform.slice(1);
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.remove('show');
    document.body.style.overflow = '';
  }
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('help-modal')) {
    e.target.classList.remove('show');
    document.body.style.overflow = '';
  }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    document.querySelectorAll('.help-modal.show').forEach(modal => {
      modal.classList.remove('show');
    });
    document.body.style.overflow = '';
  }
});

// ============================================
// CONFIGURATION
// ============================================
const CONFIG = {
  CONTACT_URL: 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/252cde504791494e823972d9651d0cee/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Qw5TH6rHqrevOeXH2VjtBtLGb1ggI7zRCIYEhBl3Xrw',
  
  SHAREPOINT_LOOKUP_URL: 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/c35b9414a0be42f88182ae7e6e409f1d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=2ztt24wScLuAfifD0pjzovseRDKXBAEtCQtScGMgPqQ',
  
  INVOICE_URL: 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/b884bb04c6594edb906cdfdb22193b2f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=z7Dd14tvZp2UVGe4DfXewImCbHHJmo3lXsTJmle1jA8'
};

// State
let bookingData = null;

// ============================================
// UTILITY FUNCTIONS
// ============================================
function decodeBase64(encoded) {
  try {
    return atob(encoded).trim();
  } catch (e) {
    console.error('Decode error:', e);
    return null;
  }
}

function normalizeValue(val) {
  if (val === null || val === undefined) return '';
  return String(val).trim();
}

async function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
  });
}

function getOrCreateSessionId() {
  let sid = localStorage.getItem('eek_session_id');
  if (!sid) {
    sid = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    localStorage.setItem('eek_session_id', sid);
  }
  return sid;
}

function captureTrackingData() {
  document.getElementById('sessionId').value = getOrCreateSessionId();
  document.getElementById('timestamp').value = new Date().toISOString();
  document.getElementById('timezone').value = Intl.DateTimeFormat().resolvedOptions().timeZone;
  document.getElementById('userAgent').value = navigator.userAgent;
  document.getElementById('referrer').value = document.referrer;
  document.getElementById('screenResolution').value = `${screen.width}x${screen.height}`;
  document.getElementById('language').value = navigator.language;
  document.getElementById('platform').value = navigator.platform;
}

// ============================================
// SHAREPOINT DATA FETCH
// ============================================
async function fetchBookingData(bookingId) {
  if (!bookingId) return null;
  
  try {
    const res = await fetch(CONFIG.SHAREPOINT_LOOKUP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ bookingId: String(bookingId) })
    });
    
    if (!res.ok) return null;
    
    const result = await res.json();
    if (result.success && result.bookingData) {
      return JSON.parse(atob(result.bookingData));
    }
    return null;
  } catch (err) {
    console.error('SharePoint fetch error:', err);
    return null;
  }
}

// ============================================
// FORM POPULATION FROM SHAREPOINT
// ============================================
function populateInvoiceForm(data) {
  if (!data) return;
  
  const customerData = data.customerData || {};
  const supplierData = data.supplierData || {};
  
  const getValue = (...keys) => {
    for (const key of keys) {
      if (data[key]) return data[key];
      if (customerData[key]) return customerData[key];
      if (supplierData[key]) return supplierData[key];
    }
    return null;
  };
  
  // Vehicle
  const rego = getValue('rego', 'Rego', 'vehicleRego');
  if (rego) {
    document.getElementById('rego').value = normalizeValue(rego).toUpperCase();
  }
  
  // Supplier - lock if pre-populated
  const supplierName = getValue('supplierName', 'Supplier', 'mechanicName');
  if (supplierName) {
    const el = document.getElementById('supplierName');
    el.value = normalizeValue(supplierName);
    el.readOnly = true;
  }
  
  const supplierEmail = getValue('supplierEmail', 'EmailJobToSupplier', 'mechanicEmail');
  if (supplierEmail) {
    const el = document.getElementById('supplierEmail');
    el.value = normalizeValue(supplierEmail);
    el.readOnly = true;
  }
  
  const supplierPhone = getValue('supplierPhone', 'TextJobToMobileNumber', 'mechanicPhone');
  if (supplierPhone) {
    const el = document.getElementById('supplierPhone');
    el.value = normalizeValue(supplierPhone);
    el.readOnly = true;
  }
  
  // Description
  const notes = getValue('description', 'JobNotes', 'jobNotes', 'notes');
  if (notes) {
    document.getElementById('description').value = normalizeValue(notes);
  }
  
  // Bank Account
  const bank = getValue('bankAccount', 'Bank');
  if (bank && typeof bank === 'string') {
    const parts = bank.split('-');
    if (parts.length === 4) {
      document.getElementById('bank1').value = parts[0];
      document.getElementById('bank2').value = parts[1];
      document.getElementById('bank3').value = parts[2];
      document.getElementById('bank4').value = parts[3];
    }
  }
  
  console.log('‚úÖ Form populated from SharePoint data');
}

// ============================================
// CONTACT FORM HANDLER
// ============================================
function setupContactForm() {
  const form = document.getElementById('contactForm');
  const submitBtn = document.getElementById('contactSubmitBtn');
  const alertSuccess = document.getElementById('contactAlertSuccess');
  const alertError = document.getElementById('contactAlertError');
  
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    alertSuccess.style.display = 'none';
    alertError.style.display = 'none';
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner"></span> Sending...';
    
    try {
      const payload = {
        formType: 'supplier_upload_request',
        formVersion: '1.0',
        submittedAt: new Date().toISOString(),
        sessionId: getOrCreateSessionId(),
        
        // Form fields
        name: document.getElementById('contactName').value.trim(),
        email: document.getElementById('contactEmail').value.trim(),
        phone: document.getElementById('contactPhone').value.trim(),
        company: document.getElementById('contactCompany').value.trim(),
        subject: document.getElementById('contactSubject').value,
        message: document.getElementById('contactMessage').value.trim(),
        
        // Fields array for dynamic email
        fields: [
          { name: 'Name', value: document.getElementById('contactName').value.trim() },
          { name: 'Email', value: document.getElementById('contactEmail').value.trim() },
          { name: 'Phone', value: document.getElementById('contactPhone').value.trim() || 'Not provided' },
          { name: 'Company', value: document.getElementById('contactCompany').value.trim() || 'Not provided' },
          { name: 'Subject', value: document.getElementById('contactSubject').value },
          { name: 'Message', value: document.getElementById('contactMessage').value.trim() }
        ],
        
        // Tracking
        referrer: document.referrer,
        userAgent: navigator.userAgent,
        timestamp: new Date().toISOString()
      };
      
      // Internal tracking
      if (window.unifiedTracking?.sendTrackingData) {
        window.unifiedTracking.sendTrackingData('contact_form_submit', payload);
      }
      
      const response = await fetch(CONFIG.CONTACT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if (response.ok) {
        alertSuccess.style.display = 'block';
        form.reset();
        
        if (window.unifiedTracking?.sendTrackingData) {
          window.unifiedTracking.sendTrackingData('contact_form_success', { formType: 'supplier_upload_request' });
        }
      } else {
        throw new Error('Server returned ' + response.status);
      }
    } catch (error) {
      console.error('Contact form error:', error);
      alertError.style.display = 'block';
      
      if (window.unifiedTracking?.sendTrackingData) {
        window.unifiedTracking.sendTrackingData('contact_form_error', { error: error.message });
      }
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'üìß Send Request';
    }
  });
}

// ============================================
// INVOICE FORM HANDLER
// ============================================
function setupInvoiceForm() {
  const form = document.getElementById('invoiceForm');
  const submitBtn = document.getElementById('invoiceSubmitBtn');
  const alertSuccess = document.getElementById('invoiceAlertSuccess');
  const alertError = document.getElementById('invoiceAlertError');
  const errorText = document.getElementById('invoiceErrorText');
  const successModal = document.getElementById('successModal');
  
  // Bank field auto-advance
  const bankFields = ['bank1', 'bank2', 'bank3', 'bank4'];
  bankFields.forEach((id, i) => {
    document.getElementById(id).addEventListener('input', function() {
      this.value = this.value.replace(/\D/g, '');
      if (this.value.length >= this.maxLength && i < bankFields.length - 1) {
        document.getElementById(bankFields[i + 1]).focus();
      }
    });
  });
  
  // Rego uppercase
  document.getElementById('rego').addEventListener('input', function() {
    this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
  });
  
  // Capture tracking data
  captureTrackingData();
  
  // Submission protection
  let isSubmitting = false;
  
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (isSubmitting) return;
    isSubmitting = true;
    
    const submissionId = `sub_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    alertSuccess.style.display = 'none';
    alertError.style.display = 'none';
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner"></span> Uploading...';
    
    try {
      // Get invoice inputs
      const invoiceFile = document.getElementById('invoiceFile');
      const invoiceLink = document.getElementById('invoiceLink').value.trim();
      const hasFile = invoiceFile.files.length > 0;
      const hasLink = invoiceLink !== '';
      
      // Must have at least one
      if (!hasFile && !hasLink) {
        throw new Error('Please provide an invoice link or upload a file');
      }
      
      // Collect form values
      const bankAccount = bankFields.map(id => document.getElementById(id).value).join('-');
      const rego = document.getElementById('rego').value.trim();
      const supplierName = document.getElementById('supplierName').value.trim();
      const supplierEmail = document.getElementById('supplierEmail').value.trim();
      const supplierPhone = document.getElementById('supplierPhone').value.trim();
      const amount = parseFloat(document.getElementById('amount').value) || 0;
      const litresExtracted = parseFloat(document.getElementById('litresExtracted').value) || 0;
      const litresIntroduced = parseFloat(document.getElementById('litresIntroduced').value) || 0;
      const description = document.getElementById('description').value.trim();
      
      // Build payload - always include all fields to prevent null errors in Power Automate
      const payload = {
        formType: 'fuel_extraction_job',
        formVersion: '2.1',
        submissionId: submissionId,
        submittedAt: new Date().toISOString(),
        
        // Flat fields for Power Automate processing
        rego: rego || '',
        supplierName: supplierName || '',
        supplierEmail: supplierEmail || '',
        supplierPhone: supplierPhone || '',
        amount: amount,
        bankAccount: bankAccount || '',
        litresExtracted: litresExtracted,
        litresIntroduced: litresIntroduced,
        description: description || '',
        
        // Invoice - always include both fields (empty string if not provided)
        invoiceLink: hasLink ? invoiceLink : '',
        invoiceFileName: '',
        invoiceFileType: '',
        invoiceFileSize: 0,
        invoiceFileBase64: '',
        
        // Fields array for dynamic email builder
        fields: [
          { name: 'Rego', value: rego || '' },
          { name: 'Supplier Name', value: supplierName || '' },
          { name: 'Supplier Email', value: supplierEmail || '' },
          { name: 'Supplier Phone', value: supplierPhone || 'Not provided' },
          { name: 'Amount', value: '$' + amount.toFixed(2) },
          { name: 'Bank Account', value: bankAccount || '' },
          { name: 'Litres Extracted', value: litresExtracted + ' L' },
          { name: 'Litres Introduced', value: litresIntroduced + ' L' },
          { name: 'Description', value: description || 'No description provided' }
        ],
        
        // Tracking data - always include with defaults
        bookingId: document.getElementById('bookingId').value || '',
        sessionId: document.getElementById('sessionId').value || '',
        timestamp: document.getElementById('timestamp').value || new Date().toISOString(),
        timezone: document.getElementById('timezone').value || '',
        userAgent: document.getElementById('userAgent').value || '',
        referrer: document.getElementById('referrer').value || '',
        screenResolution: document.getElementById('screenResolution').value || '',
        language: document.getElementById('language').value || '',
        platform: document.getElementById('platform').value || ''
      };
      
      // Add invoice link to fields if provided
      if (hasLink) {
        payload.fields.push({ name: 'Invoice Link', value: invoiceLink });
      }
      
      // Handle file upload if provided (and no link - link takes priority)
      if (hasFile && !hasLink) {
        const file = invoiceFile.files[0];
        
        // Validate file size (10MB)
        if (file.size > 10 * 1024 * 1024) {
          throw new Error('File size exceeds 10MB limit');
        }
        
        payload.invoiceFileName = file.name;
        payload.invoiceFileType = file.type;
        payload.invoiceFileSize = file.size;
        payload.invoiceFileBase64 = await fileToBase64(file);
      }
      
      // Internal tracking - submission attempt
      if (window.unifiedTracking?.sendTrackingData) {
        window.unifiedTracking.sendTrackingData('invoice_submit_attempt', {
          formType: 'fuel_extraction_job',
          amount: amount,
          submissionId: submissionId,
          hasLink: hasLink,
          hasFile: hasFile
        });
      }
      
      // Submit to Power Automate
      const response = await fetch(CONFIG.INVOICE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if (response.ok) {
        // Success
        submitBtn.disabled = true;
        submitBtn.textContent = '‚úì Submitted Successfully';
        successModal.classList.add('show');
        
        // Internal tracking - success
        if (window.unifiedTracking?.sendTrackingData) {
          window.unifiedTracking.sendTrackingData('invoice_submit_success', {
            formType: 'fuel_extraction_job',
            amount: amount,
            submissionId: submissionId
          });
        }
        
        // Redirect after 8 seconds
        setTimeout(() => { window.location.href = '/'; }, 8000);
        
      } else {
        throw new Error('Server returned ' + response.status);
      }
      
    } catch (error) {
      console.error('Invoice submission error:', error);
      errorText.textContent = error.message || 'Something went wrong. Please try again.';
      alertError.style.display = 'block';
      isSubmitting = false;
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'üì§ Submit Invoice for Payment';
      
      // Internal tracking - error
      if (window.unifiedTracking?.sendTrackingData) {
        window.unifiedTracking.sendTrackingData('invoice_submit_error', { error: error.message });
      }
    }
  });
  
  // Modal close
  document.getElementById('modalCloseBtn').addEventListener('click', () => {
    window.location.href = '/';
  });
}

// ============================================
// PAGE INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', async function() {
  const urlParams = new URLSearchParams(window.location.search);
  const encodedData = urlParams.get('d');
  
  // Track page view
  if (window.unifiedTracking?.trackEvent) {
    window.unifiedTracking.trackEvent('page_view', {
      page: 'supplier-upload',
      hasBookingId: !!encodedData
    });
  }
  
  // Handle "submit a request here" link click - show contact form
  document.getElementById('showContactLink')?.addEventListener('click', function(e) {
    e.preventDefault();
    document.getElementById('contactSection').classList.remove('hidden');
    document.getElementById('contactSection').scrollIntoView({ behavior: 'smooth' });
    setupContactForm();
  });
  
  // STATE 1: No ?d= parameter ‚Üí Contact Form
  if (!encodedData) {
    document.getElementById('contactSection').classList.remove('hidden');
    setupContactForm();
    return;
  }
  
  // STATE 2: Has ?d= parameter ‚Üí Invoice Upload Form
  document.getElementById('invoiceSection').classList.remove('hidden');
  document.getElementById('invoiceAlertLoading').style.display = 'block';
  
  // Decode booking ID from base64
  const bookingId = decodeBase64(encodedData);
  
  if (bookingId) {
    document.getElementById('bookingId').value = bookingId;
    
    // Fetch data from SharePoint and populate form
    bookingData = await fetchBookingData(bookingId);
    if (bookingData) {
      populateInvoiceForm(bookingData);
    }
  }
  
  document.getElementById('invoiceAlertLoading').style.display = 'none';
  setupInvoiceForm();
});
</script>

</body>
</html>
