<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Release Payment Confirmed | Eek Mechanical</title>
  <meta name="description" content="Release payment confirmed! We're now processing payment to the contractor so you can collect your vehicle." />
  <meta name="robots" content="noindex, nofollow" />
  <meta property="og:title" content="Release Payment Confirmed | Eek Mechanical" />
  <meta property="og:description" content="Release payment confirmed! Your vehicle will be ready for collection soon." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.eek.nz/thanks/release" />
  <meta property="og:image" content="https://www.eek.nz/sweet-ride.png" />

  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com https://www.redditstatic.com https://googleads.g.doubleclick.net https://static.cloudflareinsights.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://www.google-analytics.com https://www.redditstatic.com https://pixel-config.reddit.com https://conversions-config.reddit.com https://www.googletagmanager.com https://googleads.g.doubleclick.net https://www.google.com https://www.googleadservices.com https://www.google.hn https://prod-22.australiasoutheast.logic.azure.com https://prod-26.australiasoutheast.logic.azure.com https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com https://static.cloudflareinsights.com; frame-src 'self' https://td.doubleclick.net https://www.googletagmanager.com;">
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">

  <script>
    !function(w,d){if(!w.rdt){var p=w.rdt=function(){p.sendEvent?p.sendEvent.apply(p,arguments):p.callQueue.push(arguments)};p.callQueue=[];var t=d.createElement("script");t.src="https://www.redditstatic.com/ads/pixel.js",t.async=!0;var s=d.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}}
    (window,document);
    rdt('init', 'a2_hf16791nsdhx');
    rdt('track', 'PageVisit');
  </script>

  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17084465163"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'AW-17084465163');
    gtag('config', 'G-DQNKF1YLWR');
  </script>

  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f5f5f5 0%, #e0f2fe 100%);
      margin: 0; padding: 0; color: #333; text-align: center;
      min-height: 100vh; display: flex; flex-direction: column;
    }
    .container { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
    .success-card { background: white; padding: 50px; border-radius: 20px; box-shadow: 0 12px 40px rgba(0,0,0,0.15); max-width: 700px; width: 100%; margin: 20px; position: relative; overflow: hidden; }
    .success-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 8px; background: linear-gradient(90deg, #0ea5e9, #06b6d4, #14b8a6); }
    .success-card::after { content: '‚ú®'; position: absolute; top: 20px; right: 20px; font-size: 2em; opacity: 0.3; animation: sparkle 2s ease-in-out infinite; }
    @keyframes sparkle { 0%, 100% { opacity: 0.3; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.1); } }
    .success-icon { font-size: 4em; color: #0ea5e9; margin-bottom: 20px; animation: bounce 1s ease-in-out; }
    @keyframes bounce { 0%,20%,50%,80%,100%{transform:translateY(0)} 40%{transform:translateY(-20px)} 60%{transform:translateY(-10px)} }
    h1 { color: #0ea5e9; font-size: 2.5em; margin: 0 0 10px 0; font-weight: 700; }
    .subtitle { font-size: 1.3em; color: #666; margin-bottom: 30px; font-weight: 500; }
    .booking-details { background: #f0f9ff; padding: 25px; border-radius: 15px; margin: 20px 0; border: 2px solid #0ea5e9; text-align: left; }
    .booking-details h3 { color: #0369a1; margin-bottom: 15px; font-size: 1.3em; text-align: center; }
    .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e0f2fe; align-items: flex-start; }
    .detail-row:last-child { border-bottom: none; }
    .detail-label { font-weight: 600; color: #64748b; flex-shrink: 0; min-width: 120px; }
    .detail-value { color: #0f172a; text-align: right; flex: 1; word-break: break-word; }
    .next-steps { background: #f8f9fa; padding: 30px; border-radius: 15px; margin: 30px 0; border-left: 5px solid #0ea5e9; }
    .next-steps h2 { color: #0ea5e9; font-size: 1.5em; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .steps-list { text-align: left; margin: 0; padding: 0; list-style: none; }
    .steps-list li { padding: 12px 0; font-size: 1.1em; display: flex; align-items: flex-start; gap: 12px; }
    .step-number { background: #0ea5e9; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9em; font-weight: bold; flex-shrink: 0; margin-top: 2px; }
    .contact-info { background: #e3f2fd; padding: 25px; border-radius: 15px; margin: 30px 0; border: 2px solid #2196f3; }
    .contact-info h3 { color: #1976d2; margin-bottom: 15px; font-size: 1.3em; }
    .contact-buttons { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
    .btn { display: inline-block; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 1em; transition: all 0.3s ease; border: none; cursor: pointer; }
    .btn-primary { background: #0ea5e9; color: white; }
    .btn-primary:hover { background: #0284c7; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(14,165,233,0.3); }
    .warning-box { background: #fef3c7; padding: 20px; border-radius: 12px; margin: 20px 0; border: 2px solid #fbbf24; text-align: left; }
    .warning-box h4 { color: #92400e; margin: 0 0 10px 0; }
    .warning-box ul { margin: 0; padding-left: 20px; color: #92400e; }
    .warning-box li { margin: 8px 0; }
    .estimated-time { background: linear-gradient(135deg, #e0f2fe, #bae6fd); padding: 20px; border-radius: 12px; margin: 20px 0; border: 2px solid #0ea5e9; }
    .estimated-time .time-display { font-size: 2em; font-weight: bold; color: #0369a1; margin: 10px 0; }
    .additional-services { background: #f0f9ff; padding: 25px; border-radius: 15px; margin: 30px 0; border: 2px solid #0ea5e9; }
    .additional-services h3 { color: #0369a1; margin-bottom: 15px; font-size: 1.3em; }
    .service-links { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 15px; }
    .service-links a { background: white; padding: 12px 16px; border-radius: 8px; text-decoration: none; color: #0369a1; font-size: 0.9em; transition: all 0.3s ease; border: 1px solid #e0f2fe; }
    .service-links a:hover { background: #0ea5e9; color: white; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(14,165,233,0.2); }
    .footer-links { margin-top: 40px; padding-top: 20px; border-top: 1px solid #dee2e6; }
    .footer-links a { color: #6c757d; text-decoration: none; margin: 0 15px; font-size: 0.9em; }
    .footer-links a:hover { color: #0ea5e9; text-decoration: underline; }
    .loading-animation { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #0ea5e9; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .processing-indicator { display: none; }
    @media (max-width:768px){
      .success-card{padding:30px 20px;margin:10px}
      h1{font-size:2em}
      .contact-buttons{flex-direction:column;align-items:center}
      .btn{width:100%;max-width:250px}
      .service-links{grid-template-columns:1fr}
      .detail-row{flex-direction:column;gap:4px}
      .detail-label{min-width:unset}
      .detail-value{text-align:left}
    }
  </style>
</head>
<body>
  <div class="container">
    <header style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
      <img src="https://www.eek.nz/sweet-ride.png" alt="Sweet! - Eek Mechanical Success" style="max-width: 300px; height: auto; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);" />
      <h1 style="margin: 0.5em 0 0.2em; font-size: 2em; color: #0ea5e9;">Eek Mechanical</h1>
      <p style="font-size: 1.2em; color: #666; margin-bottom: 0;">NZ-Wide Mobile Mechanics</p>
    </header>

    <div class="success-card" id="successCard">
      <div class="success-icon" id="successIcon">üí≥‚úÖ</div>
      <h1 id="mainTitle">Release Payment Received!</h1>
      <p class="subtitle" id="mainSubtitle">Thank you ‚Äî we're now processing your vehicle release</p>

      <div class="processing-indicator" id="processingIndicator"></div>

      <div class="booking-details" id="bookingDetails">
        <h3>üìã Payment Details</h3>
        <div id="detailsContent"></div>
      </div>

      <div id="releaseSection">
        <div class="estimated-time">
          <h3>üöó Vehicle Release Status</h3>
          <div class="time-display">Processing<div class="loading-animation"></div></div>
          <p id="serviceTypeText">We're now paying the contractor so you can collect your vehicle</p>
        </div>

        <div class="next-steps">
          <h2>üìã What Happens Next</h2>
          <ol class="steps-list">
            <li><span class="step-number">‚úì</span><span>Payment received ‚Äî your release payment has been confirmed</span></li>
            <li><span class="step-number">2</span><span>We're now processing payment to the workshop/contractor</span></li>
            <li><span class="step-number">3</span><span>You'll receive an SMS & email once payment clears</span></li>
            <li><span class="step-number">4</span><span>Head to the workshop to collect your vehicle</span></li>
          </ol>
        </div>

        <div class="warning-box">
          <h4>‚ö†Ô∏è Important ‚Äî Please Read</h4>
          <ul>
            <li><strong>Do not go to collect your vehicle yet</strong> ‚Äî the workshop cannot release it until they receive payment from us</li>
            <li>Contractor payment typically processes within <strong>1-2 business hours</strong></li>
            <li>You will receive an <strong>SMS and email</strong> confirming when your vehicle is ready</li>
            <li>If you haven't heard from us within 4 hours during business hours, please call</li>
          </ul>
        </div>

        <div class="contact-info">
          <h3>üìû Questions About Your Vehicle Release?</h3>
          <p>If you need to check on your vehicle release status or have any questions</p>
          <div class="contact-buttons">
            <a href="tel:0800769000" class="btn btn-primary" onclick="trackCall('release_page_call')">üìû Call 0800 769 000</a>
          </div>
        </div>
      </div>

      <div class="additional-services">
        <h3>üõ†Ô∏è Need Additional Help?</h3>
        <p>Access our support options</p>
        <div class="service-links">
          <a href="https://www.eek.nz/customer-escalation" data-track="customer_support" onclick="trackInteraction(this)">üìù Customer Support</a>
          <a href="https://www.eek.nz/review-form" data-track="leave_review" onclick="trackInteraction(this)">‚≠ê Leave a Review</a>
          <a href="https://www.eek.nz/insurance-form" data-track="insurance_claims" onclick="trackInteraction(this)">üõ°Ô∏è Insurance Claims</a>
          <a href="https://www.eek.nz/more-options" data-track="more_services" onclick="trackInteraction(this)">üìã More Services</a>
        </div>
      </div>

    </div>
  </div>

  <script>
    console.log('üöÄ === RELEASE PAYMENT THANKS PAGE INITIALIZED === üöÄ');

    const RELEASE_PAYMENT_WEBHOOK_URL = 'https://default61ffc6bcd9ce458b8120d32187c377.0d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4c7d9551c5db4b678a54c799e09a4e0b/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ojmWoeVxo660rE1DN_WaafPN8FuMKJ38IXIscYS5efM';

    let releaseData = {};

    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        rego: params.get('rego') || '',
        amount: params.get('amount') || '',
        key: params.get('key') || '',
        name: params.get('name') || '',
        email: params.get('email') || '',
        phone: params.get('phone') || '',
        token: params.get('token') || ''
      };
    }

    function buildUniqueKey(rego) {
      if (!rego) return '';
      return rego.toUpperCase().replace(/\s/g, '') + '|Release Payment';
    }

    function displayBookingDetails(data) {
      const content = document.getElementById('detailsContent');
      const rows = [];

      if (data.rego) {
        rows.push(`<div class="detail-row"><span class="detail-label">Job Reference:</span><span class="detail-value">${data.rego}</span></div>`);
      }
      if (data.name) {
        rows.push(`<div class="detail-row"><span class="detail-label">Name:</span><span class="detail-value">${data.name}</span></div>`);
      }
      if (data.amount) {
        rows.push(`<div class="detail-row"><span class="detail-label">Release Amount:</span><span class="detail-value">$${parseFloat(data.amount).toFixed(2)}</span></div>`);
      }
      rows.push(`<div class="detail-row"><span class="detail-label">Payment Type:</span><span class="detail-value">Release Payment</span></div>`);
      rows.push(`<div class="detail-row"><span class="detail-label">Confirmed:</span><span class="detail-value">${new Date().toLocaleString('en-NZ')}</span></div>`);

      content.innerHTML = rows.length ? rows.join('') : '<p style="text-align:center;color:#64748b;">Details in your confirmation email</p>';
    }

    function showIndicator(type, message, duration = 5000) {
      const indicator = document.getElementById('processingIndicator');
      if (!indicator) return;
      
      const styles = {
        success: { background: '#d4edda', color: '#155724', border: '2px solid #c3e6cb' },
        error: { background: '#f8d7da', color: '#721c24', border: '2px solid #f5c6cb' },
        warning: { background: '#fff3cd', color: '#856404', border: '2px solid #ffeaa7' },
        info: { background: '#d1ecf1', color: '#0c5460', border: '2px solid #bee5eb' },
        loading: { background: '#e7f3ff', color: '#004085', border: '2px solid #b8daff' }
      };
      
      const style = styles[type] || styles.info;
      
      indicator.style.display = 'block';
      indicator.style.background = style.background;
      indicator.style.color = style.color;
      indicator.style.border = style.border;
      indicator.style.padding = '15px 20px';
      indicator.style.borderRadius = '8px';
      indicator.style.marginTop = '20px';
      indicator.textContent = message;
      
      if (duration > 0) {
        setTimeout(() => { indicator.style.display = 'none'; }, duration);
      }
    }

    function hasBeenSubmitted(key) {
      try {
        const storageKey = `eek_release_paid:${key}`;
        const stored = localStorage.getItem(storageKey);
        if (!stored) return false;
        
        const record = JSON.parse(stored);
        const hoursSince = (new Date() - new Date(record.timestamp)) / (1000 * 60 * 60);
        
        if (hoursSince > 24) {
          localStorage.removeItem(storageKey);
          return false;
        }
        
        console.log(`üõë Release payment ${key} already submitted at ${record.timestamp}`);
        return true;
      } catch (err) {
        return false;
      }
    }

    function markAsSubmitted(key) {
      try {
        const storageKey = `eek_release_paid:${key}`;
        localStorage.setItem(storageKey, JSON.stringify({
          status: 'sent',
          timestamp: new Date().toISOString()
        }));
        console.log(`‚úÖ Release payment ${key} marked as submitted`);
      } catch (err) {
        console.error('Error marking submission:', err);
      }
    }

    async function sendReleasePaymentConfirmation(data) {
      const uniqueKey = data.key || buildUniqueKey(data.rego);
      
      if (!uniqueKey) {
        console.log('üõë Missing rego/key ‚Äî cannot send to Power Automate');
        showIndicator('error', '‚ö†Ô∏è Missing payment reference');
        return { success: false, reason: 'missing_key' };
      }

      const forceResend = new URLSearchParams(window.location.search).get('resend') === '1';
      if (!forceResend && hasBeenSubmitted(uniqueKey)) {
        showIndicator('info', '‚úì This release payment was already confirmed', 8000);
        return { success: false, reason: 'already_submitted' };
      }

      // Convert amount from dollars to cents for Power Automate
      const amountInCents = Math.round(parseFloat(data.amount) * 100);

      const payload = {
        uniqueKey: uniqueKey,
        rego: data.rego.toUpperCase().replace(/\s/g, ''),
        amount: amountInCents,
        name: data.name,
        email: data.email,
        phone: data.phone,
        timestamp: new Date().toISOString(),
        eventType: 'release_payment_confirmed',
        paymentType: 'release'
      };

      console.log('üì§ Sending release payment to Power Automate:', payload);
      showIndicator('loading', '‚è≥ Confirming release payment...', 0);

      const maxRetries = 3;
      let lastError = null;

      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          console.log(`üì§ Attempt ${attempt}/${maxRetries}`);
          
          const res = await fetch(RELEASE_PAYMENT_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (res.ok) {
            console.log(`‚úÖ Release payment confirmed on attempt ${attempt}`);
            markAsSubmitted(uniqueKey);
            showIndicator('success', '‚úÖ Release payment confirmed! Processing contractor payment...', 5000);
            return { success: true };
          } else {
            lastError = `HTTP ${res.status}`;
            console.error(`‚ùå Attempt ${attempt} failed:`, lastError);
            
            if (res.status >= 400 && res.status < 500) break;
            
            if (attempt < maxRetries) {
              await new Promise(r => setTimeout(r, 1000 * Math.pow(2, attempt - 1)));
            }
          }
        } catch (err) {
          lastError = err.message;
          console.error(`‚ùå Attempt ${attempt} error:`, err);
          
          if (attempt < maxRetries) {
            await new Promise(r => setTimeout(r, 1000 * Math.pow(2, attempt - 1)));
          }
        }
      }

      console.error('‚ùå All attempts failed:', lastError);
      showIndicator('error', '‚ö†Ô∏è Unable to confirm automatically. Please call 0800 769 000.', 15000);
      return { success: false, error: lastError };
    }

    function trackCall(source) {
      if (typeof gtag !== 'undefined') {
        gtag('event', 'phone_call', { event_category: 'Contact', event_label: source, value: 1 });
      }
    }

    function trackInteraction(element) {
      const action = element.dataset.track;
      if (typeof gtag !== 'undefined') {
        gtag('event', action, { event_category: 'Release_Page_Interaction', event_label: element.textContent.trim() });
      }
    }

    function trackReleaseConversion(data) {
      const amount = parseFloat(data.amount) || 0;
      const transactionId = `release_${data.rego || Date.now()}`;
      
      if (typeof gtag !== 'undefined' && amount > 0) {
        gtag('event', 'conversion', {
          'send_to': 'AW-17084465163/VkFHCNfslMAbEIuAwdI_',
          'value': amount,
          'currency': 'NZD',
          'transaction_id': transactionId
        });
        
        gtag('event', 'purchase', {
          transaction_id: transactionId,
          value: amount,
          currency: 'NZD',
          items: [{ item_name: 'Release Payment', price: amount, quantity: 1, item_category: 'release_payment' }]
        });
        
        console.log('‚úÖ Release conversion tracked:', { amount, transactionId });
      }

      if (typeof rdt !== 'undefined' && amount > 0) {
        rdt('track', 'Purchase', { customEventName: 'Release_Payment_Completed', currency: 'NZD', value: amount });
      }
    }

    window.addEventListener('load', async () => {
      console.log('üöÄ Release payment page loaded');
      
      releaseData = getUrlParams();
      console.log('üìã URL parameters:', releaseData);
      
      displayBookingDetails(releaseData);
      
      const result = await sendReleasePaymentConfirmation(releaseData);
      
      if (result.success || result.reason === 'already_submitted') {
        trackReleaseConversion(releaseData);
      }
    });

    window.releaseDebug = {
      getData: () => releaseData,
      clearSubmission: () => {
        const key = releaseData.key || buildUniqueKey(releaseData.rego);
        localStorage.removeItem(`eek_release_paid:${key}`);
        console.log('‚úÖ Submission record cleared');
      },
      resend: async () => {
        const result = await sendReleasePaymentConfirmation(releaseData);
        console.log('Result:', result);
      }
    };
    
    console.log('üí° Debug: window.releaseDebug.getData(), clearSubmission(), resend()');
  </script>
</body>
</html>
