concat('NEW | ', coalesce(triggerBody()?['visitorData']?['name'], triggerBody()?['name'], 'Customer'), ' | ', coalesce(triggerBody()?['visitorData']?['vehicleRego'], triggerBody()?['vehicleRego'], 'No Rego'), ' | ', coalesce(triggerBody()?['visitorData']?['serviceCode'], triggerBody()?['serviceCode'], 'Service'))

<!-- ========================================== -->
<!-- SUBJECT LINE ENDS - HTML BODY BEGINS -->
<!-- ========================================== -->

<table cellpadding="0" cellspacing="0" border="0" style="max-width: 600px; margin: 0 auto; background-color: #ffffff; width: 100%;">
<tbody>
<tr>
<td style="display: none; max-height: 0px; overflow: hidden; opacity: 0; visibility: hidden; mso-hide: all;">
@{if(and(not(empty(triggerBody()?['utm']?['campaign'])), not(equals(string(triggerBody()?['utm']?['campaign']), ''))), concat('Campaign: ', triggerBody()?['utm']?['campaign'], ' | '), '')}
@{if(and(not(empty(triggerBody()?['utm']?['term'])), not(equals(string(triggerBody()?['utm']?['term']), ''))), concat('Keyword: ', triggerBody()?['utm']?['term'], ' | '), '')}
@{if(and(not(empty(triggerBody()?['device']?['platform'])), not(equals(string(triggerBody()?['device']?['platform']), ''))), concat(triggerBody()?['device']?['platform'], ' | '), '')}
@{if(and(not(empty(triggerBody()?['matchType'])), not(equals(string(triggerBody()?['matchType']), ''))), concat('Match: ', triggerBody()?['matchType'], ' | '), '')}
@{if(and(not(empty(triggerBody()?['visitorData']?['name'])), not(equals(string(triggerBody()?['visitorData']?['name']), ''))), concat(triggerBody()?['visitorData']?['name'], ' | '), if(and(not(empty(triggerBody()?['name'])), not(equals(string(triggerBody()?['name']), ''))), concat(triggerBody()?['name'], ' | '), ''))}
@{if(and(not(empty(triggerBody()?['visitorData']?['phone'])), not(equals(string(triggerBody()?['visitorData']?['phone']), ''))), triggerBody()?['visitorData']?['phone'], if(and(not(empty(triggerBody()?['phone'])), not(equals(string(triggerBody()?['phone']), ''))), triggerBody()?['phone'], ''))}
@{if(and(not(empty(triggerBody()?['visitorData']?['email'])), not(equals(string(triggerBody()?['visitorData']?['email']), ''))), concat(' | Email: ', triggerBody()?['visitorData']?['email']), if(and(not(empty(triggerBody()?['email'])), not(equals(string(triggerBody()?['email']), ''))), concat(' | Email: ', triggerBody()?['email']), ''))}
@{if(and(not(empty(triggerBody()?['visitorData']?['vehicleRego'])), not(equals(string(triggerBody()?['visitorData']?['vehicleRego']), ''))), concat(' | Rego: ', triggerBody()?['visitorData']?['vehicleRego']), if(and(not(empty(triggerBody()?['vehicleRego'])), not(equals(string(triggerBody()?['vehicleRego']), ''))), concat(' | Rego: ', triggerBody()?['vehicleRego']), ''))}
@{if(and(not(empty(triggerBody()?['visitorData']?['service'])), not(equals(string(triggerBody()?['visitorData']?['service']), ''))), concat(' | Service: ', triggerBody()?['visitorData']?['service']), if(and(not(empty(triggerBody()?['serviceTitle'])), not(equals(string(triggerBody()?['serviceTitle']), ''))), concat(' | Service: ', triggerBody()?['serviceTitle']), ''))}
@{if(and(not(empty(triggerBody()?['visitorData']?['location'])), not(equals(string(triggerBody()?['visitorData']?['location']), ''))), concat(' | Location: ', triggerBody()?['visitorData']?['location']), if(and(not(empty(triggerBody()?['location'])), not(equals(string(triggerBody()?['location']), ''))), concat(' | Location: ', triggerBody()?['location']), if(and(not(empty(triggerBody()?['trackingData']?['location']?['city'])), not(equals(string(triggerBody()?['trackingData']?['location']?['city']), ''))), concat(' | Location: ', triggerBody()?['trackingData']?['location']?['city']), '')))}
@{if(and(not(empty(triggerBody()?['journeyData']?['callAttemptId'])), not(equals(string(triggerBody()?['journeyData']?['callAttemptId']), ''))), concat(' | Call ID: ', triggerBody()?['journeyData']?['callAttemptId']), '')}
@{if(and(not(empty(triggerBody()?['eventAction'])), not(equals(string(triggerBody()?['eventAction']), ''))), concat(' | Action: ', triggerBody()?['eventAction']), '')}
@{if(and(not(empty(triggerBody()?['gclid'])), not(equals(string(triggerBody()?['gclid']), ''))), concat(' | GCLID: ', triggerBody()?['gclid']), '')}
@{if(and(not(empty(triggerBody()?['sessionId'])), not(equals(string(triggerBody()?['sessionId']), ''))), concat(' | Session: ', substring(triggerBody()?['sessionId'], 0, 8), '...'), '')}
</td>
</tr>
<tr>
<td style="padding: 15px; text-align: center; background-color: #ff5500; color: white;">
<h1 style="margin: 0 0 8px 0; font-size: 20px;">Eek Mobile Mechanical</h1>
<h2 style="margin: 0 0 5px 0; font-size: 16px; font-weight: normal;">@{coalesce(triggerBody()?['serviceTitle'], triggerBody()?['eventType'], 'Notification')}</h2>
<div style="font-size: 14px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">@{coalesce(triggerBody()?['bookingStatus'], triggerBody()?['eventType'], 'NEW')}</div>
</td>
</tr>
<tr>
<td style="padding: 12px 15px; background-color: #e3f2fd; border-left: 4px solid #ff5500;">
<div style="margin-bottom: 6px; font-size: 13px;"><strong>Session:</strong> @{coalesce(triggerBody()?['sessionId'], 'Unknown')}</div>
<div style="margin-bottom: 6px; font-size: 13px;"><strong>GCLID:</strong> @{coalesce(triggerBody()?['gclid'], triggerBody()?['pageSource']?['clickIds']?['gclid'], 'None')}</div>
<div style="margin-bottom: 6px; font-size: 13px;"><strong>GCLID State:</strong> <span style="padding: 2px 6px; background-color: @{if(equals(coalesce(triggerBody()?['gclidState'], ''), 'Active'), '#28a745', '#6c757d')}; color: white; border-radius: 3px; font-size: 11px;">@{coalesce(triggerBody()?['gclidState'], 'Unknown')}</span></div>
<div style="margin-bottom: 6px; font-size: 13px;"><strong>Page Source:</strong> @{coalesce(triggerBody()?['pageSource']?['type'], 'Direct')} - @{coalesce(triggerBody()?['pageSource']?['detail'], 'Direct visit')}</div>
<div style="margin-bottom: 6px; font-size: 13px;"><strong>Event Type:</strong> @{coalesce(triggerBody()?['eventType'], 'Unknown')}</div>
<div style="margin-bottom: 6px; font-size: 13px;"><strong>Event Action:</strong> @{coalesce(triggerBody()?['eventAction'], 'Unknown')}</div>
<div style="font-size: 13px;"><strong>Time:</strong> @{formatDateTime(coalesce(triggerBody()?['timestamp'], utcNow()), 'dd/MM/yyyy HH:mm')}</div>
</td>
</tr>

<!-- Call Correlation Section -->
<tr>
<td style="padding: 0 15px 15px 15px;">
<table cellpadding="0" cellspacing="0" border="0" style="background-color: #fff8e1; border: 1px solid #ffcc02; padding: 12px; width: 100%;">
<tbody>
<tr>
<td style="font-size: 15px; font-weight: bold; color: #333; padding-bottom: 8px; border-bottom: 2px solid #ffcc02;">📞 Call Correlation</td>
</tr>
<tr>
<td style="padding: 8px 0;">
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Call Attempt ID:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['journeyData']?['callAttemptId'], triggerBody()?['callAttemptId'], '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Call Timestamp:</strong> <span style="color: #333;">@{if(and(not(empty(triggerBody()?['journeyData']?['callTimestamp'])), not(equals(string(triggerBody()?['journeyData']?['callTimestamp']), ''))), formatDateTime(triggerBody()?['journeyData']?['callTimestamp'], 'dd/MM/yyyy HH:mm'), if(and(not(empty(triggerBody()?['callTimestamp'])), not(equals(string(triggerBody()?['callTimestamp']), ''))), formatDateTime(triggerBody()?['callTimestamp'], 'dd/MM/yyyy HH:mm'), '-'))}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Return Timestamp:</strong> <span style="color: #333;">@{if(and(not(empty(triggerBody()?['journeyData']?['returnTimestamp'])), not(equals(string(triggerBody()?['journeyData']?['returnTimestamp']), ''))), formatDateTime(triggerBody()?['journeyData']?['returnTimestamp'], 'dd/MM/yyyy HH:mm'), '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Time Between Call &amp; Return:</strong> <span style="color: #333;">@{if(and(not(empty(triggerBody()?['journeyData']?['timeBetweenCallAndReturn'])), not(equals(triggerBody()?['journeyData']?['timeBetweenCallAndReturn'], 0))), concat(div(triggerBody()?['journeyData']?['timeBetweenCallAndReturn'], 60000), ' minutes'), '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Return Source:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['journeyData']?['source'], '-')}</span></div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>

<tr>
<td style="padding: 15px;">
<table cellpadding="0" cellspacing="0" border="0" style="background-color: #f8f9fa; padding: 12px; width: 100%;">
<tbody>
<tr>
<td style="font-size: 15px; font-weight: bold; color: #333; padding-bottom: 8px; border-bottom: 2px solid #e9ecef;">Details</td>
</tr>
<tr>
<td style="padding: 8px 0;">
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Name:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['visitorData']?['name'], triggerBody()?['name'], '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Phone:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['visitorData']?['phone'], triggerBody()?['phone'], '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Email:</strong> <span style="color: #333; word-break: break-all;">@{coalesce(triggerBody()?['visitorData']?['email'], triggerBody()?['email'], '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Location:</strong> <span style="color: #333;">@{if(and(not(empty(triggerBody()?['visitorData']?['location'])), not(equals(string(triggerBody()?['visitorData']?['location']), ''))), triggerBody()?['visitorData']?['location'], if(and(not(empty(triggerBody()?['location'])), not(equals(string(triggerBody()?['location']), ''))), triggerBody()?['location'], '-'))</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Rego:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['visitorData']?['vehicleRego'], triggerBody()?['vehicleRego'], triggerBody()?['rego'], '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Vehicle:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['visitorData']?['vehicleYear'], triggerBody()?['vehicleYear'], '')} @{coalesce(triggerBody()?['visitorData']?['vehicleMake'], triggerBody()?['vehicleMake'], triggerBody()?['make'], '')} @{coalesce(triggerBody()?['visitorData']?['vehicleModel'], triggerBody()?['vehicleModel'], triggerBody()?['model'], '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Service:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['visitorData']?['service'], triggerBody()?['serviceTitle'], triggerBody()?['service'], '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Service Code:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['visitorData']?['serviceCode'], triggerBody()?['serviceCode'], '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Price:</strong> <span style="color: #333;">@{if(and(not(empty(triggerBody()?['basePrice'])), not(equals(triggerBody()?['basePrice'], 0))), concat('$', triggerBody()?['basePrice']), if(and(not(empty(triggerBody()?['price'])), not(equals(triggerBody()?['price'], 0))), concat('$', triggerBody()?['price']), '-'))}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Battery Voltage:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['visitorData']?['batteryVoltage'], triggerBody()?['batteryVoltage'], triggerBody()?['selectedVoltage'], '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Vehicle Type:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['visitorData']?['vehicleType'], triggerBody()?['vehicleType'], '-')}</span></div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
<tr>
<td style="padding: 0 15px 15px 15px;">
<table cellpadding="0" cellspacing="0" border="0" style="background-color: #fff9c4; border: 1px solid #fff176; padding: 12px; width: 100%;">
<tbody>
<tr>
<td style="font-size: 15px; font-weight: bold; color: #333; padding-bottom: 8px; border-bottom: 2px solid #fff176;">📋 Booking Progress</td>
</tr>
<tr>
<td style="padding: 8px 0;">
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Current Step:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['currentStep'], '-')} of @{coalesce(triggerBody()?['totalSteps'], '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Progress:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['stepProgress'], '0')}%</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Terms Accepted:</strong> <span style="color: #333;">@{if(equals(coalesce(triggerBody()?['termsAccepted'], false), true), '✅ Yes', '❌ No')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Marketing Consent:</strong> <span style="color: #333;">@{if(equals(coalesce(triggerBody()?['marketingConsent'], false), true), '✅ Yes', '❌ No')}</span></div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
<tr>
<td style="padding: 0 15px 15px 15px;">
<table cellpadding="0" cellspacing="0" border="0" style="background-color: #f3e5f5; border: 1px solid #ce93d8; padding: 12px; width: 100%;">
<tbody>
<tr>
<td style="font-size: 15px; font-weight: bold; color: #333; padding-bottom: 8px; border-bottom: 2px solid #ce93d8;">📱 Device &amp; Engagement</td>
</tr>
<tr>
<td style="padding: 8px 0;">
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Screen Resolution:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['device']?['screenResolution'], '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Viewport Size:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['device']?['viewportSize'], '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Language:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['device']?['language'], '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Timezone:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['device']?['timezone'], '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Time on Page:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['engagement']?['timeOnPage'], '0')} seconds</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Scroll Depth:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['engagement']?['scrollDepth'], '0')}%</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Total Clicks:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['engagement']?['clicks'], '0')}</span></div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>

<!-- Visitor Journey Section -->
<tr>
<td style="padding: 0 15px 15px 15px;">
<table cellpadding="0" cellspacing="0" border="0" style="background-color: #e1f5fe; border: 1px solid #4fc3f7; padding: 12px; width: 100%;">
<tbody>
<tr>
<td style="font-size: 15px; font-weight: bold; color: #333; padding-bottom: 8px; border-bottom: 2px solid #4fc3f7;">🛣️ Visitor Journey</td>
</tr>
<tr>
<td style="padding: 8px 0;">
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Entry Page:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['userJourney']?['entryPage'], triggerBody()?['pageUrl'], '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Previous Page:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['userJourney']?['previousPage'], triggerBody()?['pageSource']?['referrer'], '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Total Pages:</strong> <span style="color: #333;">@{coalesce(string(triggerBody()?['userJourney']?['totalPages']), '1')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Session Duration:</strong> <span style="color: #333;">@{if(and(not(empty(triggerBody()?['userJourney']?['sessionDuration'])), not(equals(triggerBody()?['userJourney']?['sessionDuration'], 0))), concat(div(triggerBody()?['userJourney']?['sessionDuration'], 60000), ' minutes'), '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Journey Actions:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['eventAction'], '-')}</span></div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>

<tr>
<td style="padding: 0 15px 15px 15px;">
<table cellpadding="0" cellspacing="0" border="0" style="background-color: #e8f5e8; border: 1px solid #a5d6a7; padding: 12px; width: 100%;">
<tbody>
<tr>
<td style="font-size: 15px; font-weight: bold; color: #333; padding-bottom: 8px; border-bottom: 2px solid #a5d6a7;">📍 Location Details</td>
</tr>
<tr>
<td style="padding: 8px 0;">
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Country:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['trackingData']?['location']?['country'], '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Region:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['trackingData']?['location']?['region'], '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">City:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['trackingData']?['location']?['city'], '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Coordinates:</strong> <span style="color: #333;">@{if(and(not(empty(triggerBody()?['trackingData']?['location']?['coordinates']?['latitude'])), not(empty(triggerBody()?['trackingData']?['location']?['coordinates']?['longitude']))), concat('<a href="https://www.google.com/maps/place/', triggerBody()?['trackingData']?['location']?['coordinates']?['latitude'], ',', triggerBody()?['trackingData']?['location']?['coordinates']?['longitude'], '/@', triggerBody()?['trackingData']?['location']?['coordinates']?['latitude'], ',', triggerBody()?['trackingData']?['location']?['coordinates']?['longitude'], ',17z/data=!3m1!4b1!4m4!3m3!8m2!3d', triggerBody()?['trackingData']?['location']?['coordinates']?['latitude'], '!4d', triggerBody()?['trackingData']?['location']?['coordinates']?['longitude'], '?entry=ttu&g_ep=EgoyMDI1MTAxNC4wIKXMDSoASAFQAw%3D%3D" style="color: #007bff; text-decoration: none;">', triggerBody()?['trackingData']?['location']?['coordinates']?['latitude'], ', ', triggerBody()?['trackingData']?['location']?['coordinates']?['longitude'], '</a>'), '-')}</span></div>
<div style="padding: 4px 0; font-size: 13px;"><strong style="color: #555;">Accuracy:</strong> <span style="color: #333;">@{coalesce(triggerBody()?['trackingData']?['location']?['coordinates']?['accuracy'], '-')}</span></div>
</td>
</tr>
</tbody>
</table>
</td>
</tr>
<tr>
<td style="padding: 0 15px 15px 15px;">
<a href="tel:@{coalesce(triggerBody()?['visitorData']?['phone'], triggerBody()?['phone'], '0800769000')}" style="display: block; padding: 12px; margin: 5px 0; background-color: #28a745; color: white; text-decoration: none; font-weight: bold; font-size: 14px; border-radius: 5px; text-align: center;">📞 Call Customer</a>
<a href="mailto:@{coalesce(triggerBody()?['visitorData']?['email'], triggerBody()?['email'], 'no-reply@eek.nz')}" style="display: block; padding: 12px; margin: 5px 0; background-color: #17a2b8; color: white; text-decoration: none; font-weight: bold; font-size: 14px; border-radius: 5px; text-align: center;">✉️ Email Customer</a>
<a href="https://www.carjam.co.nz/car/?plate=@{coalesce(triggerBody()?['visitorData']?['vehicleRego'], triggerBody()?['vehicleRego'], 'UNKNOWN')}" style="display: block; padding: 12px; margin: 5px 0; background-color: #6c757d; color: white; text-decoration: none; font-weight: bold; font-size: 14px; border-radius: 5px; text-align: center;">🚗 CarJam Lookup</a>
</td>
</tr>
<tr>
<td style="background-color: #333; color: #fff; padding: 15px; text-align: center; font-size: 11px;">
<strong>Eek Mobile Mechanical</strong><br>@{formatDateTime(utcNow(), 'dd/MM/yyyy HH:mm')}
</td>
</tr>
</tbody>
</table>
