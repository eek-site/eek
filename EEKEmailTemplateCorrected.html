concat(
  'üÜï ', 
  coalesce(triggerBody()?['serviceCode'], triggerBody()?['trackingData']?['visitorData']?['serviceCode'], 'JOB'), 
  ' - ', 
  coalesce(triggerBody()?['name'], triggerBody()?['trackingData']?['visitorData']?['name']), 
  ' | ', 
  toUpper(replace(trim(coalesce(triggerBody()?['rego'], triggerBody()?['trackingData']?['visitorData']?['vehicleRego'])), ' ', '')), 
  ' | ', 
  coalesce(triggerBody()?['urgencyLevel'], triggerBody()?['trackingData']?['visitorData']?['urgencyLevel'], 'Standard')
)

<meta>
<title>Your Eek Mobile Mechanical Service - Payment Confirmed</title>

<!-- Preheader Text - Shows in email preview -->
<div style="display:none;max-height:0px;overflow:hidden;">
@{coalesce(triggerBody()?['name'], 'Customer')} - @{coalesce(triggerBody()?['serviceTitle'], 'Service')} confirmed for @{toUpper(replace(trim(coalesce(triggerBody()?['rego'], triggerBody()?['vehicleRego'], '')), ' ', ''))} at @{coalesce(triggerBody()?['location'], 'your location')} ‚Ä¢ $@{coalesce(triggerBody()?['price'], '0')} ‚Ä¢ @{coalesce(triggerBody()?['timeWindow'], triggerBody()?['urgencyLevel'], 'Standard')} ‚Ä¢ Payment Confirmed ‚úÖ
</div>

<!-- Main Container -->

<!-- Enhanced Tracking Information -->
@{if(not(equals(triggerBody()?['trackingData'], null)), concat('<table cellpadding="0" cellspacing="0" border="0" style="max-width: 600px; margin: 0 auto; background-color: #ffffff;"><tbody><tr><td style="padding: 0 20px 20px 20px;"><table cellpadding="0" cellspacing="0" border="0" style="background-color: #e8f5e8; border: 1px solid #a5d6a7; padding: 15px;"><tbody><tr><td style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 10px; border-bottom: 2px solid #a5d6a7; padding-bottom: 5px;">üéØ Traffic Source & Attribution</td></tr><tr><td style="padding: 8px 0;"><table cellpadding="0" cellspacing="0" border="0"><tbody><tr><td style="font-weight: bold; width: 140px; color: #555;">GCLID:</td><td style="color: #333;">', coalesce(triggerBody()?['trackingData']?['gclid'], 'None'), '</td></tr><tr><td style="font-weight: bold; width: 140px; color: #555;">GCLID State:</td><td style="color: #333;">', coalesce(triggerBody()?['trackingData']?['gclidState'], 'Unknown'), '</td></tr><tr><td style="font-weight: bold; width: 140px; color: #555;">Page Source:</td><td style="color: #333;">', coalesce(triggerBody()?['trackingData']?['pageSource']?['type'], 'Direct'), ' - ', coalesce(triggerBody()?['trackingData']?['pageSource']?['detail'], 'Direct visit'), '</td></tr><tr><td style="font-weight: bold; width: 140px; color: #555;">Campaign:</td><td style="color: #333;">', coalesce(triggerBody()?['trackingData']?['utm']?['campaign'], triggerBody()?['trackingData']?['pageSource']?['utm']?['campaign'], 'None'), '</td></tr><tr><td style="font-weight: bold; width: 140px; color: #555;">Keyword:</td><td style="color: #333;">', coalesce(triggerBody()?['trackingData']?['utm']?['term'], triggerBody()?['trackingData']?['pageSource']?['utm']?['term'], 'None'), '</td></tr><tr><td style="font-weight: bold; width: 140px; color: #555;">Device:</td><td style="color: #333;">', coalesce(triggerBody()?['trackingData']?['device']?['platform'], 'Unknown'), '</td></tr><tr><td style="font-weight: bold; width: 140px; color: #555;">Location:</td><td style="color: #333;">', coalesce(triggerBody()?['trackingData']?['location']?['city'], 'Unknown'), ', ', coalesce(triggerBody()?['trackingData']?['location']?['region'], 'Unknown'), '</td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table>'), '')}

<!-- Call Correlation -->
@{if(or(and(not(equals(triggerBody()?['trackingData']?['journeyData']?['callAttemptId'], null)), not(equals(triggerBody()?['trackingData']?['journeyData']?['callAttemptId'], ''))), and(not(equals(triggerBody()?['trackingData']?['journeyData']?['callTimestamp'], null)), not(equals(triggerBody()?['trackingData']?['journeyData']?['callTimestamp'], '')))), concat('<table cellpadding="0" cellspacing="0" border="0" style="max-width: 600px; margin: 0 auto; background-color: #ffffff;"><tbody><tr><td style="padding: 0 20px 20px 20px;"><table cellpadding="0" cellspacing="0" border="0" style="background-color: #fff8e1; border: 1px solid #ffcc02; padding: 15px;"><tbody><tr><td style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 10px; border-bottom: 2px solid #ffcc02; padding-bottom: 5px;">üìû Call Correlation</td></tr><tr><td style="padding: 8px 0;"><table cellpadding="0" cellspacing="0" border="0"><tbody>', if(and(not(equals(triggerBody()?['trackingData']?['journeyData']?['callAttemptId'], null)), not(equals(triggerBody()?['trackingData']?['journeyData']?['callAttemptId'], ''))), concat('<tr><td style="font-weight: bold; width: 140px; color: #555;">Call Attempt ID:</td><td style="color: #333;">', triggerBody()?['trackingData']?['journeyData']?['callAttemptId'], '</td></tr>'), ''), if(and(not(equals(triggerBody()?['trackingData']?['journeyData']?['callTimestamp'], null)), not(equals(triggerBody()?['trackingData']?['journeyData']?['callTimestamp'], ''))), concat('<tr><td style="font-weight: bold; width: 140px; color: #555;">Call Timestamp:</td><td style="color: #333;">', formatDateTime(triggerBody()?['trackingData']?['journeyData']?['callTimestamp'], 'dd/MM/yyyy HH:mm'), '</td></tr>'), ''), if(and(not(equals(triggerBody()?['trackingData']?['journeyData']?['timeBetweenCallAndReturn'], null)), not(equals(triggerBody()?['trackingData']?['journeyData']?['timeBetweenCallAndReturn'], 0))), concat('<tr><td style="font-weight: bold; width: 140px; color: #555;">Time Between Call & Return:</td><td style="color: #333;">', div(triggerBody()?['trackingData']?['journeyData']?['timeBetweenCallAndReturn'], 60000), ' minutes</td></tr>'), ''), '</tbody></table></td></tr></tbody></table></td></tr></tbody></table>'), '')}

<!-- Visitor Journey -->
@{if(not(equals(triggerBody()?['trackingData']?['userJourney'], null)), concat('<table cellpadding="0" cellspacing="0" border="0" style="max-width: 600px; margin: 0 auto; background-color: #ffffff;"><tbody><tr><td style="padding: 0 20px 20px 20px;"><table cellpadding="0" cellspacing="0" border="0" style="background-color: #e1f5fe; border: 1px solid #4fc3f7; padding: 15px;"><tbody><tr><td style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 10px; border-bottom: 2px solid #4fc3f7; padding-bottom: 5px;">üõ£Ô∏è Visitor Journey</td></tr><tr><td style="padding: 8px 0;"><table cellpadding="0" cellspacing="0" border="0"><tbody><tr><td style="font-weight: bold; width: 140px; color: #555;">Entry Page:</td><td style="color: #333;">', coalesce(triggerBody()?['trackingData']?['userJourney']?['entryPage'], 'Unknown'), '</td></tr><tr><td style="font-weight: bold; width: 140px; color: #555;">Previous Page:</td><td style="color: #333;">', coalesce(triggerBody()?['trackingData']?['userJourney']?['previousPage'], 'Unknown'), '</td></tr><tr><td style="font-weight: bold; width: 140px; color: #555;">Total Pages:</td><td style="color: #333;">', coalesce(string(triggerBody()?['trackingData']?['userJourney']?['totalPages']), '1'), '</td></tr><tr><td style="font-weight: bold; width: 140px; color: #555;">Session Duration:</td><td style="color: #333;">', if(and(not(equals(triggerBody()?['trackingData']?['userJourney']?['sessionDuration'], null)), not(equals(triggerBody()?['trackingData']?['userJourney']?['sessionDuration'], 0))), concat(div(triggerBody()?['trackingData']?['userJourney']?['sessionDuration'], 60000), ' minutes'), 'Unknown'), '</td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table>'), '')}

<!-- Inspection/Seller Details (conditional) - FIXED -->
@{if(or(contains(coalesce(triggerBody()?['service'], triggerBody()?['trackingData']?['visitorData']?['service']), 'inspection'), and(not(empty(coalesce(triggerBody()?['sellerName'], triggerBody()?['trackingData']?['visitorData']?['sellerName']))), not(empty(coalesce(triggerBody()?['sellerPhone'], triggerBody()?['trackingData']?['visitorData']?['sellerPhone']))))), 
    concat('<table cellpadding="0" cellspacing="0" border="0" style="max-width: 600px; margin: 0 auto; background-color: #ffffff;"><tbody><tr><td style="padding: 0 20px 20px 20px;"><table cellpadding="0" cellspacing="0" border="0" style="background-color: #e8f4f8; border: 1px solid #bee5eb; padding: 15px;"><tbody><tr><td style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 10px; border-bottom: 2px solid #bee5eb; padding-bottom: 5px;">Seller/Inspection Details</td></tr><tr><td style="padding: 8px 0;"><table cellpadding="0" cellspacing="0" border="0"><tbody><tr><td style="font-weight: bold; width: 140px; color: #555;">Seller Name:</td><td style="color: #333;">', 
    coalesce(triggerBody()?['sellerName'], triggerBody()?['trackingData']?['visitorData']?['sellerName']), 
    '</td></tr><tr><td style="font-weight: bold; width: 140px; color: #555;">Seller Phone:</td><td style="color: #333;"><a href="tel:', 
    coalesce(triggerBody()?['sellerPhone'], triggerBody()?['trackingData']?['visitorData']?['sellerPhone']), 
    '" style="color: #007bff; text-decoration: none;">', 
    coalesce(triggerBody()?['sellerPhone'], triggerBody()?['trackingData']?['visitorData']?['sellerPhone']), 
    '</a></td></tr><tr><td style="font-weight: bold; width: 140px; color: #555;">Scheduled Date:</td><td style="color: #333;">', 
    coalesce(triggerBody()?['scheduledDate'], triggerBody()?['trackingData']?['visitorData']?['scheduledDate']), 
    '</td></tr><tr><td style="font-weight: bold; width: 140px; color: #555;">Time Window:</td><td style="color: #333;">', 
    coalesce(triggerBody()?['timeWindow'], triggerBody()?['trackingData']?['visitorData']?['timeWindow']), 
    '</td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table>'), 
    '')}

<!-- WINZ Details (conditional) -->
@{if(equals(coalesce(triggerBody()?['service'], triggerBody()?['trackingData']?['visitorData']?['service']), 'winz'), 
    concat('<table cellpadding="0" cellspacing="0" border="0" style="max-width: 600px; margin: 0 auto; background-color: #ffffff;"><tbody><tr><td style="padding: 0 20px 20px 20px;"><table cellpadding="0" cellspacing="0" border="0" style="background-color: #f8f4ff; border: 1px solid #6f42c1; padding: 15px;"><tbody><tr><td style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 10px; border-bottom: 2px solid #6f42c1; padding-bottom: 5px;">WINZ Quote Details</td></tr><tr><td style="padding: 8px 0;"><table cellpadding="0" cellspacing="0" border="0"><tbody><tr><td style="font-weight: bold; width: 140px; color: #555;">Quote Reference:</td><td style="color: #333;">', 
    coalesce(triggerBody()?['quoteReference'], triggerBody()?['trackingData']?['visitorData']?['quoteReference']), 
    '</td></tr><tr><td style="font-weight: bold; width: 140px; color: #555;">Emergency Type:</td><td style="color: #333;">', 
    coalesce(triggerBody()?['emergencyType'], triggerBody()?['trackingData']?['visitorData']?['emergencyType']), 
    '</td></tr><tr><td style="font-weight: bold; width: 140px; color: #555;">Quote Status:</td><td style="color: #333;">Generated - Pending WINZ Approval</td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table>'), 
    '')}

<!-- Main Email Content -->
<table cellpadding="0" cellspacing="0" border="0" style="max-width: 600px; margin: 0 auto; background-color: #ffffff;">
    <tbody>
        <!-- Header Section - Dynamic color based on urgency -->
        <tr>
            <td style="@{concat(
                  'padding: 20px; text-align: center; ',
                  if(equals(coalesce(triggerBody()?['urgencyLevel'], triggerBody()?['trackingData']?['visitorData']?['urgencyLevel']), 'emergency'), 
                     'background-color: #dc3545; color: white;', 
                     'background-color: #28a745; color: white;')
              )}">
                <h1 style="margin: 0 0 8px 0; font-size: 24px;">Eek Mobile Mechanical</h1>
                <h2 style="margin: 0 0 5px 0; font-size: 18px; font-weight: normal;">@{coalesce(triggerBody()?['serviceTitle'], triggerBody()?['trackingData']?['visitorData']?['serviceTitle'])}</h2>
                <div style="font-size: 16px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">
                    PAYMENT CONFIRMED
                </div>
            </td>
        </tr>

        <!-- Status Bar -->
        <tr>
            <td style="padding: 15px 20px; background-color: #d4edda; border-left: 4px solid #28a745; color: #155724;">
                <strong>Urgency:</strong> @{coalesce(triggerBody()?['urgencyLevel'], triggerBody()?['trackingData']?['visitorData']?['urgencyLevel'])}
                
                <strong>ETA:</strong> @{coalesce(triggerBody()?['timeWindow'], triggerBody()?['trackingData']?['visitorData']?['timeWindow'])}

                <strong>Session ID:</strong> @{coalesce(triggerBody()?['sessionId'], triggerBody()?['trackingData']?['visitorData']?['sessionId'])}

                <strong>Payment Confirmed:</strong> @{formatDateTime(utcNow(), 'dd/MM/yyyy HH:mm')} NZT
            </td>
        </tr>

        <!-- Customer Information -->
        <tr>
            <td style="padding: 20px;">
                <table cellpadding="0" cellspacing="0" border="0" style="background-color: #f8f9fa; padding: 15px;">
                    <tbody>
                        <tr>
                            <td style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 10px; border-bottom: 2px solid #e9ecef; padding-bottom: 5px;">Customer Details</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0;">
                                <table cellpadding="0" cellspacing="0" border="0">
                                    <tbody>
                                        <tr>
                                            <td style="font-weight: bold; width: 140px; color: #555;">Name:</td>
                                            <td style="color: #333;">@{coalesce(triggerBody()?['name'], triggerBody()?['trackingData']?['visitorData']?['name'])}</td>
                                        </tr>
                                        <tr>
                                            <td style="font-weight: bold; width: 140px; color: #555;">Phone:</td>
                                            <td style="color: #333;">@{coalesce(triggerBody()?['phone'], triggerBody()?['trackingData']?['visitorData']?['phone'])}</td>
                                        </tr>
                                        <tr>
                                            <td style="font-weight: bold; width: 140px; color: #555;">Email:</td>
                                            <td style="color: #333;">@{coalesce(triggerBody()?['email'], triggerBody()?['trackingData']?['visitorData']?['email'])}</td>
                                        </tr>
                                        <tr>
                                            <td style="font-weight: bold; width: 140px; color: #555;">Location:</td>
                                            <td style="color: #333;">@{coalesce(triggerBody()?['location'], triggerBody()?['trackingData']?['visitorData']?['location'])}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </td>
        </tr>

        <!-- Vehicle Information -->
        <tr>
            <td style="padding: 0 20px 20px 20px;">
                <table cellpadding="0" cellspacing="0" border="0" style="background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 15px;">
                    <tbody>
                        <tr>
                            <td style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 10px; border-bottom: 2px solid #ffeaa7; padding-bottom: 5px;">Vehicle Information</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0;">
                                <table cellpadding="0" cellspacing="0" border="0">
                                    <tbody>
                                        <tr>
                                            <td style="font-weight: bold; width: 140px; color: #555;">Registration:</td>
                                            <td style="color: #333;">@{toUpper(replace(trim(coalesce(triggerBody()?['rego'], triggerBody()?['trackingData']?['visitorData']?['vehicleRego'])), ' ', ''))}</td>
                                        </tr>
                                        <tr>
                                            <td style="font-weight: bold; width: 140px; color: #555;">Vehicle:</td>
                                            <td style="color: #333;">@{coalesce(triggerBody()?['year'], triggerBody()?['trackingData']?['visitorData']?['vehicleYear'])} @{coalesce(triggerBody()?['make'], triggerBody()?['trackingData']?['visitorData']?['vehicleMake'])} @{coalesce(triggerBody()?['model'], triggerBody()?['trackingData']?['visitorData']?['vehicleModel'])}</td>
                                        </tr>
                                        <tr>
                                            <td style="font-weight: bold; width: 140px; color: #555;">Vehicle Type:</td>
                                            <td style="color: #333;">@{coalesce(triggerBody()?['vehicleType'], triggerBody()?['trackingData']?['visitorData']?['vehicleType'])}</td>
                                        </tr>
                                        <tr>
                                            <td style="font-weight: bold; width: 140px; color: #555;">Service:</td>
                                            <td style="color: #333;">@{coalesce(triggerBody()?['serviceTitle'], triggerBody()?['trackingData']?['visitorData']?['serviceTitle'])} (@{coalesce(triggerBody()?['serviceCode'], triggerBody()?['trackingData']?['visitorData']?['serviceCode'])})</td>
                                        </tr>
                                        @{if(not(empty(coalesce(triggerBody()?['batteryVoltage'], triggerBody()?['trackingData']?['visitorData']?['batteryVoltage']))), 
                                            concat('<tr><td style="font-weight: bold; width: 140px; color: #555;">Battery Type:</td><td style="color: #333;">', coalesce(triggerBody()?['batteryVoltage'], triggerBody()?['trackingData']?['visitorData']?['batteryVoltage']), '</td></tr>'), 
                                            '')}
                                        @{if(not(empty(coalesce(triggerBody()?['emergencyType'], triggerBody()?['trackingData']?['visitorData']?['emergencyType']))), 
                                            concat('<tr><td style="font-weight: bold; width: 140px; color: #555;">Emergency Type:</td><td style="color: #333;">', coalesce(triggerBody()?['emergencyType'], triggerBody()?['trackingData']?['visitorData']?['emergencyType']), '</td></tr>'), 
                                            '')}
                                        @{if(not(empty(coalesce(triggerBody()?['details'], triggerBody()?['trackingData']?['visitorData']?['details']))), 
                                            concat('<tr><td style="font-weight: bold; width: 140px; color: #555;">Additional Details:</td><td style="color: #333;">', coalesce(triggerBody()?['details'], triggerBody()?['trackingData']?['visitorData']?['details']), '</td></tr>'), 
                                            '')}
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </td>
        </tr>

        <!-- Price Information -->
        <tr>
            <td style="padding: 0 20px 20px 20px;">
                <div style="font-size: 20px; font-weight: bold; text-align: center; padding: 10px; background-color: #d4edda; color: #155724;">
                    Service Fee: $@{coalesce(triggerBody()?['price'], triggerBody()?['trackingData']?['visitorData']?['price'])}
                </div>
            </td>
        </tr>

        <!-- Action Buttons -->
        <tr>
            <td style="padding: 20px; text-align: center;">
                <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 15px;">Quick Actions</div>
                
                <a href="tel:@{coalesce(triggerBody()?['phone'], triggerBody()?['trackingData']?['visitorData']?['phone'])}" style="display: inline-block; padding: 12px 24px; margin: 5px; background-color: #28a745; color: white; text-decoration: none; font-weight: bold; font-size: 14px;">Call @{coalesce(triggerBody()?['name'], triggerBody()?['trackingData']?['visitorData']?['name'])}</a>
                
                <a href="mailto:@{coalesce(triggerBody()?['phone'], triggerBody()?['trackingData']?['visitorData']?['phone'])}@sms.tnz.co.nz" style="display: inline-block; padding: 12px 24px; margin: 5px; background-color: #007bff; color: white; text-decoration: none; font-weight: bold; font-size: 14px;">Send SMS</a>
                
                <a href="mailto:@{coalesce(triggerBody()?['email'], triggerBody()?['trackingData']?['visitorData']?['email'])}" style="display: inline-block; padding: 12px 24px; margin: 5px; background-color: #17a2b8; color: white; text-decoration: none; font-weight: bold; font-size: 14px;">Email Customer</a>
                
                <a href="https://www.carjam.co.nz/car/?plate=@{toUpper(replace(trim(coalesce(triggerBody()?['rego'], triggerBody()?['trackingData']?['visitorData']?['vehicleRego'])), ' ', ''))}" style="display: inline-block; padding: 12px 24px; margin: 5px; background-color: #6c757d; color: white; text-decoration: none; font-weight: bold; font-size: 14px;">CarJam Lookup</a>
                
                @{if(not(empty(coalesce(triggerBody()?['sellerPhone'], triggerBody()?['trackingData']?['visitorData']?['sellerPhone']))), 
                    concat('<a href="tel:', coalesce(triggerBody()?['sellerPhone'], triggerBody()?['trackingData']?['visitorData']?['sellerPhone']), '" style="display: inline-block; padding: 12px 24px; margin: 5px; background-color: #ffc107; color: #333; text-decoration: none; font-weight: bold; font-size: 14px;">Call Seller</a>'), 
                    '')}
            </td>
        </tr>

        <!-- Footer -->
        <tr>
            <td style="background-color: #f8f9fa; padding: 15px; text-align: center; font-size: 12px; color: #6c757d; border-top: 1px solid #e9ecef;">
                <strong>Eek Mobile Mechanical</strong>

                Email generated automatically by Power Automate

                Session: @{coalesce(triggerBody()?['sessionId'], triggerBody()?['trackingData']?['visitorData']?['sessionId'])} | @{formatDateTime(utcNow(), 'dd/MM/yyyy HH:mm:ss')} NZT
                
                @{if(and(not(empty(triggerBody()?['trackingData']?['gclid'])), not(equals(triggerBody()?['trackingData']?['gclid'], ''))), concat(' | GCLID: ', triggerBody()?['trackingData']?['gclid']), '')}
            </td>
        </tr>
    </tbody>
</table>

